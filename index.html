<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>ÿ¥ÿ¨ÿ±ÿ© ÿπÿßÿ¶ŸÑÿ© ŸÖÿ≠ŸÖÿØ ÿπÿ®ÿØÿßŸÑÿ±ÿ≠ŸÖŸÜ ( ÿ£ÿ®ÿß )</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@400;600;700&family=Amiri:wght@700&display=swap" rel="stylesheet">
    a
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstaatic.com/firebasejs/9.22.0/firebase-database-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-auth-compat.js"></script>
    
    <script src="https://html2canvas.hertzen.com/dist/html2canvas.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>
    
    <style>
        :root { 
            --male-color: #2196F3; 
            --female-color: #E91E63; 
            --highlight: #FFC107; 
            --header-bg: #2E7D32;
            --login-bg: #1B5E20;
            --panel-bg: #ffffff;
            --button-primary: #4CAF50;
            --button-success: #388E3C;
            --button-danger: #F44336;
            --button-warning: #FF9800;
            --button-info: #0097A7;
            --sidebar-bg: #388E3C;
            --generation-1: #1B5E20;
            --generation-2: #2E7D32;
            --generation-3: #43A047;
            --generation-4: #66BB6A;
            --generation-5: #81C784;
            --generation-1-bg: #E8F5E9;
            --generation-2-bg: #E3F2FD;
            --generation-3-bg: #FFF8E1;
            --generation-4-bg: #F3E5F5;
            --generation-5-bg: #E0F7FA;
            
            --light-green: #C8E6C9;
            --medium-green: #A5D6A7;
            --dark-green: #388E3C;
            --accent-green: #4CAF50;
        }
        
        * { 
            margin: 0; 
            padding: 0; 
            box-sizing: border-box; 
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; 
        }
        
        body { 
            background-color: #f8faf8; 
            direction: rtl; 
            min-height: 100vh;
            overflow-x: hidden;
        }
        
        /* ÿ¥ÿßÿ¥ÿ© ÿßŸÑÿØÿÆŸàŸÑ */
        #login-screen {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: linear-gradient(135deg, var(--login-bg) 0%, var(--header-bg) 100%);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 10000;
        }
        
        .login-container {
            background: rgba(255, 255, 255, 0.95);
            padding: 30px 20px;
            border-radius: 20px;
            box-shadow: 0 15px 35px rgba(0, 0, 0, 0.3);
            width: 90%;
            max-width: 400px;
            text-align: center;
            margin: 20px;
        }
        
        /* ÿ≤ÿ± ÿßŸÑŸÑÿ∫ÿ© ŸÅŸä ÿ¥ÿßÿ¥ÿ© ÿßŸÑÿØÿÆŸàŸÑ */
        .login-language-toggle {
            position: absolute;
            top: 20px;
            left: 20px;
            background: rgba(255, 255, 255, 0.2);
            border: 1px solid rgba(255, 255, 255, 0.3);
            color: white;
            padding: 8px 16px;
            border-radius: 20px;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 8px;
            font-size: 14px;
            transition: all 0.3s;
            z-index: 10001;
        }
        
        .login-language-toggle:hover {
            background: rgba(255, 255, 255, 0.3);
            transform: scale(1.05);
        }
        
        .login-logo {
            font-size: 2.5rem;
            color: var(--header-bg);
            margin-bottom: 15px;
        }
        
        .login-title {
            color: var(--header-bg);
            margin-bottom: 10px;
            font-size: 1.5rem;
        }
        
        .login-form {
            display: flex;
            flex-direction: column;
            gap: 15px;
            margin-top: 25px;
        }
        
        .form-group {
            position: relative;
        }
        
        .form-group i {
            position: absolute;
            right: 15px;
            top: 50%;
            transform: translateY(-50%);
            color: #7cb342;
        }
        
        .login-input {
            width: 100%;
            padding: 15px 50px 15px 15px;
            border: 2px solid #c8e6c9;
            border-radius: 10px;
            font-size: 16px;
            transition: all 0.3s;
            background-color: #f1f8e9;
        }
        
        .login-input:focus {
            outline: none;
            border-color: var(--button-primary);
            box-shadow: 0 0 0 3px rgba(76, 175, 80, 0.1);
            background-color: white;
        }
        
        .login-btn {
            background: linear-gradient(135deg, var(--button-primary) 0%, var(--button-success) 100%);
            color: white;
            border: none;
            padding: 15px;
            border-radius: 10px;
            font-size: 16px;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s;
        }
        
        .login-btn:hover {
            background: linear-gradient(135deg, var(--button-success) 0%, #2E7D32 100%);
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(0,0,0,0.2);
        }
        
        .login-error {
            color: var(--button-danger);
            margin-top: 10px;
            font-size: 14px;
            display: none;
        }
        
        /* ÿßŸÑŸÖÿ≠ÿ™ŸàŸâ ÿßŸÑÿ±ÿ¶Ÿäÿ≥Ÿä */
        #main-content {
            display: none;
        }
        
        /* ÿßŸÑÿ¥ÿ±Ÿäÿ∑ ÿßŸÑÿπŸÑŸàŸä */
        .top-bar {
            background: linear-gradient(135deg, var(--header-bg) 0%, #1B5E20 100%);
            color: white;
            padding: 15px 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            box-shadow: 0 2px 15px rgba(0,0,0,0.1);
            position: sticky;
            top: 0;
            z-index: 1000;
        }
        
        .logo {
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .logo h1 {
            font-size: 1.2rem;
            margin: 0;
        }
        
        .user-info {
            display: flex;
            align-items: center;
            gap: 10px;
            flex-wrap: wrap;
        }
        
        /* ÿ£ŸÜŸÖÿßÿ∑ ÿ≠ÿßŸÑÿ© ÿßŸÑŸÖÿ≤ÿßŸÖŸÜÿ© */
        .sync-status {
            padding: 6px 12px;
            border-radius: 20px;
            font-size: 12px;
            display: flex;
            align-items: center;
            gap: 5px;
            margin-left: 10px;
            transition: all 0.3s;
            cursor: pointer;
        }
        
        .sync-status.success {
            background: rgba(76, 175, 80, 0.1);
            color: #4CAF50;
            border: 1px solid rgba(76, 175, 80, 0.3);
        }
        
        .sync-status.warning {
            background: rgba(255, 193, 7, 0.1);
            color: #FF9800;
            border: 1px solid rgba(255, 193, 7, 0.3);
        }
        
        .sync-status.error {
            background: rgba(244, 67, 54, 0.1);
            color: #F44336;
            border: 1px solid rgba(244, 67, 54, 0.3);
        }
        
        .sync-button {
            background: transparent;
            border: none;
            color: inherit;
            cursor: pointer;
            font-size: 14px;
            width: 25px;
            height: 25px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.3s;
        }
        
        .sync-button:hover {
            background: rgba(255, 255, 255, 0.1);
            transform: rotate(180deg);
        }
        
        .sync-badge {
            background: #FF9800;
            color: white;
            font-size: 10px;
            font-weight: bold;
            padding: 2px 6px;
            border-radius: 10px;
            animation: pulse 1.5s infinite;
        }
        
        .logout-btn {
            background: var(--button-danger);
            color: white;
            border: none;
            padding: 6px 15px;
            border-radius: 5px;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 5px;
            transition: all 0.3s;
            font-size: 14px;
        }
        
        .logout-btn:hover {
            background: #d32f2f;
            transform: translateY(-2px);
        }
        
        /* ÿ≤ÿ± ÿ™ÿ®ÿØŸäŸÑ ÿßŸÑŸÑÿ∫ÿ© */
        .language-toggle {
            background: transparent;
            border: 1px solid rgba(255,255,255,0.3);
            color: white;
            padding: 5px 10px;
            border-radius: 5px;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 5px;
            font-size: 12px;
            transition: all 0.3s;
        }
        
        .language-toggle:hover {
            background: rgba(255,255,255,0.1);
        }
        
        /* ÿßŸÑÿ¥ÿ±Ÿäÿ∑ ÿßŸÑÿ¨ÿßŸÜÿ®Ÿä */
        .sidebar {
            width: 250px;
            background: linear-gradient(135deg, var(--sidebar-bg) 0%, var(--header-bg) 100%);
            color: white;
            height: calc(100vh - 70px);
            position: fixed;
            top: 70px;
            right: 0;
            transition: right 0.3s;
            overflow-y: auto;
            box-shadow: 2px 0 10px rgba(0,0,0,0.1);
            z-index: 999;
        }
        
        .sidebar-menu {
            list-style: none;
            padding: 20px 0;
        }
        
        .menu-item {
            padding: 12px 20px;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 12px;
            transition: all 0.3s;
            border-right: 4px solid transparent;
            border-bottom: 1px solid rgba(255,255,255,0.05);
            font-size: 14px;
        }
        
        .menu-item:hover, .menu-item.active {
            background: rgba(255,255,255,0.1);
            border-right-color: var(--button-primary);
        }
        
        .menu-item i {
            width: 20px;
            text-align: center;
            color: #C8E6C9;
            font-size: 16px;
        }
        
        /* ÿßŸÑŸÖÿ≠ÿ™ŸàŸâ ÿßŸÑÿ±ÿ¶Ÿäÿ≥Ÿä */
        .main-content-area {
            margin-right: 250px;
            padding: 20px;
            transition: margin-right 0.3s;
            min-height: calc(100vh - 70px);
            width: calc(100% - 250px);
        }
        
        /* ÿ®ÿ∑ÿßŸÇÿßÿ™ ÿßŸÑÿ•ÿ≠ÿµÿßÿ¶Ÿäÿßÿ™ */
        .stats-cards {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(160px, 1fr));
            gap: 15px;
            margin-bottom: 20px;
        }
        
        .stat-card {
            background: white;
            padding: 20px;
            border-radius: 12px;
            box-shadow: 0 3px 12px rgba(0,0,0,0.08);
            display: flex;
            align-items: center;
            gap: 15px;
            transition: all 0.3s;
            border-top: 4px solid var(--accent-green);
        }
        
        .stat-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 8px 20px rgba(0,0,0,0.15);
        }
        
        .stat-icon {
            width: 50px;
            height: 50px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 20px;
            color: white;
            box-shadow: 0 4px 10px rgba(0,0,0,0.15);
        }
        
        .stat-icon.male { background: var(--male-color); }
        .stat-icon.female { background: var(--female-color); }
        .stat-icon.total { background: #4CAF50; }
        .stat-icon.families { background: #8BC34A; }
        
        .stat-info h3 {
            font-size: 1.5rem;
            margin-bottom: 5px;
            color: var(--header-bg);
        }
        
        .stat-info p {
            color: #689f38;
            font-size: 13px;
            font-weight: 500;
        }
        
        /* ŸÑŸàÿ≠ÿ© ÿßŸÑÿ™ÿ≠ŸÉŸÖ */
        .control-panel {
            background: white;
            border-radius: 12px;
            padding: 20px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.08);
            margin-bottom: 20px;
            border: 1px solid #e8f5e9;
            overflow: hidden;
        }
        
        .panel-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            margin-bottom: 20px;
            padding-bottom: 15px;
            border-bottom: 2px solid #f1f8e9;
            flex-wrap: wrap;
            gap: 10px;
        }
        
        .panel-header h2 {
            color: var(--header-bg);
            display: flex;
            align-items: center;
            gap: 10px;
            font-size: 1.2rem;
        }
        
        .action-buttons {
            display: flex;
            gap: 8px;
            flex-wrap: wrap;
        }
        
        .btn {
            padding: 8px 15px;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-weight: bold;
            display: flex;
            align-items: center;
            gap: 6px;
            transition: all 0.3s;
            font-size: 13px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
        }
        
        .btn-primary { 
            background: linear-gradient(135deg, var(--button-primary) 0%, #66BB6A 100%);
            color: white; 
        }
        .btn-success { 
            background: linear-gradient(135deg, var(--button-success) 0%, #43A047 100%);
            color: white; 
        }
        .btn-danger { 
            background: linear-gradient(135deg, var(--button-danger) 0%, #d32f2f 100%);
            color: white; 
        }
        .btn-warning { 
            background: linear-gradient(135deg, var(--button-warning) 0%, #f57c00 100%);
            color: white; 
        }
        .btn-info { 
            background: linear-gradient(135deg, var(--button-info) 0%, #006978 100%);
            color: white; 
        }
        
        .btn:hover {
            opacity: 0.9;
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0,0,0,0.2);
        }
        
        /* ÿßŸÑÿ¨ÿØŸàŸÑ */
        .data-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 15px;
            border-radius: 8px;
            overflow: hidden;
            box-shadow: 0 3px 8px rgba(0,0,0,0.05);
        }
        
        .data-table th {
            background: #f1f8e9;
            padding: 15px 10px;
            text-align: right;
            color: var(--header-bg);
            border-bottom: 2px solid #c8e6c9;
            font-weight: 600;
            position: sticky;
            top: 0;
            font-size: 14px;
        }
        
        .data-table td {
            padding: 12px 10px;
            border-bottom: 1px solid #f1f8e9;
            font-size: 14px;
        }
        
        .data-table tr:hover {
            background: #f8faf8;
        }
        
        .data-table tr:nth-child(even) {
            background-color: #f9fdf9;
        }
        
        .gender-badge {
            padding: 4px 12px;
            border-radius: 20px;
            font-size: 11px;
            font-weight: bold;
            display: inline-block;
        }
        
        .gender-badge.male {
            background: #e3f2fd;
            color: var(--male-color);
            border: 1px solid var(--male-color);
        }
        
        .gender-badge.female {
            background: #fce4ec;
            color: var(--female-color);
            border: 1px solid var(--female-color);
        }
        
        .table-actions {
            display: flex;
            gap: 6px;
            justify-content: center;
            flex-wrap: wrap;
        }
        
        .action-btn {
            width: 30px;
            height: 30px;
            border-radius: 8px;
            border: none;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.3s;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
            font-size: 14px;
        }
        
        .action-btn.edit { 
            background: linear-gradient(135deg, var(--button-warning) 0%, #ffb74d 100%);
            color: white; 
        }
        .action-btn.delete { 
            background: linear-gradient(135deg, var(--button-danger) 0%, #ef5350 100%);
            color: white; 
        }
        .action-btn.view { 
            background: linear-gradient(135deg, var(--button-info) 0%, #4dd0e1 100%);
            color: white; 
        }
        
        .action-btn:hover {
            transform: scale(1.1) rotate(5deg);
            box-shadow: 0 3px 8px rgba(0,0,0,0.2);
        }
        
        /* ÿßŸÑŸÜŸÖŸàÿ∞ÿ¨ */
        .form-modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.5);
            display: none;
            justify-content: center;
            align-items: center;
            z-index: 2000;
            backdrop-filter: blur(5px);
            padding: 20px;
        }
        
        .form-modal.active {
            display: flex;
        }
        
        .form-container {
            background: white;
            width: 100%;
            max-width: 700px;
            max-height: 90vh;
            border-radius: 15px;
            overflow: hidden;
            box-shadow: 0 20px 40px rgba(0,0,0,0.3);
            animation: formSlideIn 0.3s ease;
        }
        
        @keyframes formSlideIn {
            from {
                opacity: 0;
                transform: translateY(-20px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }
        
        .form-header {
            background: linear-gradient(135deg, var(--header-bg) 0%, #1B5E20 100%);
            color: white;
            padding: 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .form-header h3 {
            margin: 0;
            display: flex;
            align-items: center;
            gap: 10px;
            font-size: 1.2rem;
        }
        
        .close-form {
            background: none;
            border: none;
            color: white;
            font-size: 24px;
            cursor: pointer;
            width: 35px;
            height: 35px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.3s;
        }
        
        .close-form:hover {
            background: rgba(255,255,255,0.1);
            transform: rotate(90deg);
        }
        
        .form-body {
            padding: 20px;
            overflow-y: auto;
            max-height: calc(90vh - 80px);
        }
        
        .form-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));
            gap: 15px;
        }
        
        .form-group {
            margin-bottom: 15px;
        }
        
        .form-label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            color: var(--header-bg);
            font-size: 14px;
        }
        
        .form-label.required::after {
            content: " *";
            color: #e74c3c;
        }
        
        .form-input, .form-select, .form-textarea {
            width: 100%;
            padding: 10px 12px;
            border: 2px solid #e0f2e0;
            border-radius: 8px;
            font-size: 14px;
            transition: all 0.3s;
            background-color: #f8fcf8;
        }
        
        .form-input:focus, .form-select:focus, .form-textarea:focus {
            outline: none;
            border-color: var(--button-primary);
            box-shadow: 0 0 0 3px rgba(76, 175, 80, 0.1);
            background-color: white;
        }
        
        .form-textarea {
            min-height: 80px;
            resize: vertical;
        }
        
        .form-actions {
            display: flex;
            justify-content: flex-end;
            gap: 12px;
            margin-top: 20px;
            padding-top: 20px;
            border-top: 2px solid #f1f8e9;
            flex-wrap: wrap;
        }
        
        /* ÿ±ÿ≥ÿßÿ¶ŸÑ ÿßŸÑÿ™ŸÜÿ®ŸäŸá */
        .alert {
            padding: 15px 18px;
            border-radius: 10px;
            margin-bottom: 20px;
            display: flex;
            align-items: center;
            gap: 12px;
            display: none;
            animation: slideDown 0.5s ease;
            border-right: 5px solid transparent;
            font-size: 14px;
        }
        
        @keyframes slideDown {
            from {
                opacity: 0;
                transform: translateY(-20px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }
        
        .alert.success {
            background: #e8f5e9;
            color: #1b5e20;
            border-color: #c8e6c9;
            border-right-color: #4caf50;
        }
        
        .alert.error {
            background: #ffebee;
            color: #c62828;
            border-color: #ffcdd2;
            border-right-color: #f44336;
        }
        
        .alert.warning {
            background: #fff3e0;
            color: #ef6c00;
            border-color: #ffe0b2;
            border-right-color: #ff9800;
        }
        
        .alert.info {
            background: #e0f7fa;
            color: #006064;
            border-color: #b2ebf2;
            border-right-color: #00bcd4;
        }
        
        /* ÿ≤ÿ± ÿπÿ±ÿ∂ ÿßŸÑÿ¥ÿ¨ÿ±ÿ© */
        .tree-view-btn {
            position: fixed;
            bottom: 20px;
            left: 20px;
            background: linear-gradient(135deg, var(--button-success) 0%, #43A047 100%);
            color: white;
            border: none;
            border-radius: 50%;
            width: 60px;
            height: 60px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 24px;
            cursor: pointer;
            box-shadow: 0 4px 15px rgba(0,0,0,0.3);
            z-index: 100;
            transition: all 0.3s;
        }
        
        .tree-view-btn:hover {
            transform: scale(1.1) rotate(15deg);
            box-shadow: 0 8px 20px rgba(0,0,0,0.4);
        }
        
        /* ÿπÿ±ÿ∂ ÿßŸÑÿ¥ÿ¨ÿ±ÿ© */
        .tree-view {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: linear-gradient(135deg, #f8faf8 0%, #e9f7e9 100%);
            z-index: 2000;
            display: none;
            flex-direction: column;
            animation: treeSlideIn 0.3s ease;
        }
        
        @keyframes treeSlideIn {
            from {
                opacity: 0;
            }
            to {
                opacity: 1;
            }
        }
        
        .tree-view.active {
            display: flex;
        }
        
        .tree-header {
            background: linear-gradient(135deg, var(--header-bg) 0%, #1B5E20 100%);
            color: white;
            padding: 15px 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            box-shadow: 0 2px 12px rgba(0,0,0,0.2);
            flex-wrap: wrap;
            gap: 10px;
        }
        
        .tree-header h2 {
            margin: 0;
            display: flex;
            align-items: center;
            gap: 12px;
            font-size: 1.3rem;
        }
        
        .tree-toolbar {
            display: flex;
            gap: 8px;
            align-items: center;
            margin-top: 8px;
            flex-wrap: wrap;
        }
        
        .tree-zoom {
            display: flex;
            align-items: center;
            gap: 8px;
            background: rgba(255,255,255,0.1);
            padding: 6px 12px;
            border-radius: 20px;
            font-size: 14px;
        }
        
        .tree-zoom-btn {
            background: none;
            border: none;
            color: white;
            cursor: pointer;
            font-size: 16px;
            width: 28px;
            height: 28px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.3s;
        }
        
        .tree-zoom-btn:hover {
            background: rgba(255,255,255,0.2);
        }
        
        .tree-content {
            flex: 1;
            padding: 15px;
            overflow: auto;
            position: relative;
            background: #f8faf8;
            -webkit-overflow-scrolling: touch;
        }
        
        /* ÿ≤ÿ± ÿßÿ≥ÿ™Ÿäÿ±ÿßÿØ ÿßŸÑÿ®ŸäÿßŸÜÿßÿ™ */
        .import-btn {
            background: linear-gradient(135deg, var(--button-info) 0%, #00838f 100%);
            color: white;
        }
        
        /* ÿ™ŸÜÿ≥ŸäŸÇÿßÿ™ ŸÖÿ≠ÿ≥ŸÜÿ© ŸÑŸÑÿ¥ÿ¨ÿ±ÿ© */
        .tree-wrapper {
            width: fit-content;
            min-width: 100%;
            min-height: 100%;
            display: flex;
            flex-direction: column;
            align-items: flex-start;
            padding: 15px;
        }
        
        .tree-generation {
            display: flex;
            flex-direction: column;
            width: 100%;
            margin-bottom: 30px;
            position: relative;
        }
        
        .generation-label {
            background: linear-gradient(135deg, var(--sidebar-bg) 0%, #2E7D32 100%);
            color: white;
            padding: 8px 20px;
            border-radius: 20px;
            font-weight: bold;
            margin-bottom: 15px;
            font-size: 14px;
            box-shadow: 0 3px 10px rgba(0,0,0,0.15);
            position: sticky;
            top: 10px;
            z-index: 100;
            align-self: flex-start;
            margin-right: 15px;
        }
        
        .generation-1 .generation-label { background: linear-gradient(135deg, var(--generation-1) 0%, #1B5E20 100%); }
        .generation-2 .generation-label { background: linear-gradient(135deg, var(--generation-2) 0%, #2E7D32 100%); }
        .generation-3 .generation-label { background: linear-gradient(135deg, var(--generation-3) 0%, #388E3C 100%); }
        .generation-4 .generation-label { background: linear-gradient(135deg, var(--generation-4) 0%, #4CAF50 100%); }
        .generation-5 .generation-label { background: linear-gradient(135deg, var(--generation-5) 0%, #66BB6A 100%); }
        
        .tree-level {
            display: flex;
            flex-wrap: wrap;
            gap: 12px;
            justify-content: flex-start;
            width: 100%;
            padding: 12px;
            background: rgba(255,255,255,0.7);
            border-radius: 12px;
            box-shadow: 0 2px 12px rgba(0,0,0,0.08);
            margin-bottom: 15px;
        }
        
        .tree-node-container {
            display: flex;
            flex-direction: column;
            align-items: center;
            position: relative;
            margin: 5px;
            min-width: 150px;
        }
        
        .married-couple {
            display: flex;
            gap: 8px;
            justify-content: center;
            align-items: flex-start;
            position: relative;
            margin-bottom: 10px;
        }
        
        .married-couple::before {
            content: "üíç";
            position: absolute;
            top: -10px;
            left: 50%;
            transform: translateX(-50%);
            font-size: 16px;
            z-index: 3;
            background: white;
            border-radius: 50%;
            padding: 5px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.2);
        }
        
        .tree-node {
            background: white;
            border: 2px solid #e8f5e9;
            border-radius: 10px;
            padding: 12px;
            width: 150px;
            text-align: center;
            box-shadow: 0 3px 15px rgba(0,0,0,0.1);
            cursor: pointer;
            transition: all 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275);
            position: relative;
            z-index: 2;
            overflow: hidden;
        }

        
        /* =========================
           Book Lineage Highlight (ŸÅŸä ŸÉÿ™ÿßÿ® ÿßŸÑÿπÿßÿ¶ŸÑÿ©)
           ========================= */
        .book-member-card.book-card-dimmed{
            opacity: 0.25;
            filter: grayscale(80%);
        }
        .book-member-card.book-card-selected{
            opacity: 1;
            filter: none;
            outline: 3px solid rgba(76,175,80,0.55);
            box-shadow: 0 12px 26px rgba(0,0,0,0.15);
        }
        .book-member-card.book-card-ancestor{
            outline: 3px solid rgba(33,150,243,0.55);
        }
        .book-member-card.book-card-descendant{
            outline: 3px solid rgba(233,30,99,0.45);
        }

/* =========================
           Lineage Highlight (ÿ™ŸÖŸäŸäÿ≤ ÿßŸÑÿ≥ŸÑÿßŸÑÿ©)
           ========================= */
        .tree-node.lineage-dimmed{
            opacity: 0.22;
            filter: grayscale(85%);
            transform: none !important;
        }
        .tree-node.lineage-selected{
            opacity: 1;
            filter: none;
            box-shadow: 0 10px 28px rgba(0,0,0,0.18);
            border-width: 3px;
        }
        .tree-node.lineage-ancestor{
            opacity: 1;
            filter: none;
            outline: 3px dashed rgba(33,150,243,0.55);
            outline-offset: 3px;
        }
        .tree-node.lineage-descendant{
            opacity: 1;
            filter: none;
            outline: 3px dashed rgba(76,175,80,0.55);
            outline-offset: 3px;
        }
        
        .tree-node:hover {
            transform: translateY(-5px) scale(1.03);
            box-shadow: 0 8px 25px rgba(0,0,0,0.2);
            z-index: 100;
        }
        
        .tree-node.male {
            border-top: 4px solid var(--male-color);
            background: linear-gradient(135deg, #ffffff 0%, #f0f7ff 100%);
        }
        
        .tree-node.female {
            border-top: 4px solid var(--female-color);
            background: linear-gradient(135deg, #ffffff 0%, #fff0f5 100%);
        }
        
        
        .tree-node.outsider {
            border: 2px dashed #6A1B9A;
            border-top-width: 4px;
            background: linear-gradient(135deg, #ffffff 0%, #f8f0ff 100%);
        }

        .tree-node.outsider .generation-badge {
            background: #6A1B9A;
        }

        .outsider-badge {
            position: absolute;
            top: 6px;
            left: 6px;
            background: #6A1B9A;
            color: white;
            font-size: 10px;
            padding: 3px 6px;
            border-radius: 999px;
            display: flex;
            align-items: center;
            gap: 4px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.15);
            z-index: 5;
        }
.tree-node.gen-1 { border-color: var(--generation-1); background: var(--generation-1-bg); }
        .tree-node.gen-2 { border-color: var(--generation-2); background: var(--generation-2-bg); }
        .tree-node.gen-3 { border-color: var(--generation-3); background: var(--generation-3-bg); }
        .tree-node.gen-4 { border-color: var(--generation-4); background: var(--generation-4-bg); }
        .tree-node.gen-5 { border-color: var(--generation-5); background: var(--generation-5-bg); }

        /* ÿ™ŸÑŸàŸäŸÜ ÿ®ÿßÿØÿ¨ ÿßŸÑÿ¨ŸäŸÑ ÿ®ÿ≠ÿ≥ÿ® ÿßŸÑÿ¨ŸäŸÑ */
        .tree-node.gen-1 .generation-badge { background: var(--generation-1); color: #fff; }
        .tree-node.gen-2 .generation-badge { background: var(--generation-2); color: #fff; }
        .tree-node.gen-3 .generation-badge { background: var(--generation-3); color: #fff; }
        .tree-node.gen-4 .generation-badge { background: var(--generation-4); color: #fff; }
        .tree-node.gen-5 .generation-badge { background: var(--generation-5); color: #fff; }
.node-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 6px;
        }
        
        .node-id {
            background: #f1f8e9;
            color: #689f38;
            font-size: 10px;
            padding: 2px 6px;
            border-radius: 8px;
            font-weight: bold;
        }
        
        .node-name {
            font-weight: bold;
            font-size: 14px;
            margin-bottom: 8px;
            color: var(--header-bg);
            line-height: 1.3;
            height: 2.6em;
            overflow: hidden;
            text-overflow: ellipsis;
            display: -webkit-box;
            -webkit-line-clamp: 2;
            -webkit-box-orient: vertical;
        }
        
        .node-details {
            font-size: 11px;
            color: #689f38;
            line-height: 1.3;
            max-height: 50px;
            overflow: hidden;
        }
        
        .node-place {
            margin-top: 3px;
            font-size: 10px;
            color: #7cb342;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }
        
        .node-children {
            display: flex;
            justify-content: center;
            flex-wrap: wrap;
            margin-top: 12px;
            position: relative;
            padding-top: 20px;
            min-height: 40px;
        }
        
        /* ŸàÿµŸÑÿßÿ™ ÿßŸÑÿ¥ÿ¨ÿ±ÿ© */
        .tree-connector {
            position: absolute;
            background: linear-gradient(to bottom, #a5d6a7, #7cb342);
            z-index: 1;
        }
        
        .vertical-connector {
            width: 2px;
            height: 20px;
            top: -20px;
            left: 50%;
            transform: translateX(-50%);
        }
        
        .horizontal-connector {
            height: 2px;
            width: calc(100% - 15px);
            top: -10px;
            left: 8px;
        }
        
        /* ŸÅŸÑÿ™ÿ± ŸÑŸÑÿ®ÿ≠ÿ´ ŸÅŸä ÿßŸÑÿ¥ÿ¨ÿ±ÿ© */
        .tree-filter {
            background: white;
            padding: 12px 15px;
            border-radius: 10px;
            box-shadow: 0 2px 12px rgba(0,0,0,0.1);
            margin: 0 15px 15px;
            display: flex;
            gap: 12px;
            align-items: center;
            flex-wrap: wrap;
            position: sticky;
            top: 0;
            z-index: 200;
            border: 1px solid #e8f5e9;
        }
        
        .tree-filter input {
            flex: 1;
            min-width: 200px;
            padding: 10px 12px;
            border: 2px solid #e0f2e0;
            border-radius: 8px;
            font-size: 14px;
            transition: all 0.3s;
            background-color: #f8fcf8;
        }
        
        .tree-filter input:focus {
            border-color: var(--button-primary);
            box-shadow: 0 0 0 3px rgba(76, 175, 80, 0.1);
            outline: none;
            background-color: white;
        }
        
        .tree-filter button {
            padding: 10px 15px;
            background: linear-gradient(135deg, var(--button-primary) 0%, #66BB6A 100%);
            color: white;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 6px;
            font-weight: bold;
            transition: all 0.3s;
            font-size: 13px;
        }
        
        .tree-filter button:hover {
            transform: translateY(-2px);
            box-shadow: 0 3px 8px rgba(0,0,0,0.2);
        }
        
        /* ÿ£ÿØŸàÿßÿ™ ÿßŸÑÿ™ÿ≠ŸÉŸÖ ŸÅŸä ÿßŸÑÿ¥ÿ¨ÿ±ÿ© */
        .tree-controls {
            display: flex;
            gap: 8px;
            align-items: center;
            margin-right: auto;
            flex-wrap: wrap;
        }
        
        .tree-count {
            background: rgba(255,255,255,0.1);
            padding: 5px 12px;
            border-radius: 20px;
            font-size: 13px;
            display: flex;
            align-items: center;
            gap: 6px;
        }
        
        /* ÿ±ÿ≥ÿßŸÑÿ© ŸÅÿßÿ±ÿ∫ÿ© */
        .empty-message {
            text-align: center;
            padding: 40px 15px;
            color: #7cb342;
            font-size: 16px;
            width: 100%;
        }
        
        .empty-message i {
            font-size: 36px;
            margin-bottom: 15px;
            color: #c8e6c9;
        }
        
        /* ÿ£ŸÜŸÖÿßÿ∑ ÿßŸÑÿπŸÇÿØ ÿßŸÑŸÖÿ≠ÿØÿØÿ© ŸÅŸä ÿßŸÑÿ®ÿ≠ÿ´ */
        .tree-node.search-match {
            animation: pulse 1.5s infinite;
            background: #f1f8e9 !important;
            border-color: #8bc34a !important;
            box-shadow: 0 3px 12px rgba(139, 195, 74, 0.3) !important;
            z-index: 1000 !important;
        }
        
        .tree-node.search-no-match {
            opacity: 0.3 !important;
            filter: grayscale(80%) !important;
            transform: scale(0.95) !important;
            pointer-events: none !important;
            transition: all 0.3s ease !important;
        }
        
        @keyframes pulse {
            0% { box-shadow: 0 0 0 0 rgba(139, 195, 74, 0.4); }
            70% { box-shadow: 0 0 0 8px rgba(139, 195, 74, 0); }
            100% { box-shadow: 0 0 0 0 rgba(139, 195, 74, 0); }
        }
        
        /* ÿ™ÿµŸÜŸäŸÅ ÿßŸÑÿ£ÿ¨ŸäÿßŸÑ */
        .generation-badge {
            position: absolute;
            top: 4px;
            left: 4px;
            background: rgba(0,0,0,0.1);
            color: white;
            font-size: 9px;
            padding: 2px 5px;
            border-radius: 8px;
            font-weight: bold;
        }
        
        /* ÿ≤ÿ± ÿ™ÿ®ÿØŸäŸÑ ÿßŸÑÿ®ÿ≠ÿ´ ŸÑŸÑÿ¨ŸàÿßŸÑ */
        .mobile-search-toggle {
            display: none;
            position: fixed;
            top: 80px;
            right: 10px;
            background: linear-gradient(135deg, var(--button-primary) 0%, #66BB6A 100%);
            color: white;
            border: none;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            z-index: 1000;
            box-shadow: 0 2px 8px rgba(0,0,0,0.2);
            align-items: center;
            justify-content: center;
        }
        
        /* ŸÇÿßÿ¶ŸÖÿ© ÿßŸÑÿ™ÿµÿØŸäÿ± */
        .export-options {
            position: relative;
            display: inline-block;
        }
        
        .export-menu {
            position: absolute;
            top: 100%;
            left: 0;
            background: white;
            border-radius: 8px;
            box-shadow: 0 5px 20px rgba(0,0,0,0.2);
            min-width: 180px;
            z-index: 2000;
            margin-top: 8px;
            border: 1px solid #e8f5e9;
            opacity: 0;
            visibility: hidden;
            transition: all 0.3s ease;
            padding: 8px 0;
            max-height: 300px;
            overflow-y: auto;
        }
        
        .export-menu.show {
            opacity: 1;
            visibility: visible;
            top: 100%;
        }
        
        .export-option {
            padding: 10px 15px;
            display: flex;
            align-items: center;
            gap: 10px;
            cursor: pointer;
            transition: background 0.3s;
            border-bottom: 1px solid #f1f8e9;
            color: #1b5e20;
            text-decoration: none;
            font-size: 13px;
            min-height: 40px;
        }
        
        .export-option:hover {
            background: #f1f8e9;
            color: var(--button-primary);
        }
        
        .export-option:last-child {
            border-bottom: none;
        }
        
        .export-option i {
            width: 18px;
            text-align: center;
            color: #7cb342;
            font-size: 15px;
        }
        
        /* ÿ£ŸÜŸÖÿßÿ∑ ŸÇÿ≥ŸÖ ÿßŸÑŸÖŸÜÿßÿ≥ÿ®ÿßÿ™ ŸàÿßŸÑÿ•ÿπŸÑÿßŸÜÿßÿ™ */
        .events-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(320px, 1fr));
            gap: 20px;
            margin-top: 20px;
        }

        .event-card {
            background: white;
            border-radius: 12px;
            overflow: hidden;
            box-shadow: 0 4px 15px rgba(0,0,0,0.1);
            transition: all 0.3s ease;
            border: 1px solid #e8f5e9;
            position: relative;
        }

        .event-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 8px 25px rgba(0,0,0,0.15);
        }

        .event-header {
            padding: 15px;
            color: white;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .event-type-ŸÖŸÜÿßÿ≥ÿ®ÿ© { background: linear-gradient(135deg, #4CAF50 0%, #2E7D32 100%); }
        .event-type-ÿßÿ¨ÿ™ŸÖÿßÿπ { background: linear-gradient(135deg, #2196F3 0%, #0D47A1 100%); }
        .event-type-ŸÅÿπÿßŸÑŸäÿ© { background: linear-gradient(135deg, #FF9800 0%, #EF6C00 100%); }
        .event-type-ÿ®ÿ±ŸÜÿßŸÖÿ¨ { background: linear-gradient(135deg, #9C27B0 0%, #6A1B9A 100%); }
        .event-type-ÿ™ÿ∞ŸÉŸäÿ± { background: linear-gradient(135deg, #009688 0%, #00695C 100%); }
        .event-type-ÿ£ÿÆÿ±Ÿâ { background: linear-gradient(135deg, #607D8B 0%, #37474F 100%); }

        .event-date {
            background: rgba(255,255,255,0.2);
            padding: 5px 12px;
            border-radius: 20px;
            font-size: 12px;
            font-weight: bold;
        }

        .event-body {
            padding: 15px;
        }

        .event-title {
            font-size: 18px;
            color: #1B5E20;
            margin-bottom: 10px;
            font-weight: bold;
        }

        .event-description {
            color: #555;
            font-size: 14px;
            line-height: 1.6;
            margin-bottom: 15px;
            max-height: 100px;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .event-details {
            display: flex;
            flex-direction: column;
            gap: 8px;
            margin-bottom: 15px;
        }

        .event-detail {
            display: flex;
            align-items: center;
            gap: 8px;
            font-size: 13px;
            color: #666;
        }

        .event-detail i {
            color: #4CAF50;
            width: 16px;
        }

        .event-status {
            position: absolute;
            top: 10px;
            left: 10px;
            padding: 4px 10px;
            border-radius: 20px;
            font-size: 11px;
            font-weight: bold;
        }

        .status-ŸÜÿ¥ÿ∑ { background: #E8F5E9; color: #2E7D32; }
        .status-ŸÖŸÜÿ™ŸáŸä { background: #F5F5F5; color: #757575; }
        .status-ŸÖŸÑÿ∫Ÿâ { background: #FFEBEE; color: #C62828; }
        .status-ŸÖÿ§ÿ¨ŸÑ { background: #FFF3E0; color: #EF6C00; }

        .event-footer {
            padding: 12px 15px;
            background: #f8faf8;
            border-top: 1px solid #e8f5e9;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .event-organizer {
            font-size: 12px;
            color: #689f38;
        }

        .event-actions {
            display: flex;
            gap: 8px;
        }

        .event-action-btn {
            width: 32px;
            height: 32px;
            border-radius: 8px;
            border: none;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.3s;
            font-size: 14px;
        }

        .event-action-btn.edit { 
            background: #FF9800; 
            color: white; 
        }
        .event-action-btn.delete { 
            background: #F44336; 
            color: white; 
        }
        .event-action-btn.view { 
            background: #2196F3; 
            color: white; 
        }

        .event-action-btn:hover {
            transform: scale(1.1);
        }

        .upcoming-badge {
            position: absolute;
            top: 10px;
            right: 10px;
            background: #FFC107;
            color: #212121;
            padding: 4px 8px;
            border-radius: 20px;
            font-size: 10px;
            font-weight: bold;
            animation: pulse 2s infinite;
        }

        /* ÿ™ÿ≠ÿØŸäÿ´ ÿßŸÑÿ£ŸÜŸÖÿßÿ∑ ŸÑŸÑÿ¥ÿßÿ¥ÿßÿ™ ÿßŸÑÿµÿ∫Ÿäÿ±ÿ© */
        @media (max-width: 992px) {
            .sidebar {
                transform: translateX(100%);
                width: 280px;
                right: -280px;
            }
            
            .sidebar.active {
                transform: translateX(0);
                right: 0;
            }
            
            .main-content-area {
                margin-right: 0;
                width: 100%;
                padding: 15px;
            }
            
            .logo h1 {
                font-size: 1.1rem;
            }
            
            .user-info {
                gap: 8px;
            }
            
            .logout-btn span {
                display: none;
            }
            
            .logout-btn {
                padding: 8px;
            }
        }
        
        @media (max-width: 768px) {
            .panel-header {
                flex-direction: column;
                align-items: flex-start;
            }
            
            .action-buttons {
                width: 100%;
                justify-content: center;
            }
            
            .stats-cards {
                grid-template-columns: repeat(2, 1fr);
            }
            
            .tree-node {
                width: 140px;
                padding: 10px;
            }
            
            .tree-filter {
                margin: 0 10px 10px;
                padding: 10px;
                flex-direction: column;
                position: fixed;
                top: 70px;
                left: 0;
                right: 0;
                z-index: 999;
                border-radius: 0;
                box-shadow: 0 2px 8px rgba(0,0,0,0.1);
                transform: translateY(-100%);
                transition: transform 0.3s ease;
            }
            
            .tree-filter.active {
                transform: translateY(0);
            }
            
            .mobile-search-toggle {
                display: flex;
            }
            
            .sync-status {
                font-size: 11px;
                padding: 5px 8px;
                margin-left: 5px;
            }
            
            .data-table {
                font-size: 12px;
            }
            
            .data-table th, .data-table td {
                padding: 8px 6px;
            }
            
            .tree-view-btn {
                width: 50px;
                height: 50px;
                bottom: 15px;
                left: 15px;
                font-size: 20px;
            }
        }
        
        @media (max-width: 480px) {
            .stats-cards {
                grid-template-columns: 1fr;
            }
            
            .tree-node {
                width: 130px;
                font-size: 12px;
            }
            
            .tree-node-container {
                min-width: 130px;
            }
            
            .tree-level {
                justify-content: center;
            }
            
            .btn {
                padding: 7px 12px;
                font-size: 12px;
            }
            
            .form-grid {
                grid-template-columns: 1fr;
            }
            
            .top-bar {
                padding: 12px 15px;
            }
            
            .logo h1 {
                font-size: 1rem;
            }
            
            .tree-controls {
                justify-content: center;
            }
            
            .tree-header h2 {
                font-size: 1.1rem;
            }
            
            .mobile-optimized .tree-node {
                width: 120px;
                padding: 8px;
            }
        }
        
        /* ÿ¥ÿßÿ¥ÿ© ÿ™ÿ≠ŸÖŸäŸÑ ŸÑÿ™ÿµÿØŸäÿ± ÿßŸÑÿµŸàÿ± */
        .export-loading {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.7);
            display: none;
            justify-content: center;
            align-items: center;
            z-index: 3000;
            color: white;
            font-size: 1rem;
            text-align: center;
            flex-direction: column;
            gap: 15px;
        }
        
        .export-loading.active {
            display: flex;
        }
        
        .export-loading i {
            font-size: 2.5rem;
            animation: spin 1s linear infinite;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        /* ÿ£ŸÜŸÖÿßÿ∑ ÿµŸÅÿ≠ÿ© ÿßŸÑŸÅÿ±ÿØ ÿßŸÑÿ™ŸÅÿµŸäŸÑŸäÿ© */
        .person-detail-container {
            padding: 15px;
        }
        
        .person-header {
            text-align: center;
            margin-bottom: 20px;
            padding-bottom: 15px;
            border-bottom: 2px solid #f1f8e9;
        }
        
        .person-avatar {
            width: 100px;
            height: 100px;
            border-radius: 50%;
            background: linear-gradient(135deg, var(--button-primary) 0%, var(--button-success) 100%);
            display: flex;
            align-items: center;
            justify-content: center;
            margin: 0 auto 15px;
            color: white;
            font-size: 36px;
        }
        
        .person-name {
            font-size: 24px;
            color: var(--header-bg);
            margin-bottom: 8px;
        }
        
        .person-id {
            background: #f1f8e9;
            padding: 4px 12px;
            border-radius: 20px;
            color: #689f38;
            display: inline-block;
            font-size: 14px;
        }
        
        .detail-sections {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
            gap: 15px;
        }
        
        .detail-section {
            background: #f8faf8;
            padding: 15px;
            border-radius: 8px;
            border-right: 4px solid var(--button-primary);
            box-shadow: 0 2px 8px rgba(0,0,0,0.05);
        }
        
        .section-title {
            font-size: 16px;
            color: var(--header-bg);
            margin-bottom: 12px;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        .detail-item {
            margin-bottom: 10px;
            display: flex;
            font-size: 14px;
        }
        
        .detail-label {
            font-weight: bold;
            color: #388e3c;
            min-width: 120px;
        }
        
        .detail-value {
            color: var(--header-bg);
            flex: 1;
        }
        
        /* ŸÜÿßŸÅÿ∞ÿ© ÿ•ÿØÿßÿ±ÿ© ÿßŸÑÿ≥ÿ≠ÿßÿ®ÿ© */
        .status-card {
            background: #f8faf8;
            padding: 15px;
            border-radius: 8px;
            border: 1px solid #e8f5e9;
        }
        
        .status-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 8px;
            padding-bottom: 8px;
            border-bottom: 1px solid #f1f8e9;
            font-size: 14px;
        }
        
        .status-item:last-child {
            margin-bottom: 0;
            padding-bottom: 0;
            border-bottom: none;
        }
        
        .status-badge {
            padding: 4px 10px;
            border-radius: 12px;
            font-size: 11px;
            font-weight: bold;
        }
        
        .status-badge.success {
            background: #e8f5e9;
            color: #4CAF50;
        }
        
        .status-badge.warning {
            background: #fff3e0;
            color: #FF9800;
        }
        
        .status-badge.error {
            background: #ffebee;
            color: #F44336;
        }
        
        .backup-list {
            max-height: 250px;
            overflow-y: auto;
            border: 1px solid #e8f5e9;
            border-radius: 6px;
            margin-top: 8px;
        }
        
        .backup-item {
            padding: 12px;
            border-bottom: 1px solid #f1f8e9;
            transition: all 0.3s;
        }
        
        .backup-item:hover {
            background: #f8faf8;
        }
        
        .backup-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 8px;
            flex-wrap: wrap;
            gap: 5px;
        }
        
        .backup-user {
            font-size: 11px;
            color: #7cb342;
        }
        
        .backup-stats {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
            margin-bottom: 8px;
            font-size: 11px;
        }
        
        .backup-stats span {
            color: #689f38;
            display: flex;
            align-items: center;
            gap: 4px;
        }
        
        .backup-actions {
            display: flex;
            gap: 8px;
            justify-content: flex-end;
        }
        
        .btn-sm {
            padding: 5px 10px;
            font-size: 11px;
        }
        
        /* ÿ≤ÿ± ÿßŸÑÿπŸàÿØÿ© ÿßŸÑÿ≥ÿ±Ÿäÿπ */
        .quick-back-btn {
            position: fixed;
            top: 15px;
            left: 15px;
            background: rgba(255,255,255,0.9);
            border: 1px solid #e8f5e9;
            color: var(--header-bg);
            width: 45px;
            height: 45px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            z-index: 1001;
            transition: all 0.3s;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }
        
        .quick-back-btn:hover {
            background: white;
            transform: scale(1.1);
            box-shadow: 0 4px 12px rgba(0,0,0,0.2);
        }
        
        /* ÿ≤ÿ± ÿßŸÑŸÇÿßÿ¶ŸÖÿ© ŸÑŸÑÿ¨ŸàÿßŸÑ */
        .mobile-menu-toggle {
            display: none;
            position: fixed;
            top: 15px;
            right: 15px;
            background: var(--button-primary);
            color: white;
            width: 45px;
            height: 45px;
            border-radius: 50%;
            align-items: center;
            justify-content: center;
            z-index: 1002;
            box-shadow: 0 2px 8px rgba(0,0,0,0.2);
            border: none;
            font-size: 20px;
        }
        
        @media (max-width: 992px) {
            .mobile-menu-toggle {
                display: flex;
            }
        }
        
        /* ÿ™ÿ≠ÿ≥ŸäŸÜÿßÿ™ ŸÑÿπÿ±ÿ∂ ÿßŸÑŸÖŸàÿ®ÿßŸäŸÑ */
        .mobile-optimized .tree-node {
            width: 120px;
            padding: 8px;
            margin: 3px;
        }
        
        .mobile-optimized .tree-node-container {
            min-width: 120px;
        }
        
        .mobile-optimized .tree-level {
            gap: 8px;
            padding: 8px;
        }
        
        .mobile-optimized .node-name {
            font-size: 13px;
            height: 2.4em;
        }
        
        .mobile-optimized .node-details {
            font-size: 10px;
        }
        
        .mobile-optimized .generation-label {
            padding: 6px 15px;
            font-size: 13px;
        }
        
        /* ÿ™ŸÜÿ≥ŸäŸÇÿßÿ™ ŸÖÿ≠ÿ≥ŸÜÿ© ŸÑÿ¨ÿØŸàŸÑ ÿßŸÑŸÖŸàÿ®ÿßŸäŸÑ */
        @media (max-width: 768px) {
            .table-responsive {
                overflow-x: auto;
                -webkit-overflow-scrolling: touch;
            }
            
            .data-table {
                min-width: 600px;
            }
        }
        
        /* ÿ™ÿ≠ÿ≥ŸäŸÜ ÿ£ÿØÿßÿ° ÿßŸÑÿ™ŸÖÿ±Ÿäÿ± ÿπŸÑŸâ ÿßŸÑŸÖŸàÿ®ÿßŸäŸÑ */
        .tree-content, .form-body, .backup-list {
            -webkit-overflow-scrolling: touch;
        }
    
        /* =========================
           ÿ™ÿ≠ÿ≥ŸäŸÜÿßÿ™ ÿßŸÑŸáŸàŸäÿ© + ÿßŸÑÿÆÿ∑Ÿàÿ∑ + ÿßŸÑÿÆŸÑŸÅŸäÿ©
           ========================= */
        :root{
            --brand-family-name: "ŸÖÿ≠ŸÖÿØ ÿπÿ®ÿØÿßŸÑÿ±ÿ≠ŸÖŸÜ";
            --brand-mark: "üå≥";
            --paper-bg: rgba(255,255,255,0.92);
            --paper-border: rgba(27,94,32,0.12);
            --shadow-soft: 0 10px 30px rgba(0,0,0,0.10);
        }

        *{
            font-family: "Cairo", "Segoe UI", Tahoma, sans-serif;
        }

        /* ÿπŸÜÿßŸàŸäŸÜ ÿπÿ±ÿ®Ÿäÿ© ŸÉŸÑÿßÿ≥ŸäŸÉŸäÿ© */
        .book-title, .book-generation-title, .person-name, .logo h1, .panel-header h2, .tree-header h2{
            font-family: "Amiri", "Cairo", serif;
        }

        /* ÿÆŸÑŸÅŸäÿ© ÿ¥ŸÅÿßŸÅÿ© ÿÆŸÅŸäŸÅÿ© ÿ¨ÿØÿßŸã (SVG ŸÖÿ∂ŸÖŸëŸÜ) */
        body::before{
            content:"";
            position:fixed;
            inset:0;
            background:
              linear-gradient(rgba(248,250,248,0.80), rgba(248,250,248,0.80)),
              url("data:image/svg+xml;utf8,<svg xmlns='http://www.w3.org/2000/svg' width='320' height='320'><text x='18' y='160' font-size='92' opacity='0.06'>%F0%9F%8C%B3</text><text x='140' y='245' font-size='24' opacity='0.06'>%D8%B9%D8%A7%D8%A6%D9%84%D8%A9</text></svg>");
            z-index:-1;
            pointer-events:none;
        }

        /* =========================
           Book Preview (ŸÉÿ™ÿßÿ® ÿßŸÑÿπÿßÿ¶ŸÑÿ©)
           ========================= */
        .book-preview{
            background: transparent !important;
            padding: 12px !important;
        }

        .book-shell{
            display:flex;
            flex-direction:column;
            gap: 14px;
        }

        .book-page{
            background: var(--paper-bg);
            border: 1px solid var(--paper-border);
            border-radius: 18px;
            box-shadow: var(--shadow-soft);
            padding: 34px 36px;
            position: relative;
            overflow: hidden;
        }

        .book-page::after{
            content: var(--brand-mark);
            position:absolute;
            bottom: 14px;
            left: 18px;
            font-size: 22px;
            opacity: 0.25;
        }

        .book-watermark{
            position:absolute;
            top: 16px;
            left: 18px;
            font-size: 12px;
            color: rgba(27,94,32,0.55);
            display:flex;
            gap: 8px;
            align-items:center;
            user-select:none;
        }

        .book-cover{
            text-align:center;
            padding: 60px 20px;
        }

        .book-cover .book-title{
            font-size: 38px;
            color: var(--header-bg);
            margin-bottom: 10px;
        }

        .book-cover .book-subtitle{
            color: #2E7D32;
            font-size: 16px;
            margin-bottom: 26px;
        }

        .book-cover .book-badge{
            display:inline-flex;
            align-items:center;
            gap:10px;
            padding: 10px 16px;
            border-radius: 999px;
            background: rgba(76,175,80,0.12);
            border: 1px solid rgba(76,175,80,0.25);
            color: #1B5E20;
            font-weight: 700;
        }

        .book-generation-title{
            font-size: 24px;
            color: var(--header-bg);
            border-bottom: 3px solid rgba(76,175,80,0.35);
            padding-bottom: 10px;
            margin-bottom: 16px;
            display:flex;
            align-items:center;
            gap:10px;
        }

        .book-grid{
            display:grid;
            grid-template-columns: repeat(auto-fill, minmax(240px, 1fr));
            gap: 14px;
        }

        .book-card{
            background: rgba(255,255,255,0.85);
            border: 1px solid rgba(27,94,32,0.10);
            border-radius: 14px;
            padding: 14px 14px 12px;
            box-shadow: 0 6px 18px rgba(0,0,0,0.06);
            position:relative;
        }

        .book-card .name{
            font-family: "Amiri", serif;
            font-size: 18px;
            color: #1B5E20;
            margin-bottom: 8px;
            line-height: 1.35;
        }

        .book-card .meta{
            font-size: 13px;
            color: #2E7D32;
            display:flex;
            flex-direction:column;
            gap: 6px;
        }

        .book-card .meta span{
            display:flex;
            gap: 8px;
            align-items:center;
        }

        .book-card .tag{
            position:absolute;
            top: 12px;
            left: 12px;
            font-size: 11px;
            padding: 4px 10px;
            border-radius: 999px;
            background: rgba(0,151,167,0.10);
            border: 1px solid rgba(0,151,167,0.18);
            color: #006064;
            font-weight: 700;
        }

        /* ÿ∑ÿ®ÿßÿπÿ© ÿßŸÑŸÉÿ™ÿßÿ® */
        @media print{
            body::before{ display:none; }
            .book-page{
                box-shadow:none !important;
                border: 1px solid #ddd !important;
                border-radius: 0 !important;
                page-break-after: always;
                break-after: page;
            }
            .book-controls, .close-form, .quick-back-btn { display:none !important; }
        }

        /* =========================
           ÿ∞ŸÉÿßÿ° ÿßŸÇÿ™ÿ±ÿßÿ≠ ÿßŸÑÿπŸÑÿßŸÇÿßÿ™
           ========================= */
        .smart-suggest{
            margin-top: 10px;
            padding: 10px 12px;
            border-radius: 12px;
            background: rgba(0,151,167,0.06);
            border: 1px solid rgba(0,151,167,0.12);
            display:flex;
            gap: 10px;
            flex-wrap: wrap;
            align-items:center;
        }
        .smart-suggest .hint{
            font-size: 12px;
            color: #006064;
            display:flex;
            align-items:center;
            gap: 8px;
        }
        .smart-suggest .hint b{ color:#004d40; }
        .smart-suggest .suggest-actions{
            display:flex;
            gap: 8px;
            flex-wrap: wrap;
            margin-right:auto;
        }
        .chip{
            border: 1px solid rgba(27,94,32,0.18);
            background: rgba(76,175,80,0.10);
            color:#1B5E20;
            border-radius: 999px;
            padding: 6px 10px;
            font-size: 12px;
            cursor:pointer;
            transition: all .2s;
            user-select:none;
        }
        .chip:hover{ transform: translateY(-1px); box-shadow: 0 6px 14px rgba(0,0,0,0.08); }

    
        /* =========================
           Book Quick Search (ÿ®ÿ≠ÿ´ ÿØÿßÿÆŸÑ ÿßŸÑŸÉÿ™ÿßÿ®)
           ========================= */
        .book-member-card.book-hidden{
            display: none !important;
        }
        .book-member-card.book-match{
            outline: 3px solid rgba(255,193,7,0.65);
            outline-offset: 2px;
        }
        mark.book-mark{
            background: rgba(255,193,7,0.45);
            padding: 0 3px;
            border-radius: 6px;
        }

        /* =========================
           ÿ£ŸÜŸÖÿßÿ∑ ÿ•ÿ∂ÿßŸÅŸäÿ© ŸÑŸÉÿ™ÿßÿ® ÿßŸÑÿπÿßÿ¶ŸÑÿ© ÿßŸÑŸÖÿ≠ÿ≥ŸÜ
           ========================= */
        .book-card-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 12px;
            padding-bottom: 8px;
            border-bottom: 1px solid rgba(27, 94, 32, 0.1);
        }
        
        .book-card-id {
            background: #f1f8e9;
            color: #689f38;
            font-size: 12px;
            padding: 4px 8px;
            border-radius: 6px;
            font-weight: bold;
        }
        
        .book-card-gender {
            font-size: 12px;
            padding: 4px 10px;
            border-radius: 20px;
            font-weight: bold;
        }
        
        .book-card-gender.male {
            background: #e3f2fd;
            color: #2196F3;
        }
        
        .book-card-gender.female {
            background: #fce4ec;
            color: #E91E63;
        }
        
        .book-card-name {
            color: #1B5E20;
            font-size: 18px;
            margin-bottom: 12px;
            line-height: 1.4;
            font-family: 'Amiri', serif;
        }
        
        .book-card-details {
            font-size: 13px;
            color: #555;
            line-height: 1.5;
        }
        
        .book-card-detail {
            display: flex;
            align-items: flex-start;
            gap: 8px;
            margin-bottom: 6px;
        }
        
        .book-card-detail i {
            color: #4CAF50;
            min-width: 18px;
            margin-top: 2px;
        }
        
        .book-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(320px, 1fr));
            gap: 20px;
            margin-top: 20px;
        }
        
        .book-grid.compact {
            grid-template-columns: repeat(auto-fill, minmax(280px, 1fr));
            gap: 16px;
        }
        
        /* ÿ£ŸÜŸÖÿßÿ∑ ÿßŸÑÿ∑ÿ®ÿßÿπÿ© ŸÑŸÇÿ≥ŸÖ ÿßŸÑÿ•ÿπŸÑÿßŸÜÿßÿ™ */
        @media print {
            .book-grid {
                grid-template-columns: repeat(2, 1fr) !important;
                gap: 15px !important;
            }
            
            .book-card {
                break-inside: avoid;
                page-break-inside: avoid;
                box-shadow: none !important;
                border: 1px solid #ddd !important;
            }
            
            .event-card {
                break-inside: avoid;
                page-break-inside: avoid;
                box-shadow: none !important;
                border: 1px solid #ddd !important;
            }
            
            .event-actions {
                display: none !important;
            }
        }
</style>
</head>
<body>
    <button class="mobile-menu-toggle" id="mobileMenuToggle">
        <i class="fas fa-bars"></i>
    </button>

    <div id="login-screen">
        <button class="login-language-toggle" onclick="toggleLanguage()">
            <i class="fas fa-globe"></i>
            <span id="loginLanguageText">English</span>
        </button>
                        <button class="btn btn-secondary" style="padding: 8px 12px;" onclick="clearBookLineage()" title="ÿ•ŸÑÿ∫ÿßÿ° ÿ™ŸÖŸäŸäÿ≤ ÿßŸÑÿ≥ŸÑÿßŸÑÿ©">
                            <i class="fas fa-highlighter"></i>
                        </button>
        
        <div class="login-container">
            <div class="login-logo">
                <i class="fas fa-tree"></i>
            </div>
            
            <h2 class="login-title" data-i18n="loginTitle">ŸÜÿ∏ÿßŸÖ ÿ•ÿØÿßÿ±ÿ© ÿ¥ÿ¨ÿ±ÿ© ÿßŸÑÿπÿßÿ¶ŸÑÿ©</h2>
            <p data-i18n="loginSubtitle">ÿßŸÑÿ±ÿ¨ÿßÿ° ÿ™ÿ≥ÿ¨ŸäŸÑ ÿßŸÑÿØÿÆŸàŸÑ ŸÑÿ•ÿØÿßÿ±ÿ© ÿ®ŸäÿßŸÜÿßÿ™ ÿßŸÑÿπÿßÿ¶ŸÑÿ©</p>
            
            <form class="login-form" onsubmit="event.preventDefault(); handleLogin();">
                <div class="form-group">
                    <i class="fas fa-user"></i>
                    <input type="text" id="username" class="login-input" data-i18n-placeholder="usernamePlaceholder" placeholder="ÿßÿ≥ŸÖ ÿßŸÑŸÖÿ≥ÿ™ÿÆÿØŸÖ" required>
                </div>
                
                <div class="form-group">
                    <i class="fas fa-lock"></i>
                    <input type="password" id="password" class="login-input" data-i18n-placeholder="passwordPlaceholder" placeholder="ŸÉŸÑŸÖÿ© ÿßŸÑŸÖÿ±Ÿàÿ±" required>
                </div>
                
                <div class="login-error" id="loginError">
                    <i class="fas fa-exclamation-circle"></i>
                    <span id="errorMessage" data-i18n="loginError">ÿßÿ≥ŸÖ ÿßŸÑŸÖÿ≥ÿ™ÿÆÿØŸÖ ÿ£Ÿà ŸÉŸÑŸÖÿ© ÿßŸÑŸÖÿ±Ÿàÿ± ÿ∫Ÿäÿ± ÿµÿ≠Ÿäÿ≠ÿ©</span>
                </div>
                
                <button type="submit" class="login-btn">
                    <i class="fas fa-sign-in-alt"></i> <span data-i18n="loginButton">ÿØÿÆŸàŸÑ</span>
                </button>
            </form>
            
            <div style="margin-top: 20px; color: #689f38; font-size: 14px;">
                <p><i class="fas fa-info-circle"></i> <span data-i18n="familyTitle">ÿ¥ÿ¨ÿ±ÿ© ÿπÿßÿ¶ŸÑÿ© ŸÖÿ≠ŸÖÿØ ÿπÿ®ÿØÿßŸÑÿ±ÿ≠ŸÖŸÜ ( ÿ£ÿ®ÿß )</span></p>
                <p data-i18n="developerInfo">ÿ™ÿµŸÖŸäŸÖ Ÿàÿ™ŸÜŸÅŸäÿ∞: | ŸÖÿ≠ŸÖÿØ ÿπŸÖÿ± ŸÖÿ≠ŸÖÿØ</p>
            </div>
        </div>
    </div>

    <div id="main-content">
        <div class="top-bar">
            <div class="logo">
                <i class="fas fa-tree" style="font-size: 24px;"></i>
                <h1 data-i18n="appTitle">ÿ¥ÿ¨ÿ±ÿ© ÿπÿßÿ¶ŸÑÿ© ŸÖÿ≠ŸÖÿØ ÿπÿ®ÿØÿßŸÑÿ±ÿ≠ŸÖŸÜ</h1>
            </div>
            
            <div class="user-info">
                <button class="language-toggle" onclick="toggleLanguage()">
                    <i class="fas fa-globe"></i>
                    <span id="languageText">EN</span>
                </button>
                <span data-i18n="welcome">ŸÖÿ±ÿ≠ÿ®ÿßŸãÿå</span> <span id="loggedInUser">ŸÖÿØŸäÿ± ÿßŸÑŸÜÿ∏ÿßŸÖ</span>
                <button class="logout-btn" onclick="logout()">
                    <i class="fas fa-sign-out-alt"></i> <span data-i18n="logout">ÿ™ÿ≥ÿ¨ŸäŸÑ ÿßŸÑÿÆÿ±Ÿàÿ¨</span>
                </button>
            </div>
        </div>

        <div class="sidebar" id="sidebar">
            <ul class="sidebar-menu">
                <li class="menu-item active" onclick="showDashboard()">
                    <i class="fas fa-home"></i>
                    <span data-i18n="dashboard">ÿßŸÑÿ±ÿ¶Ÿäÿ≥Ÿäÿ©</span>
                </li>
                <li class="menu-item" onclick="showAllPersons()">
                    <i class="fas fa-users"></i>
                    <span data-i18n="allPersons">ÿ¨ŸÖŸäÿπ ÿßŸÑÿ£ŸÅÿ±ÿßÿØ</span>
                </li>
                <li class="menu-item" onclick="showAddPersonForm()">
                    <i class="fas fa-user-plus"></i>
                    <span data-i18n="addPerson">ÿ•ÿ∂ÿßŸÅÿ© ŸÅÿ±ÿØ ÿ¨ÿØŸäÿØ</span>
                </li>
                <li class="menu-item" onclick="showSearch()">
                    <i class="fas fa-search"></i>
                    <span data-i18n="searchEdit">ÿ®ÿ≠ÿ´ Ÿàÿ™ÿπÿØŸäŸÑ</span>
                </li>
                <li class="menu-item" onclick="showStatistics()">
                    <i class="fas fa-chart-bar"></i>
                    <span data-i18n="statistics">ÿßŸÑÿ•ÿ≠ÿµÿßÿ¶Ÿäÿßÿ™</span>
                </li>
                <li class="menu-item" onclick="showTreeView()">
                    <i class="fas fa-project-diagram"></i>
                    <span data-i18n="treeView">ÿπÿ±ÿ∂ ÿßŸÑÿ¥ÿ¨ÿ±ÿ©</span>
                </li>
                <li class="menu-item" onclick="showBackup()">
                    <i class="fas fa-database"></i>
                    <span data-i18n="backup">ÿßŸÑŸÜÿ≥ÿÆ ÿßŸÑÿßÿ≠ÿ™Ÿäÿßÿ∑Ÿä</span>
                </li>
                <li class="menu-item" onclick="showFamilyBook()">
                    <i class="fas fa-book"></i>
                    <span data-i18n="familyBook">ŸÉÿ™ÿßÿ® ÿßŸÑÿπÿßÿ¶ŸÑÿ©</span>
                </li>
                <li class="menu-item" onclick="showFamilyEvents()">
                    <i class="fas fa-calendar-alt"></i>
                    <span>ÿßŸÑŸÖŸÜÿßÿ≥ÿ®ÿßÿ™ ŸàÿßŸÑÿ•ÿπŸÑÿßŸÜÿßÿ™</span>
                </li>
                <li class="menu-item" onclick="showExcelImport()">
                    <i class="fas fa-file-excel"></i>
                    <span data-i18n="excelImport">ÿßÿ≥ÿ™Ÿäÿ±ÿßÿØ Excel</span>
                </li>
                <li class="menu-item" onclick="showPermissions()">
                    <i class="fas fa-user-shield"></i>
                    <span data-i18n="permissions">ÿ•ÿØÿßÿ±ÿ© ÿßŸÑÿµŸÑÿßÿ≠Ÿäÿßÿ™</span>
                </li>
                <li class="menu-item" onclick="showEncryptionSettings()">
                    <i class="fas fa-lock"></i>
                    <span data-i18n="encryption">ÿ•ÿπÿØÿßÿØÿßÿ™ ÿßŸÑÿ™ÿ¥ŸÅŸäÿ±</span>
                </li>
                <li class="menu-item" onclick="showCloudManager()">
                    <i class="fas fa-cloud"></i>
                    <span>ÿ•ÿØÿßÿ±ÿ© ÿßŸÑÿ≥ÿ≠ÿßÿ®ÿ©</span>
                </li>
            </ul>
        </div>

        <div class="main-content-area" id="contentArea">
            <div class="stats-cards" id="statsCards">
                <div class="stat-card">
                    <div class="stat-icon total">
                        <i class="fas fa-users"></i>
                    </div>
                    <div class="stat-info">
                        <h3 id="totalPersons">0</h3>
                        <p data-i18n="totalPersons">ÿ•ÿ¨ŸÖÿßŸÑŸä ÿßŸÑÿ£ŸÅÿ±ÿßÿØ</p>
                    </div>
                </div>
                
                <div class="stat-card">
                    <div class="stat-icon male">
                        <i class="fas fa-male"></i>
                    </div>
                    <div class="stat-info">
                        <h3 id="maleCount">0</h3>
                        <p data-i18n="maleCount">ÿπÿØÿØ ÿßŸÑÿ∞ŸÉŸàÿ±</p>
                    </div>
                </div>
                
                <div class="stat-card">
                    <div class="stat-icon female">
                        <i class="fas fa-female"></i>
                    </div>
                    <div class="stat-info">
                        <h3 id="femaleCount">0</h3>
                        <p data-i18n="femaleCount">ÿπÿØÿØ ÿßŸÑÿ•ŸÜÿßÿ´</p>
                    </div>
                </div>
                
                <div class="stat-card">
                    <div class="stat-icon families">
                        <i class="fas fa-home"></i>
                    </div>
                    <div class="stat-info">
                        <h3 id="familiesCount">0</h3>
                        <p data-i18n="familiesCount">ÿπÿØÿØ ÿßŸÑÿπÿßÿ¶ŸÑÿßÿ™</p>
                    </div>
                </div>
            </div>

            <div class="control-panel">
                <div class="panel-header">
                    <h2><i class="fas fa-users"></i> <span data-i18n="familyManagement">ÿ•ÿØÿßÿ±ÿ© ÿ£ŸÅÿ±ÿßÿØ ÿßŸÑÿπÿßÿ¶ŸÑÿ©</span></h2>
                    <div class="action-buttons">
                        <button class="btn btn-primary" onclick="showAddPersonForm()">
                            <i class="fas fa-user-plus"></i> <span data-i18n="addNewPerson">ÿ•ÿ∂ÿßŸÅÿ© ŸÅÿ±ÿØ ÿ¨ÿØŸäÿØ</span>
                        </button>
                        <button class="btn btn-success" onclick="refreshData()">
                            <i class="fas fa-sync"></i> <span data-i18n="refreshData">ÿ™ÿ≠ÿØŸäÿ´ ÿßŸÑÿ®ŸäÿßŸÜÿßÿ™</span>
                        </button>
                        <div class="export-options">
                            <button class="btn btn-warning" onclick="toggleExportMenu()">
                                <i class="fas fa-download"></i> <span data-i18n="exportData">ÿ™ÿµÿØŸäÿ± ÿßŸÑÿ®ŸäÿßŸÜÿßÿ™</span>
                            </button>
                            <div class="export-menu" id="exportMenu">
                                <div class="export-option" onclick="exportData('json')">
                                    <i class="fas fa-file-code"></i>
                                    <span data-i18n="exportJson">JSON</span>
                                </div>
                                <div class="export-option" onclick="exportData('excel')">
                                    <i class="fas fa-file-excel"></i>
                                    <span data-i18n="exportExcel">Excel</span>
                                </div>
                                <div class="export-option" onclick="exportData('csv')">
                                    <i class="fas fa-file-csv"></i>
                                    <span data-i18n="exportCSV">CSV</span>
                                </div>
                                <div class="export-option" onclick="exportFullExcel()">
                                    <i class="fas fa-file-excel"></i>
                                    <span>Excel (ŸÖÿ™ŸÇÿØŸÖ)</span>
                                </div>
                            </div>
                        </div>
                        <button class="btn btn-info" onclick="toggleSortOrder()">
                            <i class="fas fa-sort-numeric-down"></i> <span data-i18n="toggleSort">ÿ™ÿ±ÿ™Ÿäÿ® ÿ™ÿµÿßÿπÿØŸä/ÿ™ŸÜÿßÿ≤ŸÑŸä</span>
                        </button>
                        <div class="file-input-container">
                            <button class="btn btn-info import-btn" onclick="document.getElementById('importFile').click()">
                                <i class="fas fa-upload"></i> <span data-i18n="importData">ÿßÿ≥ÿ™Ÿäÿ±ÿßÿØ ÿßŸÑÿ®ŸäÿßŸÜÿßÿ™</span>
                            </button>
                            <input type="file" id="importFile" class="file-input" accept=".json" onchange="handleFileImport(event)" style="display: none;">
                        </div>
                        <button class="btn btn-info" onclick="backupToCloud()" title="ŸÜÿ≥ÿÆÿ© ÿßÿ≠ÿ™Ÿäÿßÿ∑Ÿäÿ© ÿπŸÑŸâ ÿßŸÑÿ≥ÿ≠ÿßÿ®ÿ©">
                            <i class="fas fa-cloud-upload-alt"></i> <span>ŸÜÿ≥ÿÆ ÿ≥ÿ≠ÿßÿ®Ÿä</span>
                        </button>
                        <button class="btn btn-info" onclick="loadDataFromCloud()" title="ÿ™ÿ≠ŸÖŸäŸÑ ÿßŸÑÿ®ŸäÿßŸÜÿßÿ™ ŸÖŸÜ ÿßŸÑÿ≥ÿ≠ÿßÿ®ÿ©">
                            <i class="fas fa-cloud-download-alt"></i> <span>ÿ™ÿ≠ŸÖŸäŸÑ ŸÖŸÜ ÿßŸÑÿ≥ÿ≠ÿßÿ®ÿ©</span>
                        </button>
                    </div>
                </div>
                
                <div class="alert success" id="successAlert">
                    <i class="fas fa-check-circle"></i>
                    <span id="successMessage" data-i18n="successMessage">ÿ™ŸÖÿ™ ÿßŸÑÿπŸÖŸÑŸäÿ© ÿ®ŸÜÿ¨ÿßÿ≠</span>
                </div>
                
                <div class="alert error" id="errorAlert">
                    <i class="fas fa-exclamation-circle"></i>
                    <span id="errorMessage" data-i18n="errorMessage">ÿ≠ÿØÿ´ ÿÆÿ∑ÿ£ ÿ£ÿ´ŸÜÿßÿ° ÿßŸÑÿπŸÖŸÑŸäÿ©</span>
                </div>

                <div class="table-responsive" style="overflow-x: auto;">
                    <table class="data-table" id="personsTable">
                        <thead>
                            <tr>
                                <th data-i18n="tableId">ÿßŸÑÿ±ŸÇŸÖ</th>
                                <th data-i18n="tableName">ÿßŸÑÿßÿ≥ŸÖ ÿßŸÑŸÉÿßŸÖŸÑ</th>
                                <th data-i18n="tableGender">ÿßŸÑÿ¨ŸÜÿ≥</th>
                                <th data-i18n="tableBirthPlace">ŸÖŸÉÿßŸÜ ÿßŸÑŸÖŸäŸÑÿßÿØ</th>
                                <th data-i18n="tableFather">ÿßŸÑÿ£ÿ®</th>
                                <th data-i18n="tableMother">ÿßŸÑÿ£ŸÖ</th>
                                <th data-i18n="tableActions">ÿßŸÑÿ•ÿ¨ÿ±ÿßÿ°ÿßÿ™</th>
                            </tr>
                        </thead>
                        <tbody id="tableBody">
                            </tbody>
                    </table>
                </div>
            </div>
        </div>

        <button class="tree-view-btn" onclick="showTreeView()">
            <i class="fas fa-tree"></i>
        </button>
    </div>

    <div class="form-modal" id="personFormModal">
        <button class="quick-back-btn" onclick="closePersonForm()" title="ÿ•ÿ∫ŸÑÿßŸÇ">
            <i class="fas fa-times"></i>
        </button>
        <div class="form-container">
            <div class="form-header">
                <h3><i class="fas fa-user-edit"></i> <span id="formTitle" data-i18n="addPersonForm">ÿ•ÿ∂ÿßŸÅÿ© ŸÅÿ±ÿØ ÿ¨ÿØŸäÿØ</span></h3>
                <button class="close-form" onclick="closePersonForm()">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            
            <div class="form-body">
                <form id="personForm" onsubmit="event.preventDefault(); savePerson();">
                    <input type="hidden" id="personId">
                    
                    <div class="form-grid">
                        <div class="form-group">
                            <label class="form-label required" data-i18n="formFullName">ÿßŸÑÿßÿ≥ŸÖ ÿßŸÑŸÉÿßŸÖŸÑ</label>
                            <input type="text" class="form-input" id="fullName" required>
                        </div>
                        
                        <div class="form-group">
                            <label class="form-label required" data-i18n="formGender">ÿßŸÑÿ¨ŸÜÿ≥</label>
                            <select class="form-select" id="gender" required>
                                <option value="" data-i18n="formSelectGender">ÿßÿÆÿ™ÿ± ÿßŸÑÿ¨ŸÜÿ≥</option>
                                <option value="ÿ∞ŸÉÿ±" data-i18n="male">ÿ∞ŸÉÿ±</option>
                                <option value="ÿßŸÜÿ´Ÿâ" data-i18n="female">ÿ£ŸÜÿ´Ÿâ</option>
                            </select>
                        </div>
                        
                        <div class="form-group">
                            <label class="form-label" data-i18n="formBirthPlace">ŸÖŸÉÿßŸÜ ÿßŸÑŸÖŸäŸÑÿßÿØ</label>
                            <input type="text" class="form-input" id="placeOfBirth">
                        </div>
                        
                        <div class="form-group">
                            <label class="form-label" data-i18n="formBirthDate">ÿ™ÿßÿ±ŸäÿÆ ÿßŸÑŸÖŸäŸÑÿßÿØ</label>
                            <input type="date" class="form-input" id="birthDate">
                        </div>
                        
                        <div class="form-group">
                            <label class="form-label" data-i18n="formDeathDate">ÿ™ÿßÿ±ŸäÿÆ ÿßŸÑŸàŸÅÿßÿ© (ÿ•ŸÜ Ÿàÿ¨ÿØ)</label>
                            <input type="date" class="form-input" id="deathDate">
                        </div>
                        
                        <div class="form-group">
                            <label class="form-label" data-i18n="formFatherId">ÿ±ŸÇŸÖ ÿßŸÑÿ£ÿ®</label>
                            <select class="form-select" id="fatherId">
                                <option value="0" data-i18n="formNoFather">ŸÑÿß ŸäŸàÿ¨ÿØ (ÿ¨ÿ∞ÿ± ÿßŸÑÿπÿßÿ¶ŸÑÿ©)</option>
                                </select>
                        </div>
                        
                        <div class="form-group">
                            <label class="form-label" data-i18n="formMotherId">ÿ±ŸÇŸÖ ÿßŸÑÿ£ŸÖ</label>
                            <select class="form-select" id="motherId">
                                <option value="0" data-i18n="formNoMother">ŸÑÿß ŸäŸàÿ¨ÿØ</option>
                                </select>
                        </div>
                        
                        <div class="form-group">
                            <label class="form-label" data-i18n="formSpouseId">ÿ±ŸÇŸÖ ÿßŸÑÿ≤Ÿàÿ¨/ÿßŸÑÿ≤Ÿàÿ¨ÿ©</label>
                            <select class="form-select" id="spouseId">
                                <option value="0" data-i18n="formNoSpouse">ŸÑÿß ŸäŸàÿ¨ÿØ</option>
                                </select>
                        </div>
                    
                    </div>

                    <div class="smart-suggest" id="relationSuggestBox">
                        <div class="hint">
                            <i class="fas fa-magic"></i>
                            <span>ÿßŸÇÿ™ÿ±ÿßÿ≠ÿßÿ™ ÿ∞ŸÉŸäÿ©: <b id="suggestSummary">‚Äî</b></span>
                        </div>
                        <div class="suggest-actions">
                            <span class="chip" onclick="applySmartSuggestions()">ÿ™ÿ∑ÿ®ŸäŸÇ ÿßŸÑÿßŸÇÿ™ÿ±ÿßÿ≠ÿßÿ™</span>
                            <span class="chip" onclick="showWhySuggestion()">ŸÑŸÖÿßÿ∞ÿß Ÿáÿ∞ÿß ÿßŸÑÿßŸÇÿ™ÿ±ÿßÿ≠ÿü</span>
                            <span class="chip" onclick="clearSmartSuggestions()">ŸÖÿ≥ÿ≠ ÿßŸÑÿßŸÇÿ™ÿ±ÿßÿ≠</span>
                        </div>
                    </div>

                    <div class="form-group">
                        <label class="form-label" data-i18n="formNotes">ŸÖŸÑÿßÿ≠ÿ∏ÿßÿ™ ÿ•ÿ∂ÿßŸÅŸäÿ©</label>

                        <textarea class="form-textarea" id="notes" rows="3"></textarea>
                    </div>
                    
                    <div class="form-actions">
                        <button type="button" class="btn btn-danger" onclick="closePersonForm()">
                            <i class="fas fa-times"></i> <span data-i18n="cancel">ÿ•ŸÑÿ∫ÿßÿ°</span>
                        </button>
                        <button type="submit" class="btn btn-success">
                            <i class="fas fa-save"></i> <span data-i18n="save">ÿ≠ŸÅÿ∏ ÿßŸÑÿ®ŸäÿßŸÜÿßÿ™</span>
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <div class="tree-view" id="treeView">
        <div class="tree-header">
            <div>
                <h2><i class="fas fa-project-diagram"></i> <span data-i18n="fullFamilyTree">ÿ¥ÿ¨ÿ±ÿ© ÿßŸÑÿπÿßÿ¶ŸÑÿ© ÿßŸÑŸÉÿßŸÖŸÑÿ©</span></h2>
                <div class="tree-toolbar">
                    <div class="tree-controls">
                        <div class="tree-zoom">
                            <button class="tree-zoom-btn" onclick="zoomOutTree()">
                                <i class="fas fa-search-minus"></i>
                            </button>
                            <span id="zoomLevel">100%</span>
                            <button class="tree-zoom-btn" onclick="zoomInTree()">
                                <i class="fas fa-search-plus"></i>
                            </button>
                        </div>
                        <button class="btn btn-info" onclick="toggleCompactMode()">
                            <i class="fas fa-compress"></i> <span data-i18n="toggleView">ÿ™ÿ®ÿØŸäŸÑ ÿßŸÑÿπÿ±ÿ∂</span>
                        </button>
                        <div class="export-options">
                            <button class="btn btn-warning" onclick="toggleTreeExportMenu()">
                                <i class="fas fa-camera"></i> <span data-i18n="exportImage">ÿ™ÿµÿØŸäÿ± ÿµŸàÿ±ÿ©</span>
                            </button>
                            <div class="export-menu" id="treeExportMenu">
                                <div class="export-option" onclick="exportTreeImage('normal')">
                                    <i class="fas fa-image"></i>
                                    <span data-i18n="exportNormal">ÿµŸàÿ±ÿ© ÿπÿßÿØŸäÿ©</span>
                                </div>
                                <div class="export-option" onclick="exportTreeImage('high')">
                                    <i class="fas fa-file-image"></i>
                                    <span data-i18n="exportHigh">ÿµŸàÿ±ÿ© ÿπÿßŸÑŸäÿ© ÿßŸÑÿ¨ŸàÿØÿ©</span>
                                </div>
                                <div class="export-option" onclick="exportCurrentSection()">
                                    <i class="fas fa-crop"></i>
                                    <span data-i18n="exportVisible">ÿßŸÑÿ¨ÿ≤ÿ° ÿßŸÑŸÖÿ±ÿ¶Ÿä ŸÅŸÇÿ∑</span>
                                </div>
                            </div>
                        </div>
                        <button class="btn btn-info mobile-mode-btn" onclick="toggleMobileOptimization()">
                            <i class="fas fa-mobile-alt"></i> <span data-i18n="mobileMode">Ÿàÿ∂ÿπ ÿßŸÑŸÖŸàÿ®ÿßŸäŸÑ</span>
                        </button>
                    </div>
                    <div class="tree-count">
                        <i class="fas fa-users"></i>
                        <span id="treePersonCount">0</span> <span data-i18n="persons">ŸÅÿ±ÿØ</span>
                        <span class="search-match-count" id="searchMatchCount" style="display: none;">0</span>
                    </div>
                </div>
            </div>
            <button class="btn btn-danger" onclick="closeTreeView()">
                <i class="fas fa-times"></i> <span data-i18n="close">ÿ•ÿ∫ŸÑÿßŸÇ</span>
            </button>
        </div>
        
        <button class="mobile-search-toggle" id="mobileSearchToggle">
            <i class="fas fa-search"></i>
        </button>
        
        <div class="tree-filter" id="treeFilter">
            <input type="text" id="treeSearch" data-i18n-placeholder="treeSearchPlaceholder" placeholder="ÿßÿ®ÿ≠ÿ´ ÿπŸÜ ŸÅÿ±ÿØ ŸÅŸä ÿßŸÑÿ¥ÿ¨ÿ±ÿ©..." onkeyup="searchInTree()">
            <button class="btn btn-primary" onclick="clearTreeSearch()">
                <i class="fas fa-times"></i> <span data-i18n="clearSearch">ŸÖÿ≥ÿ≠ ÿßŸÑÿ®ÿ≠ÿ´</span>
            </button>
            <button class="btn btn-success" onclick="scrollToGeneration(1)">
                <i class="fas fa-arrow-up"></i> <span data-i18n="firstGeneration">ÿßŸÑÿ¨ŸäŸÑ ÿßŸÑÿ£ŸàŸÑ</span>
            </button>
            <div style="color: #689f38; font-size: 12px; display: none;" class="tree-info-mobile">
                <i class="fas fa-info-circle"></i> <span data-i18n="treeInfo">ÿßŸÜŸÇÿ± ÿπŸÑŸâ ÿ£Ÿä ŸÅÿ±ÿØ ŸÑÿπÿ±ÿ∂ ŸÖÿπŸÑŸàŸÖÿßÿ™Ÿá</span>
            </div>
        </div>
        
        <div class="tree-content" id="treeContainer">
            </div>
    </div>

    <div class="form-modal" id="personDetailModal">
        <button class="quick-back-btn" onclick="closePersonDetail()" title="ÿ•ÿ∫ŸÑÿßŸÇ">
            <i class="fas fa-times"></i>
        </button>
        <div class="form-container" style="max-width: 800px;">
            <div class="form-header">
                <h3><i class="fas fa-user-circle"></i> <span id="detailTitle" data-i18n="personInfo">ŸÖÿπŸÑŸàŸÖÿßÿ™ ÿßŸÑŸÅÿ±ÿØ</span></h3>
                <button class="close-form" onclick="closePersonDetail()">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            
            <div class="form-body">
                <div class="person-detail-container" id="personDetailContent">
                    </div>
                
                <div class="form-actions">
                    <button type="button" class="btn btn-danger" onclick="closePersonDetail()">
                        <i class="fas fa-times"></i> <span data-i18n="close">ÿ•ÿ∫ŸÑÿßŸÇ</span>
                    </button>
                    <button type="button" class="btn btn-warning" onclick="printPersonDetail()">
                        <i class="fas fa-print"></i> <span data-i18n="print">ÿ∑ÿ®ÿßÿπÿ©</span>
                    </button>
                    <button type="button" class="btn btn-primary" onclick="editCurrentPerson()">
                        <i class="fas fa-edit"></i> <span data-i18n="edit">ÿ™ÿπÿØŸäŸÑ</span>
                    </button>
                </div>
            </div>
        </div>
    </div>

    <div class="form-modal" id="familyBookModal">
        <button class="quick-back-btn" onclick="closeFamilyBook()" title="ÿ•ÿ∫ŸÑÿßŸÇ">
            <i class="fas fa-times"></i>
        </button>
        <div class="form-container" style="max-width: 900px;">
            <div class="form-header">
                <h3><i class="fas fa-book"></i> <span data-i18n="familyBook">ŸÉÿ™ÿßÿ® ÿßŸÑÿπÿßÿ¶ŸÑÿ©</span></h3>
                <button class="close-form" onclick="closeFamilyBook()">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            
            <div class="form-body">
                
                <div class="book-controls" style="margin-bottom: 16px; display:flex; gap:10px; flex-wrap:wrap; align-items:center;">
                    <button class="btn btn-primary" onclick="generateFamilyBook()">
                        <i class="fas fa-sync"></i> <span data-i18n="generateBook">ÿ™ŸàŸÑŸäÿØ ŸÉÿ™ÿßÿ® ÿ¨ÿØŸäÿØ</span>
                    </button>
                    <button class="btn btn-success" onclick="exportFamilyBook()">
                        <i class="fas fa-file-pdf"></i> <span data-i18n="exportPDF">ÿ™ÿµÿØŸäÿ± ŸÉŸÄ PDF</span>
                    </button>
                    <button class="btn btn-info" onclick="printFamilyBook()">
                        <i class="fas fa-print"></i> <span data-i18n="print">ÿ∑ÿ®ÿßÿπÿ©</span>
                    </button>

                    <div class="book-search" style="display:flex; gap:8px; align-items:center; background: rgba(255,255,255,0.15); padding: 8px 12px; border-radius: 999px; border: 1px solid rgba(255,255,255,0.20);">
                        <i class="fas fa-search"></i>
                        <input id="bookSearchInput" class="form-input" style="width: 260px; padding: 8px 10px; border-radius: 999px;" placeholder="ÿ®ÿ≠ÿ´ ÿ≥ÿ±Ÿäÿπ ÿØÿßÿÆŸÑ ŸÉÿ™ÿßÿ® ÿßŸÑÿπÿßÿ¶ŸÑÿ© (ÿßÿ≥ŸÖ/ÿ±ŸÇŸÖ/ŸÖŸÉÿßŸÜ)..." oninput="searchFamilyBook()" />
                        <button class="btn btn-secondary" style="padding: 8px 12px;" onclick="clearBookSearch()" title="ŸÖÿ≥ÿ≠ ÿßŸÑÿ®ÿ≠ÿ´">
                            <i class="fas fa-times"></i>
                        </button>
                    </div>


                    <div id="bookOptions" style="margin-right:auto; display:flex; gap:10px; flex-wrap:wrap; align-items:center;">
                        <div style="display:flex; gap:8px; align-items:center; background: rgba(255,255,255,0.15); padding: 8px 12px; border-radius: 999px; border: 1px solid rgba(255,255,255,0.20);">
                            <i class="fas fa-palette"></i>
                            <input id="familyBrandNameInput" class="form-input" style="width: 220px; padding: 8px 10px; border-radius: 999px;" placeholder="ÿßÿ≥ŸÖ ÿßŸÑÿπÿßÿ¶ŸÑÿ© ŸÑŸÑŸáŸàŸäÿ© (ŸÖÿ´ÿßŸÑ: ÿ¢ŸÑ ÿπÿ®ÿØÿßŸÑÿ±ÿ≠ŸÖŸÜ)" />
                        </div>
                        <button class="btn btn-warning" onclick="applyBrandingFromInput()" title="ÿ™ÿ∑ÿ®ŸäŸÇ ŸáŸàŸäÿ© ÿ®ÿµÿ±Ÿäÿ©">
                            <i class="fas fa-feather-alt"></i> ÿ™ÿ∑ÿ®ŸäŸÇ ÿßŸÑŸáŸàŸäÿ©
                        </button>
                        <button class="btn btn-info" onclick="toggleBookCompact()" title="ÿπÿ±ÿ∂ ŸÖÿ∂ÿ∫Ÿàÿ∑/ŸÖŸàÿ≥ÿπ">
                            <i class="fas fa-columns"></i> ÿ™ÿÆÿ∑Ÿäÿ∑
                        </button>
                    </div>

                    <button class="btn btn-danger" onclick="closeFamilyBook()" style="margin-right: auto;">
                        <i class="fas fa-times"></i> <span data-i18n="close">ÿ•ÿ∫ŸÑÿßŸÇ</span>
                    </button>
                </div>

                <div class="book-preview" id="bookPreview" style="background: white; padding: 20px; border-radius: 10px; box-shadow: 0 0 10px rgba(0,0,0,0.1);">
                    </div>
            </div>
        </div>
    </div>

    <div class="form-modal" id="familyEventsModal">
        <button class="quick-back-btn" onclick="closeFamilyEvents()" title="ÿ•ÿ∫ŸÑÿßŸÇ">
            <i class="fas fa-times"></i>
        </button>
        <div class="form-container" style="max-width: 1000px;">
            <div class="form-header">
                <h3><i class="fas fa-calendar-alt"></i> <span>ÿßŸÑŸÖŸÜÿßÿ≥ÿ®ÿßÿ™ ŸàÿßŸÑÿ•ÿπŸÑÿßŸÜÿßÿ™ ÿßŸÑÿπÿßÿ¶ŸÑŸäÿ©</span></h3>
                <button class="close-form" onclick="closeFamilyEvents()">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            
            <div class="form-body">
                <!-- ŸÑŸàÿ≠ÿ© ÿßŸÑÿ™ÿ≠ŸÉŸÖ ŸÑŸÑŸÖÿØŸäÿ± -->
                <div class="control-panel" id="eventsControlPanel" style="margin-bottom: 20px; display: none;">
                    <div class="panel-header">
                        <h2><i class="fas fa-plus-circle"></i> <span>ÿ•ÿ∂ÿßŸÅÿ© ÿ•ÿπŸÑÿßŸÜ ÿ¨ÿØŸäÿØ</span></h2>
                    </div>
                    
                    <form id="eventForm" onsubmit="event.preventDefault(); saveEvent();">
                        <input type="hidden" id="eventId" value="">
                        
                        <div class="form-grid">
                            <div class="form-group">
                                <label class="form-label required">ŸÜŸàÿπ ÿßŸÑÿ•ÿπŸÑÿßŸÜ</label>
                                <select class="form-select" id="eventType" required>
                                    <option value="">ÿßÿÆÿ™ÿ± ÿßŸÑŸÜŸàÿπ</option>
                                    <option value="ŸÖŸÜÿßÿ≥ÿ®ÿ©">ŸÖŸÜÿßÿ≥ÿ®ÿ© ÿπÿßÿ¶ŸÑŸäÿ©</option>
                                    <option value="ÿßÿ¨ÿ™ŸÖÿßÿπ">ÿßÿ¨ÿ™ŸÖÿßÿπ ÿπÿßÿ¶ŸÑŸä</option>
                                    <option value="ŸÅÿπÿßŸÑŸäÿ©">ŸÅÿπÿßŸÑŸäÿ©</option>
                                    <option value="ÿ®ÿ±ŸÜÿßŸÖÿ¨">ÿ®ÿ±ŸÜÿßŸÖÿ¨ ÿ£ÿ≥ÿ±Ÿä</option>
                                    <option value="ÿ™ÿ∞ŸÉŸäÿ±">ÿ™ÿ∞ŸÉŸäÿ± ŸÖŸáŸÖ</option>
                                    <option value="ÿ£ÿÆÿ±Ÿâ">ÿ£ÿÆÿ±Ÿâ</option>
                                </select>
                            </div>
                            
                            <div class="form-group">
                                <label class="form-label required">ÿßŸÑÿπŸÜŸàÿßŸÜ</label>
                                <input type="text" class="form-input" id="eventTitle" required placeholder="ÿπŸÜŸàÿßŸÜ ÿßŸÑÿ•ÿπŸÑÿßŸÜ">
                            </div>
                            
                            <div class="form-group">
                                <label class="form-label required">ÿßŸÑÿ™ÿßÿ±ŸäÿÆ</label>
                                <input type="date" class="form-input" id="eventDate" required>
                            </div>
                            
                            <div class="form-group">
                                <label class="form-label">ÿßŸÑŸàŸÇÿ™</label>
                                <input type="time" class="form-input" id="eventTime">
                            </div>
                            
                            <div class="form-group">
                                <label class="form-label">ÿßŸÑŸÖŸÉÿßŸÜ</label>
                                <input type="text" class="form-input" id="eventLocation" placeholder="ŸÖŸÉÿßŸÜ ÿßŸÑÿ≠ÿØÿ´">
                            </div>
                        </div>
                        
                        <div class="form-group">
                            <label class="form-label required">ÿ™ŸÅÿßÿµŸäŸÑ ÿßŸÑÿ•ÿπŸÑÿßŸÜ</label>
                            <textarea class="form-textarea" id="eventDescription" rows="5" required placeholder="ÿ™ŸÅÿßÿµŸäŸÑ ÿßŸÑŸÖŸÜÿßÿ≥ÿ®ÿ© ÿ£Ÿà ÿßŸÑÿ®ÿ±ŸÜÿßŸÖÿ¨..."></textarea>
                        </div>
                        
                        <div class="form-group">
                            <label class="form-label">ÿßŸÑŸÖÿ≥ÿ§ŸàŸÑ ÿπŸÜ ÿßŸÑŸÖŸÜÿßÿ≥ÿ®ÿ©</label>
                            <input type="text" class="form-input" id="eventOrganizer" placeholder="ÿßÿ≥ŸÖ ÿßŸÑŸÖÿ≥ÿ§ŸàŸÑ">
                        </div>
                        
                        <div class="form-group">
                            <label class="form-label">ÿ≠ÿßŸÑÿ© ÿßŸÑÿ•ÿπŸÑÿßŸÜ</label>
                            <select class="form-select" id="eventStatus">
                                <option value="ŸÜÿ¥ÿ∑">ŸÜÿ¥ÿ∑</option>
                                <option value="ŸÖŸÜÿ™ŸáŸä">ŸÖŸÜÿ™ŸáŸä</option>
                                <option value="ŸÖŸÑÿ∫Ÿâ">ŸÖŸÑÿ∫Ÿâ</option>
                                <option value="ŸÖÿ§ÿ¨ŸÑ">ŸÖÿ§ÿ¨ŸÑ</option>
                            </select>
                        </div>
                        
                        <div class="form-actions">
                            <button type="button" class="btn btn-danger" onclick="cancelEventForm()">
                                <i class="fas fa-times"></i> ÿ•ŸÑÿ∫ÿßÿ°
                            </button>
                            <button type="submit" class="btn btn-success">
                                <i class="fas fa-save"></i> ÿ≠ŸÅÿ∏ ÿßŸÑÿ•ÿπŸÑÿßŸÜ
                            </button>
                        </div>
                    </form>
                </div>
                
                <!-- ŸÑŸàÿ≠ÿ© ÿßŸÑÿ•ÿπŸÑÿßŸÜÿßÿ™ ÿßŸÑÿ±ÿ¶Ÿäÿ≥Ÿäÿ© -->
                <div class="panel-header" style="margin-bottom: 20px;">
                    <h2><i class="fas fa-bullhorn"></i> <span>ÿßŸÑÿ•ÿπŸÑÿßŸÜÿßÿ™ ŸàÿßŸÑŸÖŸÜÿßÿ≥ÿ®ÿßÿ™ ÿßŸÑÿ≠ÿßŸÑŸäÿ©</span></h2>
                    <div class="action-buttons">
                        <button class="btn btn-primary" onclick="toggleEventForm()" id="toggleEventFormBtn">
                            <i class="fas fa-plus"></i> ÿ•ÿ∂ÿßŸÅÿ© ÿ•ÿπŸÑÿßŸÜ ÿ¨ÿØŸäÿØ
                        </button>
                        <button class="btn btn-info" onclick="filterEvents('all')">
                            <i class="fas fa-list"></i> ÿßŸÑŸÉŸÑ
                        </button>
                        <button class="btn btn-success" onclick="filterEvents('ŸÜÿ¥ÿ∑')">
                            <i class="fas fa-eye"></i> ÿßŸÑŸÜÿ¥ÿ∑ÿ©
                        </button>
                        <button class="btn btn-warning" onclick="filterEvents('ŸÇÿßÿØŸÖ')">
                            <i class="fas fa-calendar"></i> ÿßŸÑŸÇÿßÿØŸÖÿ©
                        </button>
                    </div>
                </div>
                
                <!-- ŸÅŸÑÿ™ÿ± ÿßŸÑÿ®ÿ≠ÿ´ -->
                <div class="tree-filter" style="margin: 0 0 20px 0;">
                    <input type="text" id="eventSearch" placeholder="ÿßÿ®ÿ≠ÿ´ ŸÅŸä ÿßŸÑÿ•ÿπŸÑÿßŸÜÿßÿ™..." onkeyup="searchEvents()">
                    <button class="btn btn-primary" onclick="clearEventSearch()">
                        <i class="fas fa-times"></i> ŸÖÿ≥ÿ≠ ÿßŸÑÿ®ÿ≠ÿ´
                    </button>
                    <button class="btn btn-info" onclick="printEvents()">
                        <i class="fas fa-print"></i> ÿ∑ÿ®ÿßÿπÿ©
                    </button>
                </div>
                
                <!-- ÿπÿ±ÿ∂ ÿßŸÑÿ•ÿπŸÑÿßŸÜÿßÿ™ -->
                <div id="eventsList" class="events-grid">
                    <!-- ÿ≥Ÿäÿ™ŸÖ ÿ™ÿπÿ®ÿ¶ÿ© ÿßŸÑÿ•ÿπŸÑÿßŸÜÿßÿ™ ŸáŸÜÿß -->
                </div>
                
                <!-- ÿ±ÿ≥ÿßŸÑÿ© ŸÅÿßÿ±ÿ∫ÿ© -->
                <div id="noEventsMessage" class="empty-message" style="display: none;">
                    <i class="fas fa-calendar-times"></i>
                    <h3>ŸÑÿß ÿ™Ÿàÿ¨ÿØ ÿ•ÿπŸÑÿßŸÜÿßÿ™ ÿ≠ÿßŸÑŸäÿßŸã</h3>
                    <p>ŸäŸÖŸÉŸÜŸÉ ÿ•ÿ∂ÿßŸÅÿ© ÿ•ÿπŸÑÿßŸÜÿßÿ™ ÿ¨ÿØŸäÿØÿ© ÿ®ÿßÿ≥ÿ™ÿÆÿØÿßŸÖ ÿ≤ÿ± "ÿ•ÿ∂ÿßŸÅÿ© ÿ•ÿπŸÑÿßŸÜ ÿ¨ÿØŸäÿØ"</p>
                </div>
            </div>
        </div>
    </div>

    <div class="form-modal" id="permissionsModal">
        <button class="quick-back-btn" onclick="closePermissionsModal()" title="ÿ•ÿ∫ŸÑÿßŸÇ">
            <i class="fas fa-times"></i>
        </button>
        <div class="form-container" style="max-width: 700px;">
            <div class="form-header">
                <h3><i class="fas fa-user-shield"></i> <span data-i18n="permissions">ÿ•ÿØÿßÿ±ÿ© ÿßŸÑÿµŸÑÿßÿ≠Ÿäÿßÿ™</span></h3>
                <button class="close-form" onclick="closePermissionsModal()">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            
            <div class="form-body">
                <div class="alert info">
                    <i class="fas fa-info-circle"></i>
                    <div>
                        <strong data-i18n="permissionsSystem">ŸÜÿ∏ÿßŸÖ ÿßŸÑÿµŸÑÿßÿ≠Ÿäÿßÿ™</strong>
                        <p data-i18n="permissionsInfo">ÿßŸÑŸÖÿØŸäÿ±: ÿ¨ŸÖŸäÿπ ÿßŸÑÿµŸÑÿßÿ≠Ÿäÿßÿ™ | ÿßŸÑŸÖÿ≥ÿ™ÿÆÿØŸÖ: ÿßŸÑÿπÿ±ÿ∂ ŸàÿßŸÑÿ•ÿ∂ÿßŸÅÿ© ŸÅŸÇÿ∑</p>
                    </div>
                </div>
                
                <div class="form-group">
                    <label class="form-label" data-i18n="addNewUser">ÿ•ÿ∂ÿßŸÅÿ© ŸÖÿ≥ÿ™ÿÆÿØŸÖ ÿ¨ÿØŸäÿØ</label>
                    <div class="form-grid">
                        <div class="form-group">
                            <input type="text" class="form-input" id="newUsername" data-i18n-placeholder="usernamePlaceholder" placeholder="ÿßÿ≥ŸÖ ÿßŸÑŸÖÿ≥ÿ™ÿÆÿØŸÖ">
                        </div>
                        <div class="form-group">
                            <input type="password" class="form-input" id="newPassword" data-i18n-placeholder="passwordPlaceholder" placeholder="ŸÉŸÑŸÖÿ© ÿßŸÑŸÖÿ±Ÿàÿ±">
                        </div>
                        <div class="form-group">
                            <select class="form-select" id="newUserRole">
                                <option value="user" data-i18n="user">ŸÖÿ≥ÿ™ÿÆÿØŸÖ</option>
                                <option value="admin" data-i18n="admin">ŸÖÿØŸäÿ±</option>
                            </select>
                        </div>
                    </div>
                    <button class="btn btn-success" onclick="addNewUser()">
                        <i class="fas fa-user-plus"></i> <span data-i18n="addUser">ÿ•ÿ∂ÿßŸÅÿ© ŸÖÿ≥ÿ™ÿÆÿØŸÖ</span>
                    </button>
                </div>
                
                <div class="form-group">
                    <label class="form-label" data-i18n="usersList">ŸÇÿßÿ¶ŸÖÿ© ÿßŸÑŸÖÿ≥ÿ™ÿÆÿØŸÖŸäŸÜ</label>
                    <div class="table-responsive">
                        <table class="data-table">
                            <thead>
                                <tr>
                                    <th data-i18n="username">ÿßÿ≥ŸÖ ÿßŸÑŸÖÿ≥ÿ™ÿÆÿØŸÖ</th>
                                    <th data-i18n="role">ÿßŸÑÿµŸÑÿßÿ≠Ÿäÿ©</th>
                                    <th data-i18n="lastLogin">ÿ¢ÿÆÿ± ÿØÿÆŸàŸÑ</th>
                                    <th data-i18n="actions">ÿßŸÑÿ•ÿ¨ÿ±ÿßÿ°ÿßÿ™</th>
                                </tr>
                            </thead>
                            <tbody id="usersList">
                                </tbody>
                        </table>
                    </div>
                </div>
                
                <div class="form-actions">
                    <button type="button" class="btn btn-danger" onclick="closePermissionsModal()">
                        <i class="fas fa-times"></i> <span data-i18n="close">ÿ•ÿ∫ŸÑÿßŸÇ</span>
                    </button>
                </div>
            </div>
        </div>
    </div>

    <div class="form-modal" id="excelImportModal">
        <button class="quick-back-btn" onclick="closeExcelImport()" title="ÿ•ÿ∫ŸÑÿßŸÇ">
            <i class="fas fa-times"></i>
        </button>
        <div class="form-container" style="max-width: 700px;">
            <div class="form-header">
                <h3><i class="fas fa-file-excel"></i> <span data-i18n="excelImport">ÿßÿ≥ÿ™Ÿäÿ±ÿßÿØ ŸÖŸÜ Excel</span></h3>
                <button class="close-form" onclick="closeExcelImport()">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            
            <div class="form-body">
                <div class="alert warning">
                    <i class="fas fa-exclamation-triangle"></i>
                    <div>
                        <strong data-i18n="importInstructions">ÿ™ÿπŸÑŸäŸÖÿßÿ™ ÿßŸÑÿßÿ≥ÿ™Ÿäÿ±ÿßÿØ</strong>
                        <p data-i18n="importInfo">Ÿäÿ¨ÿ® ÿ£ŸÜ Ÿäÿ≠ÿ™ŸàŸä ŸÖŸÑŸÅ Excel ÿπŸÑŸâ ÿßŸÑÿ£ÿπŸÖÿØÿ© ÿßŸÑÿ™ÿßŸÑŸäÿ©: ÿßŸÑÿ±ŸÇŸÖ, ÿßŸÑÿßÿ≥ŸÖ, ÿßŸÑÿ¨ŸÜÿ≥, ÿßŸÑÿ£ÿ®, ÿßŸÑÿ£ŸÖ, ÿßŸÑÿ≤Ÿàÿ¨/ÿßŸÑÿ≤Ÿàÿ¨ÿ©</p>
                        <p data-i18n="downloadTemplate">ŸäŸÖŸÉŸÜŸÉ ÿ™ÿ≠ŸÖŸäŸÑ <a href="#" onclick="downloadExcelTemplate()" style="color: #1b5e20; text-decoration: underline;">ŸÜŸÖŸàÿ∞ÿ¨ Excel ÿ¨ÿßŸáÿ≤</a></p>
                    </div>
                </div>
                
                <div class="form-group">
                    <label class="form-label" data-i18n="selectExcelFile">ÿßÿÆÿ™ÿ± ŸÖŸÑŸÅ Excel</label>
                    <input type="file" id="excelFile" class="form-input" accept=".xlsx,.xls,.csv" onchange="handleExcelFileSelect(event)">
                </div>
                
                <div class="form-group" id="excelPreview" style="display: none;">
                    <label class="form-label" data-i18n="dataPreview">ŸÖÿπÿßŸäŸÜÿ© ÿßŸÑÿ®ŸäÿßŸÜÿßÿ™</label>
                    
                    <div class="import-preview table-responsive">
                        <table class="data-table">
                            <thead id="excelTableHead"></thead>
                            <tbody id="excelTableBody"></tbody>
                        </table>
                    </div>
                    
                    <div class="import-stats" id="importStats" style="display: none;">
                        <p><i class="fas fa-info-circle"></i> <span id="importStatsText"></span></p>
                    </div>
                    
                    <div class="form-actions" style="margin-top: 20px;">
                        <button class="btn btn-success" onclick="importExcelData()">
                            <i class="fas fa-check"></i> <span data-i18n="confirmImport">ÿ™ÿ£ŸÉŸäÿØ ÿßŸÑÿßÿ≥ÿ™Ÿäÿ±ÿßÿØ</span>
                        </button>
                        <button class="btn btn-danger" onclick="clearExcelPreview()">
                            <i class="fas fa-times"></i> <span data-i18n="cancel">ÿ•ŸÑÿ∫ÿßÿ°</span>
                        </button>
                    </div>
                </div>
                
                <div class="form-actions">
                    <button type="button" class="btn btn-danger" onclick="closeExcelImport()">
                        <i class="fas fa-times"></i> <span data-i18n="close">ÿ•ÿ∫ŸÑÿßŸÇ</span>
                    </button>
                </div>
            </div>
        </div>
    </div>

    <div class="form-modal" id="encryptionModal">
        <button class="quick-back-btn" onclick="closeEncryptionModal()" title="ÿ•ÿ∫ŸÑÿßŸÇ">
            <i class="fas fa-times"></i>
        </button>
        <div class="form-container">
            <div class="form-header">
                <h3><i class="fas fa-lock"></i> <span data-i18n="encryption">ÿ•ÿπÿØÿßÿØÿßÿ™ ÿßŸÑÿ™ÿ¥ŸÅŸäÿ±</span></h3>
                <button class="close-form" onclick="closeEncryptionModal()">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            
            <div class="form-body">
                <div class="form-group">
                    <label class="form-label" data-i18n="encryptionStatus">ÿ≠ÿßŸÑÿ© ÿßŸÑÿ™ÿ¥ŸÅŸäÿ± ÿßŸÑÿ≠ÿßŸÑŸäÿ©</label>
                    <div class="alert info" id="encryptionAlert" style="display: flex;">
                        <i class="fas fa-info-circle"></i>
                        <span id="encryptionMessage" data-i18n="loading">ÿ¨ÿßÿ±Ÿä ÿßŸÑÿ™ÿ≠ŸÖŸäŸÑ...</span>
                    </div>
                </div>
                
                <div class="form-group">
                    <label class="form-label" data-i18n="encryptCurrent">ÿ™ÿ¥ŸÅŸäÿ± ÿßŸÑÿ®ŸäÿßŸÜÿßÿ™ ÿßŸÑÿ≠ÿßŸÑŸäÿ©</label>
                    <div class="form-grid">
                        <div class="form-group">
                            <label class="form-label required" data-i18n="encryptPassword">ŸÉŸÑŸÖÿ© ÿßŸÑŸÖÿ±Ÿàÿ± ŸÑŸÑÿ™ÿ¥ŸÅŸäÿ±</label>
                            <input type="password" class="form-input" id="encryptPassword" data-i18n-placeholder="encryptPasswordPlaceholder" placeholder="ÿ£ÿØÿÆŸÑ ŸÉŸÑŸÖÿ© ŸÖÿ±Ÿàÿ± ŸÇŸàŸäÿ©">
                        </div>
                        <div class="form-group">
                            <label class="form-label required" data-i18n="confirmPassword">ÿ™ÿ£ŸÉŸäÿØ ŸÉŸÑŸÖÿ© ÿßŸÑŸÖÿ±Ÿàÿ±</label>
                            <input type="password" class="form-input" id="encryptConfirmPassword" data-i18n-placeholder="confirmPasswordPlaceholder" placeholder="ÿ£ÿπÿØ ÿ•ÿØÿÆÿßŸÑ ŸÉŸÑŸÖÿ© ÿßŸÑŸÖÿ±Ÿàÿ±">
                        </div>
                    </div>
                    <div class="encryption-actions">
                        <button class="btn btn-success" onclick="encryptCurrentData()">
                            <i class="fas fa-lock"></i> <span data-i18n="encryptData">ÿ™ÿ¥ŸÅŸäÿ± ÿßŸÑÿ®ŸäÿßŸÜÿßÿ™</span>
                        </button>
                        <button class="btn btn-warning" onclick="decryptCurrentData()">
                            <i class="fas fa-unlock"></i> <span data-i18n="decryptData">ŸÅŸÉ ÿ™ÿ¥ŸÅŸäÿ± ÿßŸÑÿ®ŸäÿßŸÜÿßÿ™</span>
                        </button>
                        <button class="btn btn-danger" onclick="removeEncryption()">
                            <i class="fas fa-trash"></i> <span data-i18n="removeEncryption">ÿ•ÿ≤ÿßŸÑÿ© ÿßŸÑÿ™ÿ¥ŸÅŸäÿ±</span>
                        </button>
                    </div>
                </div>
                
                <div class="form-group">
                    <label class="form-label" data-i18n="securityTips">ŸÜÿµÿßÿ¶ÿ≠ ÿßŸÑÿ£ŸÖÿßŸÜ</label>
                    <div class="alert warning">
                        <i class="fas fa-shield-alt"></i>
                        <div>
                            <p><strong data-i18n="importantTips">ŸÜÿµÿßÿ¶ÿ≠ ŸÖŸáŸÖÿ©:</strong></p>
                            <ol style="margin-right: 20px; margin-top: 10px;">
                                <li data-i18n="tip1">ÿßÿ≠ŸÅÿ∏ ŸÉŸÑŸÖÿ© ÿßŸÑŸÖÿ±Ÿàÿ± ŸÅŸä ŸÖŸÉÿßŸÜ ÿ¢ŸÖŸÜ</li>
                                <li data-i18n="tip2">ŸÑÿß ÿ™ÿ≥ÿ™ÿÆÿØŸÖ ŸÉŸÑŸÖÿßÿ™ ŸÖÿ±Ÿàÿ± ÿ®ÿ≥Ÿäÿ∑ÿ© (ÿßÿ≥ÿ™ÿÆÿØŸÖ 6 ÿ£ÿ≠ÿ±ŸÅ ÿπŸÑŸâ ÿßŸÑÿ£ŸÇŸÑ)</li>
                                <li data-i18n="tip3">ŸÇŸÖ ÿ®ÿπŸÖŸÑ ŸÜÿ≥ÿÆÿ© ÿßÿ≠ÿ™Ÿäÿßÿ∑Ÿäÿ© ŸÇÿ®ŸÑ ÿßŸÑÿ™ÿ¥ŸÅŸäÿ±</li>
                                <li data-i18n="tip4">ŸÑÿß ŸäŸÖŸÉŸÜ ÿßÿ≥ÿ™ÿπÿßÿØÿ© ÿßŸÑÿ®ŸäÿßŸÜÿßÿ™ ÿ•ÿ∞ÿß ŸÜÿ≥Ÿäÿ™ ŸÉŸÑŸÖÿ© ÿßŸÑŸÖÿ±Ÿàÿ±</li>
                            </ol>
                        </div>
                    </div>
                </div>
                
                <div class="form-actions">
                    <button type="button" class="btn btn-danger" onclick="closeEncryptionModal()">
                        <i class="fas fa-times"></i> <span data-i18n="close">ÿ•ÿ∫ŸÑÿßŸÇ</span>
                    </button>
                </div>
            </div>
        </div>
    </div>

    <div class="form-modal" id="cloudManagerModal">
        <button class="quick-back-btn" onclick="closeCloudManager()" title="ÿ•ÿ∫ŸÑÿßŸÇ">
            <i class="fas fa-times"></i>
        </button>
        <div class="form-container" style="max-width: 800px;">
            <div class="form-header">
                <h3><i class="fas fa-cloud"></i> <span>ÿ•ÿØÿßÿ±ÿ© ÿ™ÿÆÿ≤ŸäŸÜ ÿßŸÑÿ≥ÿ≠ÿßÿ®ÿ©</span></h3>
                <button class="close-form" onclick="closeCloudManager()">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            
            <div class="form-body">
                <div class="alert info">
                    <i class="fas fa-info-circle"></i>
                    <div>
                        <strong>ŸÜÿ∏ÿßŸÖ ÿßŸÑÿ™ÿÆÿ≤ŸäŸÜ ÿßŸÑÿ≥ÿ≠ÿßÿ®Ÿä</strong>
                        <p>Ÿäÿ™ŸÖ ÿ™ÿÆÿ≤ŸäŸÜ ÿ®ŸäÿßŸÜÿßÿ™ ÿ¥ÿ¨ÿ±ÿ© ÿßŸÑÿπÿßÿ¶ŸÑÿ© ÿπŸÑŸâ ÿÆŸàÿßÿØŸÖ Google Firebase ÿ®ÿ≠Ÿäÿ´ ÿ™ŸÉŸàŸÜ ŸÖÿ™ÿßÿ≠ÿ© ŸÑŸÑÿ¨ŸÖŸäÿπ.</p>
                        <p>ÿßŸÑÿ™ÿ≠ÿØŸäÿ´ÿßÿ™ ÿ™ÿ∏Ÿáÿ± ŸÅŸàÿ±ŸäÿßŸã ŸÑÿ¨ŸÖŸäÿπ ÿßŸÑŸÖÿ≥ÿ™ÿÆÿØŸÖŸäŸÜ ÿßŸÑŸÖÿ™ÿµŸÑŸäŸÜ.</p>
                    </div>
                </div>
                
                <div class="form-grid">
                    <div class="form-group">
                        <label class="form-label">ÿ≠ÿßŸÑÿ© ÿßŸÑÿßÿ™ÿµÿßŸÑ ÿ®ÿßŸÑÿ≥ÿ≠ÿßÿ®ÿ©</label>
                        <div class="status-card">
                            <div class="status-item">
                                <span>ÿ≠ÿßŸÑÿ© ÿßŸÑÿ≥ÿ≠ÿßÿ®ÿ©:</span>
                                <span id="cloudStatus" class="status-badge success">‚úì ŸÜÿ¥ÿ∑ÿ©</span>
                            </div>
                            <div class="status-item">
                                <span>ÿ¢ÿÆÿ± ŸÖÿ≤ÿßŸÖŸÜÿ©:</span>
                                <span id="lastSyncTime">-</span>
                            </div>
                            <div class="status-item">
                                <span>ÿ®ŸäÿßŸÜÿßÿ™ ŸÅŸä ŸÇÿßÿ¶ŸÖÿ© ÿßŸÑÿßŸÜÿ™ÿ∏ÿßÿ±:</span>
                                <span id="pendingSync" class="status-badge">0</span>
                            </div>
                            <div class="status-item">
                                <span>ÿ≠ÿßŸÑÿ© ÿßŸÑÿ•ŸÜÿ™ÿ±ŸÜÿ™:</span>
                                <span id="internetStatus" class="status-badge success">‚úì ŸÖÿ™ÿµŸÑ</span>
                            </div>
                        </div>
                    </div>
                    
                    <div class="form-group">
                        <label class="form-label">ÿßŸÑŸÜÿ≥ÿÆ ÿßŸÑÿßÿ≠ÿ™Ÿäÿßÿ∑Ÿäÿ©</label>
                        <div class="backup-list" id="backupList">
                            </div>
                        <button class="btn btn-primary" onclick="loadBackupList()">
                            <i class="fas fa-sync"></i> ÿ™ÿ≠ÿØŸäÿ´ ÿßŸÑŸÇÿßÿ¶ŸÖÿ©
                        </button>
                    </div>
                </div>
                
                <div class="form-actions">
                    <button class="btn btn-success" onclick="forceSync()">
                        <i class="fas fa-sync"></i> ŸÖÿ≤ÿßŸÖŸÜÿ© ŸäÿØŸàŸäÿ©
                    </button>
                    <button class="btn btn-warning" onclick="clearSyncQueue()">
                        <i class="fas fa-trash"></i> ŸÖÿ≥ÿ≠ ŸÇÿßÿ¶ŸÖÿ© ÿßŸÑÿßŸÜÿ™ÿ∏ÿßÿ±
                    </button>
                    <button class="btn btn-info" onclick="showCloudStatistics()">
                        <i class="fas fa-chart-bar"></i> ÿ•ÿ≠ÿµÿßÿ¶Ÿäÿßÿ™ ÿßŸÑÿ≥ÿ≠ÿßÿ®ÿ©
                    </button>
                    <button class="btn btn-danger" onclick="closeCloudManager()" style="margin-right: auto;">
                        <i class="fas fa-times"></i> ÿ•ÿ∫ŸÑÿßŸÇ
                    </button>
                </div>
            </div>
        </div>
    </div>

    <div class="export-loading" id="exportLoading">
        <i class="fas fa-spinner"></i>
        <div id="exportLoadingText" data-i18n="preparingImage">ÿ¨ÿßÿ±Ÿä ÿ™ÿ≠ÿ∂Ÿäÿ± ÿßŸÑÿµŸàÿ±ÿ©...</div>
        <div style="font-size: 0.9rem; color: #ccc;" data-i18n="exportWait">ŸÇÿØ ÿ™ÿ≥ÿ™ÿ∫ÿ±ŸÇ ÿßŸÑÿπŸÖŸÑŸäÿ© ÿ®ÿ∂ÿπ ÿ´ŸàÿßŸÜŸç</div>
    </div>

    <script>
        // ============================================
        // ÿ™ÿπÿ±ŸäŸÅ ÿßŸÑŸÖÿ™ÿ∫Ÿäÿ±ÿßÿ™ ÿßŸÑÿπÿßŸÖÿ©
        // ============================================
        
        let familyData = [];
        let currentUser = null;
        let nextPersonId = 1;
        let treeZoom = 100;
        let treeCompactMode = false;
        let treeViewMode = 'vertical';
        let currentTreeSearch = '';
        let currentSortOrder = 'asc';
        let isDataEncrypted = false;
        let encryptionPassword = '';
        let mobileOptimized = false;
        let searchBarVisible = true;
        let lastScrollTop = 0;
        let currentDetailPersonId = null;
        let excelData = [];
        let currentLanguage = 'ar';
        let searchMatchCount = 0;

        // ŸÖÿ™ÿ∫Ÿäÿ±ÿßÿ™ ÿßŸÑÿ≥ÿ≠ÿßÿ®ÿ©
        let firebaseApp;
        let database;
        let cloudSyncEnabled = false;
        let isOffline = false;
        let lastSyncTime = null;
        let syncQueue = [];

        // ŸÖÿ™ÿ∫Ÿäÿ±ÿßÿ™ ŸÇÿ≥ŸÖ ÿßŸÑŸÖŸÜÿßÿ≥ÿ®ÿßÿ™
        let familyEvents = [];
        let eventsEditing = false;
        let currentEventsFilter = 'all';

        // ÿ™ŸÉŸàŸäŸÜ Firebase - ÿ∂ÿπ ŸÖÿπŸÑŸàŸÖÿßÿ™ ŸÖÿ¥ÿ±ŸàÿπŸÉ ŸáŸÜÿß
      // For Firebase JS SDK v7.20.0 and later, measurementId is optional
const firebaseConfig = {
  apiKey: "AIzaSyB5kAQNtC6xP4zaS4Whjoy7ZG7bQTQ68iU",
  authDomain: "familytree-2da8b.firebaseapp.com",
  databaseURL: "https://familytree-2da8b-default-rtdb.firebaseio.com",
  projectId: "familytree-2da8b",
  storageBucket: "familytree-2da8b.firebasestorage.app",
  messagingSenderId: "810651112343",
  appId: "1:810651112343:web:268b54f5505f66885daad2",
  measurementId: "G-0BT7ET24BK"
};
        
        function showBackup() {
            if (confirm('ŸáŸÑ ÿ™ÿ±ŸäÿØ ÿ™ÿµÿØŸäÿ± ŸÜÿ≥ÿÆÿ© ÿßÿ≠ÿ™Ÿäÿßÿ∑Ÿäÿ© ŸÖŸÜ ÿ¨ŸÖŸäÿπ ÿßŸÑÿ®ŸäÿßŸÜÿßÿ™ÿü')) {
                exportData('json');
            }
        }
        // ÿ®ŸäÿßŸÜÿßÿ™ ÿßŸÑÿ™ÿ±ÿ¨ŸÖÿ©
        const translations = {
            ar: {
                loginTitle: "ŸÜÿ∏ÿßŸÖ ÿ•ÿØÿßÿ±ÿ© ÿ¥ÿ¨ÿ±ÿ© ÿßŸÑÿπÿßÿ¶ŸÑÿ©",
                loginSubtitle: "ÿßŸÑÿ±ÿ¨ÿßÿ° ÿ™ÿ≥ÿ¨ŸäŸÑ ÿßŸÑÿØÿÆŸàŸÑ ŸÑÿ•ÿØÿßÿ±ÿ© ÿ®ŸäÿßŸÜÿßÿ™ ÿßŸÑÿπÿßÿ¶ŸÑÿ©",
                usernamePlaceholder: "ÿßÿ≥ŸÖ ÿßŸÑŸÖÿ≥ÿ™ÿÆÿØŸÖ",
                passwordPlaceholder: "ŸÉŸÑŸÖÿ© ÿßŸÑŸÖÿ±Ÿàÿ±",
                loginError: "ÿßÿ≥ŸÖ ÿßŸÑŸÖÿ≥ÿ™ÿÆÿØŸÖ ÿ£Ÿà ŸÉŸÑŸÖÿ© ÿßŸÑŸÖÿ±Ÿàÿ± ÿ∫Ÿäÿ± ÿµÿ≠Ÿäÿ≠ÿ©",
                loginButton: "ÿØÿÆŸàŸÑ",
                familyTitle: "ÿ¥ÿ¨ÿ±ÿ© ÿπÿßÿ¶ŸÑÿ© ŸÖÿ≠ŸÖÿØ ÿπÿ®ÿØÿßŸÑÿ±ÿ≠ŸÖŸÜ ( ÿ£ÿ®ÿß )",
                developerInfo: "ÿßÿπÿØÿßÿØ Ÿàÿ™ŸÜŸÅŸäÿ∞: | ŸÖÿ≠ŸÖÿØ ÿπŸÖÿ± ŸÖÿ≠ŸÖÿØ",
                
                appTitle: "ÿ¥ÿ¨ÿ±ÿ© ÿπÿßÿ¶ŸÑÿ© ŸÖÿ≠ŸÖÿØ ÿπÿ®ÿØÿßŸÑÿ±ÿ≠ŸÖŸÜ",
                welcome: "ŸÖÿ±ÿ≠ÿ®ÿßŸãÿå",
                logout: "ÿ™ÿ≥ÿ¨ŸäŸÑ ÿßŸÑÿÆÿ±Ÿàÿ¨",
                dashboard: "ÿßŸÑÿ±ÿ¶Ÿäÿ≥Ÿäÿ©",
                allPersons: "ÿ¨ŸÖŸäÿπ ÿßŸÑÿ£ŸÅÿ±ÿßÿØ",
                addPerson: "ÿ•ÿ∂ÿßŸÅÿ© ŸÅÿ±ÿØ ÿ¨ÿØŸäÿØ",
                searchEdit: "ÿ®ÿ≠ÿ´ Ÿàÿ™ÿπÿØŸäŸÑ",
                statistics: "ÿßŸÑÿ•ÿ≠ÿµÿßÿ¶Ÿäÿßÿ™",
                treeView: "ÿπÿ±ÿ∂ ÿßŸÑÿ¥ÿ¨ÿ±ÿ©",
                backup: "ÿßŸÑŸÜÿ≥ÿÆ ÿßŸÑÿßÿ≠ÿ™Ÿäÿßÿ∑Ÿä",
                familyBook: "ŸÉÿ™ÿßÿ® ÿßŸÑÿπÿßÿ¶ŸÑÿ©",
                excelImport: "ÿßÿ≥ÿ™Ÿäÿ±ÿßÿØ Excel",
                permissions: "ÿ•ÿØÿßÿ±ÿ© ÿßŸÑÿµŸÑÿßÿ≠Ÿäÿßÿ™",
                encryption: "ÿ•ÿπÿØÿßÿØÿßÿ™ ÿßŸÑÿ™ÿ¥ŸÅŸäÿ±",
                familyEvents: "ÿßŸÑŸÖŸÜÿßÿ≥ÿ®ÿßÿ™ ŸàÿßŸÑÿ•ÿπŸÑÿßŸÜÿßÿ™",
                
                totalPersons: "ÿ•ÿ¨ŸÖÿßŸÑŸä ÿßŸÑÿ£ŸÅÿ±ÿßÿØ",
                maleCount: "ÿπÿØÿØ ÿßŸÑÿ∞ŸÉŸàÿ±",
                femaleCount: "ÿπÿØÿØ ÿßŸÑÿ•ŸÜÿßÿ´",
                familiesCount: "ÿπÿØÿØ ÿßŸÑÿπÿßÿ¶ŸÑÿßÿ™",
                
                familyManagement: "ÿ•ÿØÿßÿ±ÿ© ÿ£ŸÅÿ±ÿßÿØ ÿßŸÑÿπÿßÿ¶ŸÑÿ©",
                addNewPerson: "ÿ•ÿ∂ÿßŸÅÿ© ŸÅÿ±ÿØ ÿ¨ÿØŸäÿØ",
                refreshData: "ÿ™ÿ≠ÿØŸäÿ´ ÿßŸÑÿ®ŸäÿßŸÜÿßÿ™",
                exportData: "ÿ™ÿµÿØŸäÿ± ÿßŸÑÿ®ŸäÿßŸÜÿßÿ™",
                exportJson: "JSON",
                exportExcel: "Excel",
                exportCSV: "CSV",
                toggleSort: "ÿ™ÿ±ÿ™Ÿäÿ® ÿ™ÿµÿßÿπÿØŸä / ÿ™ŸÜÿßÿ≤ŸÑŸä",
                importData: "ÿßÿ≥ÿ™Ÿäÿ±ÿßÿØ ÿßŸÑÿ®ŸäÿßŸÜÿßÿ™",
                successMessage: "ÿ™ŸÖÿ™ ÿßŸÑÿπŸÖŸÑŸäÿ© ÿ®ŸÜÿ¨ÿßÿ≠",
                errorMessage: "ÿ≠ÿØÿ´ ÿÆÿ∑ÿ£ ÿ£ÿ´ŸÜÿßÿ° ÿßŸÑÿπŸÖŸÑŸäÿ©",
                
                tableId: "ÿßŸÑÿ±ŸÇŸÖ",
                tableName: "ÿßŸÑÿßÿ≥ŸÖ ÿßŸÑŸÉÿßŸÖŸÑ",
                tableGender: "ÿßŸÑÿ¨ŸÜÿ≥",
                tableBirthPlace: "ŸÖŸÉÿßŸÜ ÿßŸÑŸÖŸäŸÑÿßÿØ",
                tableFather: "ÿßŸÑÿ£ÿ®",
                tableMother: "ÿßŸÑÿ£ŸÖ",
                tableActions: "ÿßŸÑÿ•ÿ¨ÿ±ÿßÿ°ÿßÿ™",
                
                addPersonForm: "ÿ•ÿ∂ÿßŸÅÿ© ŸÅÿ±ÿØ ÿ¨ÿØŸäÿØ",
                editPersonForm: "ÿ™ÿπÿØŸäŸÑ ÿ®ŸäÿßŸÜÿßÿ™ ÿßŸÑŸÅÿ±ÿØ",
                formFullName: "ÿßŸÑÿßÿ≥ŸÖ ÿßŸÑŸÉÿßŸÖŸÑ",
                formGender: "ÿßŸÑÿ¨ŸÜÿ≥",
                formSelectGender: "ÿßÿÆÿ™ÿ± ÿßŸÑÿ¨ŸÜÿ≥",
                male: "ÿ∞ŸÉÿ±",
                female: "ÿ£ŸÜÿ´Ÿâ",
                formBirthPlace: "ŸÖŸÉÿßŸÜ ÿßŸÑŸÖŸäŸÑÿßÿØ",
                formBirthDate: "ÿ™ÿßÿ±ŸäÿÆ ÿßŸÑŸÖŸäŸÑÿßÿØ",
                formDeathDate: "ÿ™ÿßÿ±ŸäÿÆ ÿßŸÑŸàŸÅÿßÿ© (ÿ•ŸÜ Ÿàÿ¨ÿØ)",
                formFatherId: "ÿ±ŸÇŸÖ ÿßŸÑÿ£ÿ®",
                formNoFather: "ŸÑÿß ŸäŸàÿ¨ÿØ (ÿ¨ÿ∞ÿ± ÿßŸÑÿπÿßÿ¶ŸÑÿ©)",
                formMotherId: "ÿ±ŸÇŸÖ ÿßŸÑÿ£ŸÖ",
                formNoMother: "ŸÑÿß ŸäŸàÿ¨ÿØ",
                formSpouseId: "ÿ±ŸÇŸÖ ÿßŸÑÿ≤Ÿàÿ¨/ÿßŸÑÿ≤Ÿàÿ¨ÿ©",
                formNoSpouse: "ŸÑÿß ŸäŸàÿ¨ÿØ",
                formNotes: "ŸÖŸÑÿßÿ≠ÿ∏ÿßÿ™ ÿ•ÿ∂ÿßŸÅŸäÿ©",
                cancel: "ÿ•ŸÑÿ∫ÿßÿ°",
                save: "ÿ≠ŸÅÿ∏ ÿßŸÑÿ®ŸäÿßŸÜÿßÿ™",
                
                fullFamilyTree: "ÿ¥ÿ¨ÿ±ÿ© ÿßŸÑÿπÿßÿ¶ŸÑÿ© ÿßŸÑŸÉÿßŸÖŸÑÿ©",
                toggleView: "ÿ™ÿ®ÿØŸäŸÑ ÿßŸÑÿπÿ±ÿ∂",
                exportImage: "ÿ™ÿµÿØŸäÿ± ÿµŸàÿ±ÿ©",
                exportNormal: "ÿµŸàÿ±ÿ© ÿπÿßÿØŸäÿ©",
                exportHigh: "ÿµŸàÿ±ÿ© ÿπÿßŸÑŸäÿ© ÿßŸÑÿ¨ŸàÿØÿ©",
                exportVisible: "ÿßŸÑÿ¨ÿ≤ÿ° ÿßŸÑŸÖÿ±ÿ¶Ÿä ŸÅŸÇÿ∑",
                exportPDF: "PDF (ÿ™ÿ¨ÿ±Ÿäÿ®Ÿä)",
                mobileMode: "Ÿàÿ∂ÿπ ÿßŸÑŸÖŸàÿ®ÿßŸäŸÑ",
                persons: "ŸÅÿ±ÿØ",
                close: "ÿ•ÿ∫ŸÑÿßŸÇ",
                treeSearchPlaceholder: "ÿßÿ®ÿ≠ÿ´ ÿπŸÜ ŸÅÿ±ÿØ ŸÅŸä ÿßŸÑÿ¥ÿ¨ÿ±ÿ©...",
                clearSearch: "ŸÖÿ≥ÿ≠ ÿßŸÑÿ®ÿ≠ÿ´",
                firstGeneration: "ÿßŸÑÿ¨ŸäŸÑ ÿßŸÑÿ£ŸàŸÑ",
                treeInfo: "ÿßŸÜŸÇÿ± ÿπŸÑŸâ ÿ£Ÿä ŸÅÿ±ÿØ ŸÑÿπÿ±ÿ∂ ŸÖÿπŸÑŸàŸÖÿßÿ™Ÿá",
                treeTooltip: "ŸäŸÖŸÉŸÜŸÉ ÿßŸÑÿ™ŸÖÿ±Ÿäÿ± ÿ£ŸÅŸÇŸäÿßŸã ŸàÿπŸÖŸàÿØŸäÿßŸã ŸÑÿπÿ±ÿ∂ ÿ¨ŸÖŸäÿπ ÿßŸÑÿ£ŸÅÿ±ÿßÿØ. ÿßÿ≥ÿ™ÿÆÿØŸÖ ÿßŸÑÿ™ŸÉÿ®Ÿäÿ± ŸÑÿ±ÿ§Ÿäÿ© ÿßŸÑÿ™ŸÅÿßÿµŸäŸÑ.",
                
                personInfo: "ŸÖÿπŸÑŸàŸÖÿßÿ™ ÿßŸÑŸÅÿ±ÿØ",
                print: "ÿ∑ÿ®ÿßÿπÿ©",
                edit: "ÿ™ÿπÿØŸäŸÑ",
                
                generateBook: "ÿ™ŸàŸÑŸäÿØ ŸÉÿ™ÿßÿ® ÿ¨ÿØŸäÿØ",
                
                permissionsSystem: "ŸÜÿ∏ÿßŸÖ ÿßŸÑÿµŸÑÿßÿ≠Ÿäÿßÿ™",
                permissionsInfo: "ÿßŸÑŸÖÿØŸäÿ±: ÿ¨ŸÖŸäÿπ ÿßŸÑÿµŸÑÿßÿ≠Ÿäÿßÿ™ | ÿßŸÑŸÖÿ≥ÿ™ÿÆÿØŸÖ: ÿßŸÑÿπÿ±ÿ∂ ŸàÿßŸÑÿ•ÿ∂ÿßŸÅÿ© ŸÅŸÇÿ∑",
                addNewUser: "ÿ•ÿ∂ÿßŸÅÿ© ŸÖÿ≥ÿ™ÿÆÿØŸÖ ÿ¨ÿØŸäÿØ",
                user: "ŸÖÿ≥ÿ™ÿÆÿØŸÖ",
                admin: "ŸÖÿØŸäÿ±",
                addUser: "ÿ•ÿ∂ÿßŸÅÿ© ŸÖÿ≥ÿ™ÿÆÿØŸÖ",
                usersList: "ŸÇÿßÿ¶ŸÖÿ© ÿßŸÑŸÖÿ≥ÿ™ÿÆÿØŸÖŸäŸÜ",
                username: "ÿßÿ≥ŸÖ ÿßŸÑŸÖÿ≥ÿ™ÿÆÿØŸÖ",
                role: "ÿßŸÑÿµŸÑÿßÿ≠Ÿäÿ©",
                lastLogin: "ÿ¢ÿÆÿ± ÿØÿÆŸàŸÑ",
                actions: "ÿßŸÑÿ•ÿ¨ÿ±ÿßÿ°ÿßÿ™",
                
                importInstructions: "ÿ™ÿπŸÑŸäŸÖÿßÿ™ ÿßŸÑÿßÿ≥ÿ™Ÿäÿ±ÿßÿØ",
                importInfo: "Ÿäÿ¨ÿ® ÿ£ŸÜ Ÿäÿ≠ÿ™ŸàŸä ŸÖŸÑŸÅ Excel ÿπŸÑŸâ ÿßŸÑÿ£ÿπŸÖÿØÿ© ÿßŸÑÿ™ÿßŸÑŸäÿ©: ÿßŸÑÿ±ŸÇŸÖ, ÿßŸÑÿßÿ≥ŸÖ, ÿßŸÑÿ¨ŸÜÿ≥, ÿßŸÑÿ£ÿ®, ÿßŸÑÿ£ŸÖ, ÿßŸÑÿ≤Ÿàÿ¨/ÿßŸÑÿ≤Ÿàÿ¨ÿ©",
                downloadTemplate: "ŸäŸÖŸÉŸÜŸÉ ÿ™ÿ≠ŸÖŸäŸÑ ŸÜŸÖŸàÿ∞ÿ¨ Excel ÿ¨ÿßŸáÿ≤",
                selectExcelFile: "ÿßÿÆÿ™ÿ± ŸÖŸÑŸÅ Excel",
                dataPreview: "ŸÖÿπÿßŸäŸÜÿ© ÿßŸÑÿ®ŸäÿßŸÜÿßÿ™",
                confirmImport: "ÿ™ÿ£ŸÉŸäÿØ ÿßŸÑÿßÿ≥ÿ™Ÿäÿ±ÿßÿØ",
                
                encryptionStatus: "ÿ≠ÿßŸÑÿ© ÿßŸÑÿ™ÿ¥ŸÅŸäÿ± ÿßŸÑÿ≠ÿßŸÑŸäÿ©",
                loading: "ÿ¨ÿßÿ±Ÿä ÿßŸÑÿ™ÿ≠ŸÖŸäŸÑ...",
                encryptCurrent: "ÿ™ÿ¥ŸÅŸäÿ± ÿßŸÑÿ®ŸäÿßŸÜÿßÿ™ ÿßŸÑÿ≠ÿßŸÑŸäÿ©",
                encryptPassword: "ŸÉŸÑŸÖÿ© ÿßŸÑŸÖÿ±Ÿàÿ± ŸÑŸÑÿ™ÿ¥ŸÅŸäÿ±",
                encryptPasswordPlaceholder: "ÿ£ÿØÿÆŸÑ ŸÉŸÑŸÖÿ© ŸÖÿ±Ÿàÿ± ŸÇŸàŸäÿ©",
                confirmPassword: "ÿ™ÿ£ŸÉŸäÿØ ŸÉŸÑŸÖÿ© ÿßŸÑŸÖÿ±Ÿàÿ±",
                confirmPasswordPlaceholder: "ÿ£ÿπÿØ ÿ•ÿØÿÆÿßŸÑ ŸÉŸÑŸÖÿ© ÿßŸÑŸÖÿ±Ÿàÿ±",
                encryptData: "ÿ™ÿ¥ŸÅŸäÿ± ÿßŸÑÿ®ŸäÿßŸÜÿßÿ™",
                decryptData: "ŸÅŸÉ ÿ™ÿ¥ŸÅŸäÿ± ÿßŸÑÿ®ŸäÿßŸÜÿßÿ™",
                removeEncryption: "ÿ•ÿ≤ÿßŸÑÿ© ÿßŸÑÿ™ÿ¥ŸÅŸäÿ±",
                securityTips: "ŸÜÿµÿßÿ¶ÿ≠ ÿßŸÑÿ£ŸÖÿßŸÜ",
                importantTips: "ŸÜÿµÿßÿ¶ÿ≠ ŸÖŸáŸÖÿ©:",
                tip1: "ÿßÿ≠ŸÅÿ∏ ŸÉŸÑŸÖÿ© ÿßŸÑŸÖÿ±Ÿàÿ± ŸÅŸä ŸÖŸÉÿßŸÜ ÿ¢ŸÖŸÜ",
                tip2: "ŸÑÿß ÿ™ÿ≥ÿ™ÿÆÿØŸÖ ŸÉŸÑŸÖÿßÿ™ ŸÖÿ±Ÿàÿ± ÿ®ÿ≥Ÿäÿ∑ÿ© (ÿßÿ≥ÿ™ÿÆÿØŸÖ 6 ÿ£ÿ≠ÿ±ŸÅ ÿπŸÑŸâ ÿßŸÑÿ£ŸÇŸÑ)",
                tip3: "ŸÇŸÖ ÿ®ÿπŸÖŸÑ ŸÜÿ≥ÿÆÿ© ÿßÿ≠ÿ™Ÿäÿßÿ∑Ÿäÿ© ŸÇÿ®ŸÑ ÿßŸÑÿ™ÿ¥ŸÅŸäÿ±",
                tip4: "ŸÑÿß ŸäŸÖŸÉŸÜ ÿßÿ≥ÿ™ÿπÿßÿØÿ© ÿßŸÑÿ®ŸäÿßŸÜÿßÿ™ ÿ•ÿ∞ÿß ŸÜÿ≥Ÿäÿ™ ŸÉŸÑŸÖÿ© ÿßŸÑŸÖÿ±Ÿàÿ±",
                
                preparingImage: "ÿ¨ÿßÿ±Ÿä ÿ™ÿ≠ÿ∂Ÿäÿ± ÿßŸÑÿµŸàÿ±ÿ©...",
                exportWait: "ŸÇÿØ ÿ™ÿ≥ÿ™ÿ∫ÿ±ŸÇ ÿßŸÑÿπŸÖŸÑŸäÿ© ÿ®ÿ∂ÿπ ÿ´ŸàÿßŸÜŸç"
            },
            en: {
                loginTitle: "Family Tree Management System",
                loginSubtitle: "Please login to manage family data",
                usernamePlaceholder: "Username",
                passwordPlaceholder: "Password",
                loginError: "Invalid username or password",
                loginButton: "Login",
                familyTitle: "Mohammed Abdulrahman Family Tree (Aba)",
                developerInfo: "Developed by: | Mohammed Omar Mohammed",
                
                appTitle: "Mohammed Abdulrahman Family Tree",
                welcome: "Welcome,",
                logout: "Logout",
                dashboard: "Dashboard",
                allPersons: "All Persons",
                addPerson: "Add New Person",
                searchEdit: "Search & Edit",
                statistics: "Statistics",
                treeView: "Tree View",
                backup: "Backup",
                familyBook: "Family Book",
                excelImport: "Import Excel",
                permissions: "Permissions",
                encryption: "Encryption Settings",
                familyEvents: "Family Events",
                
                totalPersons: "Total Persons",
                maleCount: "Males",
                femaleCount: "Females",
                familiesCount: "Families",
                
                familyManagement: "Family Members Management",
                addNewPerson: "Add New Person",
                refreshData: "Refresh Data",
                exportData: "Export Data",
                exportJson: "JSON",
                exportExcel: "Excel",
                exportCSV: "CSV",
                toggleSort: "Ascending / Descending",
                importData: "Import Data",
                successMessage: "Operation completed successfully",
                errorMessage: "An error occurred",
                
                tableId: "ID",
                tableName: "Full Name",
                tableGender: "Gender",
                tableBirthPlace: "Birth Place",
                tableFather: "Father",
                tableMother: "Mother",
                tableActions: "Actions",
                
                addPersonForm: "Add New Person",
                editPersonForm: "Edit Person",
                formFullName: "Full Name",
                formGender: "Gender",
                formSelectGender: "Select Gender",
                male: "Male",
                female: "Female",
                formBirthPlace: "Birth Place",
                formBirthDate: "Birth Date",
                formDeathDate: "Death Date (if applicable)",
                formFatherId: "Father ID",
                formNoFather: "None (Family Root)",
                formMotherId: "Mother ID",
                formNoMother: "None",
                formSpouseId: "Spouse ID",
                formNoSpouse: "None",
                formNotes: "Additional Notes",
                cancel: "Cancel",
                save: "Save Data",
                
                fullFamilyTree: "Complete Family Tree",
                toggleView: "Toggle View",
                exportImage: "Export Image",
                exportNormal: "Normal Image",
                exportHigh: "High Quality Image",
                exportVisible: "Visible Section Only",
                exportPDF: "PDF (Experimental)",
                mobileMode: "Mobile Mode",
                persons: "Persons",
                close: "Close",
                treeSearchPlaceholder: "Search person in tree...",
                clearSearch: "Clear Search",
                firstGeneration: "First Generation",
                treeInfo: "Click on any person to view details",
                treeTooltip: "Scroll horizontally and vertically to view all persons. Use zoom to see details.",
                
                personInfo: "Person Information",
                print: "Print",
                edit: "Edit",
                
                generateBook: "Generate New Book",
                
                permissionsSystem: "Permissions System",
                permissionsInfo: "Admin: All permissions | User: View and Add only",
                addNewUser: "Add New User",
                user: "User",
                admin: "Admin",
                addUser: "Add User",
                usersList: "Users List",
                username: "Username",
                role: "Role",
                lastLogin: "Last Login",
                actions: "Actions",
                
                importInstructions: "Import Instructions",
                importInfo: "Excel file must contain the following columns: ID, Name, Gender, Father, Mother, Spouse",
                downloadTemplate: "Download Excel Template",
                selectExcelFile: "Select Excel File",
                dataPreview: "Data Preview",
                confirmImport: "Confirm Import",
                
                encryptionStatus: "Current Encryption Status",
                loading: "Loading...",
                encryptCurrent: "Encrypt Current Data",
                encryptPassword: "Encryption Password",
                encryptPasswordPlaceholder: "Enter strong password",
                confirmPassword: "Confirm Password",
                confirmPasswordPlaceholder: "Re-enter password",
                encryptData: "Encrypt Data",
                decryptData: "Decrypt Data",
                removeEncryption: "Remove Encryption",
                securityTips: "Security Tips",
                importantTips: "Important Tips:",
                tip1: "Save password in a secure place",
                tip2: "Don't use simple passwords (use at least 6 characters)",
                tip3: "Create backup before encryption",
                tip4: "Data cannot be recovered if password is lost",
                
                preparingImage: "Preparing image...",
                exportWait: "Process may take a few seconds"
            }
        };

        // ÿ®ŸäÿßŸÜÿßÿ™ ÿßŸÑŸÖÿ≥ÿ™ÿÆÿØŸÖŸäŸÜ
        const users = {
            'admin': { password: 'mHome155', name: 'ŸÖÿØŸäÿ± ÿßŸÑŸÜÿ∏ÿßŸÖ', role: 'admin' },
            'user': { password: 'a1b2c3', name: 'ŸÖÿ≥ÿ™ÿÆÿØŸÖ', role: 'user' },
              'asma': { password: '112233', name: 'ÿßÿ≥ŸÖÿßÿ°', role: 'asma' },
            'host': { password: '123456', name: 'ŸÖÿ∂ŸäŸÅ', role: 'host' }
        };

        // ÿ™ÿ≠ÿØŸäÿ´ ÿµŸÑÿßÿ≠Ÿäÿßÿ™ ÿßŸÑŸÖÿ≥ÿ™ÿÆÿØŸÖŸäŸÜ
        const userPermissions = {
            'admin': ['view', 'add', 'edit', 'delete', 'export', 'print', 'import', 'manage_users', 'manage_events'],
             'asma': ['view', 'add', 'edit', 'export', 'print'],
             'user': ['view', 'add', 'export', 'print'],
            'host': ['view', 'print']
        };

        const defaultFamilyData = [
            {
                PersonID: 1,
                FullName: "ŸÖÿ≠ŸÖÿØ ÿπÿ®ÿØÿßŸÑÿ±ÿ≠ŸÖŸÜ ÿßÿØŸÖ",
                Gender: "ÿ∞ŸÉÿ±",
                PlaceOfBirth: "",
                BirthDate: "",
                DeathDate: "",
                FatherID: 0,
                MotherID: 0,
                SpouseID: 0,
                Notes: "ÿßŸÑÿ¨ÿØ"
            },
            {
                PersonID: 2,
                FullName: "ÿπÿßÿ¶ÿ¥ÿ© ÿßÿ®ŸÉÿ± ŸÖÿ≠ŸÖÿØ",
                Gender: "ÿßŸÜÿ´Ÿâ",
                PlaceOfBirth: "",
                BirthDate: "",
                DeathDate: "",
                FatherID: 0,
                MotherID: 0,
                SpouseID: 1,
                Notes: "ÿ≤Ÿàÿ¨ÿ© ÿßŸÑÿ¨ÿØ"
            }
        ];

        // ÿ®ŸäÿßŸÜÿßÿ™ ÿ£ŸàŸÑŸäÿ© ŸÑŸÑÿ•ÿπŸÑÿßŸÜÿßÿ™
        const defaultEvents = [
            {
                id: 'EV1',
                type: 'ŸÖŸÜÿßÿ≥ÿ®ÿ©',
                title: 'ÿßÿ¨ÿ™ŸÖÿßÿπ ÿπÿßÿ¶ŸÑŸä ÿ¥Ÿáÿ± ÿ±ŸÖÿ∂ÿßŸÜ',
                date: new Date(new Date().getFullYear(), 3, 15).toISOString().split('T')[0], // 15 ÿ£ÿ®ÿ±ŸäŸÑ
                time: '20:00',
                location: 'ŸÖŸÜÿ≤ŸÑ ÿßŸÑÿ¨ÿØ - ÿßŸÑÿ±Ÿäÿßÿ∂',
                description: 'ÿßÿ¨ÿ™ŸÖÿßÿπ ÿπÿßÿ¶ŸÑŸä ŸÑÿ™ŸÅŸÇÿØ ÿ£ÿ≠ŸàÿßŸÑ ÿßŸÑÿ£ÿ≥ÿ±ÿ© Ÿàÿ™Ÿàÿ≤Ÿäÿπ ÿßŸÑÿµÿØŸÇÿßÿ™ Ÿàÿ™ŸÜÿ∏ŸäŸÖ ÿ•ŸÅÿ∑ÿßÿ±ÿßÿ™ ÿ±ŸÖÿ∂ÿßŸÜ.',
                organizer: 'ŸÖÿ≠ŸÖÿØ ÿπÿ®ÿØÿßŸÑÿ±ÿ≠ŸÖŸÜ',
                status: 'ŸÜÿ¥ÿ∑',
                createdAt: new Date().toISOString(),
                createdBy: 'admin'
            },
            {
                id: 'EV2',
                type: 'ÿ®ÿ±ŸÜÿßŸÖÿ¨',
                title: 'ÿ®ÿ±ŸÜÿßŸÖÿ¨ ÿ™ÿπŸÑŸäŸÖŸä ŸÑŸÑÿ£ÿ®ŸÜÿßÿ°',
                date: new Date(new Date().getFullYear(), 4, 1).toISOString().split('T')[0], // 1 ŸÖÿßŸäŸà
                time: '17:00',
                location: 'ŸÖŸÉÿ™ÿ®ÿ© ÿßŸÑÿπÿßÿ¶ŸÑÿ©',
                description: 'ÿ®ÿ±ŸÜÿßŸÖÿ¨ ÿ™ÿπŸÑŸäŸÖŸä ŸÖŸÉÿ´ŸÅ ŸÑŸÑÿ£ÿ®ŸÜÿßÿ° Ÿäÿ¥ŸÖŸÑ ÿØÿ±Ÿàÿ≥ ÿ™ŸÇŸàŸäÿ© ŸàÿØŸàÿ±ÿßÿ™ ŸÖŸáÿßÿ±ÿßÿ™ ÿ≠Ÿäÿßÿ™Ÿäÿ©.',
                organizer: 'ŸÑÿ¨ŸÜÿ© ÿßŸÑÿ™ÿπŸÑŸäŸÖ ÿ®ÿßŸÑÿ£ÿ≥ÿ±ÿ©',
                status: 'ŸÜÿ¥ÿ∑',
                createdAt: new Date().toISOString(),
                createdBy: 'admin'
            }
        ];

        // ============================================
        // Ÿàÿ∏ÿßÿ¶ŸÅ ÿßŸÑÿ™ÿ±ÿ¨ŸÖÿ©
        // ============================================

        function toggleLanguage() {
            currentLanguage = currentLanguage === 'ar' ? 'en' : 'ar';
            updateLanguage();
        }

        function updateLanguage() {
            const languageText = document.getElementById('languageText');
            const loginLanguageText = document.getElementById('loginLanguageText');
            
            if (languageText) {
                languageText.textContent = currentLanguage === 'ar' ? 'EN' : 'AR';
            }
            
            if (loginLanguageText) {
                loginLanguageText.textContent = currentLanguage === 'ar' ? 'English' : 'ÿßŸÑÿπÿ±ÿ®Ÿäÿ©';
            }
            
            document.documentElement.dir = currentLanguage === 'ar' ? 'rtl' : 'ltr';
            document.documentElement.lang = currentLanguage;
            
            document.querySelectorAll('[data-i18n]').forEach(element => {
                const key = element.getAttribute('data-i18n');
                if (translations[currentLanguage][key]) {
                    element.textContent = translations[currentLanguage][key];
                }
            });
            
            document.querySelectorAll('[data-i18n-placeholder]').forEach(element => {
                const key = element.getAttribute('data-i18n-placeholder');
                if (translations[currentLanguage][key]) {
                    element.placeholder = translations[currentLanguage][key];
                }
            });
            
            if (document.getElementById('formTitle')) {
                const isEdit = document.getElementById('personId').value;
                document.getElementById('formTitle').textContent = translations[currentLanguage][isEdit ? 'editPersonForm' : 'addPersonForm'];
            }
            
            if (document.getElementById('personsTable')) {
                loadPersonsTable();
            }
        }

        // ============================================
        // ÿ™ŸáŸäÿ¶ÿ© Firebase
        // ============================================

        function initializeFirebase() {
            try {
                // ÿßŸÑÿ™ÿ≠ŸÇŸÇ ŸÖŸÜ ÿπÿØŸÖ ÿ™ŸáŸäÿ¶ÿ© Firebase ŸÖÿ≥ÿ®ŸÇÿßŸã
                if (!firebase.apps.length) {
                    firebaseApp = firebase.initializeApp(firebaseConfig);
                } else {
                    firebaseApp = firebase.app();
                }
                
                database = firebase.database();
                
                // ÿ™ŸÅÿπŸäŸÑ ÿßŸÑŸÖÿ≤ÿßŸÖŸÜÿ© ŸÖÿπ ÿßŸÑÿ≥ÿ≠ÿßÿ®ÿ©
                enableCloudSync();
                
                // ŸÖÿ±ÿßŸÇÿ®ÿ© ÿ≠ÿßŸÑÿ© ÿßŸÑÿßÿ™ÿµÿßŸÑ
                monitorConnection();
                
                console.log('‚úÖ Firebase initialized successfully');
                updateSyncStatus();
                return true;
            } catch (error) {
                console.error('‚ùå Firebase initialization failed:', error);
                showWarning('ÿ™ÿπÿ∞ÿ± ÿßŸÑÿßÿ™ÿµÿßŸÑ ÿ®ÿßŸÑÿ≥ÿ≠ÿßÿ®ÿ©. ÿ≥Ÿäÿ™ŸÖ ÿßÿ≥ÿ™ÿÆÿØÿßŸÖ ÿßŸÑÿ™ÿÆÿ≤ŸäŸÜ ÿßŸÑŸÖÿ≠ŸÑŸä ŸÅŸÇÿ∑.');
                return false;
            }
        }

        // ============================================
        // ÿ™ŸÖŸÉŸäŸÜ ÿßŸÑŸÖÿ≤ÿßŸÖŸÜÿ© ŸÖÿπ ÿßŸÑÿ≥ÿ≠ÿßÿ®ÿ©
        // ============================================

        function enableCloudSync() {
            if (!database) return false;
            
            cloudSyncEnabled = true;
            
            // ŸÖÿ≠ÿßŸàŸÑÿ© ÿ™ÿ≠ŸÖŸäŸÑ ÿßŸÑÿ®ŸäÿßŸÜÿßÿ™ ŸÖŸÜ ÿßŸÑÿ≥ÿ≠ÿßÿ®ÿ© ÿ£ŸàŸÑÿßŸã
            setTimeout(() => {
                loadDataFromCloud();
            }, 1000);
            
            // ŸÖÿ±ÿßŸÇÿ®ÿ© ÿßŸÑÿ™ÿ∫ŸäŸäÿ±ÿßÿ™ ŸÅŸä ÿßŸÑÿ≥ÿ≠ÿßÿ®ÿ© (ŸÑŸÑÿ™ÿ®ÿØŸäŸÑ ÿ®ŸäŸÜ ÿßŸÑŸÖÿ≥ÿ™ÿÆÿØŸÖŸäŸÜ)
            database.ref('familyData').on('value', (snapshot) => {
                if (snapshot.exists()) {
                    const cloudData = snapshot.val();
                    
                    // ÿ™ÿµÿ≠Ÿäÿ≠: ÿßŸÑÿ™ÿ≠ŸÇŸÇ ŸÖŸÜ ÿ£ŸÜ ÿßŸÑÿ®ŸäÿßŸÜÿßÿ™ ŸáŸä ŸÖÿµŸÅŸàŸÅÿ©
                    let dataFromCloud;
                    if (Array.isArray(cloudData)) {
                        dataFromCloud = cloudData;
                    } else {
                        // ÿ•ÿ∞ÿß ŸÉÿßŸÜÿ™ ÿßŸÑÿ®ŸäÿßŸÜÿßÿ™ ŸÉÿßÿ¶ŸÜ ŸÖÿπ ÿÆÿµÿßÿ¶ÿµ
                        dataFromCloud = Object.values(cloudData).filter(item => item && typeof item === 'object');
                        
                        // ÿ™ÿµŸÅŸäÿ© ÿßŸÑÿÆÿßÿµŸäÿ© _lastUpdated ÿ•ÿ∞ÿß ŸÉÿßŸÜÿ™ ŸÖŸàÿ¨ŸàÿØÿ©
                        dataFromCloud = dataFromCloud.filter(item => !item._lastUpdated);
                    }
                    
                    const localDataString = localStorage.getItem('familyData');
                    let localData = [];
                    
                    if (localDataString) {
                        try {
                            const parsedData = JSON.parse(localDataString);
                            if (Array.isArray(parsedData)) {
                                localData = parsedData;
                            }
                        } catch (error) {
                            console.error('Error parsing local data:', error);
                        }
                    }
                    
                    // ÿßŸÑÿ™ÿ≠ŸÇŸÇ ŸÖŸÖÿß ÿ•ÿ∞ÿß ŸÉÿßŸÜÿ™ ÿßŸÑÿ®ŸäÿßŸÜÿßÿ™ ÿπŸÑŸâ ÿßŸÑÿ≥ÿ≠ÿßÿ®ÿ© ŸÖÿÆÿ™ŸÑŸÅÿ©
                    const localDataJSON = JSON.stringify(localData.sort((a, b) => a.PersonID - b.PersonID));
                    const cloudDataJSON = JSON.stringify(dataFromCloud.sort((a, b) => a.PersonID - b.PersonID));
                    
                    if (cloudDataJSON !== localDataJSON) {
                        // ÿ≥ÿ§ÿßŸÑ ÿßŸÑŸÖÿ≥ÿ™ÿÆÿØŸÖ ÿπŸÜ ÿßŸÑÿ™ÿ≠ÿØŸäÿ´
                        if (confirm('ÿ™ŸÖ ÿ™ÿ≠ÿØŸäÿ´ ÿßŸÑÿ®ŸäÿßŸÜÿßÿ™ ÿπŸÑŸâ ÿßŸÑÿ≥ÿ≠ÿßÿ®ÿ©. ŸáŸÑ ÿ™ÿ±ŸäÿØ ÿ™ÿ≠ŸÖŸäŸÑ ÿßŸÑÿ™ÿ≠ÿØŸäÿ´ÿßÿ™ÿü')) {
                            familyData = dataFromCloud;
                            
                            // ÿ™ÿ≠ÿØŸäÿ´ nextPersonId
                            if (familyData.length > 0) {
                                const maxId = Math.max(...familyData.map(p => p.PersonID));
                                nextPersonId = maxId + 1;
                            } else {
                                nextPersonId = 1;
                            }
                            
                            // ÿ≠ŸÅÿ∏ ŸÖÿ≠ŸÑŸäÿßŸã
                            saveDataLocally();
                            
                            // ÿ™ÿ≠ÿØŸäÿ´ ÿßŸÑŸàÿßÿ¨Ÿáÿ©
                            loadDashboard();
                            
                            // ÿ•ÿ∞ÿß ŸÉÿßŸÜÿ™ ÿ¥ÿ¨ÿ±ÿ© ÿßŸÑÿπÿßÿ¶ŸÑÿ© ŸÖŸÅÿ™Ÿàÿ≠ÿ©ÿå ŸÇŸÖ ÿ®ÿ™ÿ≠ÿØŸäÿ´Ÿáÿß
                            if (document.getElementById('treeView').classList.contains('active')) {
                                renderTree();
                            }
                            
                            showSuccess('ÿ™ŸÖ ÿ™ÿ≠ÿØŸäÿ´ ÿßŸÑÿ®ŸäÿßŸÜÿßÿ™ ŸÖŸÜ ÿßŸÑÿ≥ÿ≠ÿßÿ®ÿ©');
                        }
                    }
                }
            });
            
            return true;
        }

        // ============================================
        // ÿ™ÿ≠ŸÖŸäŸÑ ÿßŸÑÿ®ŸäÿßŸÜÿßÿ™ ŸÖŸÜ ÿßŸÑÿ≥ÿ≠ÿßÿ®ÿ©
        // ============================================

        function loadDataFromCloud() {
            if (!database || !cloudSyncEnabled) return;
            
            showExportLoading('ÿ¨ÿßÿ±Ÿä ÿ™ÿ≠ŸÖŸäŸÑ ÿßŸÑÿ®ŸäÿßŸÜÿßÿ™ ŸÖŸÜ ÿßŸÑÿ≥ÿ≠ÿßÿ®ÿ©...');
            
            database.ref('familyData').once('value')
                .then((snapshot) => {
                    if (snapshot.exists()) {
                        const cloudData = snapshot.val();
                        
                        // ÿ™ÿµÿ≠Ÿäÿ≠: ÿßŸÑÿ™ÿ≠ŸÇŸÇ ŸÖŸÜ ÿ£ŸÜ ÿßŸÑÿ®ŸäÿßŸÜÿßÿ™ ŸáŸä ŸÖÿµŸÅŸàŸÅÿ©
                        let dataFromCloud;
                        if (Array.isArray(cloudData)) {
                            dataFromCloud = cloudData;
                        } else {
                            // ÿ•ÿ∞ÿß ŸÉÿßŸÜÿ™ ÿßŸÑÿ®ŸäÿßŸÜÿßÿ™ ŸÉÿßÿ¶ŸÜ ŸÖÿπ ÿÆÿµÿßÿ¶ÿµ
                            dataFromCloud = Object.values(cloudData).filter(item => item && typeof item === 'object');
                            
                            // ÿ™ÿµŸÅŸäÿ© ÿßŸÑÿÆÿßÿµŸäÿ© _lastUpdated ÿ•ÿ∞ÿß ŸÉÿßŸÜÿ™ ŸÖŸàÿ¨ŸàÿØÿ©
                            dataFromCloud = dataFromCloud.filter(item => !item._lastUpdated);
                        }
                        
                        // ŸÖŸÇÿßÿ±ŸÜÿ© ÿßŸÑÿ®ŸäÿßŸÜÿßÿ™ ÿßŸÑŸÖÿ≠ŸÑŸäÿ©
                        const localDataString = localStorage.getItem('familyData');
                        let localData = [];
                        
                        if (localDataString) {
                            try {
                                const parsedData = JSON.parse(localDataString);
                                if (Array.isArray(parsedData)) {
                                    localData = parsedData;
                                }
                            } catch (error) {
                                console.error('Error parsing local data:', error);
                            }
                        }
                        
                        // ÿßŸÑÿ™ÿ≠ŸÇŸÇ ŸÖŸÖÿß ÿ•ÿ∞ÿß ŸÉÿßŸÜÿ™ ÿßŸÑÿ®ŸäÿßŸÜÿßÿ™ ÿπŸÑŸâ ÿßŸÑÿ≥ÿ≠ÿßÿ®ÿ© ŸÖÿÆÿ™ŸÑŸÅÿ©
                        const localDataJSON = JSON.stringify(localData.sort((a, b) => a.PersonID - b.PersonID));
                        const cloudDataJSON = JSON.stringify(dataFromCloud.sort((a, b) => a.PersonID - b.PersonID));
                        
                        if (cloudDataJSON !== localDataJSON) {
                            // ÿ≥ÿ§ÿßŸÑ ÿßŸÑŸÖÿ≥ÿ™ÿÆÿØŸÖ ÿπŸÜ ÿßŸÑÿ™ÿ≠ÿØŸäÿ´
                            if (confirm('ÿ™Ÿàÿ¨ÿØ ÿ®ŸäÿßŸÜÿßÿ™ ÿ£ÿ≠ÿØÿ´ ÿπŸÑŸâ ÿßŸÑÿ≥ÿ≠ÿßÿ®ÿ©. ŸáŸÑ ÿ™ÿ±ŸäÿØ ÿ™ÿ≠ŸÖŸäŸÑŸáÿßÿü')) {
                                familyData = dataFromCloud;
                                
                                // ÿ™ÿ≠ÿØŸäÿ´ nextPersonId
                                if (familyData.length > 0) {
                                    const maxId = Math.max(...familyData.map(p => p.PersonID));
                                    nextPersonId = maxId + 1;
                                } else {
                                    nextPersonId = 1;
                                }
                                
                                // ÿ≠ŸÅÿ∏ ŸÖÿ≠ŸÑŸäÿßŸã
                                saveDataLocally();
                                
                                // ÿ™ÿ≠ÿØŸäÿ´ ÿßŸÑŸàŸÇÿ™
                                lastSyncTime = new Date();
                                
                                // ÿ™ÿµÿ≠Ÿäÿ≠: ÿ™ÿ≠ÿØŸäÿ´ Ÿàÿßÿ¨Ÿáÿ© ÿßŸÑŸÖÿ≥ÿ™ÿÆÿØŸÖ
                                loadDashboard();
                                
                                // ÿ•ÿ∞ÿß ŸÉÿßŸÜÿ™ ÿ¥ÿ¨ÿ±ÿ© ÿßŸÑÿπÿßÿ¶ŸÑÿ© ŸÖŸÅÿ™Ÿàÿ≠ÿ©ÿå ŸÇŸÖ ÿ®ÿ™ÿ≠ÿØŸäÿ´Ÿáÿß
                                if (document.getElementById('treeView').classList.contains('active')) {
                                    renderTree();
                                }
                                
                                showSuccess('ÿ™ŸÖ ÿ™ÿ≠ŸÖŸäŸÑ ÿßŸÑÿ®ŸäÿßŸÜÿßÿ™ ŸÖŸÜ ÿßŸÑÿ≥ÿ≠ÿßÿ®ÿ© ÿ®ŸÜÿ¨ÿßÿ≠');
                            }
                        } else {
                            showInfo('ÿßŸÑÿ®ŸäÿßŸÜÿßÿ™ ÿπŸÑŸâ ÿßŸÑÿ≥ÿ≠ÿßÿ®ÿ© ŸÖÿ∑ÿßÿ®ŸÇÿ© ŸÑŸÑÿ®ŸäÿßŸÜÿßÿ™ ÿßŸÑŸÖÿ≠ŸÑŸäÿ©');
                        }
                        
                        updateSyncStatus();
                    } else {
                        showInfo('ŸÑÿß ÿ™Ÿàÿ¨ÿØ ÿ®ŸäÿßŸÜÿßÿ™ ÿπŸÑŸâ ÿßŸÑÿ≥ÿ≠ÿßÿ®ÿ© ÿ®ÿπÿØ');
                    }
                })
                .catch((error) => {
                    console.error('Error loading from cloud:', error);
                    showWarning('ÿ™ÿπÿ∞ÿ± ÿ™ÿ≠ŸÖŸäŸÑ ÿßŸÑÿ®ŸäÿßŸÜÿßÿ™ ŸÖŸÜ ÿßŸÑÿ≥ÿ≠ÿßÿ®ÿ©. ÿ≥Ÿäÿ™ŸÖ ÿßÿ≥ÿ™ÿÆÿØÿßŸÖ ÿßŸÑÿ®ŸäÿßŸÜÿßÿ™ ÿßŸÑŸÖÿ≠ŸÑŸäÿ©.');
                })
                .finally(() => {
                    hideExportLoading();
                });
        }

        // ============================================
        // ÿ±ŸÅÿπ ÿßŸÑÿ®ŸäÿßŸÜÿßÿ™ ÿ•ŸÑŸâ ÿßŸÑÿ≥ÿ≠ÿßÿ®ÿ©
        // ============================================

        function saveDataToCloud() {
            if (!database || !cloudSyncEnabled || isOffline) return Promise.resolve(false);
            
            try {
                const dataToUpload = familyData; // ŸÅŸÇÿ∑ ÿßŸÑÿ®ŸäÿßŸÜÿßÿ™ ŸÜŸÅÿ≥Ÿáÿß
                
                return database.ref('familyData').set(dataToUpload)
                    .then(() => {
                        console.log('‚úÖ Data saved to cloud successfully');
                        lastSyncTime = new Date();
                        
                        // ÿ≠ŸÅÿ∏ ÿ∑ÿßÿ®ÿπ ÿ≤ŸÖŸÜŸä ŸÖŸÜŸÅÿµŸÑ
                        database.ref('lastUpdated').set({
                            timestamp: Date.now(),
                            user: currentUser,
                            totalPersons: familyData.length
                        });
                        
                        updateSyncStatus();
                        return true;
                    })
                    .catch((error) => {
                        console.error('‚ùå Error saving to cloud:', error);
                        queueForSync();
                        return false;
                    });
            } catch (error) {
                console.error('‚ùå Exception in saveDataToCloud:', error);
                queueForSync();
                return Promise.resolve(false);
            }
        }

        // ============================================
        // ŸÜÿ∏ÿßŸÖ ÿßŸÑŸÖÿ≤ÿßŸÖŸÜÿ© ÿßŸÑÿ∞ŸÉŸäÿ©
        // ============================================

        function saveData() {
            // ÿßŸÑÿ≠ŸÅÿ∏ ÿßŸÑŸÖÿ≠ŸÑŸä ÿ£ŸàŸÑÿßŸã
            const localSaved = saveDataLocally();
            
            // ÿ•ÿ∞ÿß ŸÉÿßŸÜ ÿßŸÑÿßÿ™ÿµÿßŸÑ ÿ®ÿßŸÑÿ≥ÿ≠ÿßÿ®ÿ© ŸÖŸÅÿπŸÑÿßŸãÿå ÿ≠ÿßŸàŸÑ ÿßŸÑÿ≠ŸÅÿ∏ ÿπŸÑŸâ ÿßŸÑÿ≥ÿ≠ÿßÿ®ÿ©
            if (cloudSyncEnabled && database && !isOffline) {
                if (localSaved) {
                    // ŸÖÿ≠ÿßŸàŸÑÿ© ÿßŸÑÿ≠ŸÅÿ∏ ÿπŸÑŸâ ÿßŸÑÿ≥ÿ≠ÿßÿ®ÿ© ŸÅŸä ÿßŸÑÿÆŸÑŸÅŸäÿ©
                    saveDataToCloud().then(success => {
                        if (success) {
                            console.log('‚úÖ Data synced with cloud');
                        } else {
                            console.log('‚ö† Data queued for sync');
                        }
                    });
                }
                return localSaved;
            }
            
            return localSaved;
        }

        // ============================================
        // ÿ≠ŸÅÿ∏ ÿßŸÑÿ®ŸäÿßŸÜÿßÿ™ ŸÖÿ≠ŸÑŸäÿßŸã
        // ============================================

        function saveDataLocally() {
            try {
                if (isDataEncrypted && encryptionPassword) {
                    const dataString = JSON.stringify(familyData);
                    const encryptedData = encryptText(dataString, encryptionPassword);
                    localStorage.setItem('familyData', encryptedData);
                    localStorage.setItem('isDataEncrypted', 'true');
                } else {
                    localStorage.setItem('familyData', JSON.stringify(familyData));
                    localStorage.setItem('isDataEncrypted', 'false');
                }
                
                // ÿ≠ŸÅÿ∏ ŸàŸÇÿ™ ÿßŸÑÿ™ÿ≠ÿØŸäÿ´ ÿßŸÑÿ£ÿÆŸäÿ±
                localStorage.setItem('lastSyncTimestamp', Date.now());
                localStorage.setItem('lastUserUpdate', currentUser || 'anonymous');
                
                console.log('‚úÖ Data saved locally');
                return true;
            } catch (error) {
                console.error('‚ùå Error saving locally:', error);
                showError('ŸÅÿ¥ŸÑ ÿ≠ŸÅÿ∏ ÿßŸÑÿ®ŸäÿßŸÜÿßÿ™ ŸÖÿ≠ŸÑŸäÿßŸã: ' + error.message);
                return false;
            }
        }

        // ============================================
        // ŸÇÿßÿ¶ŸÖÿ© ÿßŸÜÿ™ÿ∏ÿßÿ± ÿßŸÑŸÖÿ≤ÿßŸÖŸÜÿ©
        // ============================================

        function queueForSync() {
            const syncItem = {
                data: familyData,
                timestamp: Date.now(),
                user: currentUser
            };
            
            syncQueue.push(syncItem);
            localStorage.setItem('syncQueue', JSON.stringify(syncQueue));
            updateSyncStatus();
            
            // ŸÖÿ≠ÿßŸàŸÑÿ© ÿßŸÑŸÖÿ≤ÿßŸÖŸÜÿ© ÿπŸÜÿØ ÿßÿ≥ÿ™ÿπÿßÿØÿ© ÿßŸÑÿßÿ™ÿµÿßŸÑ
            if (syncQueue.length > 0) {
                showWarning('ŸäŸàÿ¨ÿØ ÿ®ŸäÿßŸÜÿßÿ™ ÿ∫Ÿäÿ± ŸÖÿ≤ÿßŸÖŸÜÿ©. ÿ≥Ÿäÿ™ŸÖ ŸÖÿ≠ÿßŸàŸÑÿ© ÿßŸÑŸÖÿ≤ÿßŸÖŸÜÿ© ÿπŸÜÿØ ÿßÿ≥ÿ™ÿπÿßÿØÿ© ÿßŸÑÿßÿ™ÿµÿßŸÑ.');
            }
        }

        function processSyncQueue() {
            if (syncQueue.length === 0 || !cloudSyncEnabled || isOffline) return;
            
            showExportLoading('ÿ¨ÿßÿ±Ÿä ŸÖÿ≤ÿßŸÖŸÜÿ© ÿßŸÑÿ®ŸäÿßŸÜÿßÿ™ ÿßŸÑŸÖÿπŸÑŸÇÿ©...');
            
            const item = syncQueue.shift();
            
            saveDataToCloud().then(success => {
                if (success) {
                    localStorage.setItem('syncQueue', JSON.stringify(syncQueue));
                    showSuccess('ÿ™ŸÖ ŸÖÿ≤ÿßŸÖŸÜÿ© ÿßŸÑÿ®ŸäÿßŸÜÿßÿ™ ÿßŸÑŸÖÿπŸÑŸÇÿ©');
                } else {
                    syncQueue.unshift(item); // ÿ•ÿπÿßÿØÿ© ÿ•ŸÑŸâ ÿßŸÑŸÇÿßÿ¶ŸÖÿ©
                }
                
                if (syncQueue.length > 0) {
                    setTimeout(processSyncQueue, 2000); // ŸÖÿ≠ÿßŸàŸÑÿ© ÿßŸÑÿπŸÜÿµÿ± ÿßŸÑÿ™ÿßŸÑŸä
                }
                
                hideExportLoading();
                updateSyncStatus();
            });
        }

        // ============================================
        // ŸÖÿ±ÿßŸÇÿ®ÿ© ÿ≠ÿßŸÑÿ© ÿßŸÑÿßÿ™ÿµÿßŸÑ
        // ============================================

        function monitorConnection() {
            // ŸÖÿ±ÿßŸÇÿ®ÿ© ÿßÿ™ÿµÿßŸÑ ÿßŸÑÿ•ŸÜÿ™ÿ±ŸÜÿ™
            window.addEventListener('online', () => {
                isOffline = false;
                showSuccess('ÿ™ŸÖ ÿßÿ≥ÿ™ÿπÿßÿØÿ© ÿßŸÑÿßÿ™ÿµÿßŸÑ ÿ®ÿßŸÑÿ•ŸÜÿ™ÿ±ŸÜÿ™');
                updateSyncStatus();
                
                // ŸÖÿ≠ÿßŸàŸÑÿ© ŸÖÿ≤ÿßŸÖŸÜÿ© ÿßŸÑÿ®ŸäÿßŸÜÿßÿ™ ÿßŸÑŸÖÿπŸÑŸÇÿ©
                if (syncQueue.length > 0) {
                    processSyncQueue();
                }
            });
            
            window.addEventListener('offline', () => {
                isOffline = true;
                showWarning('ŸÅŸÇÿØÿßŸÜ ÿßŸÑÿßÿ™ÿµÿßŸÑ ÿ®ÿßŸÑÿ•ŸÜÿ™ÿ±ŸÜÿ™. ÿ≥Ÿäÿ™ŸÖ ÿßŸÑÿ™ÿÆÿ≤ŸäŸÜ ŸÖÿ≠ŸÑŸäÿßŸã ŸÅŸÇÿ∑.');
                updateSyncStatus();
            });
            
            // ÿßŸÑÿ™ÿ≠ŸÇŸÇ ÿßŸÑÿ£ŸàŸÑŸä
            isOffline = !navigator.onLine;
            updateSyncStatus();
        }

        // ============================================
        // ÿ™ÿ≠ÿØŸäÿ´ ÿ≠ÿßŸÑÿ© ÿßŸÑŸÖÿ≤ÿßŸÖŸÜÿ©
        // ============================================

        function updateSyncStatus() {
            let syncStatusElement = document.getElementById('syncStatus');
            if (!syncStatusElement) {
                syncStatusElement = createSyncStatusElement();
            }
            
            let statusText = '';
            let statusClass = '';
            let icon = '';
            
            if (!cloudSyncEnabled) {
                statusText = 'ÿßŸÑŸÖÿ≤ÿßŸÖŸÜÿ© ŸÖÿπ ÿßŸÑÿ≥ÿ≠ÿßÿ®ÿ© ÿ∫Ÿäÿ± ŸÖŸÅÿπŸÑÿ©';
                statusClass = 'warning';
                icon = 'fa-cloud-slash';
            } else if (isOffline) {
                statusText = 'ÿ∫Ÿäÿ± ŸÖÿ™ÿµŸÑ - ÿßŸÑÿ™ÿÆÿ≤ŸäŸÜ ŸÖÿ≠ŸÑŸä ŸÅŸÇÿ∑';
                statusClass = 'error';
                icon = 'fa-wifi-slash';
            } else {
                statusText = `ŸÖÿ≤ÿßŸÖŸÜ ŸÖÿπ ÿßŸÑÿ≥ÿ≠ÿßÿ®ÿ© ${lastSyncTime ? formatTime(lastSyncTime) : ''}`;
                statusClass = 'success';
                icon = 'fa-cloud-check';
                
                if (syncQueue.length > 0) {
                    statusText += ` (${syncQueue.length} ŸÅŸä ŸÇÿßÿ¶ŸÖÿ© ÿßŸÑÿßŸÜÿ™ÿ∏ÿßÿ±)`;
                    statusClass = 'warning';
                    icon = 'fa-cloud-upload-alt';
                }
            }
            
            syncStatusElement.innerHTML = `
                <i class="fas ${icon}"></i>
                <span>${statusText}</span>
                ${syncQueue.length > 0 ? `<span class="sync-badge">${syncQueue.length}</span>` : ''}
            `;
            syncStatusElement.className = `sync-status ${statusClass}`;
            
            // ÿ™ÿ≠ÿØŸäÿ´ ÿ≠ÿßŸÑÿ© ÿßŸÑŸÖÿ≤ÿßŸÖŸÜÿ© ŸÅŸä ŸÜÿßŸÅÿ∞ÿ© ÿ•ÿØÿßÿ±ÿ© ÿßŸÑÿ≥ÿ≠ÿßÿ®ÿ©
            if (document.getElementById('cloudManagerModal').classList.contains('active')) {
                updateCloudManagerStatus();
            }
        }

        function createSyncStatusElement() {
            const element = document.createElement('div');
            element.id = 'syncStatus';
            element.className = 'sync-status';
            
            // ÿ•ÿ∂ÿßŸÅÿ© ÿ≤ÿ± ŸÑŸÑŸÖÿ≤ÿßŸÖŸÜÿ© ÿßŸÑŸäÿØŸàŸäÿ©
            const syncButton = document.createElement('button');
            syncButton.innerHTML = '<i class="fas fa-sync"></i>';
            syncButton.title = 'ŸÖÿ≤ÿßŸÖŸÜÿ© ŸäÿØŸàŸäÿ©';
            syncButton.onclick = forceSync;
            syncButton.className = 'sync-button';
            
            element.appendChild(syncButton);
            
            // ÿ•ÿ∂ÿßŸÅÿ© ÿ•ŸÑŸâ ÿßŸÑÿ¥ÿ±Ÿäÿ∑ ÿßŸÑÿπŸÑŸàŸä
            const userInfo = document.querySelector('.user-info');
            if (userInfo) {
                userInfo.insertBefore(element, userInfo.firstChild);
            }
            
            return element;
        }

        // ============================================
        // ÿßŸÑŸÖÿ≤ÿßŸÖŸÜÿ© ÿßŸÑŸäÿØŸàŸäÿ©
        // ============================================

        function forceSync() {
            if (!cloudSyncEnabled) {
                showWarning('ÿßŸÑŸÖÿ≤ÿßŸÖŸÜÿ© ŸÖÿπ ÿßŸÑÿ≥ÿ≠ÿßÿ®ÿ© ÿ∫Ÿäÿ± ŸÖŸÅÿπŸÑÿ©');
                return;
            }
            
            if (isOffline) {
                showWarning('ŸÑÿß ŸäŸàÿ¨ÿØ ÿßÿ™ÿµÿßŸÑ ÿ®ÿßŸÑÿ•ŸÜÿ™ÿ±ŸÜÿ™');
                return;
            }
            
            showExportLoading('ÿ¨ÿßÿ±Ÿä ÿßŸÑŸÖÿ≤ÿßŸÖŸÜÿ© ŸÖÿπ ÿßŸÑÿ≥ÿ≠ÿßÿ®ÿ©...');
            
            saveDataToCloud()
                .then((success) => {
                    if (success) {
                        showSuccess('ÿ™ŸÖÿ™ ÿßŸÑŸÖÿ≤ÿßŸÖŸÜÿ© ÿ®ŸÜÿ¨ÿßÿ≠');
                    }
                    updateSyncStatus();
                })
                .catch(error => {
                    showError('ŸÅÿ¥ŸÑÿ™ ÿßŸÑŸÖÿ≤ÿßŸÖŸÜÿ©: ' + error.message);
                })
                .finally(() => {
                    hideExportLoading();
                });
        }

        // ============================================
        // ÿßŸÑŸÜÿ≥ÿÆ ÿßŸÑÿßÿ≠ÿ™Ÿäÿßÿ∑Ÿä ÿπŸÑŸâ ÿßŸÑÿ≥ÿ≠ÿßÿ®ÿ©
        // ============================================

        function backupToCloud() {
            if (!cloudSyncEnabled || !database) {
                showError('ÿßŸÑŸÖÿ≤ÿßŸÖŸÜÿ© ŸÖÿπ ÿßŸÑÿ≥ÿ≠ÿßÿ®ÿ© ÿ∫Ÿäÿ± ŸÖŸÅÿπŸÑÿ©');
                return;
            }
            
            const confirmMessage = `ÿ≥Ÿäÿ™ŸÖ ÿ•ŸÜÿ¥ÿßÿ° ŸÜÿ≥ÿÆÿ© ÿßÿ≠ÿ™Ÿäÿßÿ∑Ÿäÿ© ÿπŸÑŸâ ÿßŸÑÿ≥ÿ≠ÿßÿ®ÿ©:
            
ÿπÿØÿØ ÿßŸÑÿ£ŸÅÿ±ÿßÿØ: ${familyData.length}
ÿ≠ÿ¨ŸÖ ÿßŸÑÿ®ŸäÿßŸÜÿßÿ™: ${JSON.stringify(familyData).length} ÿ®ÿßŸäÿ™
            
ŸáŸÑ ÿ™ÿ±ŸäÿØ ÿßŸÑŸÖÿ™ÿßÿ®ÿπÿ©ÿü`;
            
            if (confirm(confirmMessage)) {
                showExportLoading('ÿ¨ÿßÿ±Ÿä ÿ•ŸÜÿ¥ÿßÿ° ŸÜÿ≥ÿÆÿ© ÿßÿ≠ÿ™Ÿäÿßÿ∑Ÿäÿ© ÿπŸÑŸâ ÿßŸÑÿ≥ÿ≠ÿßÿ®ÿ©...');
                
                const backupData = {
                    familyData: familyData,
                    backupDate: new Date().toISOString(),
                    backupUser: currentUser,
                    statistics: {
                        total: familyData.length,
                        males: familyData.filter(p => p.Gender === 'ÿ∞ŸÉÿ±').length,
                        females: familyData.filter(p => p.Gender === 'ÿßŸÜÿ´Ÿâ').length,
                        families: familyData.filter(p => (p.FatherID === 0 && p.MotherID === 0 && !isOutsideFamily(p.PersonID))).length
                    }
                };
                
                const backupKey = `backups/${new Date().toISOString().replace(/[:.]/g, '-')}`;
                
                database.ref(backupKey).set(backupData)
                    .then(() => {
                        hideExportLoading();
                        showSuccess('ÿ™ŸÖ ÿ•ŸÜÿ¥ÿßÿ° ÿßŸÑŸÜÿ≥ÿÆÿ© ÿßŸÑÿßÿ≠ÿ™Ÿäÿßÿ∑Ÿäÿ© ÿπŸÑŸâ ÿßŸÑÿ≥ÿ≠ÿßÿ®ÿ© ÿ®ŸÜÿ¨ÿßÿ≠');
                    })
                    .catch(error => {
                        hideExportLoading();
                        showError('ŸÅÿ¥ŸÑ ÿ•ŸÜÿ¥ÿßÿ° ÿßŸÑŸÜÿ≥ÿÆÿ© ÿßŸÑÿßÿ≠ÿ™Ÿäÿßÿ∑Ÿäÿ©: ' + error.message);
                    });
            }
        }

        // ============================================
        // ŸÜÿßŸÅÿ∞ÿ© ÿ•ÿØÿßÿ±ÿ© ÿßŸÑÿ≥ÿ≠ÿßÿ®ÿ©
        // ============================================

        function showCloudManager() {
            document.getElementById('cloudManagerModal').classList.add('active');
            updateCloudManagerStatus();
            loadBackupList();
        }

        function closeCloudManager() {
            document.getElementById('cloudManagerModal').classList.remove('active');
        }

        function updateCloudManagerStatus() {
            if (document.getElementById('cloudStatus')) {
                document.getElementById('cloudStatus').textContent = cloudSyncEnabled ? '‚úì ŸÜÿ¥ÿ∑ÿ©' : '‚úó ŸÖÿπÿ∑ŸÑÿ©';
                document.getElementById('cloudStatus').className = cloudSyncEnabled ? 'status-badge success' : 'status-badge error';
                
                document.getElementById('lastSyncTime').textContent = lastSyncTime ? lastSyncTime.toLocaleString('ar-EG') : 'ŸÑŸÖ ÿ™ÿ™ŸÖ ÿßŸÑŸÖÿ≤ÿßŸÖŸÜÿ© ÿ®ÿπÿØ';
                document.getElementById('pendingSync').textContent = syncQueue.length;
                document.getElementById('pendingSync').className = syncQueue.length > 0 ? 'status-badge warning' : 'status-badge';
                
                document.getElementById('internetStatus').textContent = isOffline ? '‚úó ÿ∫Ÿäÿ± ŸÖÿ™ÿµŸÑ' : '‚úì ŸÖÿ™ÿµŸÑ';
                document.getElementById('internetStatus').className = isOffline ? 'status-badge error' : 'status-badge success';
            }
        }

        function loadBackupList() {
            if (!database) return;
            
            database.ref('backups').once('value')
                .then(snapshot => {
                    const backupList = document.getElementById('backupList');
                    if (!snapshot.exists()) {
                        backupList.innerHTML = '<p style="padding: 20px; text-align: center; color: #7cb342;">ŸÑÿß ÿ™Ÿàÿ¨ÿØ ŸÜÿ≥ÿÆ ÿßÿ≠ÿ™Ÿäÿßÿ∑Ÿäÿ©</p>';
                        return;
                    }
                    
                    const backups = [];
                    snapshot.forEach(child => {
                        backups.push({
                            key: child.key,
                            data: child.val()
                        });
                    });
                    
                    backups.sort((a, b) => new Date(b.data.backupDate) - new Date(a.data.backupDate));
                    
                    let html = '';
                    backups.forEach(backup => {
                        const date = new Date(backup.data.backupDate);
                        const stats = backup.data.statistics;
                        
                        html += `
                            <div class="backup-item">
                                <div class="backup-header">
                                    <h4 style="margin: 0; font-size: 14px;">${date.toLocaleString('ar-EG')}</h4>
                                    <span class="backup-user">ÿ®Ÿàÿßÿ≥ÿ∑ÿ©: ${backup.data.backupUser || 'ŸÖÿ¨ŸáŸàŸÑ'}</span>
                                </div>
                                <div class="backup-stats">
                                    <span><i class="fas fa-users"></i> ${stats.total} ŸÅÿ±ÿØ</span>
                                    <span><i class="fas fa-male"></i> ${stats.males} ÿ∞ŸÉÿ±</span>
                                    <span><i class="fas fa-female"></i> ${stats.females} ÿ£ŸÜÿ´Ÿâ</span>
                                    <span><i class="fas fa-home"></i> ${stats.families} ÿπÿßÿ¶ŸÑÿ©</span>
                                </div>
                                <div class="backup-actions">
                                    <button class="btn btn-sm btn-success" onclick="restoreFromBackup('${backup.key}')">
                                        <i class="fas fa-redo"></i> ÿßÿ≥ÿ™ÿπÿßÿØÿ©
                                    </button>
                                    <button class="btn btn-sm btn-danger" onclick="deleteBackup('${backup.key}')">
                                        <i class="fas fa-trash"></i> ÿ≠ÿ∞ŸÅ
                                    </button>
                                </div>
                            </div>
                        `;
                    });
                    
                    backupList.innerHTML = html;
                })
                .catch(error => {
                    console.error('Error loading backups:', error);
                    showError('ŸÅÿ¥ŸÑ ÿ™ÿ≠ŸÖŸäŸÑ ŸÇÿßÿ¶ŸÖÿ© ÿßŸÑŸÜÿ≥ÿÆ ÿßŸÑÿßÿ≠ÿ™Ÿäÿßÿ∑Ÿäÿ©');
                });
        }

        function restoreFromBackup(backupKey) {
            if (!confirm('ÿ™ÿ≠ÿ∞Ÿäÿ±: ÿ≥Ÿäÿ™ŸÖ ÿßÿ≥ÿ™ÿ®ÿØÿßŸÑ ÿ¨ŸÖŸäÿπ ÿßŸÑÿ®ŸäÿßŸÜÿßÿ™ ÿßŸÑÿ≠ÿßŸÑŸäÿ© ÿ®ÿßŸÑŸÜÿ≥ÿÆÿ© ÿßŸÑÿßÿ≠ÿ™Ÿäÿßÿ∑Ÿäÿ©. ŸáŸÑ ÿ™ÿ±ŸäÿØ ÿßŸÑŸÖÿ™ÿßÿ®ÿπÿ©ÿü')) {
                return;
            }
            
            database.ref(`backups/${backupKey}`).once('value')
                .then(snapshot => {
                    if (snapshot.exists()) {
                        const backupData = snapshot.val();
                        familyData = backupData.familyData;
                        
                        if (saveData()) {
                            showSuccess('ÿ™ŸÖ ÿßÿ≥ÿ™ÿπÿßÿØÿ© ÿßŸÑŸÜÿ≥ÿÆÿ© ÿßŸÑÿßÿ≠ÿ™Ÿäÿßÿ∑Ÿäÿ© ÿ®ŸÜÿ¨ÿßÿ≠');
                            loadDashboard();
                            closeCloudManager();
                        }
                    }
                })
                .catch(error => {
                    showError('ŸÅÿ¥ŸÑ ÿßÿ≥ÿ™ÿπÿßÿØÿ© ÿßŸÑŸÜÿ≥ÿÆÿ© ÿßŸÑÿßÿ≠ÿ™Ÿäÿßÿ∑Ÿäÿ©: ' + error.message);
                });
        }

        function deleteBackup(backupKey) {
            if (!confirm('ŸáŸÑ ÿ™ÿ±ŸäÿØ ÿ≠ÿ∞ŸÅ Ÿáÿ∞Ÿá ÿßŸÑŸÜÿ≥ÿÆÿ© ÿßŸÑÿßÿ≠ÿ™Ÿäÿßÿ∑Ÿäÿ©ÿü')) {
                return;
            }
            
            database.ref(`backups/${backupKey}`).remove()
                .then(() => {
                    showSuccess('ÿ™ŸÖ ÿ≠ÿ∞ŸÅ ÿßŸÑŸÜÿ≥ÿÆÿ© ÿßŸÑÿßÿ≠ÿ™Ÿäÿßÿ∑Ÿäÿ© ÿ®ŸÜÿ¨ÿßÿ≠');
                    loadBackupList();
                })
                .catch(error => {
                    showError('ŸÅÿ¥ŸÑ ÿ≠ÿ∞ŸÅ ÿßŸÑŸÜÿ≥ÿÆÿ© ÿßŸÑÿßÿ≠ÿ™Ÿäÿßÿ∑Ÿäÿ©: ' + error.message);
                });
        }

        function clearSyncQueue() {
            if (syncQueue.length === 0) {
                showInfo('ŸÑÿß ÿ™Ÿàÿ¨ÿØ ÿ®ŸäÿßŸÜÿßÿ™ ŸÅŸä ŸÇÿßÿ¶ŸÖÿ© ÿßŸÑÿßŸÜÿ™ÿ∏ÿßÿ±');
                return;
            }
            
            if (confirm(`ŸáŸÑ ÿ™ÿ±ŸäÿØ ŸÖÿ≥ÿ≠ ${syncQueue.length} ÿπŸÜÿµÿ± ŸÖŸÜ ŸÇÿßÿ¶ŸÖÿ© ÿßŸÜÿ™ÿ∏ÿßÿ± ÿßŸÑŸÖÿ≤ÿßŸÖŸÜÿ©ÿü`)) {
                syncQueue = [];
                localStorage.removeItem('syncQueue');
                showSuccess('ÿ™ŸÖ ŸÖÿ≥ÿ≠ ŸÇÿßÿ¶ŸÖÿ© ÿßŸÑÿßŸÜÿ™ÿ∏ÿßÿ± ÿ®ŸÜÿ¨ÿßÿ≠');
                updateCloudManagerStatus();
                updateSyncStatus();
            }
        }

        function showCloudStatistics() {
            const stats = {
                totalBackups: 0,
                totalSize: 0,
                lastBackup: null
            };
            
            if (database) {
                database.ref('backups').once('value')
                    .then(snapshot => {
                        if (snapshot.exists()) {
                            stats.totalBackups = snapshot.numChildren();
                            
                            let totalSize = 0;
                            let lastBackup = null;
                            
                            snapshot.forEach(child => {
                                const backup = child.val();
                                totalSize += JSON.stringify(backup).length;
                                                                const backupDate = new Date(backup.backupDate);
                                if (!lastBackup || backupDate > lastBackup) {
                                    lastBackup = backupDate;
                                }
                            });
                            
                            stats.totalSize = (totalSize / 1024).toFixed(2) + ' KB';
                            stats.lastBackup = lastBackup ? lastBackup.toLocaleString('ar-EG') : 'ŸÑÿß ŸäŸàÿ¨ÿØ';
                            
                            alert(`
                                ÿ•ÿ≠ÿµÿßÿ¶Ÿäÿßÿ™ ÿßŸÑÿ≥ÿ≠ÿßÿ®ÿ©:
                                
                                ÿπÿØÿØ ÿßŸÑŸÜÿ≥ÿÆ ÿßŸÑÿßÿ≠ÿ™Ÿäÿßÿ∑Ÿäÿ©: ${stats.totalBackups}
                                ÿßŸÑÿ≠ÿ¨ŸÖ ÿßŸÑÿ•ÿ¨ŸÖÿßŸÑŸä: ${stats.totalSize}
                                ÿ¢ÿÆÿ± ŸÜÿ≥ÿÆÿ© ÿßÿ≠ÿ™Ÿäÿßÿ∑Ÿäÿ©: ${stats.lastBackup}
                                ÿ®ŸäÿßŸÜÿßÿ™ ŸÅŸä ŸÇÿßÿ¶ŸÖÿ© ÿßŸÑÿßŸÜÿ™ÿ∏ÿßÿ±: ${syncQueue.length}
                                ÿ≠ÿßŸÑÿ© ÿßŸÑŸÖÿ≤ÿßŸÖŸÜÿ©: ${cloudSyncEnabled ? 'ŸÖŸÅÿπŸÑÿ©' : 'ŸÖÿπÿ∑ŸÑÿ©'}
                                ÿ≠ÿßŸÑÿ© ÿßŸÑÿ•ŸÜÿ™ÿ±ŸÜÿ™: ${isOffline ? 'ÿ∫Ÿäÿ± ŸÖÿ™ÿµŸÑ' : 'ŸÖÿ™ÿµŸÑ'}
                            `);
                        } else {
                            alert('ŸÑÿß ÿ™Ÿàÿ¨ÿØ ŸÜÿ≥ÿÆ ÿßÿ≠ÿ™Ÿäÿßÿ∑Ÿäÿ© ÿπŸÑŸâ ÿßŸÑÿ≥ÿ≠ÿßÿ®ÿ©');
                        }
                    })
                    .catch(error => {
                        showError('ŸÅÿ¥ŸÑ ÿ™ÿ≠ŸÖŸäŸÑ ÿ•ÿ≠ÿµÿßÿ¶Ÿäÿßÿ™ ÿßŸÑÿ≥ÿ≠ÿßÿ®ÿ©: ' + error.message);
                    });
            }
        }

        // ============================================
        // Ÿàÿ∏ÿßÿ¶ŸÅ ŸÖÿ≥ÿßÿπÿØÿ©
        // ============================================

        function formatTime(date) {
            if (!date) return '';
            const now = new Date();
            const diff = now - date;
            
            const minutes = Math.floor(diff / 60000);
            const hours = Math.floor(diff / 3600000);
            const days = Math.floor(diff / 86400000);
            
            if (minutes < 1) return '(ÿßŸÑÿ¢ŸÜ)';
            if (minutes < 60) return `(ŸÇÿ®ŸÑ ${minutes} ÿØŸÇŸäŸÇÿ©)`;
            if (hours < 24) return `(ŸÇÿ®ŸÑ ${hours} ÿ≥ÿßÿπÿ©)`;
            return `(ŸÇÿ®ŸÑ ${days} ŸäŸàŸÖ)`;
        }

        // ============================================
        // ÿØŸàÿßŸÑ ÿßŸÑÿ™ÿ¥ŸÅŸäÿ±
        // ============================================

        function encryptText(text, password) {
            try {
                let combined = password + "::" + text;
                return btoa(unescape(encodeURIComponent(combined)));
            } catch (error) {
                console.error('ÿÆÿ∑ÿ£ ŸÅŸä ÿßŸÑÿ™ÿ¥ŸÅŸäÿ±:', error);
                throw new Error('ŸÅÿ¥ŸÑ ÿ™ÿ¥ŸÅŸäÿ± ÿßŸÑÿ®ŸäÿßŸÜÿßÿ™');
            }
        }

        function decryptText(encryptedText, password) {
            try {
                let decoded = decodeURIComponent(escape(atob(encryptedText)));
                let parts = decoded.split("::");
                if (parts.length !== 2) {
                    throw new Error('ÿ™ŸÜÿ≥ŸäŸÇ ÿßŸÑÿ®ŸäÿßŸÜÿßÿ™ ÿ∫Ÿäÿ± ÿµÿ≠Ÿäÿ≠');
                }
                if (parts[0] !== password) {
                    throw new Error('ŸÉŸÑŸÖÿ© ÿßŸÑŸÖÿ±Ÿàÿ± ÿ∫Ÿäÿ± ÿµÿ≠Ÿäÿ≠ÿ©');
                }
                return parts[1];
            } catch (error) {
                console.error('ÿÆÿ∑ÿ£ ŸÅŸä ŸÅŸÉ ÿßŸÑÿ™ÿ¥ŸÅŸäÿ±:', error);
                throw new Error('ŸÅÿ¥ŸÑ ŸÅŸÉ ÿ™ÿ¥ŸÅŸäÿ± ÿßŸÑÿ®ŸäÿßŸÜÿßÿ™');
            }
        }

        // ============================================
        // ÿØŸàÿßŸÑ ÿ™ÿµÿØŸäÿ± Excel ŸÖÿ™ÿ∑Ÿàÿ±ÿ©
        // ============================================

        function exportData(format = 'json') {
            if (!checkPermission('export')) {
                showError(translations[currentLanguage].errorMessage);
                return;
            }
            
            switch(format) {
                case 'json':
                    exportDataJSON();
                    break;
                case 'excel':
                    exportDataExcel();
                    break;
                case 'csv':
                    exportDataCSV();
                    break;
                default:
                    exportDataJSON();
            }
        }

        function exportFullExcel() {
            exportDataExcelAdvanced();
        }

        function exportDataExcel() {
            try {
                const wsData = [
                    ['ID', 'ÿßŸÑÿßÿ≥ŸÖ ÿßŸÑŸÉÿßŸÖŸÑ', 'ÿßŸÑÿ¨ŸÜÿ≥', 'ŸÖŸÉÿßŸÜ ÿßŸÑŸÖŸäŸÑÿßÿØ', 'ÿ™ÿßÿ±ŸäÿÆ ÿßŸÑŸÖŸäŸÑÿßÿØ', 
                     'ÿ™ÿßÿ±ŸäÿÆ ÿßŸÑŸàŸÅÿßÿ©', 'ÿ±ŸÇŸÖ ÿßŸÑÿ£ÿ®', 'ÿ±ŸÇŸÖ ÿßŸÑÿ£ŸÖ', 'ÿ±ŸÇŸÖ ÿßŸÑÿ≤Ÿàÿ¨/ÿßŸÑÿ≤Ÿàÿ¨ÿ©', 'ŸÖŸÑÿßÿ≠ÿ∏ÿßÿ™']
                ];
                
                familyData.forEach(person => {
                    wsData.push([
                        person.PersonID,
                        person.FullName,
                        person.Gender,
                        person.PlaceOfBirth || '',
                        person.BirthDate || '',
                        person.DeathDate || '',
                        person.FatherID || 0,
                        person.MotherID || 0,
                        person.SpouseID || 0,
                        person.Notes || ''
                    ]);
                });
                
                const ws = XLSX.utils.aoa_to_sheet(wsData);
                const wb = XLSX.utils.book_new();
                XLSX.utils.book_append_sheet(wb, ws, 'ÿ¥ÿ¨ÿ±ÿ© ÿßŸÑÿπÿßÿ¶ŸÑÿ©');
                
                const fileName = `ÿ¥ÿ¨ÿ±ÿ©-ÿßŸÑÿπÿßÿ¶ŸÑÿ©-${new Date().toISOString().split('T')[0]}.xlsx`;
                XLSX.writeFile(wb, fileName);
                
                showSuccess('ÿ™ŸÖ ÿ™ÿµÿØŸäÿ± ÿßŸÑÿ®ŸäÿßŸÜÿßÿ™ ÿ•ŸÑŸâ Excel ÿ®ŸÜÿ¨ÿßÿ≠');
            } catch (error) {
                console.error('Excel export error:', error);
                showError('ŸÅÿ¥ŸÑ ÿßŸÑÿ™ÿµÿØŸäÿ±: ' + error.message);
            }
        }

        function exportDataExcelAdvanced() {
            try {
                // Ÿàÿ±ŸÇÿ© ÿßŸÑÿ®ŸäÿßŸÜÿßÿ™ ÿßŸÑÿ£ÿ≥ÿßÿ≥Ÿäÿ©
                const wsData = [
                    ['ÿßŸÑÿ±ŸÇŸÖ', 'ÿßŸÑÿßÿ≥ŸÖ ÿßŸÑŸÉÿßŸÖŸÑ', 'ÿßŸÑÿ¨ŸÜÿ≥', 'ŸÖŸÉÿßŸÜ ÿßŸÑŸÖŸäŸÑÿßÿØ', 'ÿ™ÿßÿ±ŸäÿÆ ÿßŸÑŸÖŸäŸÑÿßÿØ', 
                     'ÿ™ÿßÿ±ŸäÿÆ ÿßŸÑŸàŸÅÿßÿ©', 'ÿ±ŸÇŸÖ ÿßŸÑÿ£ÿ®', 'ÿßÿ≥ŸÖ ÿßŸÑÿ£ÿ®', 'ÿ±ŸÇŸÖ ÿßŸÑÿ£ŸÖ', 'ÿßÿ≥ŸÖ ÿßŸÑÿ£ŸÖ', 
                     'ÿ±ŸÇŸÖ ÿßŸÑÿ≤Ÿàÿ¨/ÿßŸÑÿ≤Ÿàÿ¨ÿ©', 'ÿßÿ≥ŸÖ ÿßŸÑÿ≤Ÿàÿ¨/ÿßŸÑÿ≤Ÿàÿ¨ÿ©', 'ŸÖŸÑÿßÿ≠ÿ∏ÿßÿ™', 'ÿßŸÑÿ¨ŸäŸÑ']
                ];
                
                familyData.forEach(person => {
                    const father = familyData.find(p => p.PersonID === person.FatherID);
                    const mother = familyData.find(p => p.PersonID === person.MotherID);
                    const spouse = familyData.find(p => p.PersonID === person.SpouseID);
                    const generation = calculateGeneration(person.PersonID);
                    
                    wsData.push([
                        person.PersonID,
                        person.FullName,
                        person.Gender,
                        person.PlaceOfBirth || '',
                        person.BirthDate || '',
                        person.DeathDate || '',
                        person.FatherID || 0,
                        father ? father.FullName : '',
                        person.MotherID || 0,
                        mother ? mother.FullName : '',
                        person.SpouseID || 0,
                        spouse ? spouse.FullName : '',
                        person.Notes || '',
                        generation
                    ]);
                });
                
                const ws = XLSX.utils.aoa_to_sheet(wsData);
                
                // ÿ™ÿ≠ÿ≥ŸäŸÜ ÿ™ŸÜÿ≥ŸäŸÇ ÿßŸÑÿ£ÿπŸÖÿØÿ©
                const wscols = [
                    {wch: 6},   // ÿßŸÑÿ±ŸÇŸÖ
                    {wch: 30},  // ÿßŸÑÿßÿ≥ŸÖ
                    {wch: 8},   // ÿßŸÑÿ¨ŸÜÿ≥
                    {wch: 20},  // ŸÖŸÉÿßŸÜ ÿßŸÑŸÖŸäŸÑÿßÿØ
                    {wch: 12},  // ÿ™ÿßÿ±ŸäÿÆ ÿßŸÑŸÖŸäŸÑÿßÿØ
                    {wch: 12},  // ÿ™ÿßÿ±ŸäÿÆ ÿßŸÑŸàŸÅÿßÿ©
                    {wch: 8},   // ÿ±ŸÇŸÖ ÿßŸÑÿ£ÿ®
                    {wch: 20},  // ÿßÿ≥ŸÖ ÿßŸÑÿ£ÿ®
                    {wch: 8},   // ÿ±ŸÇŸÖ ÿßŸÑÿ£ŸÖ
                    {wch: 20},  // ÿßÿ≥ŸÖ ÿßŸÑÿ£ŸÖ
                    {wch: 12},  // ÿ±ŸÇŸÖ ÿßŸÑÿ≤Ÿàÿ¨
                    {wch: 20},  // ÿßÿ≥ŸÖ ÿßŸÑÿ≤Ÿàÿ¨
                    {wch: 40},  // ŸÖŸÑÿßÿ≠ÿ∏ÿßÿ™
                    {wch: 6}    // ÿßŸÑÿ¨ŸäŸÑ
                ];
                ws['!cols'] = wscols;
                
                // ÿ™ŸÜÿ≥ŸäŸÇ ÿßŸÑÿ±ÿ£ÿ≥
                const range = XLSX.utils.decode_range(ws['!ref']);
                for (let C = range.s.c; C <= range.e.c; ++C) {
                    const cell_address = {c:C, r:0};
                    const cell_ref = XLSX.utils.encode_cell(cell_address);
                    if (!ws[cell_ref]) continue;
                    ws[cell_ref].s = {
                        fill: {fgColor: {rgb: "E8F5E9"}},
                        font: {bold: true, color: {rgb: "1B5E20"}},
                        alignment: {horizontal: 'center'}
                    };
                }
                
                // ÿ•ŸÜÿ¥ÿßÿ° Ÿàÿ±ŸÇÿ© ŸÑŸÑÿ•ÿ≠ÿµÿßÿ¶Ÿäÿßÿ™
                const statsData = [
                    ['ÿ•ÿ≠ÿµÿßÿ¶Ÿäÿßÿ™ ÿ¥ÿ¨ÿ±ÿ© ÿßŸÑÿπÿßÿ¶ŸÑÿ©', ''],
                    ['ÿ™ÿßÿ±ŸäÿÆ ÿßŸÑÿ™ÿµÿØŸäÿ±', new Date().toLocaleDateString('ar-EG')],
                    ['ÿ•ÿ¨ŸÖÿßŸÑŸä ÿπÿØÿØ ÿßŸÑÿ£ŸÅÿ±ÿßÿØ', familyData.length],
                    ['ÿπÿØÿØ ÿßŸÑÿ∞ŸÉŸàÿ±', familyData.filter(p => p.Gender === 'ÿ∞ŸÉÿ±').length],
                    ['ÿπÿØÿØ ÿßŸÑÿ•ŸÜÿßÿ´', familyData.filter(p => p.Gender === 'ÿßŸÜÿ´Ÿâ').length],
                    ['ÿπÿØÿØ ÿßŸÑŸÖÿ™ÿ≤Ÿàÿ¨ŸäŸÜ', familyData.filter(p => p.SpouseID !== 0).length],
                    ['ÿπÿØÿØ ÿßŸÑÿ£ÿ≠Ÿäÿßÿ°', familyData.filter(p => !p.DeathDate || p.DeathDate === '').length],
                    ['ÿπÿØÿØ ÿßŸÑÿ£ÿ¨ŸäÿßŸÑ', new Set(familyData.map(p => calculateGeneration(p.PersonID))).size]
                ];
                
                const wsStats = XLSX.utils.aoa_to_sheet(statsData);
                
                const wb = XLSX.utils.book_new();
                XLSX.utils.book_append_sheet(wb, ws, 'ÿ®ŸäÿßŸÜÿßÿ™ ÿßŸÑÿπÿßÿ¶ŸÑÿ©');
                XLSX.utils.book_append_sheet(wb, wsStats, 'ÿßŸÑÿ•ÿ≠ÿµÿßÿ¶Ÿäÿßÿ™');
                
                const fileName = `ÿ¥ÿ¨ÿ±ÿ©-ÿßŸÑÿπÿßÿ¶ŸÑÿ©-ŸÖÿ™ŸÇÿØŸÖ-${new Date().toISOString().split('T')[0]}.xlsx`;
                XLSX.writeFile(wb, fileName);
                
                showSuccess('ÿ™ŸÖ ÿ™ÿµÿØŸäÿ± ÿßŸÑÿ®ŸäÿßŸÜÿßÿ™ ÿßŸÑŸÖÿ™ŸÇÿØŸÖÿ© ÿ•ŸÑŸâ Excel ÿ®ŸÜÿ¨ÿßÿ≠');
                
            } catch (error) {
                console.error('Advanced Excel export error:', error);
                showError('ŸÅÿ¥ŸÑ ÿßŸÑÿ™ÿµÿØŸäÿ± ÿßŸÑŸÖÿ™ŸÇÿØŸÖ: ' + error.message);
            }
        }

        function exportDataJSON() {
            const dataStr = JSON.stringify(familyData, null, 2);
            const dataUri = 'data:application/json;charset=utf-8,'+ encodeURIComponent(dataStr);
            const exportFileDefaultName = `family-tree-${new Date().toISOString().split('T')[0]}.json`;
            const linkElement = document.createElement('a');
            linkElement.setAttribute('href', dataUri);
            linkElement.setAttribute('download', exportFileDefaultName);
            linkElement.click();
            showSuccess(translations[currentLanguage].successMessage);
        }

        function exportDataCSV() {
            try {
                let csvContent = 'ID,Full Name,Gender,Birth Place,Birth Date,Death Date,Father ID,Mother ID,Spouse ID,Notes\n';
                
                familyData.forEach(person => {
                    const row = [
                        person.PersonID,
                        `"${person.FullName.replace(/"/g, '""')}"`,
                        person.Gender,
                        `"${(person.PlaceOfBirth || '').replace(/"/g, '""')}"`,
                        person.BirthDate || '',
                        person.DeathDate || '',
                        person.FatherID || 0,
                        person.MotherID || 0,
                        person.SpouseID || 0,
                        `"${(person.Notes || '').replace(/"/g, '""')}"`
                    ];
                    csvContent += row.join(',') + '\n';
                });
                
                // ÿ™ÿµÿ≠Ÿäÿ≠: ÿ•ÿ∂ÿßŸÅÿ© BOM ŸÑÿØÿπŸÖ ÿßŸÑŸÑÿ∫ÿ© ÿßŸÑÿπÿ±ÿ®Ÿäÿ© ŸÅŸä Excel
                const blob = new Blob(['\uFEFF' + csvContent], { type: 'text/csv;charset=utf-8;' });
                const link = document.createElement('a');
                const url = URL.createObjectURL(blob);
                link.setAttribute('href', url);
                link.setAttribute('download', `family-tree-${new Date().toISOString().split('T')[0]}.csv`);
                link.style.visibility = 'hidden';
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
                
                showSuccess(translations[currentLanguage].successMessage);
            } catch (error) {
                console.error('CSV export error:', error);
                showError('Export failed: ' + error.message);
            }
        }

        function toggleExportMenu() {
            const menu = document.getElementById('exportMenu');
            menu.classList.toggle('show');
            
            setTimeout(() => {
                const closeMenuHandler = function(e) {
                    if (!menu.contains(e.target) && !e.target.closest('.export-options')) {
                        menu.classList.remove('show');
                        document.removeEventListener('click', closeMenuHandler);
                    }
                };
                document.addEventListener('click', closeMenuHandler);
            }, 10);
        }

        function toggleTreeExportMenu() {
            const menu = document.getElementById('treeExportMenu');
            menu.classList.toggle('show');
            
            setTimeout(() => {
                const closeMenuHandler = function(e) {
                    if (!menu.contains(e.target) && !e.target.closest('.export-options')) {
                        menu.classList.remove('show');
                        document.removeEventListener('click', closeMenuHandler);
                    }
                };
                document.addEventListener('click', closeMenuHandler);
            }, 10);
        }

        // ============================================
        // ÿØŸàÿßŸÑ ÿßÿ≥ÿ™Ÿäÿ±ÿßÿØ Excel ŸÖÿ≠ÿ≥ŸÜÿ©
        // ============================================

        function showExcelImport() {
            if (!checkPermission('import')) {
                showError('ŸÑÿß ÿ™ŸÖŸÑŸÉ ÿµŸÑÿßÿ≠Ÿäÿ© ÿßŸÑÿßÿ≥ÿ™Ÿäÿ±ÿßÿØ');
                return;
            }
            
            document.getElementById('excelImportModal').classList.add('active');
        }

        function closeExcelImport() {
            document.getElementById('excelImportModal').classList.remove('active');
            excelData = [];
            document.getElementById('excelPreview').style.display = 'none';
            document.getElementById('excelFile').value = '';
        }

        function downloadExcelTemplate() {
            const template = [
                ['ÿßŸÑÿ±ŸÇŸÖ', 'ÿßŸÑÿßÿ≥ŸÖ ÿßŸÑŸÉÿßŸÖŸÑ', 'ÿßŸÑÿ¨ŸÜÿ≥', 'ŸÖŸÉÿßŸÜ ÿßŸÑŸÖŸäŸÑÿßÿØ', 'ÿ™ÿßÿ±ŸäÿÆ ÿßŸÑŸÖŸäŸÑÿßÿØ', 'ÿ™ÿßÿ±ŸäÿÆ ÿßŸÑŸàŸÅÿßÿ©', 'ÿ±ŸÇŸÖ ÿßŸÑÿ£ÿ®', 'ÿ±ŸÇŸÖ ÿßŸÑÿ£ŸÖ', 'ÿ±ŸÇŸÖ ÿßŸÑÿ≤Ÿàÿ¨/ÿßŸÑÿ≤Ÿàÿ¨ÿ©', 'ŸÖŸÑÿßÿ≠ÿ∏ÿßÿ™'],
                [1, 'ŸÖÿ≠ŸÖÿØ ÿπÿ®ÿØÿßŸÑÿ±ÿ≠ŸÖŸÜ ÿßÿØŸÖ', 'ÿ∞ŸÉÿ±', '', '', '', 0, 0, 0, 'ÿßŸÑÿ¨ÿØ'],
                [2, 'ÿπÿßÿ¶ÿ¥ÿ© ÿßÿ®ŸÉÿ± ŸÖÿ≠ŸÖÿØ', 'ÿßŸÜÿ´Ÿâ', '', '', '', 0, 0, 1, 'ÿ≤Ÿàÿ¨ÿ© ÿßŸÑÿ¨ÿØ'],
                [3, 'ŸÖÿ≠ŸÖÿØ ŸÖÿ≠ŸÖÿØ ÿπÿ®ÿØÿßŸÑÿ±ÿ≠ŸÖŸÜ', 'ÿ∞ŸÉÿ±', '', '', '', 1, 2, 0, 'ÿßŸÑÿßÿ®ŸÜ ÿßŸÑÿßŸàŸÑ'],
                [4, 'ÿßÿ≠ŸÖÿØ ŸÖÿ≠ŸÖÿØ ÿπÿ®ÿØÿßŸÑÿ±ÿ≠ŸÖŸÜ', 'ÿ∞ŸÉÿ±', '', '', '', 1, 2, 0, ''],
                [5, 'ÿßÿ®ŸÉÿ± ŸÖÿ≠ŸÖÿØ ÿπÿ®ÿØÿßŸÑÿ±ÿ≠ŸÖŸÜ', 'ÿ∞ŸÉÿ±', '', '', '', 1, 2, 0, '']
            ];
            
            const ws = XLSX.utils.aoa_to_sheet(template);
            
            // ÿ™ŸÜÿ≥ŸäŸÇ ÿßŸÑÿ£ÿπŸÖÿØÿ©
            const wscols = [
                {wch: 6},   // ÿßŸÑÿ±ŸÇŸÖ
                {wch: 30},  // ÿßŸÑÿßÿ≥ŸÖ
                {wch: 8},   // ÿßŸÑÿ¨ŸÜÿ≥
                {wch: 20},  // ŸÖŸÉÿßŸÜ ÿßŸÑŸÖŸäŸÑÿßÿØ
                {wch: 12},  // ÿ™ÿßÿ±ŸäÿÆ ÿßŸÑŸÖŸäŸÑÿßÿØ
                {wch: 12},  // ÿ™ÿßÿ±ŸäÿÆ ÿßŸÑŸàŸÅÿßÿ©
                {wch: 8},   // ÿ±ŸÇŸÖ ÿßŸÑÿ£ÿ®
                {wch: 8},   // ÿ±ŸÇŸÖ ÿßŸÑÿ£ŸÖ
                {wch: 12},  // ÿ±ŸÇŸÖ ÿßŸÑÿ≤Ÿàÿ¨
                {wch: 40}   // ŸÖŸÑÿßÿ≠ÿ∏ÿßÿ™
            ];
            ws['!cols'] = wscols;
            
            // ÿ™ŸÜÿ≥ŸäŸÇ ÿßŸÑÿ±ÿ£ÿ≥
            const range = XLSX.utils.decode_range(ws['!ref']);
            for (let C = range.s.c; C <= range.e.c; ++C) {
                const cell_address = {c:C, r:0};
                const cell_ref = XLSX.utils.encode_cell(cell_address);
                if (!ws[cell_ref]) continue;
                ws[cell_ref].s = {
                    fill: {fgColor: {rgb: "E8F5E9"}},
                    font: {bold: true, color: {rgb: "1B5E20"}}
                };
            }
            
            const wb = XLSX.utils.book_new();
            XLSX.utils.book_append_sheet(wb, ws, 'ÿ¥ÿ¨ÿ±ÿ© ÿßŸÑÿπÿßÿ¶ŸÑÿ©');
            
            // ÿ•ÿ∂ÿßŸÅÿ© Ÿàÿ±ŸÇÿ© ÿßŸÑÿ™ÿπŸÑŸäŸÖÿßÿ™
            const instructions = [
                ['ÿ™ÿπŸÑŸäŸÖÿßÿ™ ÿßÿ≥ÿ™Ÿäÿ±ÿßÿØ ÿßŸÑÿ®ŸäÿßŸÜÿßÿ™'],
                [''],
                ['1. ÿßÿ≠ÿ™ŸÅÿ∏ ÿ®ÿ™ŸÜÿ≥ŸäŸÇ ÿßŸÑÿ£ÿπŸÖÿØÿ© ŸÉŸÖÿß ŸáŸà'],
                ['2. ÿßŸÑÿ±ŸÇŸÖ: Ÿäÿ¨ÿ® ÿ£ŸÜ ŸäŸÉŸàŸÜ ŸÅÿ±ŸäÿØÿßŸã ŸÑŸÉŸÑ ŸÅÿ±ÿØ'],
                ['3. ÿßŸÑÿ¨ŸÜÿ≥: ÿ•ŸÖÿß "ÿ∞ŸÉÿ±" ÿ£Ÿà "ÿßŸÜÿ´Ÿâ"'],
                ['4. ÿ±ŸÇŸÖ ÿßŸÑÿ£ÿ®/ÿßŸÑÿ£ŸÖ/ÿßŸÑÿ≤Ÿàÿ¨: 0 ÿ•ÿ∞ÿß ŸÑÿß ŸäŸàÿ¨ÿØ'],
                ['5. ÿßŸÑÿ™Ÿàÿßÿ±ŸäÿÆ: YYYY-MM-DD ÿ£Ÿà ÿßÿ™ÿ±ŸÉ ŸÅÿßÿ±ÿ∫ÿßŸã'],
                ['6. ŸäŸÖŸÉŸÜŸÉ ÿ•ÿ∂ÿßŸÅÿ© ÿ£ÿπŸÖÿØÿ© ÿ•ÿ∂ÿßŸÅŸäÿ© ŸàŸÑŸÉŸÜ ÿ≥Ÿäÿ™ŸÖ ÿ™ÿ¨ÿßŸáŸÑŸáÿß']
            ];
            
            const wsInstructions = XLSX.utils.aoa_to_sheet(instructions);
            XLSX.utils.book_append_sheet(wb, wsInstructions, 'ÿßŸÑÿ™ÿπŸÑŸäŸÖÿßÿ™');
            
            XLSX.writeFile(wb, 'ŸÜŸÖŸàÿ∞ÿ¨-ÿ¥ÿ¨ÿ±ÿ©-ÿßŸÑÿπÿßÿ¶ŸÑÿ©.xlsx');
            showSuccess('ÿ™ŸÖ ÿ™ÿ≠ŸÖŸäŸÑ ÿßŸÑŸÜŸÖŸàÿ∞ÿ¨ ÿ®ŸÜÿ¨ÿßÿ≠');
        }

        function handleExcelFileSelect(event) {
            const file = event.target.files[0];
            if (!file) return;
            
            // ÿßŸÑÿ™ÿ≠ŸÇŸÇ ŸÖŸÜ ÿ≠ÿ¨ŸÖ ÿßŸÑŸÖŸÑŸÅ (10MB ŸÉÿ≠ÿØ ÿ£ŸÇÿµŸâ)
            if (file.size > 10 * 1024 * 1024) {
                showError('ÿ≠ÿ¨ŸÖ ÿßŸÑŸÖŸÑŸÅ ŸÉÿ®Ÿäÿ± ÿ¨ÿØÿßŸã. ÿßŸÑÿ≠ÿØ ÿßŸÑÿ£ŸÇÿµŸâ 10MB');
                event.target.value = '';
                return;
            }
            
            showExportLoading('ÿ¨ÿßÿ±Ÿä ÿ™ÿ≠ŸÖŸäŸÑ Ÿàÿ™ÿ≠ŸÑŸäŸÑ ŸÖŸÑŸÅ Excel...');
            
            const reader = new FileReader();
            reader.onload = function(e) {
                try {
                    const data = new Uint8Array(e.target.result);
                    const workbook = XLSX.read(data, { type: 'array' });
                    
                    const sheetNames = workbook.SheetNames;
                    if (sheetNames.length === 0) {
                        throw new Error('ÿßŸÑŸÖŸÑŸÅ ŸÑÿß Ÿäÿ≠ÿ™ŸàŸä ÿπŸÑŸâ ÿ£Ÿàÿ±ÿßŸÇ ÿ®ŸäÿßŸÜÿßÿ™');
                    }
                    
                    let firstSheet = workbook.Sheets[sheetNames[0]];
                    excelData = XLSX.utils.sheet_to_json(firstSheet, { header: 1 });
                    
                    hideExportLoading();
                    
                    if (excelData.length < 2) {
                        showError('ÿßŸÑŸÖŸÑŸÅ ŸÑÿß Ÿäÿ≠ÿ™ŸàŸä ÿπŸÑŸâ ÿ®ŸäÿßŸÜÿßÿ™');
                        return;
                    }
                    
                    displayExcelPreview();
                    
                } catch (error) {
                    hideExportLoading();
                    showError('ÿÆÿ∑ÿ£ ŸÅŸä ŸÇÿ±ÿßÿ°ÿ© ŸÖŸÑŸÅ Excel: ' + error.message);
                    event.target.value = '';
                }
            };
            
            reader.onerror = function() {
                hideExportLoading();
                showError('ŸÅÿ¥ŸÑ ŸÅŸä ŸÇÿ±ÿßÿ°ÿ© ÿßŸÑŸÖŸÑŸÅ');
                event.target.value = '';
            };
            
            reader.readAsArrayBuffer(file);
        }

        function displayExcelPreview() {
            if (excelData.length === 0) return;
            
            const headers = excelData[0];
            const previewRows = excelData.slice(1, 11); // ÿ£ŸàŸÑ 10 ÿµŸÅŸàŸÅ ŸÅŸÇÿ∑ ŸÑŸÑŸÖÿπÿßŸäŸÜÿ©
            
            let headHTML = '<tr>';
            headers.forEach((header, index) => {
                headHTML += `<th>${header || 'ÿπŸÖŸàÿØ ' + (index + 1)}</th>`;
            });
            headHTML += '</tr>';
            
            document.getElementById('excelTableHead').innerHTML = headHTML;
            
            let bodyHTML = '';
            previewRows.forEach((row, rowIndex) => {
                bodyHTML += '<tr>';
                headers.forEach((header, colIndex) => {
                    const cellValue = row[colIndex] !== undefined ? row[colIndex] : '';
                    bodyHTML += `<td>${cellValue}</td>`;
                });
                bodyHTML += '</tr>';
            });
            
            document.getElementById('excelTableBody').innerHTML = bodyHTML;
            document.getElementById('excelPreview').style.display = 'block';
            
            // ÿ•ÿ∏Ÿáÿßÿ± ÿ•ÿ≠ÿµÿßÿ¶Ÿäÿßÿ™ ÿßŸÑÿ®ŸäÿßŸÜÿßÿ™
            const totalRows = excelData.length - 1;
            const previewCount = Math.min(10, totalRows);
            const statsText = `ÿ™ŸÖ ÿ™ÿ≠ŸÖŸäŸÑ ${totalRows} ÿ≥ÿ¨ŸÑ. ÿπÿ±ÿ∂ ${previewCount} ÿ≥ÿ¨ŸÑ ŸÑŸÑŸÖÿπÿßŸäŸÜÿ©.`;
            document.getElementById('importStatsText').textContent = statsText;
            document.getElementById('importStats').style.display = 'block';
            
            showInfo(`ÿ™ŸÖ ÿ™ÿ≠ŸÖŸäŸÑ ${totalRows} ÿ≥ÿ¨ŸÑ ŸÖŸÜ ŸÖŸÑŸÅ Excel`);
        }

        function clearExcelPreview() {
            document.getElementById('excelFile').value = '';
            document.getElementById('excelPreview').style.display = 'none';
            document.getElementById('importStats').style.display = 'none';
            excelData = [];
        }

        function importExcelData() {
            if (excelData.length < 2) {
                showError('ŸÑÿß ÿ™Ÿàÿ¨ÿØ ÿ®ŸäÿßŸÜÿßÿ™ ŸÑŸÑÿßÿ≥ÿ™Ÿäÿ±ÿßÿØ');
                return;
            }
            
            const confirmMessage = `ÿ≥Ÿäÿ™ŸÖ ÿßÿ≥ÿ™Ÿäÿ±ÿßÿØ ${excelData.length - 1} ÿ≥ÿ¨ŸÑ. ŸáŸÑ ÿ™ÿ±ŸäÿØ ÿßŸÑŸÖÿ™ÿßÿ®ÿπÿ©ÿü`;
            if (!confirm(confirmMessage)) {
                return;
            }
            
            showExportLoading('ÿ¨ÿßÿ±Ÿä ÿßÿ≥ÿ™Ÿäÿ±ÿßÿØ ÿßŸÑÿ®ŸäÿßŸÜÿßÿ™...');
            
            setTimeout(() => {
                try {
                    const headers = excelData[0].map(h => h ? h.toString().trim() : '');
                    const dataRows = excelData.slice(1);
                    
                    // ÿßŸÑÿ®ÿ≠ÿ´ ÿπŸÜ ÿ£ÿπŸÖÿØÿ© ÿßŸÑÿ®ŸäÿßŸÜÿßÿ™
                    const columnMap = {
                        id: findColumnIndex(headers, ['id', 'ÿ±ŸÇŸÖ', 'ÿßŸÑÿ±ŸÇŸÖ', 'ŸÖ']),
                        name: findColumnIndex(headers, ['name', 'ÿßÿ≥ŸÖ', 'ÿßŸÑÿßÿ≥ŸÖ', 'ÿßŸÑÿßÿ≥ŸÖ ÿßŸÑŸÉÿßŸÖŸÑ']),
                        gender: findColumnIndex(headers, ['gender', 'ÿ¨ŸÜÿ≥', 'ÿßŸÑÿ¨ŸÜÿ≥']),
                        birthPlace: findColumnIndex(headers, ['ŸÖŸÉÿßŸÜ ÿßŸÑŸÖŸäŸÑÿßÿØ', 'ŸÖŸÉÿßŸÜ', 'ÿßŸÑŸÖŸÉÿßŸÜ', 'birth place']),
                        birthDate: findColumnIndex(headers, ['ÿ™ÿßÿ±ŸäÿÆ ÿßŸÑŸÖŸäŸÑÿßÿØ', 'ÿßŸÑŸÖŸäŸÑÿßÿØ', 'ÿ™ÿßÿ±ŸäÿÆ', 'birth date']),
                        deathDate: findColumnIndex(headers, ['ÿ™ÿßÿ±ŸäÿÆ ÿßŸÑŸàŸÅÿßÿ©', 'ÿßŸÑŸàŸÅÿßÿ©', 'death date']),
                        fatherId: findColumnIndex(headers, ['ÿßŸÑÿ£ÿ®', 'ÿ±ŸÇŸÖ ÿßŸÑÿ£ÿ®', 'ÿ£ÿ®', 'father', 'father id']),
                        motherId: findColumnIndex(headers, ['ÿßŸÑÿ£ŸÖ', 'ÿ±ŸÇŸÖ ÿßŸÑÿ£ŸÖ', 'ÿ£ŸÖ', 'mother', 'mother id']),
                        spouseId: findColumnIndex(headers, ['ÿ≤Ÿàÿ¨', 'ÿ≤Ÿàÿ¨ÿ©', 'ÿßŸÑÿ≤Ÿàÿ¨', 'ÿßŸÑÿ≤Ÿàÿ¨ÿ©', 'spouse', 'spouse id']),
                        notes: findColumnIndex(headers, ['ŸÖŸÑÿßÿ≠ÿ∏ÿßÿ™', 'ŸÖŸÑÿßÿ≠ÿ∏ÿ©', 'notes'])
                    };
                    
                    const importedPersons = [];
                    // ÿ™ÿµÿ≠Ÿäÿ≠: ÿ≠ÿ≥ÿßÿ® ID ÿßŸÑÿ™ÿßŸÑŸä ÿ®ÿ¥ŸÉŸÑ ÿµÿ≠Ÿäÿ≠ ŸÑÿ™ÿ¨ŸÜÿ® ÿßŸÑÿ™ŸÉÿ±ÿßÿ±
                    let maxId = familyData.length > 0 ? Math.max(...familyData.map(p => p.PersonID)) : 0;
                    let successCount = 0;
                    let errorCount = 0;
                    let duplicateCount = 0;
                    
                    // ÿ¨ŸÖÿπ ÿßŸÑÿ£ÿÆÿ∑ÿßÿ°
                    const errors = [];
                    
                    dataRows.forEach((row, index) => {
                        try {
                            // ÿ™ÿÆÿ∑Ÿä ÿßŸÑÿµŸÅŸàŸÅ ÿßŸÑŸÅÿßÿ±ÿ∫ÿ©
                            if (row.every(cell => !cell || cell.toString().trim() === '')) {
                                return;
                            }
                            
                            // ÿßŸÑÿ≠ÿµŸàŸÑ ÿπŸÑŸâ ID
                            let personId;
                            if (columnMap.id !== -1 && row[columnMap.id]) {
                                const idValue = row[columnMap.id];
                                if (typeof idValue === 'number') {
                                    personId = parseInt(idValue);
                                } else if (typeof idValue === 'string') {
                                    personId = parseInt(idValue.trim());
                                }
                                
                                if (isNaN(personId)) {
                                    personId = maxId + index + 1;
                                }
                            } else {
                                personId = maxId + index + 1;
                            }
                            
                            // ÿßŸÑÿ™ÿ£ŸÉÿØ ŸÖŸÜ ÿ£ŸÜ ID ŸÅÿ±ŸäÿØ
                            let originalId = personId;
                            let attempt = 0;
                            // ÿ™ÿµÿ≠Ÿäÿ≠ ŸÖŸÜÿ∑ŸÇ ÿßŸÑÿ™ÿ≠ŸÇŸÇ ŸÖŸÜ ÿßŸÑÿ™ŸÉÿ±ÿßÿ± ŸÑŸäÿ¥ŸÖŸÑ familyData ŸàÿßŸÑŸÖÿ≥ÿ™Ÿàÿ±ÿØŸäŸÜ ÿßŸÑÿ¨ÿØÿØ
                            while (familyData.some(p => p.PersonID === personId) || 
                                   importedPersons.some(p => p.PersonID === personId)) {
                                personId = maxId + (++attempt) + index + 1; // ÿ™ŸàŸÑŸäÿØ ID ÿ¨ÿØŸäÿØ Ÿàÿ¢ŸÖŸÜ
                                duplicateCount++;
                            }
                            
                            // ÿßŸÑÿ≠ÿµŸàŸÑ ÿπŸÑŸâ ÿßŸÑÿßÿ≥ŸÖ
                            let fullName;
                            if (columnMap.name !== -1 && row[columnMap.name]) {
                                fullName = row[columnMap.name].toString().trim();
                            } else {
                                fullName = `ŸÅÿ±ÿØ ${personId}`;
                            }
                            
                            // ÿßŸÑÿ≠ÿµŸàŸÑ ÿπŸÑŸâ ÿßŸÑÿ¨ŸÜÿ≥
                            let gender = 'ÿ∞ŸÉÿ±'; // ÿßŸÅÿ™ÿ±ÿßÿ∂Ÿä
                            if (columnMap.gender !== -1 && row[columnMap.gender]) {
                                const genderValue = row[columnMap.gender].toString().toLowerCase();
                                if (genderValue.includes('ÿ∞ŸÉÿ±') || genderValue.includes('male') || genderValue === 'm') {
                                    gender = 'ÿ∞ŸÉÿ±';
                                } else if (genderValue.includes('ÿßŸÜÿ´Ÿâ') || genderValue.includes('female') || genderValue.includes('ÿ£ŸÜÿ´Ÿâ') || genderValue === 'f') {
                                    gender = 'ÿßŸÜÿ´Ÿâ';
                                }
                            }
                            
                            // ÿ™ÿ≠ŸàŸäŸÑ ÿßŸÑÿ™Ÿàÿßÿ±ŸäÿÆ
                            function parseDate(dateValue) {
                                if (!dateValue) return '';
                                if (dateValue instanceof Date) {
                                    return dateValue.toISOString().split('T')[0];
                                }
                                if (typeof dateValue === 'number') {
                                    // ÿ™ÿµÿ≠Ÿäÿ≠: ÿ•ÿ∂ÿßŸÅÿ© ŸÜÿµŸÅ ŸäŸàŸÖ ŸÑÿ™ÿ¨ŸÜÿ® ŸÖÿ¥ÿßŸÉŸÑ ÿßŸÑŸÖŸÜÿ∑ŸÇÿ© ÿßŸÑÿ≤ŸÖŸÜŸäÿ© ÿßŸÑÿ™Ÿä ÿ™ÿ±ÿ¨ÿπ ÿßŸÑÿ™ÿßÿ±ŸäÿÆ ŸäŸàŸÖÿßŸã ŸÑŸÑŸàÿ±ÿßÿ°
                                    // 25569 ŸáŸà ÿßŸÑŸÅÿ±ŸÇ ÿ®ŸäŸÜ epoch Excel Ÿà JS
                                    const date = new Date((dateValue - 25569.5) * 86400 * 1000);
                                    return date.toISOString().split('T')[0];
                                }
                                if (typeof dateValue === 'string') {
                                    const str = dateValue.trim();
                                    if (str.match(/^\d{4}-\d{2}-\d{2}$/)) return str;
                                    if (str.match(/^\d{2}\/\d{2}\/\d{4}$/)) {
                                        const parts = str.split('/');
                                        return `${parts[2]}-${parts[0].padStart(2, '0')}-${parts[1].padStart(2, '0')}`;
                                    }
                                    if (str.match(/^\d{2}\/\d{2}\/\d{2}$/)) {
                                        const parts = str.split('/');
                                        const year = parseInt(parts[2]) < 30 ? `20${parts[2]}` : `19${parts[2]}`;
                                        return `${year}-${parts[0].padStart(2, '0')}-${parts[1].padStart(2, '0')}`;
                                    }
                                }
                                return '';
                            }
                            
                            const person = {
                                PersonID: personId,
                                FullName: fullName,
                                Gender: gender,
                                PlaceOfBirth: (columnMap.birthPlace !== -1 && row[columnMap.birthPlace]) ? 
                                             row[columnMap.birthPlace].toString().trim() : '',
                                BirthDate: parseDate(columnMap.birthDate !== -1 ? row[columnMap.birthDate] : null),
                                DeathDate: parseDate(columnMap.deathDate !== -1 ? row[columnMap.deathDate] : null),
                                FatherID: (columnMap.fatherId !== -1 && row[columnMap.fatherId]) ? 
                                          parseInt(row[columnMap.fatherId]) || 0 : 0,
                                MotherID: (columnMap.motherId !== -1 && row[columnMap.motherId]) ? 
                                          parseInt(row[columnMap.motherId]) || 0 : 0,
                                SpouseID: (columnMap.spouseId !== -1 && row[columnMap.spouseId]) ? 
                                          parseInt(row[columnMap.spouseId]) || 0 : 0,
                                Notes: (columnMap.notes !== -1 && row[columnMap.notes]) ? 
                                       row[columnMap.notes].toString().trim() : ''
                            };
                            
                            // ÿßŸÑÿ™ÿ≠ŸÇŸÇ ŸÖŸÜ ÿµÿ≠ÿ© ÿßŸÑÿ®ŸäÿßŸÜÿßÿ™ ÿßŸÑÿ£ÿ≥ÿßÿ≥Ÿäÿ©
                            if (!person.FullName || person.FullName.trim() === '') {
                                throw new Error('ÿßŸÑÿßÿ≥ŸÖ ŸÅÿßÿ±ÿ∫');
                            }
                            
                            importedPersons.push(person);
                            successCount++;
                            
                        } catch (error) {
                            console.error(`ÿÆÿ∑ÿ£ ŸÅŸä ÿßŸÑÿ≥ÿ∑ÿ± ${index + 2}:`, error);
                            errors.push(`ÿßŸÑÿ≥ÿ∑ÿ± ${index + 2}: ${error.message}`);
                            errorCount++;
                        }
                    });
                    
                    // ÿØŸÖÿ¨ ÿßŸÑÿ®ŸäÿßŸÜÿßÿ™ ÿßŸÑÿ¨ÿØŸäÿØÿ© ŸÖÿπ ÿßŸÑŸÇÿØŸäŸÖÿ©
                    importedPersons.forEach(person => {
                        const existingIndex = familyData.findIndex(p => p.PersonID === person.PersonID);
                        if (existingIndex !== -1) {
                            familyData[existingIndex] = person; // ÿ™ÿ≠ÿØŸäÿ´
                        } else {
                            familyData.push(person); // ÿ•ÿ∂ÿßŸÅÿ© ÿ¨ÿØŸäÿØÿ©
                        }
                    });
                    
                    // ÿ™ÿ≠ÿØŸäÿ´ ŸÖÿπÿ±ŸÅÿßÿ™ ÿßŸÑÿ£ÿ≤Ÿàÿßÿ¨ ÿ™ŸÑŸÇÿßÿ¶ŸäÿßŸã
                    autoLinkFamilyRelations();
                    
                    // ÿ™ÿµÿ≠Ÿäÿ≠: ÿ™ÿ≠ÿØŸäÿ´ nextPersonId ÿ®ÿπÿØ ÿßŸÑÿßÿ≥ÿ™Ÿäÿ±ÿßÿØ
                    if (familyData.length > 0) {
                        nextPersonId = Math.max(...familyData.map(p => p.PersonID)) + 1;
                    }

                    if (saveData()) {
                        hideExportLoading();
                        closeExcelImport();
                        loadDashboard();
                        
                        let message = `ÿ™ŸÖ ÿßÿ≥ÿ™Ÿäÿ±ÿßÿØ ${successCount} ŸÅÿ±ÿØ ÿ®ŸÜÿ¨ÿßÿ≠`;
                        if (errorCount > 0) {
                            message += ` (${errorCount} ÿ£ÿÆÿ∑ÿßÿ° ÿ™ŸÖ ÿ™ÿÆÿ∑ŸäŸáÿß)`;
                        }
                        if (duplicateCount > 0) {
                            message += `ÿå ${duplicateCount} ŸÖÿπÿ±ŸÅ ÿ™ŸÖ ÿ™ÿπÿØŸäŸÑŸá ŸÑÿ™ÿ¨ŸÜÿ® ÿßŸÑÿ™ŸÉÿ±ÿßÿ±`;
                        }
                        
                        showSuccess(message);
                        
                        // ÿ•ÿ∏Ÿáÿßÿ± ÿßŸÑÿ£ÿÆÿ∑ÿßÿ° ÿ•ŸÜ Ÿàÿ¨ÿØÿ™
                        if (errors.length > 0) {
                            console.warn('ÿ£ÿÆÿ∑ÿßÿ° ÿßŸÑÿßÿ≥ÿ™Ÿäÿ±ÿßÿØ:', errors);
                        }
                        
                        // ÿ•ÿπÿßÿØÿ© ÿ™ÿπŸäŸäŸÜ ŸÖŸÑŸÅ ÿßŸÑÿ•ÿØÿÆÿßŸÑ
                        document.getElementById('excelFile').value = '';
                    }
                    
                } catch (error) {
                    hideExportLoading();
                    showError('ŸÅÿ¥ŸÑ ÿßŸÑÿßÿ≥ÿ™Ÿäÿ±ÿßÿØ: ' + error.message);
                }
            }, 1000);
        }

        function findColumnIndex(headers, possibleNames) {
            for (let name of possibleNames) {
                const index = headers.findIndex(h => 
                    h && h.toString().toLowerCase().includes(name.toLowerCase())
                );
                if (index !== -1) return index;
            }
            return -1;
        }

        function autoLinkFamilyRelations() {
            const personMap = new Map();
            familyData.forEach(person => {
                personMap.set(person.PersonID, person);
            });
            
            // ÿ±ÿ®ÿ∑ ÿßŸÑÿ£ÿ≤Ÿàÿßÿ¨ ÿ™ŸÑŸÇÿßÿ¶ŸäÿßŸã
            familyData.forEach(person => {
                if (person.SpouseID > 0) {
                    const spouse = personMap.get(person.SpouseID);
                    if (spouse && spouse.SpouseID !== person.PersonID) {
                        spouse.SpouseID = person.PersonID;
                    }
                }
            });
            
            // ÿ™ÿµÿ≠Ÿäÿ≠ ÿßŸÑÿ¨ŸÜÿ≥ ÿ®ŸÜÿßÿ°Ÿã ÿπŸÑŸâ ÿßŸÑÿπŸÑÿßŸÇÿßÿ™
            familyData.forEach(person => {
                if (person.FatherID > 0) {
                    const father = personMap.get(person.FatherID);
                    if (father && father.Gender !== 'ÿ∞ŸÉÿ±') {
                        father.Gender = 'ÿ∞ŸÉÿ±';
                    }
                }
                
                if (person.MotherID > 0) {
                    const mother = personMap.get(person.MotherID);
                    if (mother && mother.Gender !== 'ÿßŸÜÿ´Ÿâ') {
                        mother.Gender = 'ÿßŸÜÿ´Ÿâ';
                    }
                }
            });
        }

        // ============================================
        // ÿØŸàÿßŸÑ ÿ•ÿØÿßÿ±ÿ© ÿßŸÑÿµŸÑÿßÿ≠Ÿäÿßÿ™
        // ============================================

        function checkPermission(action) {
            if (!currentUser) return false;
            
            const user = users[currentUser];
            if (!user) return false;
            
            if (user.role === 'admin') return true;
            
            const permissions = userPermissions[user.role] || [];
            return permissions.includes(action);
        }

        function updateUIByPermissions() {
            const userRole = currentUser ? users[currentUser]?.role : null;
            
            document.querySelectorAll('[data-permission]').forEach(element => {
                const requiredPermission = element.getAttribute('data-permission');
                const hasPermission = checkPermission(requiredPermission);
                element.style.display = hasPermission ? '' : 'none';
            });
            
            // ÿ•ÿÆŸÅÿßÿ° ÿßÿ≥ÿ™Ÿäÿ±ÿßÿØ Excel ÿπŸÜ ÿ∫Ÿäÿ± ÿßŸÑŸÖÿØŸäÿ±ŸäŸÜ
            const excelImportItems = document.querySelectorAll('[onclick*="showExcelImport"]');
            if (userRole !== 'admin') {
                excelImportItems.forEach(item => {
                    item.style.display = 'none';
                });
            }
            
            if (userRole === 'host') {
                document.querySelectorAll('.action-btn.edit, .action-btn.delete').forEach(btn => {
                    btn.classList.add('disabled-by-permission');
                    btn.title = 'ÿ∫Ÿäÿ± ŸÖÿ≥ŸÖŸàÿ≠ - ÿµŸÑÿßÿ≠Ÿäÿßÿ™ ÿ∫Ÿäÿ± ŸÉÿßŸÅŸäÿ©';
                    btn.onclick = null;
                });
                
                const addButtons = document.querySelectorAll('.btn-primary, [onclick*="showAddPersonForm"]');
                addButtons.forEach(btn => {
                    btn.classList.add('disabled-by-permission');
                    btn.title = 'ÿ∫Ÿäÿ± ŸÖÿ≥ŸÖŸàÿ≠ ŸÑŸÑŸÖÿ∂ŸäŸÅ';
                    btn.onclick = null;
                });
            }
        }

        function updateSidebarPermissions() {
            if (currentUser && users[currentUser]?.role === 'host') {
                const hiddenItems = ['ÿ•ÿ∂ÿßŸÅÿ© ŸÅÿ±ÿØ ÿ¨ÿØŸäÿØ', 'ÿ®ÿ≠ÿ´ Ÿàÿ™ÿπÿØŸäŸÑ', 'ÿ•ÿØÿßÿ±ÿ© ÿßŸÑÿµŸÑÿßÿ≠Ÿäÿßÿ™', 'ÿßÿ≥ÿ™Ÿäÿ±ÿßÿØ Excel'];
                document.querySelectorAll('.sidebar-menu .menu-item').forEach(item => {
                    const itemText = item.querySelector('span')?.textContent.trim();
                    if (itemText && hiddenItems.includes(itemText)) {
                        item.style.display = 'none';
                    }
                });
            }
        }

        function loadUsers() {
            const savedUsers = localStorage.getItem('familyTreeUsers');
            if (savedUsers) {
                try {
                    const allUsers = JSON.parse(savedUsers);
                    Object.assign(users, allUsers);
                } catch (error) {
                    console.error('ÿÆÿ∑ÿ£ ŸÅŸä ÿ™ÿ≠ŸÖŸäŸÑ ÿßŸÑŸÖÿ≥ÿ™ÿÆÿØŸÖŸäŸÜ:', error);
                }
            }
        }

        // ============================================
        // ŸÜÿ∏ÿßŸÖ ÿßŸÑŸÖŸÜÿßÿ≥ÿ®ÿßÿ™ ŸàÿßŸÑÿ•ÿπŸÑÿßŸÜÿßÿ™ ÿßŸÑÿπÿßÿ¶ŸÑŸäÿ©
        // ============================================

        function initEventsSystem() {
            const savedEvents = localStorage.getItem('familyEvents');
            if (savedEvents) {
                try {
                    familyEvents = JSON.parse(savedEvents);
                } catch (error) {
                    familyEvents = defaultEvents;
                }
            } else {
                familyEvents = defaultEvents;
                saveEvents();
            }
        }

        function showFamilyEvents() {
            if (!checkPermission('view')) {
                showError('ŸÑÿß ÿ™ŸÖŸÑŸÉ ÿµŸÑÿßÿ≠Ÿäÿ© ÿßŸÑŸàÿµŸàŸÑ');
                return;
            }
            
            document.querySelectorAll('.menu-item').forEach(item => item.classList.remove('active'));
            document.querySelector('.sidebar-menu li:nth-child(9)').classList.add('active');
            
            document.getElementById('familyEventsModal').classList.add('active');
            
            // ÿ•ÿ∏Ÿáÿßÿ±/ÿ•ÿÆŸÅÿßÿ° ŸÑŸàÿ≠ÿ© ÿßŸÑÿ™ÿ≠ŸÉŸÖ ÿ≠ÿ≥ÿ® ÿßŸÑÿµŸÑÿßÿ≠Ÿäÿ©
            const isAdmin = currentUser === 'admin';
            document.getElementById('eventsControlPanel').style.display = isAdmin ? 'block' : 'none';
            document.getElementById('toggleEventFormBtn').style.display = isAdmin ? 'inline-flex' : 'none';
            
            loadEvents();
        }

        function closeFamilyEvents() {
            document.getElementById('familyEventsModal').classList.remove('active');
            resetEventForm();
        }

        function toggleEventForm() {
            if (!checkPermission('manage_events')) {
                showError('ŸÑÿß ÿ™ŸÖŸÑŸÉ ÿµŸÑÿßÿ≠Ÿäÿ© ÿ•ÿØÿßÿ±ÿ© ÿßŸÑÿ•ÿπŸÑÿßŸÜÿßÿ™');
                return;
            }
            
            const panel = document.getElementById('eventsControlPanel');
            const isVisible = panel.style.display === 'block';
            panel.style.display = isVisible ? 'none' : 'block';
            
            if (!isVisible) {
                panel.scrollIntoView({ behavior: 'smooth' });
            }
        }

        function resetEventForm() {
            document.getElementById('eventForm').reset();
            document.getElementById('eventId').value = '';
            document.getElementById('eventDate').value = new Date().toISOString().split('T')[0];
            eventsEditing = false;
        }

        function cancelEventForm() {
            resetEventForm();
            document.getElementById('eventsControlPanel').style.display = 'none';
        }

        function saveEvent() {
            if (!checkPermission('manage_events')) {
                showError('ŸÑÿß ÿ™ŸÖŸÑŸÉ ÿµŸÑÿßÿ≠Ÿäÿ© ÿ•ÿØÿßÿ±ÿ© ÿßŸÑÿ•ÿπŸÑÿßŸÜÿßÿ™');
                return;
            }
            
            const eventId = document.getElementById('eventId').value;
            const isEdit = !!eventId;
            
            const eventData = {
                id: isEdit ? eventId : generateEventId(),
                type: document.getElementById('eventType').value,
                title: document.getElementById('eventTitle').value,
                date: document.getElementById('eventDate').value,
                time: document.getElementById('eventTime').value || '',
                location: document.getElementById('eventLocation').value || '',
                description: document.getElementById('eventDescription').value,
                organizer: document.getElementById('eventOrganizer').value || 'ÿ•ÿØÿßÿ±ÿ© ÿßŸÑÿ£ÿ≥ÿ±ÿ©',
                status: document.getElementById('eventStatus').value,
                createdAt: isEdit ? undefined : new Date().toISOString(),
                updatedAt: new Date().toISOString(),
                createdBy: currentUser
            };
            
            if (!eventData.type || !eventData.title || !eventData.date || !eventData.description) {
                showError('ÿßŸÑÿ±ÿ¨ÿßÿ° ŸÖŸÑÿ° ÿ¨ŸÖŸäÿπ ÿßŸÑÿ≠ŸÇŸàŸÑ ÿßŸÑŸÖÿ∑ŸÑŸàÿ®ÿ©');
                return;
            }
            
            if (isEdit) {
                const index = familyEvents.findIndex(e => e.id === eventId);
                if (index !== -1) {
                    familyEvents[index] = {...familyEvents[index], ...eventData};
                }
            } else {
                familyEvents.push(eventData);
            }
            
            saveEvents();
            resetEventForm();
            loadEvents();
            document.getElementById('eventsControlPanel').style.display = 'none';
            
            showSuccess(isEdit ? 'ÿ™ŸÖ ÿ™ÿ≠ÿØŸäÿ´ ÿßŸÑÿ•ÿπŸÑÿßŸÜ ÿ®ŸÜÿ¨ÿßÿ≠' : 'ÿ™ŸÖ ŸÜÿ¥ÿ± ÿßŸÑÿ•ÿπŸÑÿßŸÜ ÿ®ŸÜÿ¨ÿßÿ≠');
        }

        function generateEventId() {
            return 'EV' + Date.now() + Math.floor(Math.random() * 1000);
        }

        function saveEvents() {
            try {
                localStorage.setItem('familyEvents', JSON.stringify(familyEvents));
                console.log('‚úÖ Events saved locally');
                return true;
            } catch (error) {
                console.error('‚ùå Error saving events:', error);
                return false;
            }
        }

        function loadEvents() {
            const eventsList = document.getElementById('eventsList');
            const noEventsMessage = document.getElementById('noEventsMessage');
            
            if (familyEvents.length === 0) {
                eventsList.innerHTML = '';
                noEventsMessage.style.display = 'block';
                return;
            }
            
            noEventsMessage.style.display = 'none';
            
            // ÿ™ÿµŸÅŸäÿ© ÿßŸÑÿ£ÿ≠ÿØÿßÿ´ ÿ≠ÿ≥ÿ® ÿßŸÑŸÜŸàÿπ
            let filteredEvents = [...familyEvents];
            if (currentEventsFilter === 'ŸÜÿ¥ÿ∑') {
                filteredEvents = filteredEvents.filter(e => e.status === 'ŸÜÿ¥ÿ∑');
            } else if (currentEventsFilter === 'ŸÇÿßÿØŸÖ') {
                const today = new Date().toISOString().split('T')[0];
                filteredEvents = filteredEvents.filter(e => e.date >= today && e.status === 'ŸÜÿ¥ÿ∑');
            }
            
            // ÿ™ÿ±ÿ™Ÿäÿ® ÿßŸÑÿ£ÿ≠ÿØÿßÿ´: ÿßŸÑŸÇÿßÿØŸÖÿ© ÿ£ŸàŸÑÿßŸã
            filteredEvents.sort((a, b) => {
                if (a.date === b.date) {
                    return new Date(b.createdAt) - new Date(a.createdAt);
                }
                return new Date(a.date) - new Date(b.date);
            });
            
            let html = '';
            filteredEvents.forEach(event => {
                const eventDate = new Date(event.date);
                const today = new Date();
                const isUpcoming = eventDate > today && event.status === 'ŸÜÿ¥ÿ∑';
                
                html += `
                    <div class="event-card">
                        <div class="event-header event-type-${event.type}">
                            <span class="event-type">${getEventTypeArabic(event.type)}</span>
                            <span class="event-date">${formatEventDate(event.date)}</span>
                        </div>
                        
                        ${isUpcoming ? '<div class="upcoming-badge">ŸÇÿßÿØŸÖ</div>' : ''}
                        <div class="event-status status-${event.status}">${event.status}</div>
                        
                        <div class="event-body">
                            <h3 class="event-title">${event.title}</h3>
                            <div class="event-description">${event.description}</div>
                            
                            <div class="event-details">
                                ${event.time ? `
                                    <div class="event-detail">
                                        <i class="fas fa-clock"></i>
                                        <span>ÿßŸÑŸàŸÇÿ™: ${event.time}</span>
                                    </div>
                                ` : ''}
                                
                                ${event.location ? `
                                    <div class="event-detail">
                                        <i class="fas fa-map-marker-alt"></i>
                                        <span>ÿßŸÑŸÖŸÉÿßŸÜ: ${event.location}</span>
                                    </div>
                                ` : ''}
                            </div>
                        </div>
                        
                        <div class="event-footer">
                            <div class="event-organizer">
                                <i class="fas fa-user"></i> ${event.organizer}
                            </div>
                            
                            ${currentUser === 'admin' ? `
                                <div class="event-actions">
                                    <button class="event-action-btn edit" onclick="editEvent('${event.id}')" title="ÿ™ÿπÿØŸäŸÑ">
                                        <i class="fas fa-edit"></i>
                                    </button>
                                    <button class="event-action-btn delete" onclick="deleteEvent('${event.id}')" title="ÿ≠ÿ∞ŸÅ">
                                        <i class="fas fa-trash"></i>
                                    </button>
                                </div>
                            ` : ''}
                        </div>
                    </div>
                `;
            });
            
            eventsList.innerHTML = html;
        }

        function getEventTypeArabic(type) {
            const types = {
                'ŸÖŸÜÿßÿ≥ÿ®ÿ©': 'ŸÖŸÜÿßÿ≥ÿ®ÿ© ÿπÿßÿ¶ŸÑŸäÿ©',
                'ÿßÿ¨ÿ™ŸÖÿßÿπ': 'ÿßÿ¨ÿ™ŸÖÿßÿπ ÿπÿßÿ¶ŸÑŸä',
                'ŸÅÿπÿßŸÑŸäÿ©': 'ŸÅÿπÿßŸÑŸäÿ©',
                'ÿ®ÿ±ŸÜÿßŸÖÿ¨': 'ÿ®ÿ±ŸÜÿßŸÖÿ¨ ÿ£ÿ≥ÿ±Ÿä',
                'ÿ™ÿ∞ŸÉŸäÿ±': 'ÿ™ÿ∞ŸÉŸäÿ± ŸÖŸáŸÖ',
                'ÿ£ÿÆÿ±Ÿâ': 'ÿ•ÿπŸÑÿßŸÜ'
            };
            return types[type] || type;
        }

        function formatEventDate(dateString) {
            try {
                const date = new Date(dateString);
                return date.toLocaleDateString('ar-EG', {
                    year: 'numeric',
                    month: 'long',
                    day: 'numeric'
                });
            } catch (error) {
                return dateString;
            }
        }

        function editEvent(eventId) {
            if (!checkPermission('manage_events')) {
                showError('ŸÑÿß ÿ™ŸÖŸÑŸÉ ÿµŸÑÿßÿ≠Ÿäÿ© ÿßŸÑÿ™ÿπÿØŸäŸÑ');
                return;
            }
            
            const event = familyEvents.find(e => e.id === eventId);
            if (!event) return;
            
            eventsEditing = true;
            document.getElementById('eventId').value = event.id;
            document.getElementById('eventType').value = event.type;
            document.getElementById('eventTitle').value = event.title;
            document.getElementById('eventDate').value = event.date;
            document.getElementById('eventTime').value = event.time || '';
            document.getElementById('eventLocation').value = event.location || '';
            document.getElementById('eventDescription').value = event.description;
            document.getElementById('eventOrganizer').value = event.organizer || '';
            document.getElementById('eventStatus').value = event.status || 'ŸÜÿ¥ÿ∑';
            
            document.getElementById('eventsControlPanel').style.display = 'block';
            document.getElementById('eventsControlPanel').scrollIntoView({ behavior: 'smooth' });
        }

        function deleteEvent(eventId) {
            if (!checkPermission('manage_events')) {
                showError('ŸÑÿß ÿ™ŸÖŸÑŸÉ ÿµŸÑÿßÿ≠Ÿäÿ© ÿßŸÑÿ≠ÿ∞ŸÅ');
                return;
            }
            
            if (!confirm('ŸáŸÑ ÿ£ŸÜÿ™ ŸÖÿ™ÿ£ŸÉÿØ ŸÖŸÜ ÿ≠ÿ∞ŸÅ Ÿáÿ∞ÿß ÿßŸÑÿ•ÿπŸÑÿßŸÜÿü')) return;
            
            familyEvents = familyEvents.filter(e => e.id !== eventId);
            saveEvents();
            loadEvents();
            showSuccess('ÿ™ŸÖ ÿ≠ÿ∞ŸÅ ÿßŸÑÿ•ÿπŸÑÿßŸÜ ÿ®ŸÜÿ¨ÿßÿ≠');
        }

        function filterEvents(filterType) {
            currentEventsFilter = filterType;
            loadEvents();
            
            const buttons = document.querySelectorAll('.action-buttons button');
            buttons.forEach(btn => btn.classList.remove('active'));
            
            // ÿ•ÿ∂ÿßŸÅÿ© active ŸÑŸÑÿ≤ÿ± ÿßŸÑŸÖÿ≠ÿØÿØ
            const activeBtn = Array.from(buttons).find(btn => 
                btn.onclick && btn.onclick.toString().includes(`'${filterType}'`)
            );
            if (activeBtn) activeBtn.classList.add('active');
        }

        function searchEvents() {
            const searchTerm = document.getElementById('eventSearch').value.toLowerCase();
            
            const eventCards = document.querySelectorAll('.event-card');
            let foundCount = 0;
            
            eventCards.forEach(card => {
                const title = card.querySelector('.event-title').textContent.toLowerCase();
                const description = card.querySelector('.event-description').textContent.toLowerCase();
                const type = card.querySelector('.event-type').textContent.toLowerCase();
                
                const isMatch = title.includes(searchTerm) || 
                               description.includes(searchTerm) || 
                               type.includes(searchTerm);
                
                card.style.display = isMatch ? 'block' : 'none';
                if (isMatch) foundCount++;
            });
            
            if (searchTerm && foundCount === 0) {
                showError('ŸÑŸÖ Ÿäÿ™ŸÖ ÿßŸÑÿπÿ´Ÿàÿ± ÿπŸÑŸâ ÿ•ÿπŸÑÿßŸÜÿßÿ™ ÿ™ÿ∑ÿßÿ®ŸÇ ÿßŸÑÿ®ÿ≠ÿ´');
            }
        }

        function clearEventSearch() {
            document.getElementById('eventSearch').value = '';
            const eventCards = document.querySelectorAll('.event-card');
            eventCards.forEach(card => {
                card.style.display = 'block';
            });
        }

        function printEvents() {
            const printContent = document.getElementById('eventsList').innerHTML;
            const originalContent = document.body.innerHTML;
            
            document.body.innerHTML = `
                <div dir="rtl" style="padding: 20px; font-family: 'Cairo', sans-serif;">
                    <h1 style="text-align: center; color: #2E7D32; border-bottom: 2px solid #4CAF50; padding-bottom: 10px;">
                        üìÖ ÿ•ÿπŸÑÿßŸÜÿßÿ™ ŸàŸÖŸÜÿßÿ≥ÿ®ÿßÿ™ ÿπÿßÿ¶ŸÑÿ© ŸÖÿ≠ŸÖÿØ ÿπÿ®ÿØÿßŸÑÿ±ÿ≠ŸÖŸÜ
                    </h1>
                    <div style="margin-top: 20px;">
                        ${printContent}
                    </div>
                    <div style="margin-top: 30px; text-align: center; color: #666; font-size: 12px;">
                        <p>ÿ™ÿßÿ±ŸäÿÆ ÿßŸÑÿ∑ÿ®ÿßÿπÿ©: ${new Date().toLocaleDateString('ar-EG')}</p>
                        <p>ÿπÿØÿØ ÿßŸÑÿ•ÿπŸÑÿßŸÜÿßÿ™: ${familyEvents.length}</p>
                    </div>
                </div>
            `;
            
            window.print();
            document.body.innerHTML = originalContent;
            location.reload();
        }

        // ============================================
        // ÿØŸàÿßŸÑ ÿßŸÑŸÜÿ∏ÿßŸÖ ÿßŸÑÿ£ÿ≥ÿßÿ≥Ÿäÿ©
        // ============================================

        function initSystem() {
            console.log('ÿ¨ÿßÿ±Ÿä ÿ™ŸáŸäÿ¶ÿ© ÿßŸÑŸÜÿ∏ÿßŸÖ...');
            
            loadUsers();
            
            // ÿ™ÿ≠ŸÖŸäŸÑ ŸÇÿßÿ¶ŸÖÿ© ÿßŸÜÿ™ÿ∏ÿßÿ± ÿßŸÑŸÖÿ≤ÿßŸÖŸÜÿ©
            const savedQueue = localStorage.getItem('syncQueue');
            if (savedQueue) {
                try {
                    syncQueue = JSON.parse(savedQueue);
                } catch (error) {
                    syncQueue = [];
                }
            }
            
            // ÿ™ÿ≠ŸÖŸäŸÑ ÿßŸÑÿ®ŸäÿßŸÜÿßÿ™
            const savedEncryptionFlag = localStorage.getItem('isDataEncrypted');
            const savedData = localStorage.getItem('familyData');
            
            if (savedEncryptionFlag === 'true' && savedData) {
                isDataEncrypted = true;
                familyData = defaultFamilyData;
            } else if (savedData) {
                try {
                    const parsedData = JSON.parse(savedData);
                    if (Array.isArray(parsedData)) {
                        familyData = parsedData;
                    } else {
                        familyData = defaultFamilyData;
                    }
                    isDataEncrypted = false;
                } catch (error) {
                    familyData = defaultFamilyData;
                    isDataEncrypted = false;
                }
            } else {
                familyData = defaultFamilyData;
                isDataEncrypted = false;
            }
            
            // ÿ™ÿ≠ŸÖŸäŸÑ ÿßŸÑÿ•ÿπŸÑÿßŸÜÿßÿ™
            initEventsSystem();
            
            if (familyData.length > 0) {
                const maxId = Math.max(...familyData.map(p => p.PersonID));
                nextPersonId = maxId + 1;
            } else {
                nextPersonId = 1;
            }
            
            console.log('ÿπÿØÿØ ÿßŸÑÿ£ŸÅÿ±ÿßÿØ:', familyData.length);
            console.log('ÿπÿØÿØ ÿßŸÑÿ•ÿπŸÑÿßŸÜÿßÿ™:', familyEvents.length);
            
            // ÿ™ŸáŸäÿ¶ÿ© Firebase
            cloudSyncEnabled = initializeFirebase();
            
            // ÿ™ÿµÿ≠Ÿäÿ≠: ÿ™ÿ≠ŸÖŸäŸÑ ÿßŸÑÿ®ŸäÿßŸÜÿßÿ™ ŸÖŸÜ ÿßŸÑÿ≥ÿ≠ÿßÿ®ÿ© ÿ®ÿπÿØ ÿßŸÑÿ™ŸáŸäÿ¶ÿ©
            if (cloudSyncEnabled) {
                setTimeout(() => {
                    loadDataFromCloud();
                }, 1000);
            }
            
            updateUIByPermissions();
            updateSidebarPermissions();
            updateSyncStatus();
            
            // ÿ™ŸáŸäÿ¶ÿ© ÿßŸÑŸÇÿßÿ¶ŸÖÿ© ÿßŸÑÿ¨ŸàÿßŸÑŸäÿ©
            initMobileMenu();
        }

        function initMobileMenu() {
            const mobileMenuToggle = document.getElementById('mobileMenuToggle');
            const sidebar = document.getElementById('sidebar');
            
            if (mobileMenuToggle && sidebar) {
                mobileMenuToggle.addEventListener('click', function() {
                    sidebar.classList.toggle('active');
                });
                
                // ÿ•ÿ∫ŸÑÿßŸÇ ÿßŸÑŸÇÿßÿ¶ŸÖÿ© ÿπŸÜÿØ ÿßŸÑŸÜŸÇÿ± ÿÆÿßÿ±ÿ¨Ÿáÿß
                document.addEventListener('click', function(event) {
                    if (!sidebar.contains(event.target) && !mobileMenuToggle.contains(event.target) && sidebar.classList.contains('active')) {
                        sidebar.classList.remove('active');
                    }
                });
            }
        }

        function handleLogin() {
            const username = document.getElementById('username').value;
            const password = document.getElementById('password').value;
            const errorDiv = document.getElementById('loginError');
            
            if (users[username] && users[username].password === password) {
                currentUser = username;
                document.getElementById('loggedInUser').textContent = users[username].name;
                document.getElementById('login-screen').style.display = 'none';
                document.getElementById('main-content').style.display = 'block';
                initSystem();
                loadDashboard();
                updateUIByPermissions();
                updateSidebarPermissions();
                showSuccess('ÿ™ŸÖ ÿ™ÿ≥ÿ¨ŸäŸÑ ÿßŸÑÿØÿÆŸàŸÑ ÿ®ŸÜÿ¨ÿßÿ≠');
            } else {
                errorDiv.style.display = 'block';
            }
        }

        function logout() {
            if (confirm('ŸáŸÑ ÿ™ÿ±ŸäÿØ ÿ™ÿ≥ÿ¨ŸäŸÑ ÿßŸÑÿÆÿ±Ÿàÿ¨ÿü')) {
                currentUser = null;
                document.getElementById('main-content').style.display = 'none';
                document.getElementById('login-screen').style.display = 'flex';
                document.getElementById('username').value = '';
                document.getElementById('password').value = '';
                showSuccess('ÿ™ŸÖ ÿ™ÿ≥ÿ¨ŸäŸÑ ÿßŸÑÿÆÿ±Ÿàÿ¨ ÿ®ŸÜÿ¨ÿßÿ≠');
            }
        }

        // ============================================
        // ÿØŸàÿßŸÑ ÿ•ÿØÿßÿ±ÿ© ÿßŸÑÿ£ŸÅÿ±ÿßÿØ
        // ============================================

        function validatePersonData(data) {
            if (!data.FullName || data.FullName.trim() === '') {
                showError('ÿßŸÑÿßÿ≥ŸÖ ÿßŸÑŸÉÿßŸÖŸÑ ŸÖÿ∑ŸÑŸàÿ®');
                return false;
            }
            
            if (!data.Gender) {
                showError('ÿßŸÑÿ¨ŸÜÿ≥ ŸÖÿ∑ŸÑŸàÿ®');
                return false;
            }
            
            return true;
        }

        function savePerson() {
            if (!checkPermission('edit') && !checkPermission('add')) {
                showError('ŸÑÿß ÿ™ŸÖŸÑŸÉ ÿµŸÑÿßÿ≠Ÿäÿ© ÿßŸÑÿ™ÿπÿØŸäŸÑ ÿ£Ÿà ÿßŸÑÿ•ÿ∂ÿßŸÅÿ©');
                return;
            }
            
            const personId = parseInt(document.getElementById('personId').value);
            const isEdit = !!personId;
            
            if (!isEdit) {
                const maxId = familyData.length > 0 ? Math.max(...familyData.map(p => p.PersonID)) : 0;
                nextPersonId = maxId + 1;
            }
            
            const personData = {
                PersonID: isEdit ? personId : nextPersonId,
                FullName: document.getElementById('fullName').value,
                Gender: document.getElementById('gender').value,
                PlaceOfBirth: document.getElementById('placeOfBirth').value,
                BirthDate: document.getElementById('birthDate').value,
                DeathDate: document.getElementById('deathDate').value,
                FatherID: parseInt(document.getElementById('fatherId').value) || 0,
                MotherID: parseInt(document.getElementById('motherId').value) || 0,
                SpouseID: parseInt(document.getElementById('spouseId').value) || 0,
                Notes: document.getElementById('notes').value
            };
            
            if (!validatePersonData(personData)) {
                return;
            }
            
            if (isEdit) {
                const index = familyData.findIndex(p => p.PersonID === personId);
                if (index !== -1) {
                    familyData[index] = personData;
                }
            } else {
                familyData.push(personData);
                nextPersonId++;
            }
            
            if (saveData()) {
                loadDashboard();
                closePersonForm();
                showSuccess(isEdit ? 'ÿ™ŸÖ ÿ™ÿ≠ÿØŸäÿ´ ÿ®ŸäÿßŸÜÿßÿ™ ÿßŸÑŸÅÿ±ÿØ ÿ®ŸÜÿ¨ÿßÿ≠' : 'ÿ™ŸÖ ÿ•ÿ∂ÿßŸÅÿ© ÿßŸÑŸÅÿ±ÿØ ÿßŸÑÿ¨ÿØŸäÿØ ÿ®ŸÜÿ¨ÿßÿ≠');
            }
        }

        function updateDropdowns() {
            const fatherSelect = document.getElementById('fatherId');
            const motherSelect = document.getElementById('motherId');
            const spouseSelect = document.getElementById('spouseId');
            
            fatherSelect.innerHTML = `<option value="0">${translations[currentLanguage].formNoFather}</option>`;
            motherSelect.innerHTML = `<option value="0">${translations[currentLanguage].formNoMother}</option>`;
            spouseSelect.innerHTML = `<option value="0">${translations[currentLanguage].formNoSpouse}</option>`;
            
            familyData.filter(p => p.Gender === 'ÿ∞ŸÉÿ±').forEach(person => {
                fatherSelect.innerHTML += `<option value="${person.PersonID}">${person.FullName} (${person.PersonID})</option>`;
            });
            
            familyData.filter(p => p.Gender === 'ÿßŸÜÿ´Ÿâ').forEach(person => {
                motherSelect.innerHTML += `<option value="${person.PersonID}">${person.FullName} (${person.PersonID})</option>`;
            });
            
            familyData.forEach(person => {
                spouseSelect.innerHTML += `<option value="${person.PersonID}">${person.FullName} (${person.PersonID})</option>`;
            });
        }

        function showAddPersonForm() {
            if (!checkPermission('add')) {
                showError('ŸÑÿß ÿ™ŸÖŸÑŸÉ ÿµŸÑÿßÿ≠Ÿäÿ© ÿßŸÑÿ•ÿ∂ÿßŸÅÿ©');
                return;
            }
            
            document.getElementById('formTitle').textContent = translations[currentLanguage].addPersonForm;
            document.getElementById('personForm').reset();
            document.getElementById('personId').value = '';
            document.getElementById('birthDate').value = '';
            document.getElementById('deathDate').value = '';
            updateDropdowns();
            document.getElementById('personFormModal').classList.add('active');
        }

        function editPerson(personId) {
            if (!checkPermission('edit')) {
                showError('ŸÑÿß ÿ™ŸÖŸÑŸÉ ÿµŸÑÿßÿ≠Ÿäÿ© ÿßŸÑÿ™ÿπÿØŸäŸÑ');
                return;
            }
            
            const person = familyData.find(p => p.PersonID === personId);
            if (!person) return;
            
            document.getElementById('formTitle').textContent = translations[currentLanguage].editPersonForm;
            document.getElementById('personId').value = person.PersonID;
            document.getElementById('fullName').value = person.FullName;
            document.getElementById('gender').value = person.Gender;
            document.getElementById('placeOfBirth').value = person.PlaceOfBirth || '';
            document.getElementById('birthDate').value = person.BirthDate || '';
            document.getElementById('deathDate').value = person.DeathDate || '';
            document.getElementById('fatherId').value = person.FatherID || 0;
            document.getElementById('motherId').value = person.MotherID || 0;
            document.getElementById('spouseId').value = person.SpouseID || 0;
            document.getElementById('notes').value = person.Notes || '';
            
            updateDropdowns();
            document.getElementById('personFormModal').classList.add('active');
        }

        function deletePerson(personId) {
            if (!checkPermission('delete')) {
                showError('ŸÑÿß ÿ™ŸÖŸÑŸÉ ÿµŸÑÿßÿ≠Ÿäÿ© ÿßŸÑÿ≠ÿ∞ŸÅ');
                return;
            }
            
            if (!confirm('ŸáŸÑ ÿ£ŸÜÿ™ ŸÖÿ™ÿ£ŸÉÿØ ŸÖŸÜ ÿ≠ÿ∞ŸÅ Ÿáÿ∞ÿß ÿßŸÑŸÅÿ±ÿØÿü')) return;
            
            const hasChildren = familyData.some(p => p.FatherID === personId || p.MotherID === personId);
            if (hasChildren) {
                if (!confirm('ÿ™ÿ≠ÿ∞Ÿäÿ±: Ÿáÿ∞ÿß ÿßŸÑŸÅÿ±ÿØ ŸÑÿØŸäŸá ÿ£ÿ®ŸÜÿßÿ°. ÿ≠ÿ∞ŸÅŸá ŸÇÿØ Ÿäÿ§ÿ´ÿ± ÿπŸÑŸâ ÿßŸÑÿπŸÑÿßŸÇÿßÿ™ ÿßŸÑÿπÿßÿ¶ŸÑŸäÿ©. ŸáŸÑ ÿ™ÿ±ŸäÿØ ÿßŸÑŸÖÿ™ÿßÿ®ÿπÿ©ÿü')) {
                    return;
                }
            }
            
            familyData = familyData.filter(p => p.PersonID !== personId);
            if (saveData()) {
                loadDashboard();
                showSuccess('ÿ™ŸÖ ÿ≠ÿ∞ŸÅ ÿßŸÑŸÅÿ±ÿØ ÿ®ŸÜÿ¨ÿßÿ≠');
            }
        }

        // ============================================
        // ÿØŸàÿßŸÑ ÿµŸÅÿ≠ÿ© ÿßŸÑŸÅÿ±ÿØ ÿßŸÑÿ™ŸÅÿµŸäŸÑŸäÿ©
        // ============================================

        function showPersonDetail(personId) {
            const person = familyData.find(p => p.PersonID === personId);
            if (!person) return;
            
            currentDetailPersonId = personId;
            document.getElementById('detailTitle').textContent = `${translations[currentLanguage].personInfo}: ${person.FullName}`;
            
            const father = familyData.find(p => p.PersonID === person.FatherID);
            const mother = familyData.find(p => p.PersonID === person.MotherID);
            const spouse = familyData.find(p => p.PersonID === person.SpouseID);
            const children = familyData.filter(p => p.FatherID === personId || p.MotherID === personId);
            const siblings = familyData.filter(p => 
                p.PersonID !== personId && (
                    (person.FatherID && person.FatherID !== 0 && p.FatherID === person.FatherID) ||
                    (person.MotherID && person.MotherID !== 0 && p.MotherID === person.MotherID)
                )
            );
const detailHTML = `
                <div class="person-header">
                    <div class="person-avatar">
                        <i class="fas fa-${person.Gender === 'ÿ∞ŸÉÿ±' ? 'male' : 'female'}"></i>
                    </div>
                    <h2 class="person-name">${person.FullName}</h2>
                    <span class="person-id">ÿ±ŸÇŸÖ: ${person.PersonID}</span>
                </div>
                
                <div class="detail-sections">
                    <div class="detail-section">
                        <h3 class="section-title"><i class="fas fa-info-circle"></i> ÿßŸÑŸÖÿπŸÑŸàŸÖÿßÿ™ ÿßŸÑÿ¥ÿÆÿµŸäÿ©</h3>
                        <div class="detail-item">
                            <span class="detail-label">ÿßŸÑÿ¨ŸÜÿ≥:</span>
                            <span class="detail-value">${person.Gender === 'ÿ∞ŸÉÿ±' ? 'ÿ∞ŸÉÿ±' : 'ÿ£ŸÜÿ´Ÿâ'}</span>
                        </div>
                        <div class="detail-item">
                            <span class="detail-label">ŸÖŸÉÿßŸÜ ÿßŸÑŸÖŸäŸÑÿßÿØ:</span>
                            <span class="detail-value">${person.PlaceOfBirth || 'ÿ∫Ÿäÿ± ŸÖÿ≠ÿØÿØ'}</span>
                        </div>
                        <div class="detail-item">
                            <span class="detail-label">ÿ™ÿßÿ±ŸäÿÆ ÿßŸÑŸÖŸäŸÑÿßÿØ:</span>
                            <span class="detail-value">${formatDate(person.BirthDate) || 'ÿ∫Ÿäÿ± ŸÖÿ≠ÿØÿØ'}</span>
                        </div>
                        <div class="detail-item">
                            <span class="detail-label">ÿ™ÿßÿ±ŸäÿÆ ÿßŸÑŸàŸÅÿßÿ©:</span>
                            <span class="detail-value">${person.DeathDate ? formatDate(person.DeathDate) : 'ŸÑÿß ŸäŸàÿ¨ÿØ'}</span>
                        </div>
                    </div>
                    
                    <div class="detail-section">
                        <h3 class="section-title"><i class="fas fa-family"></i> ÿßŸÑÿπŸÑÿßŸÇÿßÿ™ ÿßŸÑÿπÿßÿ¶ŸÑŸäÿ©</h3>
                        <div class="detail-item">
                            <span class="detail-label">ÿßŸÑÿ£ÿ®:</span>
                            <span class="detail-value">${father ? `${father.FullName} (${father.PersonID})` : 'ÿ∫Ÿäÿ± ŸÖÿ≠ÿØÿØ'}</span>
                        </div>
                        <div class="detail-item">
                            <span class="detail-label">ÿßŸÑÿ£ŸÖ:</span>
                            <span class="detail-value">${mother ? `${mother.FullName} (${mother.PersonID})` : 'ÿ∫Ÿäÿ± ŸÖÿ≠ÿØÿØ'}</span>
                        </div>
                        <div class="detail-item">
                            <span class="detail-label">ÿßŸÑÿ≤Ÿàÿ¨/ÿßŸÑÿ≤Ÿàÿ¨ÿ©:</span>
                            <span class="detail-value">${spouse ? `${spouse.FullName} (${spouse.PersonID})` : 'ŸÑÿß ŸäŸàÿ¨ÿØ'}</span>
                        </div>
                    </div>
                    
                    <div class="detail-section">
                        <h3 class="section-title"><i class="fas fa-users"></i> ÿßŸÑÿ£ÿ®ŸÜÿßÿ° (${children.length})</h3>
                        ${children.length > 0 ? children.map(child => `
                            <div class="detail-item">
                                <span class="detail-label">${child.FullName}:</span>
                                <span class="detail-value">${child.Gender === 'ÿ∞ŸÉÿ±' ? 'ÿ∞ŸÉÿ±' : 'ÿ£ŸÜÿ´Ÿâ'} - ÿ±ŸÇŸÖ ${child.PersonID}</span>
                            </div>
                        `).join('') : `<p>ŸÑÿß ŸäŸàÿ¨ÿØ ÿ£ÿ®ŸÜÿßÿ°</p>`}
                    </div>
                    
                    <div class="detail-section">
                        <h3 class="section-title"><i class="fas fa-user-friends"></i> ÿßŸÑÿ£ÿÆŸàÿ© (${siblings.length})</h3>
                        ${siblings.length > 0 ? siblings.map(sibling => `
                            <div class="detail-item">
                                <span class="detail-label">${sibling.FullName}:</span>
                                <span class="detail-value">${sibling.Gender === 'ÿ∞ŸÉÿ±' ? 'ÿ∞ŸÉÿ±' : 'ÿ£ŸÜÿ´Ÿâ'} - ÿ±ŸÇŸÖ ${sibling.PersonID}</span>
                            </div>
                        `).join('') : `<p>ŸÑÿß ŸäŸàÿ¨ÿØ ÿ£ÿÆŸàÿ©</p>`}
                    </div>
                </div>
                
                ${person.Notes ? `
                <div class="detail-section" style="grid-column: 1 / -1;">
                    <h3 class="section-title"><i class="fas fa-sticky-note"></i> ŸÖŸÑÿßÿ≠ÿ∏ÿßÿ™</h3>
                    <p>${person.Notes}</p>
                </div>
                ` : ''}
            `;
            
            document.getElementById('personDetailContent').innerHTML = detailHTML;
            document.getElementById('personDetailModal').classList.add('active');
        }

        function closePersonDetail() {
            document.getElementById('personDetailModal').classList.remove('active');
        }

        function editCurrentPerson() {
            if (!checkPermission('edit')) {
                showError('ŸÑÿß ÿ™ŸÖŸÑŸÉ ÿµŸÑÿßÿ≠Ÿäÿ© ÿßŸÑÿ™ÿπÿØŸäŸÑ');
                return;
            }
            closePersonDetail();
            editPerson(currentDetailPersonId);
        }

        function printPersonDetail() {
            const printContent = document.getElementById('personDetailContent').innerHTML;
            const originalContent = document.body.innerHTML;
            
            document.body.innerHTML = `
                <div dir="${currentLanguage === 'ar' ? 'rtl' : 'ltr'}" style="padding: 20px; font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;">
                    <h1 style="text-align: center; color: #2E7D32;">ÿ¥ÿ¨ÿ±ÿ© ÿπÿßÿ¶ŸÑÿ© ŸÖÿ≠ŸÖÿØ ÿπÿ®ÿØÿßŸÑÿ±ÿ≠ŸÖŸÜ</h1>
                    ${printContent}
                </div>
            `;
            
            window.print();
            document.body.innerHTML = originalContent;
            location.reload();
        }

        // ============================================
        // ÿØŸàÿßŸÑ ŸÉÿ™ÿßÿ® ÿßŸÑÿπÿßÿ¶ŸÑÿ© ÿßŸÑŸÖÿ≠ÿ≥ŸÜÿ©
        // ============================================

        function showFamilyBook() {
            document.getElementById('familyBookModal').classList.add('active');
            generateFamilyBook();
        }

        function closeFamilyBook() {
            document.getElementById('familyBookModal').classList.remove('active');
        }

        function generateFamilyBook() {
            const preview = document.getElementById('bookPreview');
            if (!preview) {
                showError('ŸÑŸÖ Ÿäÿ™ŸÖ ÿßŸÑÿπÿ´Ÿàÿ± ÿπŸÑŸâ ŸÖŸÜÿ∑ŸÇÿ© ÿßŸÑŸÖÿπÿßŸäŸÜÿ©');
                return;
            }

            preview.innerHTML = '';
            const shell = document.createElement('div');
            shell.className = 'book-shell';
            preview.appendChild(shell);

            // ÿßŸÑÿµŸÅÿ≠ÿ© ÿßŸÑÿ£ŸàŸÑŸâ: ÿßŸÑÿ∫ŸÑÿßŸÅ
            const cover = document.createElement('section');
            cover.className = 'book-page book-cover';
            cover.innerHTML = `
                <div class="book-watermark">
                    <i class="fas fa-feather-alt"></i>
                    <span>ÿ¥ÿ¨ÿ±ÿ© ÿπÿßÿ¶ŸÑÿ© ŸÖÿ≠ŸÖÿØ ÿπÿ®ÿØÿßŸÑÿ±ÿ≠ŸÖŸÜ</span>
                </div>
                <div class="book-cover">
                    <h1 class="book-title">üìò ŸÉÿ™ÿßÿ® ÿßŸÑÿπÿßÿ¶ŸÑÿ©</h1>
                    <h2 class="book-subtitle">ÿπÿßÿ¶ŸÑÿ© ŸÖÿ≠ŸÖÿØ ÿπÿ®ÿØÿßŸÑÿ±ÿ≠ŸÖŸÜ (ÿ£ÿ®ÿß)</h2>
                    <div style="margin-top: 100px;">
                        <p>ÿ™ÿßÿ±ŸäÿÆ ÿßŸÑÿ•ÿµÿØÿßÿ±: ${new Date().toLocaleDateString('ar-EG')}</p>
                        <p>ÿπÿØÿØ ÿßŸÑÿ£ŸÅÿ±ÿßÿØ: ${familyData.length}</p>
                        <p>ÿπÿØÿØ ÿßŸÑÿ£ÿ¨ŸäÿßŸÑ: ${new Set(familyData.map(p => calculateGeneration(p.PersonID))).size}</p>
                    </div>
                    <div class="book-badge">
                        <span style="font-size: 20px;">üå≥</span>
                        <span>ŸÜÿ≥ÿÆÿ© ÿ¥ÿßŸÖŸÑÿ© ŸÑŸÉŸÑ ÿßŸÑÿ£ŸÅÿ±ÿßÿØ</span>
                    </div>
                </div>
            `;
            shell.appendChild(cover);

            // ÿßŸÑÿµŸÅÿ≠ÿ© ÿßŸÑÿ´ÿßŸÜŸäÿ©: ÿßŸÑŸÅŸáÿ±ÿ≥
            const indexPage = document.createElement('section');
            indexPage.className = 'book-page';
            indexPage.innerHTML = `
                <div class="book-watermark">
                    <i class="fas fa-list"></i>
                    <span>ŸÅŸáÿ±ÿ≥ ÿßŸÑŸÖÿ≠ÿ™ŸàŸäÿßÿ™</span>
                </div>
                <h2 style="text-align: center; margin-bottom: 30px;">üìë ŸÅŸáÿ±ÿ≥ ÿßŸÑŸÖÿ≠ÿ™ŸàŸäÿßÿ™</h2>
                <div style="margin-right: 50px;">
                    ${Object.entries(organizeByGeneration()).map(([gen, persons]) => `
                        <div style="margin-bottom: 10px; font-size: 16px;">
                            <a href="#gen-${gen}" style="color: #4CAF50; text-decoration: none;">
                                <i class="fas fa-layer-group"></i> ÿßŸÑÿ¨ŸäŸÑ ${gen} - ${persons.length} ŸÅÿ±ÿØ
                            </a>
                        </div>
                    `).join('')}
                    <div style="margin-top: 20px; padding-top: 20px; border-top: 2px solid #eee;">
                        <h3>ÿ•ÿ≠ÿµÿßÿ¶Ÿäÿßÿ™ ÿßŸÑÿπÿßÿ¶ŸÑÿ©</h3>
                        <p><i class="fas fa-users"></i> ÿ•ÿ¨ŸÖÿßŸÑŸä ÿßŸÑÿ£ŸÅÿ±ÿßÿØ: <b>${familyData.length}</b></p>
                        <p><i class="fas fa-male"></i> ÿπÿØÿØ ÿßŸÑÿ∞ŸÉŸàÿ±: <b>${familyData.filter(p => p.Gender === 'ÿ∞ŸÉÿ±').length}</b></p>
                        <p><i class="fas fa-female"></i> ÿπÿØÿØ ÿßŸÑÿ•ŸÜÿßÿ´: <b>${familyData.filter(p => p.Gender === 'ÿßŸÜÿ´Ÿâ').length}</b></p>
                        <p><i class="fas fa-heart"></i> ÿπÿØÿØ ÿßŸÑŸÖÿ™ÿ≤Ÿàÿ¨ŸäŸÜ: <b>${familyData.filter(p => p.SpouseID !== 0).length}</b></p>
                        <p><i class="fas fa-home"></i> ÿπÿØÿØ ÿßŸÑÿπÿßÿ¶ŸÑÿßÿ™: <b>${familyData.filter(p => p.FatherID === 0 && p.MotherID === 0 && !isOutsideFamily(p.PersonID)).length}</b></p>
                    </div>
                </div>
            `;
            shell.appendChild(indexPage);

            // ÿµŸÅÿ≠ÿßÿ™ ÿßŸÑÿ£ÿ¨ŸäÿßŸÑ ŸÖÿπ ÿ™ŸÇÿ≥ŸäŸÖ ÿ•ŸÑŸâ ÿµŸÅÿ≠ÿßÿ™ ŸÖÿ™ÿπÿØÿØÿ© ŸÑŸÉŸÑ ÿ¨ŸäŸÑ
            const generations = organizeByGeneration();
            const ITEMS_PER_PAGE = 12; // 12 ŸÅÿ±ÿØ ŸÅŸä ŸÉŸÑ ÿµŸÅÿ≠ÿ©

            Object.keys(generations).forEach(genKey => {
                const personsInGeneration = generations[genKey];
                const totalPages = Math.ceil(personsInGeneration.length / ITEMS_PER_PAGE);
                
                for (let pageNum = 0; pageNum < totalPages; pageNum++) {
                    const startIdx = pageNum * ITEMS_PER_PAGE;
                    const endIdx = Math.min(startIdx + ITEMS_PER_PAGE, personsInGeneration.length);
                    const pagePersons = personsInGeneration.slice(startIdx, endIdx);
                    
                    const pageSuffix = totalPages > 1 ? ` (ÿµŸÅÿ≠ÿ© ${pageNum + 1} ŸÖŸÜ ${totalPages})` : '';
                    
                    const page = document.createElement('section');
                    page.className = 'book-page';
                    page.id = `gen-${genKey}-page-${pageNum}`;
                    page.innerHTML = `
                        <div class="book-watermark">
                            <i class="fas fa-tree"></i>
                            <span>ÿßŸÑÿ¨ŸäŸÑ ${genKey}</span>
                        </div>
                        <h2 class="book-generation-title">
                            <i class="fas fa-layer-group"></i> 
                            ÿßŸÑÿ¨ŸäŸÑ ${genKey}${pageSuffix}
                            <span style="font-size: 14px; color: #666; margin-right: 10px;">
                                (ÿßŸÑÿ£ŸÅÿ±ÿßÿØ ${startIdx + 1} - ${endIdx} ŸÖŸÜ ${personsInGeneration.length})
                            </span>
                        </h2>
                        <div class="book-grid ${bookCompact ? 'compact' : ''}">
                            ${pagePersons.map(person => renderBookPersonCard(person)).join('')}
                        </div>
                    `;
                    
                    if (pageNum === 0) {
                        page.id = `gen-${genKey}`;
                    }
                    
                    shell.appendChild(page);
                }
            });

            // ÿµŸÅÿ≠ÿ© ÿ•ÿ∂ÿßŸÅŸäÿ©: ÿ¨ŸÖŸäÿπ ÿßŸÑÿ£ŸÅÿ±ÿßÿØ ŸÖÿ±ÿ™ÿ®ŸäŸÜ ÿ£ÿ®ÿ¨ÿØŸäÿßŸã (ÿßÿÆÿ™Ÿäÿßÿ±Ÿä)
            if (familyData.length > 0) {
                const allPersonsPage = document.createElement('section');
                allPersonsPage.className = 'book-page';
                allPersonsPage.id = 'all-persons-index';
                allPersonsPage.innerHTML = `
                    <div class="book-watermark">
                        <i class="fas fa-address-book"></i>
                        <span>ŸÅŸáÿ±ÿ≥ ÿ¨ŸÖŸäÿπ ÿßŸÑÿ£ŸÅÿ±ÿßÿØ</span>
                    </div>
                    <h2 class="book-generation-title" style="color: #2196F3;">
                        <i class="fas fa-address-book"></i>
                        ŸÅŸáÿ±ÿ≥ ÿ¨ŸÖŸäÿπ ÿßŸÑÿ£ŸÅÿ±ÿßÿØ (ŸÖÿ±ÿ™ÿ® ÿ£ÿ®ÿ¨ÿØŸäÿßŸã)
                    </h2>
                    <div style="columns: 2; column-gap: 40px;">
                        ${[...familyData]
                            .sort((a, b) => a.FullName.localeCompare(b.FullName, 'ar'))
                            .map(person => `
                                <div style="margin-bottom: 8px; page-break-inside: avoid;">
                                    <a href="#gen-${calculateGeneration(person.PersonID)}" 
                                       style="color: ${person.Gender === 'ÿ∞ŸÉÿ±' ? '#2196F3' : '#E91E63'}; text-decoration: none;"
                                       onclick="scrollToGenerationInBook(${person.PersonID})">
                                        <i class="fas fa-${person.Gender === 'ÿ∞ŸÉÿ±' ? 'male' : 'female'}"></i>
                                        ${person.FullName} (ÿ±ŸÇŸÖ: ${person.PersonID})
                                    </a>
                                </div>
                            `).join('')}
                    </div>
                `;
                shell.appendChild(allPersonsPage);
            }

            showSuccess(`ÿ™ŸÖ ÿ•ŸÜÿ¥ÿßÿ° ŸÉÿ™ÿßÿ® ÿßŸÑÿπÿßÿ¶ŸÑÿ© ÿ®ŸÜÿ¨ÿßÿ≠ Ÿäÿ≠ÿ™ŸàŸä ÿπŸÑŸâ ${Object.keys(generations).length} ÿ¨ŸäŸÑ${Object.keys(generations).length > 1 ? 'ÿßÿ™' : ''}`);
        }

        // ÿØÿßŸÑÿ© ŸÖÿ≥ÿßÿπÿØÿ© ŸÑÿπÿ±ÿ∂ ÿ®ÿ∑ÿßŸÇÿ© ÿßŸÑŸÅÿ±ÿØ ŸÅŸä ÿßŸÑŸÉÿ™ÿßÿ®
        function renderBookPersonCard(person) {
            const father = familyData.find(p => p.PersonID === person.FatherID);
            const mother = familyData.find(p => p.PersonID === person.MotherID);
            const spouse = familyData.find(p => p.PersonID === person.SpouseID);
            const children = familyData.filter(p => p.FatherID === person.PersonID || p.MotherID === person.PersonID);
            
            const age = computeAge(person.BirthDate);
            
            return `
                <div class="book-card book-member-card" 
                     onclick="highlightBookLineage(${person.PersonID})" 
                     data-book-person-id="${person.PersonID}"
                     data-book-search="${person.FullName || ''} ${person.PersonID} ${person.PlaceOfBirth || ''} ${person.Notes || ''} ${person.BirthDate || ''} ${person.DeathDate || ''}">
                    
                    <div class="book-card-header">
                        <div class="book-card-id">#${person.PersonID}</div>
                        <div class="book-card-gender ${person.Gender === 'ÿ∞ŸÉÿ±' ? 'male' : 'female'}">
                            ${person.Gender === 'ÿ∞ŸÉÿ±' ? 'ÿ∞ŸÉÿ±' : 'ÿ£ŸÜÿ´Ÿâ'}
                        </div>
                    </div>
                    
                    <h3 class="book-card-name">${person.FullName}</h3>
                    
                    <div class="book-card-details">
                        ${person.BirthDate ? `
                            <div class="book-card-detail">
                                <i class="fas fa-star-and-crescent"></i>
                                <span>ÿßŸÑŸÖŸàŸÑÿØ: ${formatDateDisplay(person.BirthDate)} ${age ? `(${age} ÿ≥ŸÜÿ©)` : ''}</span>
                            </div>
                        ` : ''}
                        
                        ${person.DeathDate ? `
                            <div class="book-card-detail">
                                <i class="fas fa-kaaba"></i>
                                <span>ÿßŸÑŸàŸÅÿßÿ©: ${formatDateDisplay(person.DeathDate)}</span>
                            </div>
                        ` : ''}
                        
                        ${person.PlaceOfBirth ? `
                            <div class="book-card-detail">
                                <i class="fas fa-map-marker-alt"></i>
                                <span>${person.PlaceOfBirth}</span>
                            </div>
                        ` : ''}
                        
                        ${father ? `
                            <div class="book-card-detail">
                                <i class="fas fa-male"></i>
                                <span>ÿßŸÑÿ£ÿ®: ${father.FullName}</span>
                            </div>
                        ` : ''}
                        
                        ${mother ? `
                            <div class="book-card-detail">
                                <i class="fas fa-female"></i>
                                <span>ÿßŸÑÿ£ŸÖ: ${mother.FullName}</span>
                            </div>
                        ` : ''}
                        
                        ${spouse ? `
                            <div class="book-card-detail">
                                <i class="fas fa-heart"></i>
                                <span>ÿßŸÑÿ≤Ÿàÿ¨/ÿßŸÑÿ≤Ÿàÿ¨ÿ©: ${spouse.FullName}</span>
                            </div>
                        ` : ''}
                        
                        ${children.length > 0 ? `
                            <div class="book-card-detail">
                                <i class="fas fa-child"></i>
                                <span>ÿßŸÑÿ£ÿ®ŸÜÿßÿ°: ${children.length} ŸÅÿ±ÿØ</span>
                            </div>
                        ` : ''}
                        
                        ${person.Notes ? `
                            <div class="book-card-detail">
                                <i class="fas fa-sticky-note"></i>
                                <span>${person.Notes}</span>
                            </div>
                        ` : ''}
                    </div>
                </div>
            `;
        }

        // ÿØÿßŸÑÿ© ŸÑŸÑÿßŸÜÿ™ŸÇÿßŸÑ ÿ•ŸÑŸâ ÿßŸÑÿ¨ŸäŸÑ ŸÅŸä ÿßŸÑŸÉÿ™ÿßÿ®
        function scrollToGenerationInBook(personId) {
            const generation = calculateGeneration(personId);
            const genElement = document.getElementById(`gen-${generation}`);
            if (genElement) {
                genElement.scrollIntoView({ behavior: 'smooth' });
                highlightBookLineage(personId);
            }
        }

        // ============================================
        // ÿ®ÿ≠ÿ´ ÿ≥ÿ±Ÿäÿπ ÿØÿßÿÆŸÑ ŸÉÿ™ÿßÿ® ÿßŸÑÿπÿßÿ¶ŸÑÿ© (ÿßÿ≥ŸÖ/ÿ±ŸÇŸÖ/ŸÖŸÉÿßŸÜ/ŸÖŸÑÿßÿ≠ÿ∏ÿßÿ™)
        // ============================================

        function normalizeArabic(str) {
            if (!str) return '';
            return String(str)
                .toLowerCase()
                .replace(/[ÿ•ÿ£ÿ¢ÿß]/g, 'ÿß')
                .replace(/[Ÿâ]/g, 'Ÿä')
                .replace(/[ÿ§]/g, 'Ÿà')
                .replace(/[ÿ¶]/g, 'Ÿä')
                .replace(/[ÿ©]/g, 'Ÿá')
                .replace(/[Ÿã-ŸüŸ∞]/g, '') // ÿ™ÿ¥ŸÉŸäŸÑ
                .replace(/\s+/g, ' ')
                .trim();
        }

        
        // ============================================
        // ÿßŸÑÿ™ŸÅÿßÿπŸÑ ÿØÿßÿÆŸÑ ŸÉÿ™ÿßÿ® ÿßŸÑÿπÿßÿ¶ŸÑÿ©: ÿ™ŸÖŸäŸäÿ≤ ÿßŸÑÿ≥ŸÑÿßŸÑÿ© + ÿßŸÑÿßŸÜÿ™ŸÇÿßŸÑ ŸÑŸÑÿ¥ÿ¨ÿ±ÿ©
        // ============================================
        function onBookPersonClick(evt, personId) {
            if (evt) evt.stopPropagation();
            highlightBookLineage(personId);
            highlightLineage(personId);
            const node = document.querySelector(`.tree-node[data-person-id="${personId}"]`);
            if (node) node.scrollIntoView({ behavior: 'smooth', block: 'center', inline: 'center' });
        }

        function clearBookLineage() {
            document.querySelectorAll('.book-member-card').forEach(card => {
                card.classList.remove('book-card-dimmed','book-card-selected','book-card-ancestor','book-card-descendant');
            });
        }

        function highlightBookLineage(personId) {
            clearBookLineage();
            const cards = Array.from(document.querySelectorAll('.book-member-card'));
            if (!cards.length) return;

            const ancestors = getAncestors(personId);
            const descendants = getDescendants(personId);

            cards.forEach(c => c.classList.add('book-card-dimmed'));

            const sel = document.querySelector(`.book-member-card[data-book-person-id="${personId}"]`);
            if (sel) {
                sel.classList.remove('book-card-dimmed');
                sel.classList.add('book-card-selected');
                sel.scrollIntoView({ behavior: 'smooth', block: 'center' });
            }

            ancestors.forEach(id => {
                const el = document.querySelector(`.book-member-card[data-book-person-id="${id}"]`);
                if (el) {
                    el.classList.remove('book-card-dimmed');
                    el.classList.add('book-card-ancestor');
                }
            });

            descendants.forEach(id => {
                const el = document.querySelector(`.book-member-card[data-book-person-id="${id}"]`);
                if (el) {
                    el.classList.remove('book-card-dimmed');
                    el.classList.add('book-card-descendant');
                }
            });
        }


function clearBookSearch() {
            const input = document.getElementById('bookSearchInput');
            if (input) input.value = '';
            // ÿ•ÿ≤ÿßŸÑÿ© ÿßŸÑÿ•ÿÆŸÅÿßÿ° ŸàÿßŸÑÿ™ÿ∏ŸÑŸäŸÑ Ÿàÿ•ÿ≤ÿßŸÑÿ© <mark>
            document.querySelectorAll('.book-member-card').forEach(card => {
                card.classList.remove('book-hidden', 'book-match');
                unmarkElement(card);
            });
        }

        function unmarkElement(root) {
            if (!root) return;
            const marks = root.querySelectorAll('mark.book-mark');
            marks.forEach(m => {
                const text = document.createTextNode(m.textContent);
                m.parentNode.replaceChild(text, m);
                m.parentNode.normalize();
            });
        }

        function markMatchesInElement(root, query) {
            // ÿ™ÿ∏ŸÑŸäŸÑ ÿ®ÿ≥Ÿäÿ∑ ÿØÿßÿÆŸÑ ÿπŸÜŸàÿßŸÜ ÿßŸÑÿßÿ≥ŸÖ ŸÅŸÇÿ∑ ŸÑÿ™ÿ¨ŸÜÿ® ÿ™ÿ∫ŸäŸäÿ± ÿßŸÑÿ®ŸÜŸäÿ©
            const nameEl = root.querySelector('h4');
            if (!nameEl) return;
            unmarkElement(nameEl);

            const text = nameEl.textContent;
            const normText = normalizeArabic(text);
            const normQ = normalizeArabic(query);
            if (!normQ) return;

            // ÿ™ÿ∏ŸÑŸäŸÑ ÿ≠ÿ≥ÿ® ÿßŸÑŸÖŸàÿ∂ÿπ ŸÅŸä ÿßŸÑŸÜÿµ ÿßŸÑÿ£ÿµŸÑŸä (ÿ™ŸÇÿ±Ÿäÿ®ŸäÿßŸã)
            const idx = normText.indexOf(normQ);
            if (idx === -1) return;

            // fallback: ÿ™ÿ∏ŸÑŸäŸÑ ÿ≠ÿ±ŸÅŸä (case-insensitive) ÿ®ÿØŸàŸÜ ÿ™ÿπÿ±Ÿäÿ® ŸÉÿßŸÖŸÑ
            const safeQ = query.replace(/[.*+?^${}()|[\]\\]/g, '\\$&');
            const rx = new RegExp(safeQ, 'gi');
            nameEl.innerHTML = nameEl.innerHTML.replace(rx, (m) => `<mark class="book-mark">${m}</mark>`);
        }

        function searchFamilyBook() {
            const input = document.getElementById('bookSearchInput');
            const q = input ? input.value : '';
            const nq = normalizeArabic(q);

            const cards = document.querySelectorAll('.book-member-card');
            if (!nq) {
                cards.forEach(card => {
                    card.classList.remove('book-hidden', 'book-match');
                    unmarkElement(card);
                });
                return;
            }

            let firstMatch = null;
            cards.forEach(card => {
                const hay = normalizeArabic(card.getAttribute('data-book-search') || '');
                const isMatch = hay.includes(nq);
                card.classList.toggle('book-hidden', !isMatch);
                card.classList.toggle('book-match', isMatch);

                if (isMatch && !firstMatch) firstMatch = card;
                if (isMatch) markMatchesInElement(card, q);
                else unmarkElement(card);
            });

            if (firstMatch) {
                firstMatch.scrollIntoView({ behavior: 'smooth', block: 'center' });
            }
        }


        function exportFamilyBook() {
            const element = document.getElementById('bookPreview');
            const opt = {
                margin: [10, 10, 10, 10],
                filename: `ŸÉÿ™ÿßÿ®-ÿßŸÑÿπÿßÿ¶ŸÑÿ©-${new Date().toISOString().split('T')[0]}.pdf`,
                image: { type: 'jpeg', quality: 0.98 },
                html2canvas: { scale: 2, useCORS: true },
                jsPDF: { unit: 'mm', format: 'a4', orientation: 'portrait' }
            };
            
            html2pdf().set(opt).from(element).save();
            showSuccess('ÿ™ŸÖ ÿ™ÿµÿØŸäÿ± ŸÉÿ™ÿßÿ® ÿßŸÑÿπÿßÿ¶ŸÑÿ© ÿ®ŸÜÿ¨ÿßÿ≠');
        }

        function printFamilyBook() {
            const modal = document.getElementById('familyBookModal');
            if(!modal) return;
            window.print();
        }

        // ============================================
        // ÿØŸàÿßŸÑ ÿ•ÿØÿßÿ±ÿ© ÿßŸÑÿµŸÑÿßÿ≠Ÿäÿßÿ™
        // ============================================

        function showPermissions() {
            if (!checkPermission('manage_users')) {
                showError('ŸÑÿß ÿ™ŸÖŸÑŸÉ ÿµŸÑÿßÿ≠Ÿäÿ© ÿßŸÑŸàÿµŸàŸÑ ÿ•ŸÑŸâ ÿ•ÿØÿßÿ±ÿ© ÿßŸÑÿµŸÑÿßÿ≠Ÿäÿßÿ™');
                return;
            }
            
            document.getElementById('permissionsModal').classList.add('active');
            loadUsersList();
        }

        function closePermissionsModal() {
            document.getElementById('permissionsModal').classList.remove('active');
        }

        function loadUsersList() {
            const usersList = document.getElementById('usersList');
            usersList.innerHTML = '';
            
            Object.keys(users).forEach(username => {
                const user = users[username];
                const tr = document.createElement('tr');
                tr.innerHTML = `
                    <td>${user.name} (${username})</td>
                    <td>${user.role === 'admin' ? 'ŸÖÿØŸäÿ±' : user.role === 'host' ? 'ŸÖÿ∂ŸäŸÅ' : 'ŸÖÿ≥ÿ™ÿÆÿØŸÖ'}</td>
                    <td>${new Date().toLocaleDateString('ar-EG')}</td>
                    <td>
                        ${username !== 'admin' ? `
                        <button class="action-btn delete" onclick="deleteUser('${username}')" title="ÿ≠ÿ∞ŸÅ">
                            <i class="fas fa-trash"></i>
                        </button>
                        ` : 'ŸÑÿß ŸäŸÖŸÉŸÜ ÿ≠ÿ∞ŸÅ ÿßŸÑŸÖÿØŸäÿ± ÿßŸÑÿ±ÿ¶Ÿäÿ≥Ÿä'}
                    </td>
                `;
                usersList.appendChild(tr);
            });
        }

        function addNewUser() {
            const username = document.getElementById('newUsername').value;
            const password = document.getElementById('newPassword').value;
            const role = document.getElementById('newUserRole').value;
            
            if (!username || !password) {
                showError('Ÿäÿ¨ÿ® ÿ•ÿØÿÆÿßŸÑ ÿßÿ≥ŸÖ ÿßŸÑŸÖÿ≥ÿ™ÿÆÿØŸÖ ŸàŸÉŸÑŸÖÿ© ÿßŸÑŸÖÿ±Ÿàÿ±');
                return;
            }
            
            if (users[username]) {
                showError('ÿßÿ≥ŸÖ ÿßŸÑŸÖÿ≥ÿ™ÿÆÿØŸÖ ŸÖŸàÿ¨ŸàÿØ ÿ®ÿßŸÑŸÅÿπŸÑ');
                return;
            }
            
            users[username] = {
                password: password,
                name: username,
                role: role
            };
            
            localStorage.setItem('familyTreeUsers', JSON.stringify(users));
            
            document.getElementById('newUsername').value = '';
            document.getElementById('newPassword').value = '';
            
            loadUsersList();
            showSuccess('ÿ™ŸÖ ÿ•ÿ∂ÿßŸÅÿ© ÿßŸÑŸÖÿ≥ÿ™ÿÆÿØŸÖ ÿ®ŸÜÿ¨ÿßÿ≠');
        }

        function deleteUser(username) {
            if (username === 'admin') {
                showError('ŸÑÿß ŸäŸÖŸÉŸÜ ÿ≠ÿ∞ŸÅ ÿßŸÑŸÖÿØŸäÿ± ÿßŸÑÿ±ÿ¶Ÿäÿ≥Ÿä');
                return;
            }
            
            if (confirm(`ŸáŸÑ ÿ™ÿ±ŸäÿØ ÿ≠ÿ∞ŸÅ ÿßŸÑŸÖÿ≥ÿ™ÿÆÿØŸÖ ${username}ÿü`)) {
                delete users[username];
                localStorage.setItem('familyTreeUsers', JSON.stringify(users));
                loadUsersList();
                showSuccess('ÿ™ŸÖ ÿ≠ÿ∞ŸÅ ÿßŸÑŸÖÿ≥ÿ™ÿÆÿØŸÖ ÿ®ŸÜÿ¨ÿßÿ≠');
            }
        }

        // ============================================
        // ÿØŸàÿßŸÑ ÿßŸÑÿ™ÿ¥ŸÅŸäÿ±
        // ============================================

        function encryptCurrentData() {
            const password = document.getElementById('encryptPassword').value;
            const confirmPassword = document.getElementById('encryptConfirmPassword').value;
            
            if (!password || password.length < 4) {
                showError('ŸÉŸÑŸÖÿ© ÿßŸÑŸÖÿ±Ÿàÿ± Ÿäÿ¨ÿ® ÿ£ŸÜ ÿ™ŸÉŸàŸÜ 4 ÿ£ÿ≠ÿ±ŸÅ ÿπŸÑŸâ ÿßŸÑÿ£ŸÇŸÑ');
                return;
            }
            
            if (password !== confirmPassword) {
                showError('ŸÉŸÑŸÖÿßÿ™ ÿßŸÑŸÖÿ±Ÿàÿ± ÿ∫Ÿäÿ± ŸÖÿ™ÿ∑ÿßÿ®ŸÇÿ©');
                return;
            }
            
            if (confirm('ÿ™ÿ≠ÿ∞Ÿäÿ±: ÿ≥Ÿäÿ™ŸÖ ÿ™ÿ¥ŸÅŸäÿ± ÿ¨ŸÖŸäÿπ ÿßŸÑÿ®ŸäÿßŸÜÿßÿ™. ŸÑÿß ŸäŸÖŸÉŸÜ ÿßÿ≥ÿ™ÿπÿßÿØÿ™Ÿáÿß ÿ®ÿØŸàŸÜ ŸÉŸÑŸÖÿ© ÿßŸÑŸÖÿ±Ÿàÿ±. ŸáŸÑ ÿ™ÿ±ŸäÿØ ÿßŸÑŸÖÿ™ÿßÿ®ÿπÿ©ÿü')) {
                try {
                    const dataString = JSON.stringify(familyData);
                    const encryptedData = encryptText(dataString, password);
                    
                    localStorage.setItem('familyData', encryptedData);
                    localStorage.setItem('isDataEncrypted', 'true');
                    
                    isDataEncrypted = true;
                    encryptionPassword = password;
                    
                    document.getElementById('encryptPassword').value = '';
                    document.getElementById('encryptConfirmPassword').value = '';
                    
                    showSuccess('ÿ™ŸÖ ÿ™ÿ¥ŸÅŸäÿ± ÿßŸÑÿ®ŸäÿßŸÜÿßÿ™ ÿ®ŸÜÿ¨ÿßÿ≠');
                    updateEncryptionStatus();
                } catch (error) {
                    showError('ŸÅÿ¥ŸÑ ÿ™ÿ¥ŸÅŸäÿ± ÿßŸÑÿ®ŸäÿßŸÜÿßÿ™: ' + error.message);
                }
            }
        }

        function decryptCurrentData() {
            const password = prompt('ÿ£ÿØÿÆŸÑ ŸÉŸÑŸÖÿ© ÿßŸÑŸÖÿ±Ÿàÿ± ŸÑŸÅŸÉ ÿ™ÿ¥ŸÅŸäÿ± ÿßŸÑÿ®ŸäÿßŸÜÿßÿ™:');
            if (!password) return;
            
            try {
                const encryptedData = localStorage.getItem('familyData');
                if (!encryptedData) {
                    showError('ŸÑÿß ÿ™Ÿàÿ¨ÿØ ÿ®ŸäÿßŸÜÿßÿ™ ŸÖÿ¥ŸÅÿ±ÿ©');
                    return;
                }
                
                const decryptedText = decryptText(encryptedData, password);
                const decryptedData = JSON.parse(decryptedText);
                
                familyData = decryptedData;
                isDataEncrypted = false;
                encryptionPassword = '';
                
                localStorage.setItem('familyData', JSON.stringify(familyData));
                localStorage.setItem('isDataEncrypted', 'false');
                
                showSuccess('ÿ™ŸÖ ŸÅŸÉ ÿ™ÿ¥ŸÅŸäÿ± ÿßŸÑÿ®ŸäÿßŸÜÿßÿ™ ÿ®ŸÜÿ¨ÿßÿ≠');
                updateEncryptionStatus();
                loadDashboard();
            } catch (error) {
                showError('ŸÅÿ¥ŸÑ ŸÅŸÉ ÿ™ÿ¥ŸÅŸäÿ± ÿßŸÑÿ®ŸäÿßŸÜÿßÿ™: ' + error.message);
            }
        }

        function removeEncryption() {
            if (!isDataEncrypted) {
                showError('ÿßŸÑÿ®ŸäÿßŸÜÿßÿ™ ÿ∫Ÿäÿ± ŸÖÿ¥ŸÅÿ±ÿ© ÿ≠ÿßŸÑŸäÿßŸã');
                return;
            }
            
            if (confirm('ÿ™ÿ≠ÿ∞Ÿäÿ±: ÿ•ÿ≤ÿßŸÑÿ© ÿßŸÑÿ™ÿ¥ŸÅŸäÿ± ÿ≥ÿ™ÿπÿ±ÿ∂ ÿßŸÑÿ®ŸäÿßŸÜÿßÿ™ ŸÑŸÑŸÇÿ±ÿßÿ°ÿ© ÿ®ÿØŸàŸÜ ÿ≠ŸÖÿßŸäÿ©. ŸáŸÑ ÿ™ÿ±ŸäÿØ ÿßŸÑŸÖÿ™ÿßÿ®ÿπÿ©ÿü')) {
                try {
                    localStorage.setItem('familyData', JSON.stringify(familyData));
                    localStorage.setItem('isDataEncrypted', 'false');
                    
                    isDataEncrypted = false;
                    encryptionPassword = '';
                    
                    showSuccess('ÿ™ŸÖ ÿ•ÿ≤ÿßŸÑÿ© ÿßŸÑÿ™ÿ¥ŸÅŸäÿ± ÿ®ŸÜÿ¨ÿßÿ≠');
                    updateEncryptionStatus();
                } catch (error) {
                    showError('ŸÅÿ¥ŸÑ ÿ•ÿ≤ÿßŸÑÿ© ÿßŸÑÿ™ÿ¥ŸÅŸäÿ±: ' + error.message);
                }
            }
        }

        function updateEncryptionStatus() {
            const statusElement = document.getElementById('encryptionAlert');
            const messageElement = document.getElementById('encryptionMessage');
            
            if (isDataEncrypted) {
                statusElement.className = 'alert success';
                messageElement.innerHTML = `
                    <strong>‚úì ÿßŸÑÿ®ŸäÿßŸÜÿßÿ™ ŸÖÿ¥ŸÅÿ±ÿ©</strong><br>
                    <small>ÿ¨ŸÖŸäÿπ ÿßŸÑÿ®ŸäÿßŸÜÿßÿ™ ŸÖÿ≠ŸÖŸäÿ© ÿ®ÿ™ÿ¥ŸÅŸäÿ± ÿ¢ŸÖŸÜ</small>
                `;
            } else {
                statusElement.className = 'alert warning';
                messageElement.innerHTML = `
                    <strong>‚ö† ÿßŸÑÿ®ŸäÿßŸÜÿßÿ™ ÿ∫Ÿäÿ± ŸÖÿ¥ŸÅÿ±ÿ©</strong><br>
                    <small>ŸäŸàÿµŸâ ÿ®ÿ™ÿ¥ŸÅŸäÿ± ÿßŸÑÿ®ŸäÿßŸÜÿßÿ™ ŸÑÿ≠ŸÖÿßŸäÿ™Ÿáÿß</small>
                `;
            }
            statusElement.style.display = 'flex';
        }

        function showEncryptionSettings() {
            document.querySelectorAll('.menu-item').forEach(item => item.classList.remove('active'));
            document.querySelector('.sidebar-menu li:nth-child(12)').classList.add('active');
            document.getElementById('encryptionModal').classList.add('active');
            updateEncryptionStatus();
        }

        function closeEncryptionModal() {
            document.getElementById('encryptionModal').classList.remove('active');
        }

        // ============================================
        // ÿØŸàÿßŸÑ ÿßŸÑÿ¥ÿ¨ÿ±ÿ©
        // ============================================

        function showTreeView() {
            document.getElementById('treeView').classList.add('active');
            treeZoom = 100;
            treeCompactMode = false;
            treeViewMode = 'vertical';
            renderTree();
            setupTreeScrollListener();
            setupMobileSearch();
        }

        function closeTreeView() {
            document.getElementById('treeView').classList.remove('active');
        }

        function renderTree() {
            const container = document.getElementById('treeContainer');
            if (familyData.length === 0) {
                container.innerHTML = `
                    <div class="empty-message">
                        <i class="fas fa-tree"></i>
                        <h3>ŸÑÿß ÿ™Ÿàÿ¨ÿØ ÿ®ŸäÿßŸÜÿßÿ™ ŸÑŸÑÿπÿ±ÿ∂</h3>
                        <p>ÿ£ÿ∂ŸÅ ÿ£ŸÅÿ±ÿßÿØÿßŸã ÿ•ŸÑŸâ ÿßŸÑÿπÿßÿ¶ŸÑÿ© ŸÑÿπÿ±ÿ∂ ÿßŸÑÿ¥ÿ¨ÿ±ÿ©</p>
                    </div>
                `;
                return;
            }
            
            container.innerHTML = '<div class="tree-wrapper" id="treeWrapper"></div>';
            const treeWrapper = document.getElementById('treeWrapper');
            const generations = organizeByGeneration();
            
            Object.keys(generations).forEach(genKey => {
                const genNumber = parseInt(genKey);
                const generationDiv = document.createElement('div');
                
                if (treeViewMode === 'vertical') {
                    generationDiv.className = `tree-generation generation-${Math.min(genNumber, 5)}`;
                } else {
                    generationDiv.className = `tree-generation tree-horizontal generation-${Math.min(genNumber, 5)}`;
                }
                
                let genLabel = '';
                switch(genNumber) {
                    case 1: genLabel = 'ÿßŸÑÿ¨ŸäŸÑ ÿßŸÑÿ£ŸàŸÑ: ÿßŸÑÿ£ÿ¨ÿØÿßÿØ'; break;
                    case 2: genLabel = 'ÿßŸÑÿ¨ŸäŸÑ ÿßŸÑÿ´ÿßŸÜŸä: ÿßŸÑÿ¢ÿ®ÿßÿ°'; break;
                    case 3: genLabel = 'ÿßŸÑÿ¨ŸäŸÑ ÿßŸÑÿ´ÿßŸÑÿ´: ÿßŸÑÿ£ÿ®ŸÜÿßÿ°'; break;
                    case 4: genLabel = 'ÿßŸÑÿ¨ŸäŸÑ ÿßŸÑÿ±ÿßÿ®ÿπ: ÿßŸÑÿ£ÿ≠ŸÅÿßÿØ'; break;
                    default: genLabel = `ÿßŸÑÿ¨ŸäŸÑ ${genNumber}`;
                }
                
                generationDiv.innerHTML = `
                    <div class="generation-label">${genLabel} (${generations[genKey].length} ŸÅÿ±ÿØ)</div>
                    <div class="tree-level" id="generation-${genNumber}"></div>
                `;
                
                treeWrapper.appendChild(generationDiv);
                const genContainer = document.getElementById(`generation-${genNumber}`);
                
                const personsInGeneration = generations[genKey];
                const displayedPersons = new Set();
                
                personsInGeneration.forEach(person => {
                    if (displayedPersons.has(person.PersonID)) return;
                    
                    const spouse = findSpouse(person.PersonID);
                    const children = findChildren(person.PersonID);
                    
                    const personDiv = document.createElement('div');
                    personDiv.className = 'tree-node-container';
                    
                    let personHTML = '';
                    
                    if (spouse && !displayedPersons.has(spouse.PersonID)) {
                        personHTML += `
                            <div class="spouse-container">
                                <div class="married-couple">
                                    ${renderPersonCard(person)}
                                    ${renderPersonCard(spouse)}
                                </div>
                                ${renderChildren(children, genNumber + 1)}
                            </div>
                        `;
                        displayedPersons.add(person.PersonID);
                        displayedPersons.add(spouse.PersonID);
                    } else if (!spouse || displayedPersons.has(spouse.PersonID)) {
                        personHTML += `
                            ${renderPersonCard(person)}
                            ${renderChildren(children, genNumber + 1)}
                        `;
                        displayedPersons.add(person.PersonID);
                    }
                    
                    personDiv.innerHTML = personHTML;
                    genContainer.appendChild(personDiv);
                });
            });
            
            updateTreeZoom();
            updateTreePersonCount();
            setTimeout(addTreeConnectors, 100);
            if (currentTreeSearch) searchInTree();
        }

        
        // ============================================
        // ŸÖŸÜÿ∑ŸÇ ŸÖÿ≠ÿ≥ŸÜ ŸÑÿ≠ÿ≥ÿßÿ® ÿßŸÑÿ£ÿ¨ŸäÿßŸÑ + ÿ™ŸÖŸäŸäÿ≤ ÿßŸÑŸÖŸÜÿ™ŸÖŸäŸÜ ÿ®ÿßŸÑŸÜÿ≥ÿ® (ŸÖŸÜ ÿÆÿßÿ±ÿ¨ ÿßŸÑÿπÿßÿ¶ŸÑÿ©)
        // ============================================

        function getSpouseById(personId) {
            const person = familyData.find(p => p.PersonID === personId);
            if (!person) return null;

            // ÿØÿπŸÖ ÿßŸÑÿßÿ™ÿ¨ÿßŸáŸäŸÜ: (SpouseID ÿπŸÑŸâ ÿßŸÑÿ¥ÿÆÿµ) ÿ£Ÿà (SpouseID ÿπŸÑŸâ ÿßŸÑÿ∑ÿ±ŸÅ ÿßŸÑÿ¢ÿÆÿ±)
            let spouse = null;
            if (person.SpouseID && person.SpouseID !== 0) {
                spouse = familyData.find(p => p.PersonID === person.SpouseID) || null;
            }
            if (!spouse) {
                spouse = familyData.find(p => p.SpouseID === personId) || null;
            }
            return spouse;
        }

        function isOutsideFamily(personId, visited = new Set()) {
            if (visited.has(personId)) return false;
            visited.add(personId);

            const person = familyData.find(p => p.PersonID === personId);
            if (!person) return false;

            const noParents = (person.FatherID === 0 && person.MotherID === 0);
            if (!noParents) return false;

            const spouse = getSpouseById(personId);
            if (!spouse) return false;

            // ÿ•ÿ∞ÿß ŸÉÿßŸÜ/ŸÉÿßŸÜÿ™ ÿßŸÑÿ≤Ÿàÿ¨/ÿßŸÑÿ≤Ÿàÿ¨ÿ© ŸÑŸá/ŸÑŸáÿß ÿ¨ÿ∞Ÿàÿ± ÿØÿßÿÆŸÑ ÿßŸÑÿπÿßÿ¶ŸÑÿ© (ÿ£ÿ®/ÿ£ŸÖ) ÿ£Ÿà ŸäŸÖŸÉŸÜ ÿ•ÿ±ÿ¨ÿßÿπŸá ŸÑÿ¨ŸäŸÑ ÿ£ŸÉÿ®ÿ± ŸÖŸÜ 1
            const spouseHasParents = (spouse.FatherID !== 0 || spouse.MotherID !== 0);
            if (spouseHasParents) return true;

            // ÿ£Ÿà ÿ•ÿ∞ÿß ŸÉÿßŸÜ ÿßŸÑÿ≤Ÿàÿ¨ ŸÜŸÅÿ≥Ÿá/ŸÜŸÅÿ≥Ÿáÿß ŸÖÿ™ÿµŸÑ ÿ®ÿ≥ŸÑÿ≥ŸÑÿ© ŸÜÿ≥ÿ® ÿØÿßÿÆŸÑ ÿßŸÑÿπÿßÿ¶ŸÑÿ© ÿπÿ®ÿ± ÿ≤Ÿàÿ¨/ÿ£ÿ®ŸÜÿßÿ° ÿ•ŸÑÿÆ
            // (ÿßÿ≠ÿ™Ÿäÿßÿ∑Ÿä ŸÑŸÖŸÜÿπ ÿßŸÑÿ≠ÿßŸÑÿßÿ™ ÿ∫Ÿäÿ± ÿßŸÑŸÖŸÉÿ™ŸÖŸÑÿ© ŸÅŸä ÿßŸÑÿ®ŸäÿßŸÜÿßÿ™)
            const spouseGen = calculateGeneration(spouse.PersonID, new Set(visited));
            return spouseGen > 1;
        }

        function calculateGeneration(personId, visited = new Set()) {
            if (visited.has(personId)) return 0;
            visited.add(personId);

            const person = familyData.find(p => p.PersonID === personId);
            if (!person) return 0;

            const noParents = (person.FatherID === 0 && person.MotherID === 0);

            // ÿ™ÿµÿ≠Ÿäÿ≠ ÿßŸÑŸÖÿ¥ŸÉŸÑÿ©: ÿßŸÑÿ£ÿ¥ÿÆÿßÿµ ŸÖŸÜ ÿÆÿßÿ±ÿ¨ ÿßŸÑÿπÿßÿ¶ŸÑÿ© (ŸÖŸÜÿ≥Ÿàÿ®ŸäŸÜ ÿ®ÿßŸÑŸÜÿ≥ÿ®) ŸÑÿß ŸäŸèÿπÿ™ÿ®ÿ±ŸàŸÜ ÿ¨ÿ∞Ÿàÿ±ÿßŸã.
            // ŸÜÿπÿ∑ŸäŸáŸÖ ŸÜŸÅÿ≥ ÿ¨ŸäŸÑ ÿßŸÑÿ≤Ÿàÿ¨/ÿßŸÑÿ≤Ÿàÿ¨ÿ© ÿ®ÿØŸÑ ÿ¨ŸäŸÑ 1.
            if (noParents) {
                const spouse = getSpouseById(personId);
                if (spouse) {
                    const spouseHasParents = (spouse.FatherID !== 0 || spouse.MotherID !== 0);
                    if (spouseHasParents) {
                        return calculateGeneration(spouse.PersonID, visited);
                    }
                }
                return 1;
            }

            const fatherGen = person.FatherID ? calculateGeneration(person.FatherID, visited) : 0;
            const motherGen = person.MotherID ? calculateGeneration(person.MotherID, visited) : 0;

            return Math.max(fatherGen, motherGen) + 1;
        }

        function organizeByGeneration() {
            const generations = {};
            const sortedData = [...familyData].sort((a, b) => {
                return currentSortOrder === 'asc' ? a.PersonID - b.PersonID : b.PersonID - a.PersonID;
            });

            sortedData.forEach(person => {
                const gen = calculateGeneration(person.PersonID);
                if (!generations[gen]) generations[gen] = [];
                generations[gen].push(person);
            });

            const sortedGenerations = {};
            Object.keys(generations).sort((a, b) => a - b).forEach(key => {
                sortedGenerations[key] = generations[key];
            });

            return sortedGenerations;
        }

        function findChildren(personId) {
            return familyData.filter(p => p.FatherID === personId || p.MotherID === personId);
        }

        function findSpouse(personId) {
            return getSpouseById(personId);
        }        function renderPersonCard(person) {
            const spouse = findSpouse(person.PersonID);
            const isMarried = spouse ? 'married' : '';
            const genClass = `gen-${Math.min(calculateGeneration(person.PersonID), 5)}`;
            const generation = calculateGeneration(person.PersonID);
            const outsider = isOutsideFamily(person.PersonID);
            const outsiderClass = outsider ? 'outsider' : '';
            const outsiderBadge = outsider ? `<div class="outsider-badge" title="ŸÖŸÜ ÿÆÿßÿ±ÿ¨ ÿßŸÑÿπÿßÿ¶ŸÑÿ© (ŸÜÿ≥ÿ®)"><i class="fas fa-link"></i> ŸÜÿ≥ÿ®</div>` : '';

            
            const nodeId = `tree-node-${person.PersonID}`;
            
            return `
                <div class="tree-node ${person.Gender === 'ÿ∞ŸÉÿ±' ? 'male' : 'female'} ${isMarried} ${genClass} ${outsiderClass}" 
                     id="${nodeId}" onclick="onTreeNodeClick(event, ${person.PersonID})" data-person-id="${person.PersonID}">
                    ${outsiderBadge}
                    <div class="generation-badge">ÿßŸÑÿ¨ŸäŸÑ ${generation}</div>
                    <div class="node-header">
                        <div class="node-id">${person.PersonID}</div>
                        <div style="font-size: 11px; color: ${person.Gender === 'ÿ∞ŸÉÿ±' ? 'var(--male-color)' : 'var(--female-color)'}">
                            ${person.Gender === 'ÿ∞ŸÉÿ±' ? 'ÿ∞ŸÉÿ±' : 'ÿ£ŸÜÿ´Ÿâ'}
                        </div>
                    </div>
                    <div class="node-name" id="node-name-${person.PersonID}">${person.FullName}</div>
                    <div class="node-details">
                        ${person.BirthDate ? `<div>üë∂ ŸÖŸàŸÑÿØ: ${formatDate(person.BirthDate)}</div>` : ''}
                        ${person.DeathDate ? `<div>‚ò™Ô∏è ŸàŸÅÿßÿ©: ${formatDate(person.DeathDate)}</div>` : ''}
                    </div>
                    ${person.PlaceOfBirth ? `<div class="node-place"><i class="fas fa-map-marker-alt"></i> ${person.PlaceOfBirth}</div>` : ''}
                    ${spouse ? `<div style="margin-top: 5px; font-size: 10px; color: #E91E63;"><i class="fas fa-heart"></i> ŸÖÿ™ÿ≤Ÿàÿ¨</div>` : ''}
                </div>
            `;
        }

        // ============================================
        // ÿ™ŸÖŸäŸäÿ≤ ÿßŸÑÿ≥ŸÑÿßŸÑÿ© (ÿßŸÑÿ£ÿ≥ŸÑÿßŸÅ/ÿßŸÑÿ£ÿ≠ŸÅÿßÿØ) ÿπŸÜÿØ ÿßŸÑÿ∂ÿ∫ÿ∑
        // ============================================

        function onTreeNodeClick(evt, personId) {
            // ŸÖŸÜÿπ ŸÅÿ™ÿ≠ ÿ®ÿ∑ÿßŸÇÿ© ÿßŸÑÿ¥ÿÆÿµ ÿπŸÜÿØ ÿßŸÑÿ∂ÿ∫ÿ∑ ŸÑŸÑÿ™ÿ∏ŸÑŸäŸÑ ŸÅŸÇÿ∑
            if (evt) evt.stopPropagation();

            highlightLineage(personId);

            // ŸÅÿ™ÿ≠ ÿ™ŸÅÿßÿµŸäŸÑ ÿßŸÑÿ¥ÿÆÿµ ÿπŸÜÿØ ÿßŸÑÿ∂ÿ∫ÿ∑ ÿßŸÑŸÖÿ≤ÿØŸàÿ¨ ÿ£Ÿà ŸÖÿπ ALT
            if (evt && (evt.detail >= 2 || evt.altKey)) {
                viewPerson(personId);
            }
        }

        function buildChildrenMap() {
            const map = new Map();
            familyData.forEach(p => {
                const father = p.FatherID || 0;
                const mother = p.MotherID || 0;
                if (father) {
                    if (!map.has(father)) map.set(father, []);
                    map.get(father).push(p.PersonID);
                }
                if (mother) {
                    if (!map.has(mother)) map.set(mother, []);
                    map.get(mother).push(p.PersonID);
                }
            });
            return map;
        }

        function getAncestors(personId, maxDepth = 50) {
            const ancestors = new Set();
            const queue = [{ id: personId, depth: 0 }];
            while (queue.length) {
                const { id, depth } = queue.shift();
                if (depth >= maxDepth) continue;
                const p = familyData.find(x => x.PersonID === id);
                if (!p) continue;
                [p.FatherID, p.MotherID].forEach(pid => {
                    if (pid && pid !== 0 && !ancestors.has(pid)) {
                        ancestors.add(pid);
                        queue.push({ id: pid, depth: depth + 1 });
                    }
                });
            }
            return Array.from(ancestors);
        }

        function getDescendants(personId, maxDepth = 50) {
            const descendants = new Set();
            const childrenMap = buildChildrenMap();
            const queue = [{ id: personId, depth: 0 }];
            while (queue.length) {
                const { id, depth } = queue.shift();
                if (depth >= maxDepth) continue;
                const kids = childrenMap.get(id) || [];
                kids.forEach(kidId => {
                    if (!descendants.has(kidId)) {
                        descendants.add(kidId);
                        queue.push({ id: kidId, depth: depth + 1 });
                    }
                });
            }
            return Array.from(descendants);
        }

        function clearLineageHighlight() {
            document.querySelectorAll('.tree-node').forEach(node => {
                node.classList.remove('lineage-dimmed', 'lineage-selected', 'lineage-ancestor', 'lineage-descendant');
            });
        }

        function highlightLineage(personId) {
            clearLineageHighlight();

            const selected = document.querySelector(`.tree-node[data-person-id="${personId}"]`);
            if (!selected) return;

            const ancestors = getAncestors(personId);
            const descendants = getDescendants(personId);

            // ÿ™ÿπÿ™ŸäŸÖ ÿßŸÑÿ¨ŸÖŸäÿπ
            document.querySelectorAll('.tree-node').forEach(node => node.classList.add('lineage-dimmed'));

            // ÿ•ÿ∏Ÿáÿßÿ± ÿßŸÑÿ≥ŸÑÿßŸÑÿ©
            selected.classList.remove('lineage-dimmed');
            selected.classList.add('lineage-selected');

            ancestors.forEach(id => {
                const el = document.querySelector(`.tree-node[data-person-id="${id}"]`);
                if (el) {
                    el.classList.remove('lineage-dimmed');
                    el.classList.add('lineage-ancestor');
                }
            });

            descendants.forEach(id => {
                const el = document.querySelector(`.tree-node[data-person-id="${id}"]`);
                if (el) {
                    el.classList.remove('lineage-dimmed');
                    el.classList.add('lineage-descendant');
                }
            });

            // ÿ™ŸÖÿ±Ÿäÿ± ŸÑÿ∑ŸäŸÅ ŸÜÿ≠Ÿà ÿßŸÑÿ¥ÿÆÿµ ÿßŸÑŸÖÿ≠ÿØÿØ
            selected.scrollIntoView({ behavior: 'smooth', block: 'center', inline: 'center' });
        }


        function renderChildren(children, nextGen) {
            if (children.length === 0) return '';
            
            children.sort((a, b) => {
                if (a.BirthDate && b.BirthDate) return new Date(a.BirthDate) - new Date(b.BirthDate);
                return a.PersonID - b.PersonID;
            });
            
            let childrenHTML = '<div class="node-children">';
            
            children.forEach(child => {
                const childSpouse = findSpouse(child.PersonID);
                const grandChildren = findChildren(child.PersonID);
                
                childrenHTML += `
                    <div class="tree-node-container">
                        ${childSpouse ? `
                            <div class="married-couple">
                                ${renderPersonCard(child)}
                                ${renderPersonCard(childSpouse)}
                            </div>
                        ` : renderPersonCard(child)}
                        ${renderChildren(grandChildren, nextGen + 1)}
                    </div>
                `;
            });
            
            childrenHTML += '</div>';
            return childrenHTML;
        }

        function addTreeConnectors() {
            const nodeContainers = document.querySelectorAll('.tree-node-container');
            nodeContainers.forEach(container => {
                const childrenContainer = container.querySelector('.node-children');
                if (childrenContainer && childrenContainer.children.length > 0) {
                    const verticalConnector = document.createElement('div');
                    verticalConnector.className = 'tree-connector vertical-connector';
                    container.insertBefore(verticalConnector, childrenContainer);
                    
                    if (childrenContainer.children.length > 1) {
                        const horizontalConnector = document.createElement('div');
                        horizontalConnector.className = 'tree-connector horizontal-connector';
                        childrenContainer.insertBefore(horizontalConnector, childrenContainer.firstChild);
                    }
                }
            });
        }

        function updateTreePersonCount() {
            const nodes = document.querySelectorAll('.tree-node').length;
            if (document.getElementById('treePersonCount')) {
                document.getElementById('treePersonCount').textContent = nodes;
            }
        }

        function zoomInTree() {
            if (treeZoom < 200) {
                treeZoom += 10;
                updateTreeZoom();
            }
        }

        function zoomOutTree() {
            if (treeZoom > 50) {
                treeZoom -= 10;
                updateTreeZoom();
            }
        }

        function updateTreeZoom() {
            const treeContainer = document.getElementById('treeContainer');
            if (treeContainer) {
                treeContainer.style.transform = `scale(${treeZoom/100})`;
                treeContainer.style.transformOrigin = 'top center';
                if (document.getElementById('zoomLevel')) {
                    document.getElementById('zoomLevel').textContent = `${treeZoom}%`;
                }
            }
        }

        function toggleCompactMode() {
            treeCompactMode = !treeCompactMode;
            const treeContainer = document.getElementById('treeContainer');
            if (treeContainer) {
                if (treeCompactMode) {
                    treeContainer.classList.add('tree-compact');
                    showSuccess('ÿ™ŸÖ ÿ™ŸÅÿπŸäŸÑ ÿßŸÑÿπÿ±ÿ∂ ÿßŸÑŸÖÿ∂ÿ∫Ÿàÿ∑');
                } else {
                    treeContainer.classList.remove('tree-compact');
                    showSuccess('ÿ™ŸÖ ÿ•ŸÑÿ∫ÿßÿ° ÿßŸÑÿπÿ±ÿ∂ ÿßŸÑŸÖÿ∂ÿ∫Ÿàÿ∑');
                }
            }
        }

        function setTreeViewMode(mode) {
            treeViewMode = mode;
            const treeContainer = document.getElementById('treeContainer');
            const viewToggleBtns = document.querySelectorAll('.view-toggle-btn');
            
            viewToggleBtns.forEach(btn => btn.classList.remove('active'));
            if (mode === 'vertical') {
                viewToggleBtns[0].classList.add('active');
                if (treeContainer) treeContainer.classList.remove('tree-horizontal');
            } else {
                viewToggleBtns[1].classList.add('active');
                if (treeContainer) treeContainer.classList.add('tree-horizontal');
            }
            
            renderTree();
        }

        // ============================================
        // ÿØŸàÿßŸÑ ÿßŸÑÿ®ÿ≠ÿ´
        // ============================================

        function searchInTree() {
            const searchTerm = document.getElementById('treeSearch').value.trim().toLowerCase();
            currentTreeSearch = searchTerm;
            
            if (searchTerm === '') {
                clearTreeSearch();
                return;
            }
            
            const nodes = document.querySelectorAll('.tree-node');
            let foundCount = 0;
            
            nodes.forEach(node => {
                node.classList.add('search-no-match');
                node.classList.remove('search-match');
                const nameElement = node.querySelector('.node-name');
                if (nameElement) {
                    nameElement.innerHTML = nameElement.textContent;
                }
            });
            
            nodes.forEach(node => {
                const name = node.querySelector('.node-name').textContent.toLowerCase();
                const id = node.querySelector('.node-id').textContent.toLowerCase();
                const details = node.querySelector('.node-details')?.textContent.toLowerCase() || '';
                const place = node.querySelector('.node-place')?.textContent.toLowerCase() || '';
                
                let isMatch = false;
                
                if (name.includes(searchTerm)) {
                    isMatch = true;
                    const nameElement = node.querySelector('.node-name');
                    if (nameElement) {
                        const originalName = nameElement.textContent;
                        const highlightedName = highlightText(originalName, searchTerm);
                        nameElement.innerHTML = highlightedName;
                    }
                }
                
                if (id.includes(searchTerm)) {
                    isMatch = true;
                }
                
                if (details.includes(searchTerm) || place.includes(searchTerm)) {
                    isMatch = true;
                }
                
                if (isMatch) {
                    node.classList.remove('search-no-match');
                    node.classList.add('search-match');
                    foundCount++;
                    
                    const personId = parseInt(node.getAttribute('data-person-id') || node.id.replace('tree-node-', ''));
                    if (personId) {
                        showRelatedPersons(personId);
                    }
                }
            });
            
            updateSearchMatchCount(foundCount);
            
            if (foundCount > 0) {
                showSuccess(`ÿ™ŸÖ ÿßŸÑÿπÿ´Ÿàÿ± ÿπŸÑŸâ ${foundCount} ŸÅÿ±ÿØ`);
                
                const firstMatch = document.querySelector('.tree-node.search-match');
                if (firstMatch) {
                    setTimeout(() => {
                        firstMatch.scrollIntoView({ behavior: 'smooth', block: 'center' });
                    }, 300);
                }
            } else {
                showError('ŸÑŸÖ Ÿäÿ™ŸÖ ÿßŸÑÿπÿ´Ÿàÿ± ÿπŸÑŸâ ÿ£Ÿä ŸÅÿ±ÿØ');
            }
        }

        function highlightText(text, searchTerm) {
            if (!searchTerm) return text;
            
            const regex = new RegExp(`(${searchTerm})`, 'gi');
            return text.replace(regex, '<span class="search-highlight">$1</span>');
        }

        function showRelatedPersons(personId) {
            const person = familyData.find(p => p.PersonID === personId);
            if (!person) return;
            
            if (person.SpouseID > 0) {
                const spouseNode = document.getElementById(`tree-node-${person.SpouseID}`);
                if (spouseNode) {
                    spouseNode.classList.remove('search-no-match');
                    spouseNode.classList.add('search-match');
                }
            }
            
            const children = familyData.filter(p => p.FatherID === personId || p.MotherID === personId);
            children.forEach(child => {
                const childNode = document.getElementById(`tree-node-${child.PersonID}`);
                if (childNode) {
                    childNode.classList.remove('search-no-match');
                    childNode.classList.add('search-match');
                }
            });
            
            if (person.FatherID > 0) {
                const fatherNode = document.getElementById(`tree-node-${person.FatherID}`);
                if (fatherNode) {
                    fatherNode.classList.remove('search-no-match');
                    fatherNode.classList.add('search-match');
                }
            }
            
            if (person.MotherID > 0) {
                const motherNode = document.getElementById(`tree-node-${person.MotherID}`);
                if (motherNode) {
                    motherNode.classList.remove('search-no-match');
                    motherNode.classList.add('search-match');
                }
            }
        }

        function updateSearchMatchCount(count) {
            searchMatchCount = count;
            const matchCountElement = document.getElementById('searchMatchCount');
            if (matchCountElement) {
                if (count > 0) {
                    matchCountElement.textContent = count;
                    matchCountElement.style.display = 'inline-block';
                } else {
                    matchCountElement.style.display = 'none';
                }
            }
        }

        function clearTreeSearch() {
            const searchInput = document.getElementById('treeSearch');
            if (searchInput) searchInput.value = '';
            currentTreeSearch = '';
            searchMatchCount = 0;
            
            const nodes = document.querySelectorAll('.tree-node');
            nodes.forEach(node => {
                node.classList.remove('search-match');
                node.classList.remove('search-no-match');
                
                const nameElement = node.querySelector('.node-name');
                if (nameElement) {
                    nameElement.innerHTML = nameElement.textContent;
                }
            });
            
            const matchCountElement = document.getElementById('searchMatchCount');
            if (matchCountElement) {
                matchCountElement.style.display = 'none';
            }
            
            showSuccess('ÿ™ŸÖ ŸÖÿ≥ÿ≠ ÿßŸÑÿ®ÿ≠ÿ´');
        }

        function scrollToGeneration(genNumber) {
            const generationElement = document.getElementById(`generation-${genNumber}`);
            if (generationElement) {
                generationElement.scrollIntoView({ behavior: 'smooth', block: 'start' });
                generationElement.parentElement.classList.add('highlighted');
                setTimeout(() => {
                    generationElement.parentElement.classList.remove('highlighted');
                }, 2000);
            }
        }

        function setupTreeScrollListener() {
            const treeContainer = document.getElementById('treeContainer');
            const backToTopBtn = document.getElementById('backToTop');
            
            if (treeContainer && backToTopBtn) {
                treeContainer.addEventListener('scroll', () => {
                    if (treeContainer.scrollTop > 300) {
                        backToTopBtn.style.display = 'flex';
                    } else {
                        backToTopBtn.style.display = 'none';
                    }
                });
            }
        }

        function setupMobileSearch() {
            const mobileToggle = document.getElementById('mobileSearchToggle');
            const treeFilter = document.getElementById('treeFilter');
            const treeContainer = document.getElementById('treeContainer');
            
            if (!mobileToggle || !treeFilter || !treeContainer) return;
            
            mobileToggle.addEventListener('click', function() {
                treeFilter.classList.toggle('active');
                searchBarVisible = !searchBarVisible;
            });
            
            if (window.innerWidth <= 768) {
                treeFilter.classList.remove('active');
                searchBarVisible = false;
            }
            
            window.addEventListener('resize', function() {
                if (window.innerWidth <= 768 && searchBarVisible) {
                    treeFilter.classList.remove('active');
                    searchBarVisible = false;
                }
            });
        }

        function toggleMobileOptimization() {
            mobileOptimized = !mobileOptimized;
            const treeContainer = document.getElementById('treeContainer');
            
            if (treeContainer) {
                if (mobileOptimized) {
                    treeContainer.classList.add('mobile-optimized');
                    treeCompactMode = true;
                    treeZoom = 80;
                    showSuccess('ÿ™ŸÖ ÿ™ŸÅÿπŸäŸÑ Ÿàÿ∂ÿπ ÿßŸÑŸÖŸàÿ®ÿßŸäŸÑ ÿßŸÑŸÖŸÖŸäÿ≤');
                } else {
                    treeContainer.classList.remove('mobile-optimized');
                    treeCompactMode = false;
                    treeZoom = 100;
                    showSuccess('ÿ™ŸÖ ÿ•ŸÑÿ∫ÿßÿ° Ÿàÿ∂ÿπ ÿßŸÑŸÖŸàÿ®ÿßŸäŸÑ');
                }
                
                updateTreeZoom();
                renderTree();
            }
        }

        // ============================================
        // ÿØŸàÿßŸÑ ÿ™ÿµÿØŸäÿ± ÿßŸÑÿµŸàÿ±
        // ============================================

        function exportTreeImage(quality = 'normal') {
            showExportLoading('ÿ¨ÿßÿ±Ÿä ÿ™ÿ≠ÿ∂Ÿäÿ± ÿßŸÑÿµŸàÿ±ÿ©...');
            
            const treeContainer = document.getElementById('treeContainer');
            if (!treeContainer) {
                hideExportLoading();
                showError('ÿπŸÜÿµÿ± ÿßŸÑÿ¥ÿ¨ÿ±ÿ© ÿ∫Ÿäÿ± ŸÖŸàÿ¨ŸàÿØ');
                return;
            }
            
            const originalTransform = treeContainer.style.transform;
            const originalZoom = treeZoom;
            
            treeContainer.style.transform = 'scale(1)';
            treeContainer.style.transformOrigin = 'top center';
            
            const options = {
                backgroundColor: '#f8faf8',
                useCORS: true,
                allowTaint: true,
                logging: false,
                scrollX: 0,
                scrollY: 0,
                windowWidth: treeContainer.scrollWidth,
                windowHeight: treeContainer.scrollHeight
            };
            
            if (quality === 'high') {
                options.scale = 3;
                options.quality = 1.0;
            } else {
                options.scale = 2;
                options.quality = 0.95;
            }
            
            setTimeout(() => {
                html2canvas(treeContainer, options).then(canvas => {
                    treeContainer.style.transform = originalTransform;
                    
                    const image = canvas.toDataURL('image/png', 1.0);
                    const link = document.createElement('a');
                    const now = new Date();
                    const dateStr = `${now.getFullYear()}${(now.getMonth()+1).toString().padStart(2, '0')}${now.getDate().toString().padStart(2, '0')}_${now.getHours()}${now.getMinutes()}`;
                    link.download = `ÿ¥ÿ¨ÿ±ÿ©-ÿßŸÑÿπÿßÿ¶ŸÑÿ©-${dateStr}.png`;
                    link.href = image;
                    
                    document.body.appendChild(link);
                    link.click();
                    document.body.removeChild(link);
                    
                    hideExportLoading();
                    showSuccess('ÿ™ŸÖ ÿ™ÿµÿØŸäÿ± ÿµŸàÿ±ÿ© ÿßŸÑÿ¥ÿ¨ÿ±ÿ© ÿ®ŸÜÿ¨ÿßÿ≠!');
                    
                }).catch(error => {
                    treeContainer.style.transform = originalTransform;
                    hideExportLoading();
                    console.error('html2canvas error:', error);
                    showError('ŸÅÿ¥ŸÑ ÿ™ÿµÿØŸäÿ± ÿßŸÑÿµŸàÿ±ÿ©: ' + error.message);
                });
            }, 500);
        }

        function exportCurrentSection() {
            showExportLoading('ÿ¨ÿßÿ±Ÿä ÿ™ÿµÿØŸäÿ± ÿßŸÑÿ¨ÿ≤ÿ° ÿßŸÑŸÖÿ±ÿ¶Ÿä...');
            
            const treeContainer = document.getElementById('treeContainer');
            if (!treeContainer) {
                hideExportLoading();
                showError('ÿπŸÜÿµÿ± ÿßŸÑÿ¥ÿ¨ÿ±ÿ© ÿ∫Ÿäÿ± ŸÖŸàÿ¨ŸàÿØ');
                return;
            }
            
            const options = {
                scale: 2,
                backgroundColor: '#f8faf8',
                useCORS: true,
                logging: false,
                x: treeContainer.scrollLeft,
                y: treeContainer.scrollTop,
                width: treeContainer.clientWidth,
                height: treeContainer.clientHeight,
                windowWidth: treeContainer.clientWidth,
                windowHeight: treeContainer.clientHeight
            };
            
            setTimeout(() => {
                html2canvas(treeContainer, options).then(canvas => {
                    const image = canvas.toDataURL('image/png', 1.0);
                    const link = document.createElement('a');
                    const now = new Date();
                    const dateStr = `${now.getFullYear()}${(now.getMonth()+1).toString().padStart(2, '0')}${now.getDate().toString().padStart(2, '0')}`;
                    link.download = `ÿ¥ÿ¨ÿ±ÿ©-ÿßŸÑÿπÿßÿ¶ŸÑÿ©-ÿ¨ÿ≤ÿ°-${dateStr}.png`;
                    link.href = image;
                    
                    document.body.appendChild(link);
                    link.click();
                    document.body.removeChild(link);
                    
                    hideExportLoading();
                    showSuccess('ÿ™ŸÖ ÿ™ÿµÿØŸäÿ± ÿßŸÑÿ¨ÿ≤ÿ° ÿßŸÑŸÖÿ±ÿ¶Ÿä ÿ®ŸÜÿ¨ÿßÿ≠!');
                    
                }).catch(error => {
                    hideExportLoading();
                    console.error('html2canvas error:', error);
                    showError('ŸÅÿ¥ŸÑ ÿ™ÿµÿØŸäÿ± ÿßŸÑÿµŸàÿ±ÿ©: ' + error.message);
                });
            }, 500);
        }

        function exportTreeAsPDF() {
            showWarning('Ÿáÿ∞Ÿá ÿßŸÑŸÖŸäÿ≤ÿ© ŸÇŸäÿØ ÿßŸÑÿ™ÿ∑ŸàŸäÿ±. ÿ≥Ÿäÿ™ŸÖ ÿ™ÿµÿØŸäÿ± ÿµŸàÿ±ÿ© PNG ÿ®ÿØŸÑÿßŸã ŸÖŸÜ ÿ∞ŸÑŸÉ.');
            exportTreeImage('high');
        }

        function showExportLoading(message) {
            const loading = document.getElementById('exportLoading');
            const text = document.getElementById('exportLoadingText');
            if (loading && text) {
                text.textContent = message;
                loading.classList.add('active');
            }
        }

        function hideExportLoading() {
            const loading = document.getElementById('exportLoading');
            if (loading) {
                loading.classList.remove('active');
            }
        }

        // ============================================
        // ÿØŸàÿßŸÑ ÿßŸÑÿπÿ±ÿ∂ ŸàÿßŸÑÿ•ÿØÿßÿ±ÿ©
        // ============================================

        function updateStatistics() {
            const total = familyData.length;
            const males = familyData.filter(p => p.Gender === 'ÿ∞ŸÉÿ±').length;
            const females = familyData.filter(p => p.Gender === 'ÿßŸÜÿ´Ÿâ').length;
            const families = familyData.filter(p => (p.FatherID === 0 && p.MotherID === 0 && !isOutsideFamily(p.PersonID))).length;
            
            document.getElementById('totalPersons').textContent = total;
            document.getElementById('maleCount').textContent = males;
            document.getElementById('femaleCount').textContent = females;
            document.getElementById('familiesCount').textContent = families;
            
            if (document.getElementById('treePersonCount')) {
                document.getElementById('treePersonCount').textContent = total;
            }
        }

        function loadDashboard() {
            updateStatistics();
            loadPersonsTable();
        }

        function loadPersonsTable() {
            const tableBody = document.getElementById('tableBody');
            tableBody.innerHTML = '';
            
            const sortedData = [...familyData].sort((a, b) => {
                return currentSortOrder === 'asc' ? a.PersonID - b.PersonID : b.PersonID - a.PersonID;
            });
            
            sortedData.forEach(person => {
                const father = familyData.find(p => p.PersonID === person.FatherID);
                const mother = familyData.find(p => p.PersonID === person.MotherID);
                
                const row = `
                    <tr>
                        <td>${person.PersonID}</td>
                        <td><strong>${person.FullName}</strong></td>
                        <td>
                            <span class="gender-badge ${person.Gender === 'ÿ∞ŸÉÿ±' ? 'male' : 'female'}">
                                ${person.Gender === 'ÿ∞ŸÉÿ±' ? 'ÿ∞ŸÉÿ±' : 'ÿ£ŸÜÿ´Ÿâ'}
                            </span>
                        </td>
                        <td>${person.PlaceOfBirth || '-'}</td>
                        <td>${father ? father.FullName : '-'}</td>
                        <td>${mother ? mother.FullName : '-'}</td>
                        <td>
                            <div class="table-actions">
                                <button class="action-btn edit" onclick="editPerson(${person.PersonID})" 
                                        data-permission="edit" title="ÿ™ÿπÿØŸäŸÑ">
                                    <i class="fas fa-edit"></i>
                                </button>
                                <button class="action-btn view" onclick="showPersonDetail(${person.PersonID})" 
                                        data-permission="view" title="ÿπÿ±ÿ∂">
                                    <i class="fas fa-eye"></i>
                                </button>
                                <button class="action-btn delete" onclick="deletePerson(${person.PersonID})" 
                                        data-permission="delete" title="ÿ≠ÿ∞ŸÅ">
                                    <i class="fas fa-trash"></i>
                                </button>
                            </div>
                        </td>
                    </tr>
                `;
                tableBody.innerHTML += row;
            });
        }

        function showSuccess(message) {
            const alert = document.getElementById('successAlert');
            document.getElementById('successMessage').textContent = message;
            alert.style.display = 'flex';
            setTimeout(() => { alert.style.display = 'none'; }, 3000);
        }

        function showError(message) {
            const alert = document.getElementById('errorAlert');
            document.getElementById('errorMessage').textContent = message;
            alert.style.display = 'flex';
            setTimeout(() => { alert.style.display = 'none'; }, 3000);
        }

        function showWarning(message) {
            alert(message);
        }

        function showInfo(message) {
            const alertDiv = document.createElement('div');
            alertDiv.className = 'alert info';
            alertDiv.innerHTML = `<i class="fas fa-info-circle"></i> ${message}`;
            
            const controlPanel = document.querySelector('.control-panel');
            controlPanel.insertBefore(alertDiv, controlPanel.firstChild);
            
            setTimeout(() => alertDiv.remove(), 5000);
        }

        function formatDate(dateString) {
            if (!dateString) return '';
            try {
                const date = new Date(dateString);
                return date.toLocaleDateString('ar-EG', {
                    year: 'numeric',
                    month: 'long',
                    day: 'numeric'
                });
            } catch (error) {
                return dateString;
            }
        }

        function closePersonForm() {
            document.getElementById('personFormModal').classList.remove('active');
        }

        function viewPerson(personId) {
            showPersonDetail(personId);
        }

        function toggleSortOrder() {
            currentSortOrder = currentSortOrder === 'asc' ? 'desc' : 'asc';
            loadPersonsTable();
            showSuccess(currentSortOrder === 'asc' ? 'ÿ™ŸÖ ÿßŸÑÿ™ÿ±ÿ™Ÿäÿ® ÿ™ÿµÿßÿπÿØŸäÿßŸã' : 'ÿ™ŸÖ ÿßŸÑÿ™ÿ±ÿ™Ÿäÿ® ÿ™ŸÜÿßÿ≤ŸÑŸäÿßŸã');
        }

        function showAllPersons() {
            document.querySelectorAll('.menu-item').forEach(item => item.classList.remove('active'));
            document.querySelectorAll('.menu-item')[1].classList.add('active');
            loadPersonsTable();
        }

        function showSearch() {
            if (!checkPermission('edit')) {
                showError('ŸÑÿß ÿ™ŸÖŸÑŸÉ ÿµŸÑÿßÿ≠Ÿäÿ© ÿßŸÑÿ®ÿ≠ÿ´ ŸàÿßŸÑÿ™ÿπÿØŸäŸÑ');
                return;
            }
            
            const searchTerm = prompt('ÿ£ÿØÿÆŸÑ ÿßÿ≥ŸÖ ÿßŸÑŸÅÿ±ÿØ ŸÑŸÑÿ®ÿ≠ÿ´:');
            if (!searchTerm) return;
            
            const results = familyData.filter(person => person.FullName.includes(searchTerm));
            if (results.length === 0) {
                alert('ŸÑŸÖ Ÿäÿ™ŸÖ ÿßŸÑÿπÿ´Ÿàÿ± ÿπŸÑŸâ ŸÜÿ™ÿßÿ¶ÿ¨');
                return;
            }
            
            let message = `ŸÜÿ™ÿßÿ¶ÿ¨ ÿßŸÑÿ®ÿ≠ÿ´ ÿπŸÜ "${searchTerm}":\n\n`;
            results.forEach(person => {
                message += `${person.PersonID}. ${person.FullName} (${person.Gender === 'ÿ∞ŸÉÿ±' ? 'ÿ∞ŸÉÿ±' : 'ÿ£ŸÜÿ´Ÿâ'})\n`;
            });
            alert(message);
        }

        function showStatistics() {
            const total = familyData.length;
            const males = familyData.filter(p => p.Gender === 'ÿ∞ŸÉÿ±').length;
            const females = familyData.filter(p => p.Gender === 'ÿßŸÜÿ´Ÿâ').length;
            const families = familyData.filter(p => p.FatherID === 0).length;
            const married = familyData.filter(p => p.SpouseID !== 0).length;
            const alive = familyData.filter(p => !p.DeathDate || p.DeathDate === '').length;
            const deceased = total - alive;
            
            alert(`
                ÿ•ÿ≠ÿµÿßÿ¶Ÿäÿßÿ™ ÿßŸÑÿπÿßÿ¶ŸÑÿ©:
                
                ÿ•ÿ¨ŸÖÿßŸÑŸä ÿßŸÑÿ£ŸÅÿ±ÿßÿØ: ${total}
                ÿπÿØÿØ ÿßŸÑÿ∞ŸÉŸàÿ±: ${males} (${((males/total)*100).toFixed(1)}%)
                ÿπÿØÿØ ÿßŸÑÿ•ŸÜÿßÿ´: ${females} (${((females/total)*100).toFixed(1)}%)
                ÿπÿØÿØ ÿßŸÑÿπÿßÿ¶ŸÑÿßÿ™: ${families}
                ÿπÿØÿØ ÿßŸÑŸÖÿ™ÿ≤Ÿàÿ¨ŸäŸÜ: ${married} (${((married/total)*100).toFixed(1)}%)
                ÿπÿØÿØ ÿ∫Ÿäÿ± ÿßŸÑŸÖÿ™ÿ≤Ÿàÿ¨ŸäŸÜ: ${total - married}
                ÿπÿØÿØ ÿßŸÑÿ£ÿ≠Ÿäÿßÿ°: ${alive}
                ÿπÿØÿØ ÿßŸÑŸÖÿ™ŸàŸÅŸäŸÜ: ${deceased}
            `);
        }

        function showBackup() {
            if (confirm('ŸáŸÑ ÿ™ÿ±ŸäÿØ ÿ™ÿµÿØŸäÿ± ŸÜÿ≥ÿÆÿ© ÿßÿ≠ÿ™Ÿäÿßÿ∑Ÿäÿ© ŸÖŸÜ ÿ¨ŸÖŸäÿπ ÿßŸÑÿ®ŸäÿßŸÜÿßÿ™ÿü')) {
                exportData('json');
            }
        }

        function refreshData() {
            loadDashboard();
            showSuccess('ÿ™ŸÖ ÿ™ÿ≠ÿØŸäÿ´ ÿßŸÑÿ®ŸäÿßŸÜÿßÿ™ ÿ®ŸÜÿ¨ÿßÿ≠');
        }

        function handleFileImport(event) {
            if (!checkPermission('import')) {
                showError('ŸÑÿß ÿ™ŸÖŸÑŸÉ ÿµŸÑÿßÿ≠Ÿäÿ© ÿßŸÑÿßÿ≥ÿ™Ÿäÿ±ÿßÿØ');
                return;
            }
            
            const file = event.target.files[0];
            if (!file) return;
            
            const reader = new FileReader();
            reader.onload = function(e) {
                try {
                    const importedData = JSON.parse(e.target.result);
                    if (!Array.isArray(importedData)) throw new Error('ÿ™ŸÜÿ≥ŸäŸÇ ÿßŸÑŸÖŸÑŸÅ ÿ∫Ÿäÿ± ÿµÿ≠Ÿäÿ≠');
                    
                    if (confirm(`ÿ≥Ÿäÿ™ŸÖ ÿßÿ≥ÿ™Ÿäÿ±ÿßÿØ ${importedData.length} ŸÅÿ±ÿØ. ŸáŸÑ ÿ™ÿ±ŸäÿØ ÿßŸÑŸÖÿ™ÿßÿ®ÿπÿ©ÿü`)) {
                        familyData = importedData;
                        
                        if (familyData.length > 0) {
                            nextPersonId = Math.max(...familyData.map(p => p.PersonID)) + 1;
                        }
                        
                        if (saveData()) {
                            loadDashboard();
                            showSuccess(`ÿ™ŸÖ ÿßÿ≥ÿ™Ÿäÿ±ÿßÿØ ${importedData.length} ŸÅÿ±ÿØ ÿ®ŸÜÿ¨ÿßÿ≠`);
                        }
                    }
                } catch (error) {
                    showError('ŸÅÿ¥ŸÑ ÿßÿ≥ÿ™Ÿäÿ±ÿßÿØ ÿßŸÑŸÖŸÑŸÅ: ' + error.message);
                }
            };
            
            reader.readAsText(file);
        }

        // ============================================
        // ÿØŸàÿßŸÑ ŸÖÿ≥ÿßÿπÿØÿ© ÿ•ÿ∂ÿßŸÅŸäÿ©
        // ============================================

        let bookCompact = false;

        function setBrandFamilyName(name){
            try{
                const root = document.documentElement;
                if(name && name.trim()){
                    root.style.setProperty('--brand-family-name', `"${name.trim()}"`);
                }
            }catch(e){}
        }

        function applyBrandingFromInput(){
            const inp = document.getElementById('familyBrandNameInput');
            const val = inp ? inp.value : '';
            if(val && val.trim()){
                setBrandFamilyName(val.trim());
                showSuccess('ÿ™ŸÖ ÿ™ÿ∑ÿ®ŸäŸÇ ÿßŸÑŸáŸàŸäÿ© ÿßŸÑÿ®ÿµÿ±Ÿäÿ©');
                // ÿ•ÿπÿßÿØÿ© ÿ™ŸàŸÑŸäÿØ ÿßŸÑŸÉÿ™ÿßÿ® ŸÑÿ™ÿ∏Ÿáÿ± ÿßŸÑŸáŸàŸäÿ© ŸÅŸàÿ±ÿßŸã
                generateFamilyBook();
            }else{
                showWarning('ÿßŸÉÿ™ÿ® ÿßÿ≥ŸÖ ÿßŸÑÿπÿßÿ¶ŸÑÿ© ÿ£ŸàŸÑÿßŸã');
            }
        }

        function toggleBookCompact(){
            bookCompact = !bookCompact;
            generateFamilyBook();
            showInfo(bookCompact ? 'ÿ™ŸÖ ÿ™ŸÅÿπŸäŸÑ ÿßŸÑÿ™ÿÆÿ∑Ÿäÿ∑ ÿßŸÑŸÖÿ∂ÿ∫Ÿàÿ∑' : 'ÿ™ŸÖ ÿ™ŸÅÿπŸäŸÑ ÿßŸÑÿ™ÿÆÿ∑Ÿäÿ∑ ÿßŸÑŸÖŸàÿ≥ÿπ');
        }

        function safeText(v){
            return (v === null || v === undefined) ? '' : String(v);
        }

        function getPersonById(id){
            return familyData.find(p => Number(p.PersonID) === Number(id)) || null;
        }

        function formatDateDisplay(d){
            if(!d) return '';
            try{
                return new Date(d).toLocaleDateString(currentLanguage === 'ar' ? 'ar-EG' : 'en-US');
            }catch(e){ return d; }
        }

        function computeAge(birthDate){
            if(!birthDate) return null;
            try{
                const bd = new Date(birthDate);
                if(isNaN(bd.getTime())) return null;
                const now = new Date();
                let age = now.getFullYear() - bd.getFullYear();
                const m = now.getMonth() - bd.getMonth();
                if(m < 0 || (m === 0 && now.getDate() < bd.getDate())) age--;
                return age;
            }catch(e){ return null; }
        }

        // ============================================
        // ÿ™ŸáŸäÿ¶ÿ© ÿßŸÑŸÜÿ∏ÿßŸÖ ÿπŸÜÿØ ÿßŸÑÿ™ÿ≠ŸÖŸäŸÑ
        // ============================================

        window.onload = function() {
            updateLanguage();
        };
    </script>
</body>
</html>
