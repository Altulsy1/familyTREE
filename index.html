        // ============================================
        // تمييز السلالة (الأسلاف/الأحفاد) عند الضغط
        // ============================================

        function getAncestors(personId, ancestors = new Set()) {
            const person = familyData.find(p => p.PersonID === personId);
            if (!person) return Array.from(ancestors);
            
            if (person.FatherID !== 0 && person.FatherID) {
                ancestors.add(person.FatherID);
                getAncestors(person.FatherID, ancestors);
            }
            
            if (person.MotherID !== 0 && person.MotherID) {
                ancestors.add(person.MotherID);
                getAncestors(person.MotherID, ancestors);
            }
            
            return Array.from(ancestors);
        }

        function getDescendants(personId, descendants = new Set()) {
            const children = findChildren(personId);
            
            children.forEach(child => {
                descendants.add(child.PersonID);
                getDescendants(child.PersonID, descendants);
            });
            
            return Array.from(descendants);
        }

        function highlightLineage(personId) {
            // إزالة التمييز السابق
            document.querySelectorAll('.tree-node').forEach(node => {
                node.classList.remove('lineage-dimmed', 'lineage-selected', 'lineage-ancestor', 'lineage-descendant');
            });
            
            const ancestors = getAncestors(personId);
            const descendants = getDescendants(personId);
            
            // تمييز الفرد المحدد
            const selectedNode = document.querySelector(`.tree-node[data-person-id="${personId}"]`);
            if (selectedNode) {
                selectedNode.classList.add('lineage-selected');
            }
            
            // تمييز الأسلاف
            ancestors.forEach(ancestorId => {
                const ancestorNode = document.querySelector(`.tree-node[data-person-id="${ancestorId}"]`);
                if (ancestorNode) {
                    ancestorNode.classList.add('lineage-ancestor');
                }
            });
            
            // تمييز الأحفاد
            descendants.forEach(descendantId => {
                const descendantNode = document.querySelector(`.tree-node[data-person-id="${descendantId}"]`);
                if (descendantNode) {
                    descendantNode.classList.add('lineage-descendant');
                }
            });
            
            // تخفيف الباقين
            document.querySelectorAll('.tree-node').forEach(node => {
                const nodeId = parseInt(node.getAttribute('data-person-id'));
                if (nodeId !== personId && 
                    !ancestors.includes(nodeId) && 
                    !descendants.includes(nodeId)) {
                    node.classList.add('lineage-dimmed');
                }
            });
        }

        function clearLineageHighlight() {
            document.querySelectorAll('.tree-node').forEach(node => {
                node.classList.remove('lineage-dimmed', 'lineage-selected', 'lineage-ancestor', 'lineage-descendant');
            });
        }

        function onTreeNodeClick(event, personId) {
            event.stopPropagation();
            highlightLineage(personId);
            
            // إذا كان هناك بحث نشط، نظهر التفاصيل
            if (!currentTreeSearch) {
                showPersonDetail(personId);
            }
        }

        function renderChildren(children, generation) {
            if (children.length === 0) return '';
            
            return `
                <div class="node-children" style="min-height: 50px;">
                    ${children.map(child => renderPersonCard(child)).join('')}
                </div>
            `;
        }

        function addTreeConnectors() {
            document.querySelectorAll('.tree-node-container').forEach(container => {
                const parentNode = container.querySelector('.tree-node');
                const childrenContainer = container.querySelector('.node-children');
                
                if (parentNode && childrenContainer && childrenContainer.children.length > 0) {
                    const connector = document.createElement('div');
                    connector.className = 'tree-connector vertical-connector';
                    container.insertBefore(connector, parentNode.nextSibling);
                    
                    if (childrenContainer.children.length > 1) {
                        const horizontalConnector = document.createElement('div');
                        horizontalConnector.className = 'tree-connector horizontal-connector';
                        childrenContainer.insertBefore(horizontalConnector, childrenContainer.firstChild);
                    }
                }
            });
        }

        function updateTreeZoom() {
            const wrapper = document.getElementById('treeWrapper');
            if (wrapper) {
                wrapper.style.transform = `scale(${treeZoom / 100})`;
                wrapper.style.transformOrigin = 'top right';
                document.getElementById('zoomLevel').textContent = `${treeZoom}%`;
            }
        }

        function zoomInTree() {
            if (treeZoom < 200) {
                treeZoom += 10;
                updateTreeZoom();
            }
        }

        function zoomOutTree() {
            if (treeZoom > 30) {
                treeZoom -= 10;
                updateTreeZoom();
            }
        }

        function toggleCompactMode() {
            treeCompactMode = !treeCompactMode;
            const wrapper = document.getElementById('treeWrapper');
            
            if (treeCompactMode) {
                wrapper.classList.add('compact-mode');
                showSuccess('تم تفعيل العرض المضغوط');
            } else {
                wrapper.classList.remove('compact-mode');
                showSuccess('تم تفعيل العرض العادي');
            }
        }

        function toggleMobileOptimization() {
            mobileOptimized = !mobileOptimized;
            const treeContainer = document.getElementById('treeContainer');
            
            if (mobileOptimized) {
                treeContainer.classList.add('mobile-optimized');
                showSuccess('تم تفعيل وضع الموبايل');
            } else {
                treeContainer.classList.remove('mobile-optimized');
                showSuccess('تم تعطيل وضع الموبايل');
            }
        }

        function searchInTree() {
            const searchTerm = document.getElementById('treeSearch').value.toLowerCase();
            currentTreeSearch = searchTerm;
            searchMatchCount = 0;
            
            document.querySelectorAll('.tree-node').forEach(node => {
                const name = node.querySelector('.node-name').textContent.toLowerCase();
                const id = node.getAttribute('data-person-id');
                const person = familyData.find(p => p.PersonID === parseInt(id));
                
                let match = false;
                if (searchTerm) {
                    match = name.includes(searchTerm) || 
                           id.includes(searchTerm) ||
                           (person && person.PlaceOfBirth && person.PlaceOfBirth.toLowerCase().includes(searchTerm)) ||
                           (person && person.Notes && person.Notes.toLowerCase().includes(searchTerm));
                }
                
                node.classList.remove('search-match', 'search-no-match');
                
                if (searchTerm) {
                    if (match) {
                        node.classList.add('search-match');
                        searchMatchCount++;
                    } else {
                        node.classList.add('search-no-match');
                    }
                }
            });
            
            const searchMatchElement = document.getElementById('searchMatchCount');
            if (searchTerm && searchMatchCount > 0) {
                searchMatchElement.textContent = ` (${searchMatchCount} مطابق)`;
                searchMatchElement.style.display = 'inline';
                showSuccess(`تم العثور على ${searchMatchCount} فرد`);
                
                // تمرير للعنصر الأول المطابق
                const firstMatch = document.querySelector('.tree-node.search-match');
                if (firstMatch) {
                    firstMatch.scrollIntoView({ behavior: 'smooth', block: 'center' });
                    highlightLineage(parseInt(firstMatch.getAttribute('data-person-id')));
                }
            } else if (searchTerm) {
                searchMatchElement.style.display = 'none';
                showError('لم يتم العثور على أفراد يطابقون البحث');
            } else {
                searchMatchElement.style.display = 'none';
                clearLineageHighlight();
            }
        }

        function clearTreeSearch() {
            document.getElementById('treeSearch').value = '';
            currentTreeSearch = '';
            searchMatchCount = 0;
            document.getElementById('searchMatchCount').style.display = 'none';
            searchInTree();
            clearLineageHighlight();
        }

        function scrollToGeneration(genNumber) {
            const genElement = document.getElementById(`generation-${genNumber}`);
            if (genElement) {
                genElement.scrollIntoView({ behavior: 'smooth' });
            }
        }

        function setupTreeScrollListener() {
            const treeContent = document.getElementById('treeContainer');
            if (!treeContent) return;
            
            treeContent.addEventListener('scroll', function() {
                const currentScrollTop = treeContent.scrollTop;
                
                if (Math.abs(currentScrollTop - lastScrollTop) > 50) {
                    const treeFilter = document.getElementById('treeFilter');
                    if (currentScrollTop > lastScrollTop) {
                        // التمرير لأسفل - إخفاء شريط البحث
                        treeFilter.style.transform = 'translateY(-100%)';
                    } else {
                        // التمرير لأعلى - إظهار شريط البحث
                        treeFilter.style.transform = 'translateY(0)';
                    }
                    lastScrollTop = currentScrollTop;
                }
            });
        }

        function setupMobileSearch() {
            const mobileSearchToggle = document.getElementById('mobileSearchToggle');
            const treeFilter = document.getElementById('treeFilter');
            
            if (mobileSearchToggle && treeFilter) {
                mobileSearchToggle.addEventListener('click', function() {
                    treeFilter.classList.toggle('active');
                });
                
                // إغلاق شريط البحث عند النقر خارجها
                document.addEventListener('click', function(event) {
                    if (!treeFilter.contains(event.target) && 
                        !mobileSearchToggle.contains(event.target) && 
                        treeFilter.classList.contains('active')) {
                        treeFilter.classList.remove('active');
                    }
                });
            }
        }

        function updateTreePersonCount() {
            document.getElementById('treePersonCount').textContent = familyData.length;
        }

        // ============================================
        // دوال التصدير والاستيراد
        // ============================================

        function toggleExportMenu() {
            const menu = document.getElementById('exportMenu');
            menu.classList.toggle('show');
            
            // إغلاق القائمة عند النقر خارجها
            setTimeout(() => {
                document.addEventListener('click', function closeMenu(event) {
                    if (!menu.contains(event.target) && !event.target.closest('.export-options')) {
                        menu.classList.remove('show');
                        document.removeEventListener('click', closeMenu);
                    }
                });
            }, 10);
        }

        function toggleTreeExportMenu() {
            const menu = document.getElementById('treeExportMenu');
            menu.classList.toggle('show');
            
            setTimeout(() => {
                document.addEventListener('click', function closeMenu(event) {
                    if (!menu.contains(event.target) && !event.target.closest('.export-options')) {
                        menu.classList.remove('show');
                        document.removeEventListener('click', closeMenu);
                    }
                });
            }, 10);
        }

        function exportData(format) {
            let dataStr, fileName, mimeType;
            
            switch(format) {
                case 'json':
                    dataStr = JSON.stringify(familyData, null, 2);
                    fileName = `family-tree-${new Date().toISOString().split('T')[0]}.json`;
                    mimeType = 'application/json';
                    break;
                    
                case 'excel':
                    const ws = XLSX.utils.json_to_sheet(familyData);
                    const wb = XLSX.utils.book_new();
                    XLSX.utils.book_append_sheet(wb, ws, "Family Members");
                    XLSX.writeFile(wb, `family-tree-${new Date().toISOString().split('T')[0]}.xlsx`);
                    showSuccess('تم تصدير البيانات كملف Excel بنجاح');
                    return;
                    
                case 'csv':
                    const csv = XLSX.utils.sheet_to_csv(XLSX.utils.json_to_sheet(familyData));
                    dataStr = csv;
                    fileName = `family-tree-${new Date().toISOString().split('T')[0]}.csv`;
                    mimeType = 'text/csv';
                    break;
                    
                default:
                    return;
            }
            
            const blob = new Blob([dataStr], { type: mimeType });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = fileName;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
            
            showSuccess(`تم تصدير البيانات كملف ${format.toUpperCase()} بنجاح`);
        }

        function exportFullExcel() {
            const enrichedData = familyData.map(person => {
                const father = familyData.find(p => p.PersonID === person.FatherID);
                const mother = familyData.find(p => p.PersonID === person.MotherID);
                const spouse = familyData.find(p => p.PersonID === person.SpouseID);
                const childrenCount = findChildren(person.PersonID).length;
                const generation = calculateGeneration(person.PersonID);
                
                return {
                    ...person,
                    FatherName: father ? father.FullName : '',
                    MotherName: mother ? mother.FullName : '',
                    SpouseName: spouse ? spouse.FullName : '',
                    ChildrenCount: childrenCount,
                    Generation: generation
                };
            });
            
            const ws = XLSX.utils.json_to_sheet(enrichedData);
            const wb = XLSX.utils.book_new();
            XLSX.utils.book_append_sheet(wb, ws, "Family Members");
            
            // إضافة صفحة للعلاقات
            const relationships = [];
            familyData.forEach(person => {
                if (person.FatherID !== 0) {
                    relationships.push({
                        Person: person.FullName,
                        Relation: 'Father',
                        RelatedTo: familyData.find(p => p.PersonID === person.FatherID)?.FullName || '',
                        PersonID: person.PersonID,
                        RelatedID: person.FatherID
                    });
                }
                if (person.MotherID !== 0) {
                    relationships.push({
                        Person: person.FullName,
                        Relation: 'Mother',
                        RelatedTo: familyData.find(p => p.PersonID === person.MotherID)?.FullName || '',
                        PersonID: person.PersonID,
                        RelatedID: person.MotherID
                    });
                }
                if (person.SpouseID !== 0) {
                    relationships.push({
                        Person: person.FullName,
                        Relation: 'Spouse',
                        RelatedTo: familyData.find(p => p.PersonID === person.SpouseID)?.FullName || '',
                        PersonID: person.PersonID,
                        RelatedID: person.SpouseID
                    });
                }
            });
            
            const ws2 = XLSX.utils.json_to_sheet(relationships);
            XLSX.utils.book_append_sheet(wb, ws2, "Relationships");
            
            XLSX.writeFile(wb, `family-tree-complete-${new Date().toISOString().split('T')[0]}.xlsx`);
            showSuccess('تم تصدير البيانات المتقدمة بنجاح');
        }

        function exportTreeImage(quality) {
            showExportLoading('جاري تحضير صورة الشجرة...');
            
            setTimeout(() => {
                const treeContent = document.getElementById('treeContainer');
                const scale = quality === 'high' ? 2 : 1;
                
                html2canvas(treeContent, {
                    scale: scale,
                    useCORS: true,
                    backgroundColor: '#f8faf8',
                    logging: false,
                    allowTaint: true,
                    foreignObjectRendering: false,
                    width: treeContent.scrollWidth,
                    height: treeContent.scrollHeight
                }).then(canvas => {
                    const link = document.createElement('a');
                    link.download = `family-tree-${new Date().toISOString().split('T')[0]}.png`;
                    link.href = canvas.toDataURL('image/png');
                    link.click();
                    hideExportLoading();
                    showSuccess('تم تصدير صورة الشجرة بنجاح');
                }).catch(error => {
                    hideExportLoading();
                    showError('فشل تصدير الصورة: ' + error.message);
                });
            }, 100);
        }

        function exportCurrentSection() {
            showExportLoading('جاري تحضير صورة الجزء المرئي...');
            
            setTimeout(() => {
                const treeContent = document.getElementById('treeContainer');
                
                html2canvas(treeContent, {
                    scale: 2,
                    useCORS: true,
                    backgroundColor: '#f8faf8',
                    logging: false
                }).then(canvas => {
                    const link = document.createElement('a');
                    link.download = `family-tree-section-${new Date().toISOString().split('T')[0]}.png`;
                    link.href = canvas.toDataURL('image/png');
                    link.click();
                    hideExportLoading();
                    showSuccess('تم تصدير صورة الجزء المرئي بنجاح');
                }).catch(error => {
                    hideExportLoading();
                    showError('فشل تصدير الصورة: ' + error.message);
                });
            }, 100);
        }

        function showExportLoading(message) {
            const loading = document.getElementById('exportLoading');
            const text = document.getElementById('exportLoadingText');
            if (loading && text) {
                text.textContent = message;
                loading.classList.add('active');
            }
        }

        function hideExportLoading() {
            const loading = document.getElementById('exportLoading');
            if (loading) {
                loading.classList.remove('active');
            }
        }

        function handleFileImport(event) {
            const file = event.target.files[0];
            if (!file) return;
            
            const reader = new FileReader();
            reader.onload = function(e) {
                try {
                    const importedData = JSON.parse(e.target.result);
                    
                    if (Array.isArray(importedData)) {
                        if (confirm(`سيتم استيراد ${importedData.length} فرد. هل تريد المتابعة؟`)) {
                            familyData = importedData;
                            if (saveData()) {
                                nextPersonId = familyData.length > 0 ? Math.max(...familyData.map(p => p.PersonID)) + 1 : 1;
                                loadDashboard();
                                showSuccess(`تم استيراد ${importedData.length} فرد بنجاح`);
                            }
                        }
                    } else {
                        showError('ملف غير صالح. يجب أن يحتوي على مصفوفة من الأفراد.');
                    }
                } catch (error) {
                    showError('فشل قراءة الملف: ' + error.message);
                }
                
                event.target.value = '';
            };
            
            reader.readAsText(file);
        }

        // ============================================
        // دوال استيراد Excel
        // ============================================

        function showExcelImport() {
            document.getElementById('excelImportModal').classList.add('active');
        }

        function closeExcelImport() {
            document.getElementById('excelImportModal').classList.remove('active');
            clearExcelPreview();
        }

        function handleExcelFileSelect(event) {
            const file = event.target.files[0];
            if (!file) return;
            
            const reader = new FileReader();
            reader.onload = function(e) {
                try {
                    const data = new Uint8Array(e.target.result);
                    const workbook = XLSX.read(data, { type: 'array' });
                    const firstSheet = workbook.Sheets[workbook.SheetNames[0]];
                    excelData = XLSX.utils.sheet_to_json(firstSheet);
                    
                    if (excelData.length > 0) {
                        displayExcelPreview();
                    }
                } catch (error) {
                    showError('فشل قراءة ملف Excel: ' + error.message);
                }
            };
            
            reader.readAsArrayBuffer(file);
        }

        function displayExcelPreview() {
            const previewDiv = document.getElementById('excelPreview');
            const tableHead = document.getElementById('excelTableHead');
            const tableBody = document.getElementById('excelTableBody');
            const statsDiv = document.getElementById('importStats');
            
            if (excelData.length === 0) {
                previewDiv.style.display = 'none';
                return;
            }
            
            // عرض العناوين
            const headers = Object.keys(excelData[0]);
            tableHead.innerHTML = `<tr>${headers.map(h => `<th>${h}</th>`).join('')}</tr>`;
            
            // عرض البيانات
            tableBody.innerHTML = '';
            excelData.slice(0, 10).forEach(row => {
                const tr = document.createElement('tr');
                headers.forEach(header => {
                    const td = document.createElement('td');
                    td.textContent = row[header] || '';
                    tr.appendChild(td);
                });
                tableBody.appendChild(tr);
            });
            
            // عرض الإحصائيات
            statsDiv.style.display = 'block';
            document.getElementById('importStatsText').textContent = 
                `تم تحميل ${excelData.length} صف. ${excelData.length > 10 ? 'يتم عرض أول 10 صفوف فقط.' : ''}`;
            
            previewDiv.style.display = 'block';
        }

        function clearExcelPreview() {
            excelData = [];
            document.getElementById('excelPreview').style.display = 'none';
            document.getElementById('excelFile').value = '';
        }

        function importExcelData() {
            if (excelData.length === 0) {
                showError('لا توجد بيانات للاستيراد');
                return;
            }
            
            if (!confirm(`سيتم استيراد ${excelData.length} فرد. هل تريد المتابعة؟`)) {
                return;
            }
            
            try {
                const importedPersons = [];
                
                excelData.forEach((row, index) => {
                    const person = {
                        PersonID: row['PersonID'] || row['رقم'] || nextPersonId + index,
                        FullName: row['FullName'] || row['الاسم'] || row['Name'] || '',
                        Gender: (row['Gender'] || row['الجنس'] || 'ذكر') === 'ذكر' ? 'ذكر' : 'انثى',
                        PlaceOfBirth: row['PlaceOfBirth'] || row['مكان الميلاد'] || '',
                        BirthDate: row['BirthDate'] || row['تاريخ الميلاد'] || '',
                        DeathDate: row['DeathDate'] || row['تاريخ الوفاة'] || '',
                        FatherID: parseInt(row['FatherID'] || row['الأب'] || 0),
                        MotherID: parseInt(row['MotherID'] || row['الأم'] || 0),
                        SpouseID: parseInt(row['SpouseID'] || row['الزوج'] || row['الزوجة'] || 0),
                        Notes: row['Notes'] || row['ملاحظات'] || ''
                    };
                    
                    importedPersons.push(person);
                });
                
                // دمج مع البيانات الحالية
                familyData = [...familyData, ...importedPersons];
                
                // تحديث nextPersonId
                if (familyData.length > 0) {
                    nextPersonId = Math.max(...familyData.map(p => p.PersonID)) + 1;
                }
                
                if (saveData()) {
                    closeExcelImport();
                    loadDashboard();
                    showSuccess(`تم استيراد ${importedPersons.length} فرد بنجاح`);
                }
            } catch (error) {
                showError('فشل استيراد البيانات: ' + error.message);
            }
        }

        function downloadExcelTemplate() {
            const templateData = [
                {
                    PersonID: 1,
                    FullName: "محمد عبدالرحمن ادم",
                    Gender: "ذكر",
                    PlaceOfBirth: "الرياض",
                    BirthDate: "1950-01-01",
                    DeathDate: "",
                    FatherID: 0,
                    MotherID: 0,
                    SpouseID: 2,
                    Notes: "الجد"
                },
                {
                    PersonID: 2,
                    FullName: "عائشة ابكر محمد",
                    Gender: "انثى",
                    PlaceOfBirth: "الرياض",
                    BirthDate: "1955-01-01",
                    DeathDate: "",
                    FatherID: 0,
                    MotherID: 0,
                    SpouseID: 1,
                    Notes: "الجدة"
                }
            ];
            
            const ws = XLSX.utils.json_to_sheet(templateData);
            const wb = XLSX.utils.book_new();
            XLSX.utils.book_append_sheet(wb, ws, "Family Template");
            XLSX.writeFile(wb, "family-tree-template.xlsx");
            showSuccess('تم تحميل النموذج بنجاح');
        }

        // ============================================
        // دوال مساعدة إضافية
        // ============================================

        function formatDate(dateString) {
            if (!dateString) return '';
            try {
                const date = new Date(dateString);
                return date.toLocaleDateString('ar-EG');
            } catch (error) {
                return dateString;
            }
        }

        function formatDateDisplay(dateString) {
            if (!dateString) return '';
            try {
                const date = new Date(dateString);
                return date.toLocaleDateString('ar-EG', {
                    year: 'numeric',
                    month: 'long',
                    day: 'numeric'
                });
            } catch (error) {
                return dateString;
            }
        }

        function computeAge(birthDate) {
            if (!birthDate) return null;
            try {
                const birth = new Date(birthDate);
                const today = new Date();
                let age = today.getFullYear() - birth.getFullYear();
                const monthDiff = today.getMonth() - birth.getMonth();
                if (monthDiff < 0 || (monthDiff === 0 && today.getDate() < birth.getDate())) {
                    age--;
                }
                return age;
            } catch (error) {
                return null;
            }
        }

        function loadUsers() {
            const savedUsers = localStorage.getItem('familyTreeUsers');
            if (savedUsers) {
                try {
                    const parsedUsers = JSON.parse(savedUsers);
                    Object.assign(users, parsedUsers);
                } catch (error) {
                    console.error('Error loading users:', error);
                }
            }
        }

        function updateUIByPermissions() {
            if (!currentUser) return;
            
            const permissions = userPermissions[currentUser] || userPermissions['user'];
            
            // تحديث الأزرار حسب الصلاحيات
            const addButton = document.querySelector('.btn-primary[onclick*="showAddPersonForm"]');
            const exportButton = document.querySelector('.btn-warning[onclick*="toggleExportMenu"]');
            const importButton = document.querySelector('.import-btn');
            
            if (addButton) addButton.style.display = permissions.includes('add') ? 'inline-flex' : 'none';
            if (exportButton) exportButton.style.display = permissions.includes('export') ? 'inline-flex' : 'none';
            if (importButton) importButton.style.display = permissions.includes('import') ? 'inline-flex' : 'none';
        }

        function updateSidebarPermissions() {
            if (!currentUser) return;
            
            const permissions = userPermissions[currentUser] || userPermissions['user'];
            const menuItems = document.querySelectorAll('.sidebar-menu li');
            
            // إخفاء عناصر القائمة حسب الصلاحيات
            menuItems.forEach(item => {
                const text = item.textContent || '';
                if (text.includes('الصلاحيات') && !permissions.includes('manage_users')) {
                    item.style.display = 'none';
                } else if (text.includes('Excel') && !permissions.includes('import')) {
                    item.style.display = 'none';
                } else if (text.includes('التشفير') && currentUser !== 'admin') {
                    item.style.display = 'none';
                } else {
                    item.style.display = 'flex';
                }
            });
        }

        function checkPermission(permission) {
            if (!currentUser) return false;
            const permissions = userPermissions[currentUser] || userPermissions['user'];
            return permissions.includes(permission);
        }

        // ============================================
        // دوال عرض الرسائل
        // ============================================

        function showSuccess(message) {
            const alert = document.getElementById('successAlert');
            const messageElement = document.getElementById('successMessage');
            
            if (alert && messageElement) {
                messageElement.textContent = message;
                alert.style.display = 'flex';
                
                setTimeout(() => {
                    alert.style.display = 'none';
                }, 3000);
            }
        }

        function showError(message) {
            const alert = document.getElementById('errorAlert');
            const messageElement = document.getElementById('errorMessage');
            
            if (alert && messageElement) {
                messageElement.textContent = message;
                alert.style.display = 'flex';
                
                setTimeout(() => {
                    alert.style.display = 'none';
                }, 5000);
            }
        }

        function showWarning(message) {
            const alert = document.createElement('div');
            alert.className = 'alert warning';
            alert.innerHTML = `
                <i class="fas fa-exclamation-triangle"></i>
                <span>${message}</span>
            `;
            
            const controlPanel = document.querySelector('.control-panel');
            if (controlPanel) {
                controlPanel.insertBefore(alert, controlPanel.firstChild);
                
                setTimeout(() => {
                    alert.remove();
                }, 5000);
            }
        }

        function showInfo(message) {
            const alert = document.createElement('div');
            alert.className = 'alert info';
            alert.innerHTML = `
                <i class="fas fa-info-circle"></i>
                <span>${message}</span>
            `;
            
            const controlPanel = document.querySelector('.control-panel');
            if (controlPanel) {
                controlPanel.insertBefore(alert, controlPanel.firstChild);
                
                setTimeout(() => {
                    alert.remove();
                }, 3000);
            }
        }

        // ============================================
        // تهيئة النظام عند تحميل الصفحة
        // ============================================

        document.addEventListener('DOMContentLoaded', function() {
            updateLanguage();
            loadUsers();
            
            // تعريف زر القائمة للجوال
            const mobileMenuToggle = document.getElementById('mobileMenuToggle');
            const sidebar = document.getElementById('sidebar');
            
            if (mobileMenuToggle && sidebar) {
                mobileMenuToggle.addEventListener('click', function() {
                    sidebar.classList.toggle('active');
                });
                
                // إغلاق القائمة عند النقر خارجها
                document.addEventListener('click', function(event) {
                    if (!sidebar.contains(event.target) && !mobileMenuToggle.contains(event.target) && sidebar.classList.contains('active')) {
                        sidebar.classList.remove('active');
                    }
                });
            }
            
            // تعريف زر البحث في الموبايل للشجرة
            const mobileSearchToggle = document.getElementById('mobileSearchToggle');
            if (mobileSearchToggle) {
                mobileSearchToggle.addEventListener('click', function() {
                    const treeFilter = document.getElementById('treeFilter');
                    if (treeFilter) {
                        treeFilter.classList.toggle('active');
                    }
                });
            }
            
            // إغلاق القوائم المنسدلة عند النقر خارجها
            document.addEventListener('click', function(event) {
                const exportMenu = document.getElementById('exportMenu');
                const treeExportMenu = document.getElementById('treeExportMenu');
                
                if (exportMenu && exportMenu.classList.contains('show') && 
                    !event.target.closest('.export-options')) {
                    exportMenu.classList.remove('show');
                }
                
                if (treeExportMenu && treeExportMenu.classList.contains('show') && 
                    !event.target.closest('.export-options')) {
                    treeExportMenu.classList.remove('show');
                }
            });
            
            console.log('✅ System initialized successfully');
        });

        // ============================================
        // استيراد الاقتراحات الذكية (اختياري - يمكن تطويرها)
        // ============================================

        function applySmartSuggestions() {
            // يمكن تطوير هذه الدالة لاقتراح علاقات ذكية
            showInfo('سيتم تطوير نظام الاقتراحات الذكية في الإصدارات القادمة');
        }

        function showWhySuggestion() {
            showInfo('يقوم النظام بتحليل العلاقات الحالية لاقتراح أفضل الخيارات للعلاقات العائلية');
        }

        function clearSmartSuggestions() {
            document.getElementById('smartSuggestions').innerHTML = '';
        }

        // ============================================
        // دالة تطبيق الهوية البصرية
        // ============================================

        function applyBrandingFromInput() {
            const brandNameInput = document.getElementById('familyBrandNameInput');
            if (!brandNameInput) return;
            
            const brandName = brandNameInput.value.trim();
            if (!brandName) {
                showError('الرجاء إدخال اسم للهوية العائلية');
                return;
            }
            
            // حفظ في localStorage
            localStorage.setItem('familyBrandName', brandName);
            
            // تطبيق على واجهة المستخدم
            const logoTitle = document.querySelector('.logo h1');
            if (logoTitle) {
                logoTitle.textContent = `شجرة عائلة ${brandName}`;
            }
            
            // تحديث عنوان النظام
            document.title = `شجرة عائلة ${brandName}`;
            
            showSuccess(`تم تطبيق الهوية البصرية: ${brandName}`);
        }

        function toggleBookCompact() {
            const bookGrid = document.querySelector('.book-grid');
            if (!bookGrid) return;
            
            bookGrid.classList.toggle('compact');
            showSuccess(bookGrid.classList.contains('compact') ? 
                'تم تفعيل العرض المضغوط' : 'تم تفعيل العرض الموسع');
        }

    </script>
</body>
</html>
