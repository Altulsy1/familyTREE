<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>ÿ¥ÿ¨ÿ±ÿ© ÿπÿßÿ¶ŸÑÿ© ŸÖÿ≠ŸÖÿØ ÿπÿ®ÿØÿßŸÑÿ±ÿ≠ŸÖŸÜ (ÿ£ÿ®ÿß)</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@400;600;700&family=Amiri:wght@700&display=swap" rel="stylesheet">
    
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-database-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-auth-compat.js"></script>
    
    <script src="https://html2canvas.hertzen.com/dist/html2canvas.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>
    
    <style>
        :root { 
            --male-color: #2196F3; 
            --female-color: #E91E63; 
            --highlight: #FFC107; 
            --header-bg: #2E7D32;
            --login-bg: #1B5E20;
            --panel-bg: #ffffff;
            --button-primary: #4CAF50;
            --button-success: #388E3C;
            --button-danger: #F44336;
            --button-warning: #FF9800;
            --button-info: #0097A7;
            --sidebar-bg: #388E3C;
            --generation-1: #1B5E20;
            --generation-2: #2E7D32;
            --generation-3: #43A047;
            --generation-4: #66BB6A;
            --generation-5: #81C784;
            --generation-1-bg: #E8F5E9;
            --generation-2-bg: #E3F2FD;
            --generation-3-bg: #FFF8E1;
            --generation-4-bg: #F3E5F5;
            --generation-5-bg: #E0F7FA;
            --light-green: #C8E6C9;
            --medium-green: #A5D6A7;
            --dark-green: #388E3C;
            --accent-green: #4CAF50;
            --brand-family-name: "ŸÖÿ≠ŸÖÿØ ÿπÿ®ÿØÿßŸÑÿ±ÿ≠ŸÖŸÜ";
            --brand-mark: "üå≥";
            --paper-bg: rgba(255,255,255,0.92);
            --paper-border: rgba(27,94,32,0.12);
            --shadow-soft: 0 10px 30px rgba(0,0,0,0.10);
        }
        
        * { 
            margin: 0; 
            padding: 0; 
            box-sizing: border-box; 
            font-family: 'Cairo', 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; 
        }
        
        body { 
            background-color: #f8faf8; 
            direction: rtl; 
            min-height: 100vh;
            overflow-x: hidden;
        }
        
        body::before {
            content: "";
            position: fixed;
            inset: 0;
            background:
              linear-gradient(rgba(248,250,248,0.80), rgba(248,250,248,0.80)),
              url("data:image/svg+xml;utf8,<svg xmlns='http://www.w3.org/2000/svg' width='320' height='320'><text x='18' y='160' font-size='92' opacity='0.06'>%F0%9F%8C%B3</text><text x='140' y='245' font-size='24' opacity='0.06'>%D8%B9%D8%A7%D8%A6%D9%84%D8%A9</text></svg>");
            z-index: -1;
            pointer-events: none;
        }
        
        /* ÿ¥ÿßÿ¥ÿ© ÿßŸÑÿØÿÆŸàŸÑ */
        #login-screen {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: linear-gradient(135deg, var(--login-bg) 0%, var(--header-bg) 100%);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 10000;
        }
        
        .login-container {
            background: rgba(255, 255, 255, 0.95);
            padding: 30px 20px;
            border-radius: 20px;
            box-shadow: 0 15px 35px rgba(0, 0, 0, 0.3);
            width: 90%;
            max-width: 400px;
            text-align: center;
            margin: 20px;
        }
        
        .login-language-toggle {
            position: absolute;
            top: 20px;
            left: 20px;
            background: rgba(255, 255, 255, 0.2);
            border: 1px solid rgba(255, 255, 255, 0.3);
            color: white;
            padding: 8px 16px;
            border-radius: 20px;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 8px;
            font-size: 14px;
            transition: all 0.3s;
            z-index: 10001;
        }
        
        .login-language-toggle:hover {
            background: rgba(255, 255, 255, 0.3);
            transform: scale(1.05);
        }
        
        .login-logo {
            font-size: 2.5rem;
            color: var(--header-bg);
            margin-bottom: 15px;
        }
        
        .login-title {
            color: var(--header-bg);
            margin-bottom: 10px;
            font-size: 1.5rem;
        }
        
        .login-form {
            display: flex;
            flex-direction: column;
            gap: 15px;
            margin-top: 25px;
        }
        
        .form-group {
            position: relative;
        }
        
        .form-group i {
            position: absolute;
            right: 15px;
            top: 50%;
            transform: translateY(-50%);
            color: #7cb342;
        }
        
        .login-input {
            width: 100%;
            padding: 15px 50px 15px 15px;
            border: 2px solid #c8e6c9;
            border-radius: 10px;
            font-size: 16px;
            transition: all 0.3s;
            background-color: #f1f8e9;
        }
        
        .login-input:focus {
            outline: none;
            border-color: var(--button-primary);
            box-shadow: 0 0 0 3px rgba(76, 175, 80, 0.1);
            background-color: white;
        }
        
        .login-btn {
            background: linear-gradient(135deg, var(--button-primary) 0%, var(--button-success) 100%);
            color: white;
            border: none;
            padding: 15px;
            border-radius: 10px;
            font-size: 16px;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s;
        }
        
        .login-btn:hover {
            background: linear-gradient(135deg, var(--button-success) 0%, #2E7D32 100%);
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(0,0,0,0.2);
        }
        
        .login-error {
            color: var(--button-danger);
            margin-top: 10px;
            font-size: 14px;
            display: none;
        }
        
        /* ÿßŸÑŸÖÿ≠ÿ™ŸàŸâ ÿßŸÑÿ±ÿ¶Ÿäÿ≥Ÿä */
        #main-content {
            display: none;
        }
        
        /* ÿßŸÑÿ¥ÿ±Ÿäÿ∑ ÿßŸÑÿπŸÑŸàŸä */
        .top-bar {
            background: linear-gradient(135deg, var(--header-bg) 0%, #1B5E20 100%);
            color: white;
            padding: 15px 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            box-shadow: 0 2px 15px rgba(0,0,0,0.1);
            position: sticky;
            top: 0;
            z-index: 1000;
        }
        
        .logo {
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .logo h1 {
            font-size: 1.2rem;
            margin: 0;
            font-family: 'Amiri', 'Cairo', serif;
        }
        
        .user-info {
            display: flex;
            align-items: center;
            gap: 10px;
            flex-wrap: wrap;
        }
        
        .sync-status {
            padding: 6px 12px;
            border-radius: 20px;
            font-size: 12px;
            display: flex;
            align-items: center;
            gap: 5px;
            margin-left: 10px;
            transition: all 0.3s;
            cursor: pointer;
        }
        
        .sync-status.success {
            background: rgba(76, 175, 80, 0.1);
            color: #4CAF50;
            border: 1px solid rgba(76, 175, 80, 0.3);
        }
        
        .sync-status.warning {
            background: rgba(255, 193, 7, 0.1);
            color: #FF9800;
            border: 1px solid rgba(255, 193, 7, 0.3);
        }
        
        .sync-status.error {
            background: rgba(244, 67, 54, 0.1);
            color: #F44336;
            border: 1px solid rgba(244, 67, 54, 0.3);
        }
        
        .sync-button {
            background: transparent;
            border: none;
            color: inherit;
            cursor: pointer;
            font-size: 14px;
            width: 25px;
            height: 25px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.3s;
        }
        
        .sync-button:hover {
            background: rgba(255, 255, 255, 0.1);
            transform: rotate(180deg);
        }
        
        .sync-badge {
            background: #FF9800;
            color: white;
            font-size: 10px;
            font-weight: bold;
            padding: 2px 6px;
            border-radius: 10px;
            animation: pulse 1.5s infinite;
        }
        
        .logout-btn {
            background: var(--button-danger);
            color: white;
            border: none;
            padding: 6px 15px;
            border-radius: 5px;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 5px;
            transition: all 0.3s;
            font-size: 14px;
        }
        
        .logout-btn:hover {
            background: #d32f2f;
            transform: translateY(-2px);
        }
        
        .language-toggle {
            background: transparent;
            border: 1px solid rgba(255,255,255,0.3);
            color: white;
            padding: 5px 10px;
            border-radius: 5px;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 5px;
            font-size: 12px;
            transition: all 0.3s;
        }
        
        .language-toggle:hover {
            background: rgba(255,255,255,0.1);
        }
        
        /* ÿßŸÑÿ¥ÿ±Ÿäÿ∑ ÿßŸÑÿ¨ÿßŸÜÿ®Ÿä */
        .sidebar {
            width: 250px;
            background: linear-gradient(135deg, var(--sidebar-bg) 0%, var(--header-bg) 100%);
            color: white;
            height: calc(100vh - 70px);
            position: fixed;
            top: 70px;
            right: 0;
            transition: right 0.3s;
            overflow-y: auto;
            box-shadow: 2px 0 10px rgba(0,0,0,0.1);
            z-index: 999;
        }
        
        .sidebar-menu {
            list-style: none;
            padding: 20px 0;
        }
        
        .menu-item {
            padding: 12px 20px;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 12px;
            transition: all 0.3s;
            border-right: 4px solid transparent;
            border-bottom: 1px solid rgba(255,255,255,0.05);
            font-size: 14px;
        }
        
        .menu-item:hover, .menu-item.active {
            background: rgba(255,255,255,0.1);
            border-right-color: var(--button-primary);
        }
        
        .menu-item i {
            width: 20px;
            text-align: center;
            color: #C8E6C9;
            font-size: 16px;
        }
        
        /* ÿßŸÑŸÖÿ≠ÿ™ŸàŸâ ÿßŸÑÿ±ÿ¶Ÿäÿ≥Ÿä */
        .main-content-area {
            margin-right: 250px;
            padding: 20px;
            transition: margin-right 0.3s;
            min-height: calc(100vh - 70px);
            width: calc(100% - 250px);
        }
        
        /* ÿ®ÿ∑ÿßŸÇÿßÿ™ ÿßŸÑÿ•ÿ≠ÿµÿßÿ¶Ÿäÿßÿ™ */
        .stats-cards {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(160px, 1fr));
            gap: 15px;
            margin-bottom: 20px;
        }
        
        .stat-card {
            background: white;
            padding: 20px;
            border-radius: 12px;
            box-shadow: 0 3px 12px rgba(0,0,0,0.08);
            display: flex;
            align-items: center;
            gap: 15px;
            transition: all 0.3s;
            border-top: 4px solid var(--accent-green);
        }
        
        .stat-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 8px 20px rgba(0,0,0,0.15);
        }
        
        .stat-icon {
            width: 50px;
            height: 50px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 20px;
            color: white;
            box-shadow: 0 4px 10px rgba(0,0,0,0.15);
        }
        
        .stat-icon.male { background: var(--male-color); }
        .stat-icon.female { background: var(--female-color); }
        .stat-icon.total { background: #4CAF50; }
        .stat-icon.families { background: #8BC34A; }
        
        .stat-info h3 {
            font-size: 1.5rem;
            margin-bottom: 5px;
            color: var(--header-bg);
        }
        
        .stat-info p {
            color: #689f38;
            font-size: 13px;
            font-weight: 500;
        }
        
        /* ŸÑŸàÿ≠ÿ© ÿßŸÑÿ™ÿ≠ŸÉŸÖ */
        .control-panel {
            background: white;
            border-radius: 12px;
            padding: 20px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.08);
            margin-bottom: 20px;
            border: 1px solid #e8f5e9;
            overflow: hidden;
        }
        
        .panel-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            margin-bottom: 20px;
            padding-bottom: 15px;
            border-bottom: 2px solid #f1f8e9;
            flex-wrap: wrap;
            gap: 10px;
        }
        
        .panel-header h2 {
            color: var(--header-bg);
            display: flex;
            align-items: center;
            gap: 10px;
            font-size: 1.2rem;
            font-family: 'Amiri', 'Cairo', serif;
        }
        
        .action-buttons {
            display: flex;
            gap: 8px;
            flex-wrap: wrap;
        }
        
        .btn {
            padding: 8px 15px;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-weight: bold;
            display: flex;
            align-items: center;
            gap: 6px;
            transition: all 0.3s;
            font-size: 13px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
        }
        
        .btn-primary { 
            background: linear-gradient(135deg, var(--button-primary) 0%, #66BB6A 100%);
            color: white; 
        }
        .btn-success { 
            background: linear-gradient(135deg, var(--button-success) 0%, #43A047 100%);
            color: white; 
        }
        .btn-danger { 
            background: linear-gradient(135deg, var(--button-danger) 0%, #d32f2f 100%);
            color: white; 
        }
        .btn-warning { 
            background: linear-gradient(135deg, var(--button-warning) 0%, #f57c00 100%);
            color: white; 
        }
        .btn-info { 
            background: linear-gradient(135deg, var(--button-info) 0%, #006978 100%);
            color: white; 
        }
        
        .btn:hover {
            opacity: 0.9;
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0,0,0,0.2);
        }
        
        /* ÿßŸÑÿ¨ÿØŸàŸÑ */
        .data-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 15px;
            border-radius: 8px;
            overflow: hidden;
            box-shadow: 0 3px 8px rgba(0,0,0,0.05);
        }
        
        .data-table th {
            background: #f1f8e9;
            padding: 15px 10px;
            text-align: right;
            color: var(--header-bg);
            border-bottom: 2px solid #c8e6c9;
            font-weight: 600;
            position: sticky;
            top: 0;
            font-size: 14px;
        }
        
        .data-table td {
            padding: 12px 10px;
            border-bottom: 1px solid #f1f8e9;
            font-size: 14px;
        }
        
        .data-table tr:hover {
            background: #f8faf8;
        }
        
        .data-table tr:nth-child(even) {
            background-color: #f9fdf9;
        }
        
        .gender-badge {
            padding: 4px 12px;
            border-radius: 20px;
            font-size: 11px;
            font-weight: bold;
            display: inline-block;
        }
        
        .gender-badge.male {
            background: #e3f2fd;
            color: var(--male-color);
            border: 1px solid var(--male-color);
        }
        
        .gender-badge.female {
            background: #fce4ec;
            color: var(--female-color);
            border: 1px solid var(--female-color);
        }
        
        .table-actions {
            display: flex;
            gap: 6px;
            justify-content: center;
            flex-wrap: wrap;
        }
        
        .action-btn {
            width: 30px;
            height: 30px;
            border-radius: 8px;
            border: none;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.3s;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
            font-size: 14px;
        }
        
        .action-btn.edit { 
            background: linear-gradient(135deg, var(--button-warning) 0%, #ffb74d 100%);
            color: white; 
        }
        .action-btn.delete { 
            background: linear-gradient(135deg, var(--button-danger) 0%, #ef5350 100%);
            color: white; 
        }
        .action-btn.view { 
            background: linear-gradient(135deg, var(--button-info) 0%, #4dd0e1 100%);
            color: white; 
        }
        
        .action-btn:hover {
            transform: scale(1.1) rotate(5deg);
            box-shadow: 0 3px 8px rgba(0,0,0,0.2);
        }
        
        /* ÿßŸÑŸÜŸÖŸàÿ∞ÿ¨ */
        .form-modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.5);
            display: none;
            justify-content: center;
            align-items: center;
            z-index: 2000;
            backdrop-filter: blur(5px);
            padding: 20px;
        }
        
        .form-modal.active {
            display: flex;
        }
        
        .form-container {
            background: white;
            width: 100%;
            max-width: 700px;
            max-height: 90vh;
            border-radius: 15px;
            overflow: hidden;
            box-shadow: 0 20px 40px rgba(0,0,0,0.3);
            animation: formSlideIn 0.3s ease;
        }
        
        @keyframes formSlideIn {
            from {
                opacity: 0;
                transform: translateY(-20px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }
        
        .form-header {
            background: linear-gradient(135deg, var(--header-bg) 0%, #1B5E20 100%);
            color: white;
            padding: 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .form-header h3 {
            margin: 0;
            display: flex;
            align-items: center;
            gap: 10px;
            font-size: 1.2rem;
            font-family: 'Amiri', 'Cairo', serif;
        }
        
        .close-form {
            background: none;
            border: none;
            color: white;
            font-size: 24px;
            cursor: pointer;
            width: 35px;
            height: 35px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.3s;
        }
        
        .close-form:hover {
            background: rgba(255,255,255,0.1);
            transform: rotate(90deg);
        }
        
        .form-body {
            padding: 20px;
            overflow-y: auto;
            max-height: calc(90vh - 80px);
        }
        
        .form-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));
            gap: 15px;
        }
        
        .form-label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            color: var(--header-bg);
            font-size: 14px;
        }
        
        .form-label.required::after {
            content: " *";
            color: #e74c3c;
        }
        
        .form-input, .form-select, .form-textarea {
            width: 100%;
            padding: 10px 12px;
            border: 2px solid #e0f2e0;
            border-radius: 8px;
            font-size: 14px;
            transition: all 0.3s;
            background-color: #f8fcf8;
        }
        
        .form-input:focus, .form-select:focus, .form-textarea:focus {
            outline: none;
            border-color: var(--button-primary);
            box-shadow: 0 0 0 3px rgba(76, 175, 80, 0.1);
            background-color: white;
        }
        
        .form-textarea {
            min-height: 80px;
            resize: vertical;
        }
        
        .form-actions {
            display: flex;
            justify-content: flex-end;
            gap: 12px;
            margin-top: 20px;
            padding-top: 20px;
            border-top: 2px solid #f1f8e9;
            flex-wrap: wrap;
        }
        
        /* ÿ±ÿ≥ÿßÿ¶ŸÑ ÿßŸÑÿ™ŸÜÿ®ŸäŸá */
        .alert {
            padding: 15px 18px;
            border-radius: 10px;
            margin-bottom: 20px;
            display: flex;
            align-items: center;
            gap: 12px;
            display: none;
            animation: slideDown 0.5s ease;
            border-right: 5px solid transparent;
            font-size: 14px;
        }
        
        @keyframes slideDown {
            from {
                opacity: 0;
                transform: translateY(-20px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }
        
        .alert.success {
            background: #e8f5e9;
            color: #1b5e20;
            border-color: #c8e6c9;
            border-right-color: #4caf50;
        }
        
        .alert.error {
            background: #ffebee;
            color: #c62828;
            border-color: #ffcdd2;
            border-right-color: #f44336;
        }
        
        .alert.warning {
            background: #fff3e0;
            color: #ef6c00;
            border-color: #ffe0b2;
            border-right-color: #ff9800;
        }
        
        .alert.info {
            background: #e0f7fa;
            color: #006064;
            border-color: #b2ebf2;
            border-right-color: #00bcd4;
        }
        
        /* ÿ≤ÿ± ÿπÿ±ÿ∂ ÿßŸÑÿ¥ÿ¨ÿ±ÿ© */
        .tree-view-btn {
            position: fixed;
            bottom: 20px;
            left: 20px;
            background: linear-gradient(135deg, var(--button-success) 0%, #43A047 100%);
            color: white;
            border: none;
            border-radius: 50%;
            width: 60px;
            height: 60px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 24px;
            cursor: pointer;
            box-shadow: 0 4px 15px rgba(0,0,0,0.3);
            z-index: 100;
            transition: all 0.3s;
        }
        
        .tree-view-btn:hover {
            transform: scale(1.1) rotate(15deg);
            box-shadow: 0 8px 20px rgba(0,0,0,0.4);
        }
        
        /* ÿπÿ±ÿ∂ ÿßŸÑÿ¥ÿ¨ÿ±ÿ© */
        .tree-view {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: linear-gradient(135deg, #f8faf8 0%, #e9f7e9 100%);
            z-index: 2000;
            display: none;
            flex-direction: column;
            animation: treeSlideIn 0.3s ease;
        }
        
        @keyframes treeSlideIn {
            from {
                opacity: 0;
            }
            to {
                opacity: 1;
            }
        }
        
        .tree-view.active {
            display: flex;
        }
        
        .tree-header {
            background: linear-gradient(135deg, var(--header-bg) 0%, #1B5E20 100%);
            color: white;
            padding: 15px 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            box-shadow: 0 2px 12px rgba(0,0,0,0.2);
            flex-wrap: wrap;
            gap: 10px;
        }
        
        .tree-header h2 {
            margin: 0;
            display: flex;
            align-items: center;
            gap: 12px;
            font-size: 1.3rem;
            font-family: 'Amiri', 'Cairo', serif;
        }
        
        .tree-toolbar {
            display: flex;
            gap: 8px;
            align-items: center;
            margin-top: 8px;
            flex-wrap: wrap;
        }
        
        .tree-zoom {
            display: flex;
            align-items: center;
            gap: 8px;
            background: rgba(255,255,255,0.1);
            padding: 6px 12px;
            border-radius: 20px;
            font-size: 14px;
        }
        
        .tree-zoom-btn {
            background: none;
            border: none;
            color: white;
            cursor: pointer;
            font-size: 16px;
            width: 28px;
            height: 28px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.3s;
        }
        
        .tree-zoom-btn:hover {
            background: rgba(255,255,255,0.2);
        }
        
        .tree-content {
            flex: 1;
            padding: 15px;
            overflow: auto;
            position: relative;
            background: #f8faf8;
            -webkit-overflow-scrolling: touch;
        }
        
        /* ÿ™ŸÜÿ≥ŸäŸÇÿßÿ™ ŸÖÿ≠ÿ≥ŸÜÿ© ŸÑŸÑÿ¥ÿ¨ÿ±ÿ© */
        .tree-wrapper {
            width: fit-content;
            min-width: 100%;
            min-height: 100%;
            display: flex;
            flex-direction: column;
            align-items: flex-start;
            padding: 15px;
        }
        
        .tree-generation {
            display: flex;
            flex-direction: column;
            width: 100%;
            margin-bottom: 30px;
            position: relative;
        }
        
        .generation-label {
            background: linear-gradient(135deg, var(--sidebar-bg) 0%, #2E7D32 100%);
            color: white;
            padding: 8px 20px;
            border-radius: 20px;
            font-weight: bold;
            margin-bottom: 15px;
            font-size: 14px;
            box-shadow: 0 3px 10px rgba(0,0,0,0.15);
            position: sticky;
            top: 10px;
            z-index: 100;
            align-self: flex-start;
            margin-right: 15px;
        }
        
        .generation-1 .generation-label { background: linear-gradient(135deg, var(--generation-1) 0%, #1B5E20 100%); }
        .generation-2 .generation-label { background: linear-gradient(135deg, var(--generation-2) 0%, #2E7D32 100%); }
        .generation-3 .generation-label { background: linear-gradient(135deg, var(--generation-3) 0%, #388E3C 100%); }
        .generation-4 .generation-label { background: linear-gradient(135deg, var(--generation-4) 0%, #4CAF50 100%); }
        .generation-5 .generation-label { background: linear-gradient(135deg, var(--generation-5) 0%, #66BB6A 100%); }
        
        .tree-level {
            display: flex;
            flex-wrap: wrap;
            gap: 12px;
            justify-content: flex-start;
            width: 100%;
            padding: 12px;
            background: rgba(255,255,255,0.7);
            border-radius: 12px;
            box-shadow: 0 2px 12px rgba(0,0,0,0.08);
            margin-bottom: 15px;
        }
        
        .tree-node-container {
            display: flex;
            flex-direction: column;
            align-items: center;
            position: relative;
            margin: 5px;
            min-width: 150px;
        }
        
        .tree-node {
            background: white;
            border: 2px solid #e8f5e9;
            border-radius: 10px;
            padding: 12px;
            width: 150px;
            text-align: center;
            box-shadow: 0 3px 15px rgba(0,0,0,0.1);
            cursor: pointer;
            transition: all 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275);
            position: relative;
            z-index: 2;
            overflow: hidden;
        }
        
        .tree-node:hover {
            transform: translateY(-5px) scale(1.03);
            box-shadow: 0 8px 25px rgba(0,0,0,0.2);
            z-index: 100;
        }
        
        .tree-node.male {
            border-top: 4px solid var(--male-color);
            background: linear-gradient(135deg, #ffffff 0%, #f0f7ff 100%);
        }
        
        .tree-node.female {
            border-top: 4px solid var(--female-color);
            background: linear-gradient(135deg, #ffffff 0%, #fff0f5 100%);
        }
        
        .tree-node.outsider {
            border: 2px dashed #6A1B9A;
            border-top-width: 4px;
            background: linear-gradient(135deg, #ffffff 0%, #f8f0ff 100%);
        }

        .tree-node.outsider .generation-badge {
            background: #6A1B9A;
        }

        .outsider-badge {
            position: absolute;
            top: 6px;
            left: 6px;
            background: #6A1B9A;
            color: white;
            font-size: 10px;
            padding: 3px 6px;
            border-radius: 999px;
            display: flex;
            align-items: center;
            gap: 4px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.15);
            z-index: 5;
        }

        .tree-node.gen-1 { border-color: var(--generation-1); background: var(--generation-1-bg); }
        .tree-node.gen-2 { border-color: var(--generation-2); background: var(--generation-2-bg); }
        .tree-node.gen-3 { border-color: var(--generation-3); background: var(--generation-3-bg); }
        .tree-node.gen-4 { border-color: var(--generation-4); background: var(--generation-4-bg); }
        .tree-node.gen-5 { border-color: var(--generation-5); background: var(--generation-5-bg); }

        .tree-node.gen-1 .generation-badge { background: var(--generation-1); color: #fff; }
        .tree-node.gen-2 .generation-badge { background: var(--generation-2); color: #fff; }
        .tree-node.gen-3 .generation-badge { background: var(--generation-3); color: #fff; }
        .tree-node.gen-4 .generation-badge { background: var(--generation-4); color: #fff; }
        .tree-node.gen-5 .generation-badge { background: var(--generation-5); color: #fff; }
        
        .node-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 6px;
        }
        
        .node-id {
            background: #f1f8e9;
            color: #689f38;
            font-size: 10px;
            padding: 2px 6px;
            border-radius: 8px;
            font-weight: bold;
        }
        
        .node-name {
            font-weight: bold;
            font-size: 14px;
            margin-bottom: 8px;
            color: var(--header-bg);
            line-height: 1.3;
            height: 2.6em;
            overflow: hidden;
            text-overflow: ellipsis;
            display: -webkit-box;
            -webkit-line-clamp: 2;
            -webkit-box-orient: vertical;
        }
        
        .node-details {
            font-size: 11px;
            color: #689f38;
            line-height: 1.3;
            max-height: 50px;
            overflow: hidden;
        }
        
        .node-place {
            margin-top: 3px;
            font-size: 10px;
            color: #7cb342;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }
        
        .node-children {
            display: flex;
            justify-content: center;
            flex-wrap: wrap;
            margin-top: 12px;
            position: relative;
            padding-top: 20px;
            min-height: 40px;
        }
        
        /* ŸàÿµŸÑÿßÿ™ ÿßŸÑÿ¥ÿ¨ÿ±ÿ© */
        .tree-connector {
            position: absolute;
            background: linear-gradient(to bottom, #a5d6a7, #7cb342);
            z-index: 1;
        }
        
        .vertical-connector {
            width: 2px;
            height: 20px;
            top: -20px;
            left: 50%;
            transform: translateX(-50%);
        }
        
        .horizontal-connector {
            height: 2px;
            width: calc(100% - 15px);
            top: -10px;
            left: 8px;
        }
        
        /* ŸÅŸÑÿ™ÿ± ŸÑŸÑÿ®ÿ≠ÿ´ ŸÅŸä ÿßŸÑÿ¥ÿ¨ÿ±ÿ© */
        .tree-filter {
            background: white;
            padding: 12px 15px;
            border-radius: 10px;
            box-shadow: 0 2px 12px rgba(0,0,0,0.1);
            margin: 0 15px 15px;
            display: flex;
            gap: 12px;
            align-items: center;
            flex-wrap: wrap;
            position: sticky;
            top: 0;
            z-index: 200;
            border: 1px solid #e8f5e9;
        }
        
        .tree-filter input {
            flex: 1;
            min-width: 200px;
            padding: 10px 12px;
            border: 2px solid #e0f2e0;
            border-radius: 8px;
            font-size: 14px;
            transition: all 0.3s;
            background-color: #f8fcf8;
        }
        
        .tree-filter input:focus {
            border-color: var(--button-primary);
            box-shadow: 0 0 0 3px rgba(76, 175, 80, 0.1);
            outline: none;
            background-color: white;
        }
        
        .tree-filter button {
            padding: 10px 15px;
            background: linear-gradient(135deg, var(--button-primary) 0%, #66BB6A 100%);
            color: white;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 6px;
            font-weight: bold;
            transition: all 0.3s;
            font-size: 13px;
        }
        
        .tree-filter button:hover {
            transform: translateY(-2px);
            box-shadow: 0 3px 8px rgba(0,0,0,0.2);
        }
        
        /* ÿ£ÿØŸàÿßÿ™ ÿßŸÑÿ™ÿ≠ŸÉŸÖ ŸÅŸä ÿßŸÑÿ¥ÿ¨ÿ±ÿ© */
        .tree-controls {
            display: flex;
            gap: 8px;
            align-items: center;
            margin-right: auto;
            flex-wrap: wrap;
        }
        
        .tree-count {
            background: rgba(255,255,255,0.1);
            padding: 5px 12px;
            border-radius: 20px;
            font-size: 13px;
            display: flex;
            align-items: center;
            gap: 6px;
        }
        
        /* ÿ±ÿ≥ÿßŸÑÿ© ŸÅÿßÿ±ÿ∫ÿ© */
        .empty-message {
            text-align: center;
            padding: 40px 15px;
            color: #7cb342;
            font-size: 16px;
            width: 100%;
        }
        
        .empty-message i {
            font-size: 36px;
            margin-bottom: 15px;
            color: #c8e6c9;
        }
        
        /* ÿ£ŸÜŸÖÿßÿ∑ ÿßŸÑÿπŸÇÿØ ÿßŸÑŸÖÿ≠ÿØÿØÿ© ŸÅŸä ÿßŸÑÿ®ÿ≠ÿ´ */
        .tree-node.search-match {
            animation: pulse 1.5s infinite;
            background: #f1f8e9 !important;
            border-color: #8bc34a !important;
            box-shadow: 0 3px 12px rgba(139, 195, 74, 0.3) !important;
            z-index: 1000 !important;
        }
        
        .tree-node.search-no-match {
            opacity: 0.3 !important;
            filter: grayscale(80%) !important;
            transform: scale(0.95) !important;
            pointer-events: none !important;
            transition: all 0.3s ease !important;
        }
        
        @keyframes pulse {
            0% { box-shadow: 0 0 0 0 rgba(139, 195, 74, 0.4); }
            70% { box-shadow: 0 0 0 8px rgba(139, 195, 74, 0); }
            100% { box-shadow: 0 0 0 0 rgba(139, 195, 74, 0); }
        }
        
        /* ÿ™ÿµŸÜŸäŸÅ ÿßŸÑÿ£ÿ¨ŸäÿßŸÑ */
        .generation-badge {
            position: absolute;
            top: 4px;
            left: 4px;
            background: rgba(0,0,0,0.1);
            color: white;
            font-size: 9px;
            padding: 2px 5px;
            border-radius: 8px;
            font-weight: bold;
        }
        
        /* ÿ≤ÿ± ÿ™ÿ®ÿØŸäŸÑ ÿßŸÑÿ®ÿ≠ÿ´ ŸÑŸÑÿ¨ŸàÿßŸÑ */
        .mobile-search-toggle {
            display: none;
            position: fixed;
            top: 80px;
            right: 10px;
            background: linear-gradient(135deg, var(--button-primary) 0%, #66BB6A 100%);
            color: white;
            border: none;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            z-index: 1000;
            box-shadow: 0 2px 8px rgba(0,0,0,0.2);
            align-items: center;
            justify-content: center;
        }
        
        /* ŸÇÿßÿ¶ŸÖÿ© ÿßŸÑÿ™ÿµÿØŸäÿ± */
        .export-options {
            position: relative;
            display: inline-block;
        }
        
        .export-menu {
            position: absolute;
            top: 100%;
            left: 0;
            background: white;
            border-radius: 8px;
            box-shadow: 0 5px 20px rgba(0,0,0,0.2);
            min-width: 180px;
            z-index: 2000;
            margin-top: 8px;
            border: 1px solid #e8f5e9;
            opacity: 0;
            visibility: hidden;
            transition: all 0.3s ease;
            padding: 8px 0;
            max-height: 300px;
            overflow-y: auto;
        }
        
        .export-menu.show {
            opacity: 1;
            visibility: visible;
            top: 100%;
        }
        
        .export-option {
            padding: 10px 15px;
            display: flex;
            align-items: center;
            gap: 10px;
            cursor: pointer;
            transition: background 0.3s;
            border-bottom: 1px solid #f1f8e9;
            color: #1b5e20;
            text-decoration: none;
            font-size: 13px;
            min-height: 40px;
        }
        
        .export-option:hover {
            background: #f1f8e9;
            color: var(--button-primary);
        }
        
        .export-option:last-child {
            border-bottom: none;
        }
        
        .export-option i {
            width: 18px;
            text-align: center;
            color: #7cb342;
            font-size: 15px;
        }
        
        /* ÿ£ŸÜŸÖÿßÿ∑ ŸÇÿ≥ŸÖ ÿßŸÑŸÖŸÜÿßÿ≥ÿ®ÿßÿ™ ŸàÿßŸÑÿ•ÿπŸÑÿßŸÜÿßÿ™ */
        .events-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(320px, 1fr));
            gap: 20px;
            margin-top: 20px;
        }

        .event-card {
            background: white;
            border-radius: 12px;
            overflow: hidden;
            box-shadow: 0 4px 15px rgba(0,0,0,0.1);
            transition: all 0.3s ease;
            border: 1px solid #e8f5e9;
            position: relative;
        }

        .event-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 8px 25px rgba(0,0,0,0.15);
        }

        .event-header {
            padding: 15px;
            color: white;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .event-type-ŸÖŸÜÿßÿ≥ÿ®ÿ© { background: linear-gradient(135deg, #4CAF50 0%, #2E7D32 100%); }
        .event-type-ÿßÿ¨ÿ™ŸÖÿßÿπ { background: linear-gradient(135deg, #2196F3 0%, #0D47A1 100%); }
        .event-type-ŸÅÿπÿßŸÑŸäÿ© { background: linear-gradient(135deg, #FF9800 0%, #EF6C00 100%); }
        .event-type-ÿ®ÿ±ŸÜÿßŸÖÿ¨ { background: linear-gradient(135deg, #9C27B0 0%, #6A1B9A 100%); }
        .event-type-ÿ™ÿ∞ŸÉŸäÿ± { background: linear-gradient(135deg, #009688 0%, #00695C 100%); }
        .event-type-ÿ£ÿÆÿ±Ÿâ { background: linear-gradient(135deg, #607D8B 0%, #37474F 100%); }

        .event-date {
            background: rgba(255,255,255,0.2);
            padding: 5px 12px;
            border-radius: 20px;
            font-size: 12px;
            font-weight: bold;
        }

        .event-body {
            padding: 15px;
        }

        .event-title {
            font-size: 18px;
            color: #1B5E20;
            margin-bottom: 10px;
            font-weight: bold;
        }

        .event-description {
            color: #555;
            font-size: 14px;
            line-height: 1.6;
            margin-bottom: 15px;
            max-height: 100px;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .event-details {
            display: flex;
            flex-direction: column;
            gap: 8px;
            margin-bottom: 15px;
        }

        .event-detail {
            display: flex;
            align-items: center;
            gap: 8px;
            font-size: 13px;
            color: #666;
        }

        .event-detail i {
            color: #4CAF50;
            width: 16px;
        }

        .event-status {
            position: absolute;
            top: 10px;
            left: 10px;
            padding: 4px 10px;
            border-radius: 20px;
            font-size: 11px;
            font-weight: bold;
        }

        .status-ŸÜÿ¥ÿ∑ { background: #E8F5E9; color: #2E7D32; }
        .status-ŸÖŸÜÿ™ŸáŸä { background: #F5F5F5; color: #757575; }
        .status-ŸÖŸÑÿ∫Ÿâ { background: #FFEBEE; color: #C62828; }
        .status-ŸÖÿ§ÿ¨ŸÑ { background: #FFF3E0; color: #EF6C00; }

        .event-footer {
            padding: 12px 15px;
            background: #f8faf8;
            border-top: 1px solid #e8f5e9;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .event-organizer {
            font-size: 12px;
            color: #689f38;
        }

        .event-actions {
            display: flex;
            gap: 8px;
        }

        .event-action-btn {
            width: 32px;
            height: 32px;
            border-radius: 8px;
            border: none;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.3s;
            font-size: 14px;
        }

        .event-action-btn.edit { 
            background: #FF9800; 
            color: white; 
        }
        .event-action-btn.delete { 
            background: #F44336; 
            color: white; 
        }
        .event-action-btn.view { 
            background: #2196F3; 
            color: white; 
        }

        .event-action-btn:hover {
            transform: scale(1.1);
        }

        .upcoming-badge {
            position: absolute;
            top: 10px;
            right: 10px;
            background: #FFC107;
            color: #212121;
            padding: 4px 8px;
            border-radius: 20px;
            font-size: 10px;
            font-weight: bold;
            animation: pulse 2s infinite;
        }
        
        /* Lineage Highlight */
        .tree-node.lineage-dimmed {
            opacity: 0.22;
            filter: grayscale(85%);
            transform: none !important;
        }
        
        .tree-node.lineage-selected {
            opacity: 1;
            filter: none;
            box-shadow: 0 10px 28px rgba(0,0,0,0.18);
            border-width: 3px;
        }
        
        .tree-node.lineage-ancestor {
            opacity: 1;
            filter: none;
            outline: 3px dashed rgba(33,150,243,0.55);
            outline-offset: 3px;
        }
        
        .tree-node.lineage-descendant {
            opacity: 1;
            filter: none;
            outline: 3px dashed rgba(76,175,80,0.55);
            outline-offset: 3px;
        }

        /* Book Lineage */
        .book-member-card.book-card-dimmed {
            opacity: 0.25;
            filter: grayscale(80%);
        }
        
        .book-member-card.book-card-selected {
            opacity: 1;
            filter: none;
            outline: 3px solid rgba(76,175,80,0.55);
            box-shadow: 0 12px 26px rgba(0,0,0,0.15);
        }
        
        .book-member-card.book-card-ancestor {
            outline: 3px solid rgba(33,150,243,0.55);
        }
        
        .book-member-card.book-card-descendant {
            outline: 3px solid rgba(233,30,99,0.45);
        }

        /* Book Search */
        .book-member-card.book-hidden {
            display: none !important;
        }
        
        .book-member-card.book-match {
            outline: 3px solid rgba(255,193,7,0.65);
            outline-offset: 2px;
        }
        
        mark.book-mark {
            background: rgba(255,193,7,0.45);
            padding: 0 3px;
            border-radius: 6px;
        }

        /* Book Preview */
        .book-preview {
            background: transparent !important;
            padding: 12px !important;
        }

        .book-shell {
            display: flex;
            flex-direction: column;
            gap: 14px;
        }

        .book-page {
            background: var(--paper-bg);
            border: 1px solid var(--paper-border);
            border-radius: 18px;
            box-shadow: var(--shadow-soft);
            padding: 34px 36px;
            position: relative;
            overflow: hidden;
        }

        .book-page::after {
            content: var(--brand-mark);
            position: absolute;
            bottom: 14px;
            left: 18px;
            font-size: 22px;
            opacity: 0.25;
        }

        .book-watermark {
            position: absolute;
            top: 16px;
            left: 18px;
            font-size: 12px;
            color: rgba(27,94,32,0.55);
            display: flex;
            gap: 8px;
            align-items: center;
            user-select: none;
        }

        .book-cover {
            text-align: center;
            padding: 60px 20px;
        }

        .book-cover .book-title {
            font-size: 38px;
            color: var(--header-bg);
            margin-bottom: 10px;
            font-family: 'Amiri', serif;
        }

        .book-cover .book-subtitle {
            color: #2E7D32;
            font-size: 16px;
            margin-bottom: 26px;
        }

        .book-cover .book-badge {
            display: inline-flex;
            align-items: center;
            gap: 10px;
            padding: 10px 16px;
            border-radius: 999px;
            background: rgba(76,175,80,0.12);
            border: 1px solid rgba(76,175,80,0.25);
            color: #1B5E20;
            font-weight: 700;
        }

        .book-generation-title {
            font-size: 24px;
            color: var(--header-bg);
            border-bottom: 3px solid rgba(76,175,80,0.35);
            padding-bottom: 10px;
            margin-bottom: 16px;
            display: flex;
            align-items: center;
            gap: 10px;
            font-family: 'Amiri', serif;
        }

        .book-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(240px, 1fr));
            gap: 14px;
        }
        
        .book-grid.compact {
            grid-template-columns: repeat(auto-fill, minmax(280px, 1fr));
            gap: 16px;
        }

        .book-card {
            background: rgba(255,255,255,0.85);
            border: 1px solid rgba(27,94,32,0.10);
            border-radius: 14px;
            padding: 14px 14px 12px;
            box-shadow: 0 6px 18px rgba(0,0,0,0.06);
            position: relative;
        }

        .book-card .name {
            font-family: 'Amiri', serif;
            font-size: 18px;
            color: #1B5E20;
            margin-bottom: 8px;
            line-height: 1.35;
        }

        .book-card .meta {
            font-size: 13px;
            color: #2E7D32;
            display: flex;
            flex-direction: column;
            gap: 6px;
        }

        .book-card .meta span {
            display: flex;
            gap: 8px;
            align-items: center;
        }

        .book-card .tag {
            position: absolute;
            top: 12px;
            left: 12px;
            font-size: 11px;
            padding: 4px 10px;
            border-radius: 999px;
            background: rgba(0,151,167,0.10);
            border: 1px solid rgba(0,151,167,0.18);
            color: #006064;
            font-weight: 700;
        }

        /* ÿ£ŸÜŸÖÿßÿ∑ ÿ•ÿ∂ÿßŸÅŸäÿ© ŸÑŸÉÿ™ÿßÿ® ÿßŸÑÿπÿßÿ¶ŸÑÿ© */
        .book-card-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 12px;
            padding-bottom: 8px;
            border-bottom: 1px solid rgba(27, 94, 32, 0.1);
        }
        
        .book-card-id {
            background: #f1f8e9;
            color: #689f38;
            font-size: 12px;
            padding: 4px 8px;
            border-radius: 6px;
            font-weight: bold;
        }
        
        .book-card-gender {
            font-size: 12px;
            padding: 4px 10px;
            border-radius: 20px;
            font-weight: bold;
        }
        
        .book-card-gender.male {
            background: #e3f2fd;
            color: #2196F3;
        }
        
        .book-card-gender.female {
            background: #fce4ec;
            color: #E91E63;
        }
        
        .book-card-name {
            color: #1B5E20;
            font-size: 18px;
            margin-bottom: 12px;
            line-height: 1.4;
            font-family: 'Amiri', serif;
        }
        
        .book-card-details {
            font-size: 13px;
            color: #555;
            line-height: 1.5;
        }
        
        .book-card-detail {
            display: flex;
            align-items: flex-start;
            gap: 8px;
            margin-bottom: 6px;
        }
        
        .book-card-detail i {
            color: #4CAF50;
            min-width: 18px;
            margin-top: 2px;
        }

        /* Smart Suggestions */
        .smart-suggest {
            margin-top: 10px;
            padding: 10px 12px;
            border-radius: 12px;
            background: rgba(0,151,167,0.06);
            border: 1px solid rgba(0,151,167,0.12);
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
            align-items: center;
        }
        
        .smart-suggest .hint {
            font-size: 12px;
            color: #006064;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        .smart-suggest .hint b { 
            color: #004d40; 
        }
        
        .smart-suggest .suggest-actions {
            display: flex;
            gap: 8px;
            flex-wrap: wrap;
            margin-right: auto;
        }
        
        .chip {
            border: 1px solid rgba(27,94,32,0.18);
            background: rgba(76,175,80,0.10);
            color: #1B5E20;
            border-radius: 999px;
            padding: 6px 10px;
            font-size: 12px;
            cursor: pointer;
            transition: all .2s;
            user-select: none;
        }
        
        .chip:hover { 
            transform: translateY(-1px); 
            box-shadow: 0 6px 14px rgba(0,0,0,0.08); 
        }

        /* Import Button */
        .import-btn {
            background: linear-gradient(135deg, var(--button-info) 0%, #00838f 100%);
            color: white;
        }

        /* ÿ≤ÿ± ÿßŸÑÿπŸàÿØÿ© ÿßŸÑÿ≥ÿ±Ÿäÿπ */
        .quick-back-btn {
            position: fixed;
            top: 15px;
            left: 15px;
            background: rgba(255,255,255,0.9);
            border: 1px solid #e8f5e9;
            color: var(--header-bg);
            width: 45px;
            height: 45px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            z-index: 1001;
            transition: all 0.3s;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }
        
        .quick-back-btn:hover {
            background: white;
            transform: scale(1.1);
            box-shadow: 0 4px 12px rgba(0,0,0,0.2);
        }
        
        /* ÿ≤ÿ± ÿßŸÑŸÇÿßÿ¶ŸÖÿ© ŸÑŸÑÿ¨ŸàÿßŸÑ */
        .mobile-menu-toggle {
            display: none;
            position: fixed;
            top: 15px;
            right: 15px;
            background: var(--button-primary);
            color: white;
            width: 45px;
            height: 45px;
            border-radius: 50%;
            align-items: center;
            justify-content: center;
            z-index: 1002;
            box-shadow: 0 2px 8px rgba(0,0,0,0.2);
            border: none;
            font-size: 20px;
        }
        
        /* ÿ™ÿ≠ÿ≥ŸäŸÜÿßÿ™ ŸÑÿπÿ±ÿ∂ ÿßŸÑŸÖŸàÿ®ÿßŸäŸÑ */
        .mobile-optimized .tree-node {
            width: 120px;
            padding: 8px;
            margin: 3px;
        }
        
        .mobile-optimized .tree-node-container {
            min-width: 120px;
        }
        
        .mobile-optimized .tree-level {
            gap: 8px;
            padding: 8px;
        }
        
        .mobile-optimized .node-name {
            font-size: 13px;
            height: 2.4em;
        }
        
        .mobile-optimized .node-details {
            font-size: 10px;
        }
        
        .mobile-optimized .generation-label {
            padding: 6px 15px;
            font-size: 13px;
        }
        
        /* ÿ¥ÿßÿ¥ÿ© ÿ™ÿ≠ŸÖŸäŸÑ ŸÑÿ™ÿµÿØŸäÿ± ÿßŸÑÿµŸàÿ± */
        .export-loading {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.7);
            display: none;
            justify-content: center;
            align-items: center;
            z-index: 3000;
            color: white;
            font-size: 1rem;
            text-align: center;
            flex-direction: column;
            gap: 15px;
        }
        
        .export-loading.active {
            display: flex;
        }
        
        .export-loading i {
            font-size: 2.5rem;
            animation: spin 1s linear infinite;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        /* ÿ£ŸÜŸÖÿßÿ∑ ÿµŸÅÿ≠ÿ© ÿßŸÑŸÅÿ±ÿØ ÿßŸÑÿ™ŸÅÿµŸäŸÑŸäÿ© */
        .person-detail-container {
            padding: 15px;
        }
        
        .person-header {
            text-align: center;
            margin-bottom: 20px;
            padding-bottom: 15px;
            border-bottom: 2px solid #f1f8e9;
        }
        
        .person-avatar {
            width: 100px;
            height: 100px;
            border-radius: 50%;
            background: linear-gradient(135deg, var(--button-primary) 0%, var(--button-success) 100%);
            display: flex;
            align-items: center;
            justify-content: center;
            margin: 0 auto 15px;
            color: white;
            font-size: 36px;
        }
        
        .person-name {
            font-size: 24px;
            color: var(--header-bg);
            margin-bottom: 8px;
        }
        
        .person-id {
            background: #f1f8e9;
            padding: 4px 12px;
            border-radius: 20px;
            color: #689f38;
            display: inline-block;
            font-size: 14px;
        }
        
        .detail-sections {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
            gap: 15px;
        }
        
        .detail-section {
            background: #f8faf8;
            padding: 15px;
            border-radius: 8px;
            border-right: 4px solid var(--button-primary);
            box-shadow: 0 2px 8px rgba(0,0,0,0.05);
        }
        
        .section-title {
            font-size: 16px;
            color: var(--header-bg);
            margin-bottom: 12px;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        .detail-item {
            margin-bottom: 10px;
            display: flex;
            font-size: 14px;
        }
        
        .detail-label {
            font-weight: bold;
            color: #388e3c;
            min-width: 120px;
        }
        
        .detail-value {
            color: var(--header-bg);
            flex: 1;
        }
        
        /* ŸÜÿßŸÅÿ∞ÿ© ÿ•ÿØÿßÿ±ÿ© ÿßŸÑÿ≥ÿ≠ÿßÿ®ÿ© */
        .status-card {
            background: #f8faf8;
            padding: 15px;
            border-radius: 8px;
            border: 1px solid #e8f5e9;
        }
        
        .status-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 8px;
            padding-bottom: 8px;
            border-bottom: 1px solid #f1f8e9;
            font-size: 14px;
        }
        
        .status-item:last-child {
            margin-bottom: 0;
            padding-bottom: 0;
            border-bottom: none;
        }
        
        .status-badge {
            padding: 4px 10px;
            border-radius: 12px;
            font-size: 11px;
            font-weight: bold;
        }
        
        .status-badge.success {
            background: #e8f5e9;
            color: #4CAF50;
        }
        
        .status-badge.warning {
            background: #fff3e0;
            color: #FF9800;
        }
        
        .status-badge.error {
            background: #ffebee;
            color: #F44336;
        }
        
        .backup-list {
            max-height: 250px;
            overflow-y: auto;
            border: 1px solid #e8f5e9;
            border-radius: 6px;
            margin-top: 8px;
        }
        
        .backup-item {
            padding: 12px;
            border-bottom: 1px solid #f1f8e9;
            transition: all 0.3s;
        }
        
        .backup-item:hover {
            background: #f8faf8;
        }
        
        .backup-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 8px;
            flex-wrap: wrap;
            gap: 5px;
        }
        
        .backup-user {
            font-size: 11px;
            color: #7cb342;
        }
        
        .backup-stats {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
            margin-bottom: 8px;
            font-size: 11px;
        }
        
        .backup-stats span {
            color: #689f38;
            display: flex;
            align-items: center;
            gap: 4px;
        }
        
        .backup-actions {
            display: flex;
            gap: 8px;
            justify-content: flex-end;
        }
        
        .btn-sm {
            padding: 5px 10px;
            font-size: 11px;
        }

        /* ÿ∑ÿ®ÿßÿπÿ© */
        @media print {
            body::before { display: none; }
            .book-page {
                box-shadow: none !important;
                border: 1px solid #ddd !important;
                border-radius: 0 !important;
                page-break-after: always;
                break-after: page;
            }
            .book-controls, .close-form, .quick-back-btn, .mobile-menu-toggle { 
                display: none !important; 
            }
            .book-grid {
                grid-template-columns: repeat(2, 1fr) !important;
                gap: 15px !important;
            }
            .book-card, .event-card {
                break-inside: avoid;
                page-break-inside: avoid;
                box-shadow: none !important;
                border: 1px solid #ddd !important;
            }
            .event-actions {
                display: none !important;
            }
        }

        /* ÿ™ÿ≠ÿØŸäÿ´ ÿßŸÑÿ£ŸÜŸÖÿßÿ∑ ŸÑŸÑÿ¥ÿßÿ¥ÿßÿ™ ÿßŸÑÿµÿ∫Ÿäÿ±ÿ© */
        @media (max-width: 992px) {
            .sidebar {
                transform: translateX(100%);
                width: 280px;
                right: -280px;
            }
            
            .sidebar.active {
                transform: translateX(0);
                right: 0;
            }
            
            .main-content-area {
                margin-right: 0;
                width: 100%;
                padding: 15px;
            }
            
            .logo h1 {
                font-size: 1.1rem;
            }
            
            .user-info {
                gap: 8px;
            }
            
            .logout-btn span {
                display: none;
            }
            
            .logout-btn {
                padding: 8px;
            }
            
            .mobile-menu-toggle {
                display: flex;
            }
        }
        
        @media (max-width: 768px) {
            .panel-header {
                flex-direction: column;
                align-items: flex-start;
            }
            
            .action-buttons {
                width: 100%;
                justify-content: center;
            }
            
            .stats-cards {
                grid-template-columns: repeat(2, 1fr);
            }
            
            .tree-node {
                width: 140px;
                padding: 10px;
            }
            
            .tree-filter {
                margin: 0 10px 10px;
                padding: 10px;
                flex-direction: column;
                position: fixed;
                top: 70px;
                left: 0;
                right: 0;
                z-index: 999;
                border-radius: 0;
                box-shadow: 0 2px 8px rgba(0,0,0,0.1);
                transform: translateY(-100%);
                transition: transform 0.3s ease;
            }
            
            .tree-filter.active {
                transform: translateY(0);
            }
            
            .mobile-search-toggle {
                display: flex;
            }
            
            .sync-status {
                font-size: 11px;
                padding: 5px 8px;
                margin-left: 5px;
            }
            
            .data-table {
                font-size: 12px;
            }
            
            .data-table th, .data-table td {
                padding: 8px 6px;
            }
            
            .tree-view-btn {
                width: 50px;
                height: 50px;
                bottom: 15px;
                left: 15px;
                font-size: 20px;
            }
            
            .table-responsive {
                overflow-x: auto;
                -webkit-overflow-scrolling: touch;
            }
            
            .data-table {
                min-width: 600px;
            }
        }
        
        @media (max-width: 480px) {
            .stats-cards {
                grid-template-columns: 1fr;
            }
            
            .tree-node {
                width: 130px;
                font-size: 12px;
            }
            
            .tree-node-container {
                min-width: 130px;
            }
            
            .tree-level {
                justify-content: center;
            }
            
            .btn {
                padding: 7px 12px;
                font-size: 12px;
            }
            
            .form-grid {
                grid-template-columns: 1fr;
            }
            
            .top-bar {
                padding: 12px 15px;
            }
            
            .logo h1 {
                font-size: 1rem;
            }
            
            .tree-controls {
                justify-content: center;
            }
            
            .tree-header h2 {
                font-size: 1.1rem;
            }
            
            .mobile-optimized .tree-node {
                width: 120px;
                padding: 8px;
            }
        }
    </style>
</head>
<body>
    <button class="mobile-menu-toggle" id="mobileMenuToggle">
        <i class="fas fa-bars"></i>
    </button>

    <div id="login-screen">
        <button class="login-language-toggle" onclick="toggleLanguage()">
            <i class="fas fa-globe"></i>
            <span id="loginLanguageText">English</span>
        </button>
        
        <div class="login-container">
            <div class="login-logo">
                <i class="fas fa-tree"></i>
            </div>
            
            <h2 class="login-title" data-i18n="loginTitle">ŸÜÿ∏ÿßŸÖ ÿ•ÿØÿßÿ±ÿ© ÿ¥ÿ¨ÿ±ÿ© ÿßŸÑÿπÿßÿ¶ŸÑÿ©</h2>
            <p data-i18n="loginSubtitle">ÿßŸÑÿ±ÿ¨ÿßÿ° ÿ™ÿ≥ÿ¨ŸäŸÑ ÿßŸÑÿØÿÆŸàŸÑ ŸÑÿ•ÿØÿßÿ±ÿ© ÿ®ŸäÿßŸÜÿßÿ™ ÿßŸÑÿπÿßÿ¶ŸÑÿ©</p>
            
            <form class="login-form" onsubmit="event.preventDefault(); handleLogin();">
                <div class="form-group">
                    <i class="fas fa-user"></i>
                    <input type="text" id="username" class="login-input" data-i18n-placeholder="usernamePlaceholder" placeholder="ÿßÿ≥ŸÖ ÿßŸÑŸÖÿ≥ÿ™ÿÆÿØŸÖ" required>
                </div>
                
                <div class="form-group">
                    <i class="fas fa-lock"></i>
                    <input type="password" id="password" class="login-input" data-i18n-placeholder="passwordPlaceholder" placeholder="ŸÉŸÑŸÖÿ© ÿßŸÑŸÖÿ±Ÿàÿ±" required>
                </div>
                
                <div class="login-error" id="loginError">
                    <i class="fas fa-exclamation-circle"></i>
                    <span id="errorMessage" data-i18n="loginError">ÿßÿ≥ŸÖ ÿßŸÑŸÖÿ≥ÿ™ÿÆÿØŸÖ ÿ£Ÿà ŸÉŸÑŸÖÿ© ÿßŸÑŸÖÿ±Ÿàÿ± ÿ∫Ÿäÿ± ÿµÿ≠Ÿäÿ≠ÿ©</span>
                </div>
                
                <button type="submit" class="login-btn">
                    <i class="fas fa-sign-in-alt"></i> <span data-i18n="loginButton">ÿØÿÆŸàŸÑ</span>
                </button>
            </form>
            
            <div style="margin-top: 20px; color: #689f38; font-size: 14px;">
                <p><i class="fas fa-info-circle"></i> <span data-i18n="familyTitle">ÿ¥ÿ¨ÿ±ÿ© ÿπÿßÿ¶ŸÑÿ© ŸÖÿ≠ŸÖÿØ ÿπÿ®ÿØÿßŸÑÿ±ÿ≠ŸÖŸÜ ( ÿ£ÿ®ÿß )</span></p>
                <p data-i18n="developerInfo">ÿ™ÿµŸÖŸäŸÖ Ÿàÿ™ŸÜŸÅŸäÿ∞: | ŸÖÿ≠ŸÖÿØ ÿπŸÖÿ± ŸÖÿ≠ŸÖÿØ</p>
            </div>
        </div>
    </div>

    <div id="main-content">
        <div class="top-bar">
            <div class="logo">
                <i class="fas fa-tree" style="font-size: 24px;"></i>
                <h1 data-i18n="appTitle">ÿ¥ÿ¨ÿ±ÿ© ÿπÿßÿ¶ŸÑÿ© ŸÖÿ≠ŸÖÿØ ÿπÿ®ÿØÿßŸÑÿ±ÿ≠ŸÖŸÜ</h1>
            </div>
            
            <div class="user-info">
                <button class="language-toggle" onclick="toggleLanguage()">
                    <i class="fas fa-globe"></i>
                    <span id="languageText">EN</span>
                </button>
                <span data-i18n="welcome">ŸÖÿ±ÿ≠ÿ®ÿßŸãÿå</span> <span id="loggedInUser">ŸÖÿØŸäÿ± ÿßŸÑŸÜÿ∏ÿßŸÖ</span>
                <button class="logout-btn" onclick="logout()">
                    <i class="fas fa-sign-out-alt"></i> <span data-i18n="logout">ÿ™ÿ≥ÿ¨ŸäŸÑ ÿßŸÑÿÆÿ±Ÿàÿ¨</span>
                </button>
            </div>
        </div>

        <div class="sidebar" id="sidebar">
            <ul class="sidebar-menu">
                <li class="menu-item active" onclick="showDashboard()">
                    <i class="fas fa-home"></i>
                    <span data-i18n="dashboard">ÿßŸÑÿ±ÿ¶Ÿäÿ≥Ÿäÿ©</span>
                </li>
                <li class="menu-item" onclick="showAllPersons()">
                    <i class="fas fa-users"></i>
                    <span data-i18n="allPersons">ÿ¨ŸÖŸäÿπ ÿßŸÑÿ£ŸÅÿ±ÿßÿØ</span>
                </li>
                <li class="menu-item" onclick="showAddPersonForm()">
                    <i class="fas fa-user-plus"></i>
                    <span data-i18n="addPerson">ÿ•ÿ∂ÿßŸÅÿ© ŸÅÿ±ÿØ ÿ¨ÿØŸäÿØ</span>
                </li>
                <li class="menu-item" onclick="showSearch()">
                    <i class="fas fa-search"></i>
                    <span data-i18n="searchEdit">ÿ®ÿ≠ÿ´ Ÿàÿ™ÿπÿØŸäŸÑ</span>
                </li>
                <li class="menu-item" onclick="showStatistics()">
                    <i class="fas fa-chart-bar"></i>
                    <span data-i18n="statistics">ÿßŸÑÿ•ÿ≠ÿµÿßÿ¶Ÿäÿßÿ™</span>
                </li>
                <li class="menu-item" onclick="showTreeView()">
                    <i class="fas fa-project-diagram"></i>
                    <span data-i18n="treeView">ÿπÿ±ÿ∂ ÿßŸÑÿ¥ÿ¨ÿ±ÿ©</span>
                </li>
                <li class="menu-item" onclick="showBackup()">
                    <i class="fas fa-database"></i>
                    <span data-i18n="backup">ÿßŸÑŸÜÿ≥ÿÆ ÿßŸÑÿßÿ≠ÿ™Ÿäÿßÿ∑Ÿä</span>
                </li>
                <li class="menu-item" onclick="showFamilyBook()">
                    <i class="fas fa-book"></i>
                    <span data-i18n="familyBook">ŸÉÿ™ÿßÿ® ÿßŸÑÿπÿßÿ¶ŸÑÿ©</span>
                </li>
                <li class="menu-item" onclick="showFamilyEvents()">
                    <i class="fas fa-calendar-alt"></i>
                    <span>ÿßŸÑŸÖŸÜÿßÿ≥ÿ®ÿßÿ™ ŸàÿßŸÑÿ•ÿπŸÑÿßŸÜÿßÿ™</span>
                </li>
                <li class="menu-item" onclick="showExcelImport()">
                    <i class="fas fa-file-excel"></i>
                    <span data-i18n="excelImport">ÿßÿ≥ÿ™Ÿäÿ±ÿßÿØ Excel</span>
                </li>
                <li class="menu-item" onclick="showPermissions()">
                    <i class="fas fa-user-shield"></i>
                    <span data-i18n="permissions">ÿ•ÿØÿßÿ±ÿ© ÿßŸÑÿµŸÑÿßÿ≠Ÿäÿßÿ™</span>
                </li>
                <li class="menu-item" onclick="showEncryptionSettings()">
                    <i class="fas fa-lock"></i>
                    <span data-i18n="encryption">ÿ•ÿπÿØÿßÿØÿßÿ™ ÿßŸÑÿ™ÿ¥ŸÅŸäÿ±</span>
                </li>
                <li class="menu-item" onclick="showCloudManager()">
                    <i class="fas fa-cloud"></i>
                    <span>ÿ•ÿØÿßÿ±ÿ© ÿßŸÑÿ≥ÿ≠ÿßÿ®ÿ©</span>
                </li>
            </ul>
        </div>

        <div class="main-content-area" id="contentArea">
            <div class="stats-cards" id="statsCards">
                <div class="stat-card">
                    <div class="stat-icon total">
                        <i class="fas fa-users"></i>
                    </div>
                    <div class="stat-info">
                        <h3 id="totalPersons">0</h3>
                        <p data-i18n="totalPersons">ÿ•ÿ¨ŸÖÿßŸÑŸä ÿßŸÑÿ£ŸÅÿ±ÿßÿØ</p>
                    </div>
                </div>
                
                <div class="stat-card">
                    <div class="stat-icon male">
                        <i class="fas fa-male"></i>
                    </div>
                    <div class="stat-info">
                        <h3 id="maleCount">0</h3>
                        <p data-i18n="maleCount">ÿπÿØÿØ ÿßŸÑÿ∞ŸÉŸàÿ±</p>
                    </div>
                </div>
                
                <div class="stat-card">
                    <div class="stat-icon female">
                        <i class="fas fa-female"></i>
                    </div>
                    <div class="stat-info">
                        <h3 id="femaleCount">0</h3>
                        <p data-i18n="femaleCount">ÿπÿØÿØ ÿßŸÑÿ•ŸÜÿßÿ´</p>
                    </div>
                </div>
                
                <div class="stat-card">
                    <div class="stat-icon families">
                        <i class="fas fa-home"></i>
                    </div>
                    <div class="stat-info">
                        <h3 id="familiesCount">0</h3>
                        <p data-i18n="familiesCount">ÿπÿØÿØ ÿßŸÑÿπÿßÿ¶ŸÑÿßÿ™</p>
                    </div>
                </div>
            </div>

            <div class="control-panel">
                <div class="panel-header">
                    <h2><i class="fas fa-users"></i> <span data-i18n="familyManagement">ÿ•ÿØÿßÿ±ÿ© ÿ£ŸÅÿ±ÿßÿØ ÿßŸÑÿπÿßÿ¶ŸÑÿ©</span></h2>
                    <div class="action-buttons">
                        <button class="btn btn-primary" onclick="showAddPersonForm()">
                            <i class="fas fa-user-plus"></i> <span data-i18n="addNewPerson">ÿ•ÿ∂ÿßŸÅÿ© ŸÅÿ±ÿØ ÿ¨ÿØŸäÿØ</span>
                        </button>
                        <button class="btn btn-success" onclick="refreshData()">
                            <i class="fas fa-sync"></i> <span data-i18n="refreshData">ÿ™ÿ≠ÿØŸäÿ´ ÿßŸÑÿ®ŸäÿßŸÜÿßÿ™</span>
                        </button>
                        <div class="export-options">
                            <button class="btn btn-warning" onclick="toggleExportMenu()">
                                <i class="fas fa-download"></i> <span data-i18n="exportData">ÿ™ÿµÿØŸäÿ± ÿßŸÑÿ®ŸäÿßŸÜÿßÿ™</span>
                            </button>
                            <div class="export-menu" id="exportMenu">
                                <div class="export-option" onclick="exportData('json')">
                                    <i class="fas fa-file-code"></i>
                                    <span data-i18n="exportJson">JSON</span>
                                </div>
                                <div class="export-option" onclick="exportData('excel')">
                                    <i class="fas fa-file-excel"></i>
                                    <span data-i18n="exportExcel">Excel</span>
                                </div>
                                <div class="export-option" onclick="exportData('csv')">
                                    <i class="fas fa-file-csv"></i>
                                    <span data-i18n="exportCSV">CSV</span>
                                </div>
                                <div class="export-option" onclick="exportFullExcel()">
                                    <i class="fas fa-file-excel"></i>
                                    <span>Excel (ŸÖÿ™ŸÇÿØŸÖ)</span>
                                </div>
                            </div>
                        </div>
                        <button class="btn btn-info" onclick="toggleSortOrder()">
                            <i class="fas fa-sort-numeric-down"></i> <span data-i18n="toggleSort">ÿ™ÿ±ÿ™Ÿäÿ® ÿ™ÿµÿßÿπÿØŸä/ÿ™ŸÜÿßÿ≤ŸÑŸä</span>
                        </button>
                        <div class="file-input-container">
                            <button class="btn btn-info import-btn" onclick="document.getElementById('importFile').click()">
                                <i class="fas fa-upload"></i> <span data-i18n="importData">ÿßÿ≥ÿ™Ÿäÿ±ÿßÿØ ÿßŸÑÿ®ŸäÿßŸÜÿßÿ™</span>
                            </button>
                            <input type="file" id="importFile" class="file-input" accept=".json" onchange="handleFileImport(event)" style="display: none;">
                        </div>
                        <button class="btn btn-info" onclick="backupToCloud()" title="ŸÜÿ≥ÿÆÿ© ÿßÿ≠ÿ™Ÿäÿßÿ∑Ÿäÿ© ÿπŸÑŸâ ÿßŸÑÿ≥ÿ≠ÿßÿ®ÿ©">
                            <i class="fas fa-cloud-upload-alt"></i> <span>ŸÜÿ≥ÿÆ ÿ≥ÿ≠ÿßÿ®Ÿä</span>
                        </button>
                        <button class="btn btn-info" onclick="loadDataFromCloud()" title="ÿ™ÿ≠ŸÖŸäŸÑ ÿßŸÑÿ®ŸäÿßŸÜÿßÿ™ ŸÖŸÜ ÿßŸÑÿ≥ÿ≠ÿßÿ®ÿ©">
                            <i class="fas fa-cloud-download-alt"></i> <span>ÿ™ÿ≠ŸÖŸäŸÑ ŸÖŸÜ ÿßŸÑÿ≥ÿ≠ÿßÿ®ÿ©</span>
                        </button>
                    </div>
                </div>
                
                <div class="alert success" id="successAlert">
                    <i class="fas fa-check-circle"></i>
                    <span id="successMessage" data-i18n="successMessage">ÿ™ŸÖÿ™ ÿßŸÑÿπŸÖŸÑŸäÿ© ÿ®ŸÜÿ¨ÿßÿ≠</span>
                </div>
                
                <div class="alert error" id="errorAlert">
                    <i class="fas fa-exclamation-circle"></i>
                    <span id="errorMessage" data-i18n="errorMessage">ÿ≠ÿØÿ´ ÿÆÿ∑ÿ£ ÿ£ÿ´ŸÜÿßÿ° ÿßŸÑÿπŸÖŸÑŸäÿ©</span>
                </div>

                <div class="table-responsive" style="overflow-x: auto;">
                    <table class="data-table" id="personsTable">
                        <thead>
                            <tr>
                                <th data-i18n="tableId">ÿßŸÑÿ±ŸÇŸÖ</th>
                                <th data-i18n="tableName">ÿßŸÑÿßÿ≥ŸÖ ÿßŸÑŸÉÿßŸÖŸÑ</th>
                                <th data-i18n="tableGender">ÿßŸÑÿ¨ŸÜÿ≥</th>
                                <th data-i18n="tableBirthPlace">ŸÖŸÉÿßŸÜ ÿßŸÑŸÖŸäŸÑÿßÿØ</th>
                                <th data-i18n="tableFather">ÿßŸÑÿ£ÿ®</th>
                                <th data-i18n="tableMother">ÿßŸÑÿ£ŸÖ</th>
                                <th data-i18n="tableActions">ÿßŸÑÿ•ÿ¨ÿ±ÿßÿ°ÿßÿ™</th>
                            </tr>
                        </thead>
                        <tbody id="tableBody">
                            </tbody>
                    </table>
                </div>
            </div>
        </div>

        <button class="tree-view-btn" onclick="showTreeView()">
            <i class="fas fa-tree"></i>
        </button>
    </div>

    <div class="form-modal" id="personFormModal">
        <button class="quick-back-btn" onclick="closePersonForm()" title="ÿ•ÿ∫ŸÑÿßŸÇ">
            <i class="fas fa-times"></i>
        </button>
        <div class="form-container">
            <div class="form-header">
                <h3><i class="fas fa-user-edit"></i> <span id="formTitle" data-i18n="addPersonForm">ÿ•ÿ∂ÿßŸÅÿ© ŸÅÿ±ÿØ ÿ¨ÿØŸäÿØ</span></h3>
                <button class="close-form" onclick="closePersonForm()">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            
            <div class="form-body">
                <form id="personForm" onsubmit="event.preventDefault(); savePerson();">
                    <input type="hidden" id="personId">
                    
                    <div class="form-grid">
                        <div class="form-group">
                            <label class="form-label required" data-i18n="formFullName">ÿßŸÑÿßÿ≥ŸÖ ÿßŸÑŸÉÿßŸÖŸÑ</label>
                            <input type="text" class="form-input" id="fullName" required>
                        </div>
                        
                        <div class="form-group">
                            <label class="form-label required" data-i18n="formGender">ÿßŸÑÿ¨ŸÜÿ≥</label>
                            <select class="form-select" id="gender" required>
                                <option value="" data-i18n="formSelectGender">ÿßÿÆÿ™ÿ± ÿßŸÑÿ¨ŸÜÿ≥</option>
                                <option value="ÿ∞ŸÉÿ±" data-i18n="male">ÿ∞ŸÉÿ±</option>
                                <option value="ÿßŸÜÿ´Ÿâ" data-i18n="female">ÿ£ŸÜÿ´Ÿâ</option>
                            </select>
                        </div>
                        
                        <div class="form-group">
                            <label class="form-label" data-i18n="formBirthPlace">ŸÖŸÉÿßŸÜ ÿßŸÑŸÖŸäŸÑÿßÿØ</label>
                            <input type="text" class="form-input" id="placeOfBirth">
                        </div>
                        
                        <div class="form-group">
                            <label class="form-label" data-i18n="formBirthDate">ÿ™ÿßÿ±ŸäÿÆ ÿßŸÑŸÖŸäŸÑÿßÿØ</label>
                            <input type="date" class="form-input" id="birthDate">
                        </div>
                        
                        <div class="form-group">
                            <label class="form-label" data-i18n="formDeathDate">ÿ™ÿßÿ±ŸäÿÆ ÿßŸÑŸàŸÅÿßÿ© (ÿ•ŸÜ Ÿàÿ¨ÿØ)</label>
                            <input type="date" class="form-input" id="deathDate">
                        </div>
                        
                        <div class="form-group">
                            <label class="form-label" data-i18n="formFatherId">ÿ±ŸÇŸÖ ÿßŸÑÿ£ÿ®</label>
                            <select class="form-select" id="fatherId">
                                <option value="0" data-i18n="formNoFather">ŸÑÿß ŸäŸàÿ¨ÿØ (ÿ¨ÿ∞ÿ± ÿßŸÑÿπÿßÿ¶ŸÑÿ©)</option>
                                </select>
                        </div>
                        
                        <div class="form-group">
                            <label class="form-label" data-i18n="formMotherId">ÿ±ŸÇŸÖ ÿßŸÑÿ£ŸÖ</label>
                            <select class="form-select" id="motherId">
                                <option value="0" data-i18n="formNoMother">ŸÑÿß ŸäŸàÿ¨ÿØ</option>
                                </select>
                        </div>
                        
                        <div class="form-group">
                            <label class="form-label" data-i18n="formSpouseId">ÿ±ŸÇŸÖ ÿßŸÑÿ≤Ÿàÿ¨/ÿßŸÑÿ≤Ÿàÿ¨ÿ©</label>
                            <select class="form-select" id="spouseId">
                                <option value="0" data-i18n="formNoSpouse">ŸÑÿß ŸäŸàÿ¨ÿØ</option>
                                </select>
                        </div>
                    
                    </div>

                    <div class="smart-suggest" id="relationSuggestBox" style="display: none;">
                        <div class="hint">
                            <i class="fas fa-magic"></i>
                            <span>ÿßŸÇÿ™ÿ±ÿßÿ≠ÿßÿ™ ÿ∞ŸÉŸäÿ©: <b id="suggestSummary">‚Äî</b></span>
                        </div>
                        <div class="suggest-actions">
                            <span class="chip" onclick="applySmartSuggestions()">ÿ™ÿ∑ÿ®ŸäŸÇ ÿßŸÑÿßŸÇÿ™ÿ±ÿßÿ≠ÿßÿ™</span>
                            <span class="chip" onclick="showWhySuggestion()">ŸÑŸÖÿßÿ∞ÿß Ÿáÿ∞ÿß ÿßŸÑÿßŸÇÿ™ÿ±ÿßÿ≠ÿü</span>
                            <span class="chip" onclick="clearSmartSuggestions()">ŸÖÿ≥ÿ≠ ÿßŸÑÿßŸÇÿ™ÿ±ÿßÿ≠</span>
                        </div>
                    </div>

                    <div class="form-group">
                        <label class="form-label" data-i18n="formNotes">ŸÖŸÑÿßÿ≠ÿ∏ÿßÿ™ ÿ•ÿ∂ÿßŸÅŸäÿ©</label>
                        <textarea class="form-textarea" id="notes" rows="3"></textarea>
                    </div>
                    
                    <div class="form-actions">
                        <button type="button" class="btn btn-danger" onclick="closePersonForm()">
                            <i class="fas fa-times"></i> <span data-i18n="cancel">ÿ•ŸÑÿ∫ÿßÿ°</span>
                        </button>
                        <button type="submit" class="btn btn-success">
                            <i class="fas fa-save"></i> <span data-i18n="save">ÿ≠ŸÅÿ∏ ÿßŸÑÿ®ŸäÿßŸÜÿßÿ™</span>
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <div class="tree-view" id="treeView">
        <div class="tree-header">
            <div>
                <h2><i class="fas fa-project-diagram"></i> <span data-i18n="fullFamilyTree">ÿ¥ÿ¨ÿ±ÿ© ÿßŸÑÿπÿßÿ¶ŸÑÿ© </span></h2>
                <div class="tree-toolbar">
                    <div class="tree-controls">
                        <div class="tree-zoom">
                            <button class="tree-zoom-btn" onclick="zoomOutTree()">
                                <i class="fas fa-search-minus"></i>
                            </button>
                            <span id="zoomLevel">100%</span>
                            <button class="tree-zoom-btn" onclick="zoomInTree()">
                                <i class="fas fa-search-plus"></i>
                            </button>
                        </div>
                        <button class="btn btn-info" onclick="toggleCompactMode()">
                            <i class="fas fa-compress"></i> <span data-i18n="toggleView">ÿ™ÿ®ÿØŸäŸÑ ÿßŸÑÿπÿ±ÿ∂</span>
                        </button>
                        <div class="export-options">
                            <button class="btn btn-warning" onclick="toggleTreeExportMenu()">
                                <i class="fas fa-camera"></i> <span data-i18n="exportImage">ÿ™ÿµÿØŸäÿ± ÿµŸàÿ±ÿ©</span>
                            </button>
                            <div class="export-menu" id="treeExportMenu">
                                <div class="export-option" onclick="exportTreeImage('normal')">
                                    <i class="fas fa-image"></i>
                                    <span data-i18n="exportNormal">ÿµŸàÿ±ÿ© ÿπÿßÿØŸäÿ©</span>
                                </div>
                                <div class="export-option" onclick="exportTreeImage('high')">
                                    <i class="fas fa-file-image"></i>
                                    <span data-i18n="exportHigh">ÿµŸàÿ±ÿ© ÿπÿßŸÑŸäÿ© ÿßŸÑÿ¨ŸàÿØÿ©</span>
                                </div>
                                <div class="export-option" onclick="exportCurrentSection()">
                                    <i class="fas fa-crop"></i>
                                    <span data-i18n="exportVisible">ÿßŸÑÿ¨ÿ≤ÿ° ÿßŸÑŸÖÿ±ÿ¶Ÿä ŸÅŸÇÿ∑</span>
                                </div>
                            </div>
                        </div>
                        <button class="btn btn-info mobile-mode-btn" onclick="toggleMobileOptimization()">
                            <i class="fas fa-mobile-alt"></i> <span data-i18n="mobileMode">Ÿàÿ∂ÿπ ÿßŸÑŸÖŸàÿ®ÿßŸäŸÑ</span>
                        </button>
                    </div>
                    <div class="tree-count">
                        <i class="fas fa-users"></i>
                        <span id="treePersonCount">0</span> <span data-i18n="persons">ŸÅÿ±ÿØ</span>
                        <span class="search-match-count" id="searchMatchCount" style="display: none;">0</span>
                    </div>
                </div>
            </div>
            <button class="btn btn-danger" onclick="closeTreeView()">
                <i class="fas fa-times"></i> <span data-i18n="close">ÿ•ÿ∫ŸÑÿßŸÇ</span>
            </button>
        </div>
        
        <button class="mobile-search-toggle" id="mobileSearchToggle">
            <i class="fas fa-search"></i>
        </button>
        
        <div class="tree-filter" id="treeFilter">
            <input type="text" id="treeSearch" data-i18n-placeholder="treeSearchPlaceholder" placeholder="ÿßÿ®ÿ≠ÿ´ ÿπŸÜ ŸÅÿ±ÿØ ŸÅŸä ÿßŸÑÿ¥ÿ¨ÿ±ÿ©..." onkeyup="searchInTree()">
            <button class="btn btn-primary" onclick="clearTreeSearch()">
                <i class="fas fa-times"></i> <span data-i18n="clearSearch">ŸÖÿ≥ÿ≠ ÿßŸÑÿ®ÿ≠ÿ´</span>
            </button>
            <button class="btn btn-success" onclick="scrollToGeneration(1)">
                <i class="fas fa-arrow-up"></i> <span data-i18n="firstGeneration">ÿßŸÑÿ¨ŸäŸÑ ÿßŸÑÿ£ŸàŸÑ</span>
            </button>
            <div style="color: #689f38; font-size: 12px; display: none;" class="tree-info-mobile">
                <i class="fas fa-info-circle"></i> <span data-i18n="treeInfo">ÿßŸÜŸÇÿ± ÿπŸÑŸâ ÿ£Ÿä ŸÅÿ±ÿØ ŸÑÿπÿ±ÿ∂ ŸÖÿπŸÑŸàŸÖÿßÿ™Ÿá</span>
            </div>
        </div>
        
        <div class="tree-content" id="treeContainer">
            </div>
    </div>

    <div class="form-modal" id="personDetailModal">
        <button class="quick-back-btn" onclick="closePersonDetail()" title="ÿ•ÿ∫ŸÑÿßŸÇ">
            <i class="fas fa-times"></i>
        </button>
        <div class="form-container" style="max-width: 800px;">
            <div class="form-header">
                <h3><i class="fas fa-user-circle"></i> <span id="detailTitle" data-i18n="personInfo">ŸÖÿπŸÑŸàŸÖÿßÿ™ ÿßŸÑŸÅÿ±ÿØ</span></h3>
                <button class="close-form" onclick="closePersonDetail()">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            
            <div class="form-body">
                <div class="person-detail-container" id="personDetailContent">
                    </div>
                
                <div class="form-actions">
                    <button type="button" class="btn btn-danger" onclick="closePersonDetail()">
                        <i class="fas fa-times"></i> <span data-i18n="close">ÿ•ÿ∫ŸÑÿßŸÇ</span>
                    </button>
                    <button type="button" class="btn btn-warning" onclick="printPersonDetail()">
                        <i class="fas fa-print"></i> <span data-i18n="print">ÿ∑ÿ®ÿßÿπÿ©</span>
                    </button>
                    <button type="button" class="btn btn-primary" onclick="editCurrentPerson()">
                        <i class="fas fa-edit"></i> <span data-i18n="edit">ÿ™ÿπÿØŸäŸÑ</span>
                    </button>
                </div>
            </div>
        </div>
    </div>

    <div class="form-modal" id="familyBookModal">
        <button class="quick-back-btn" onclick="closeFamilyBook()" title="ÿ•ÿ∫ŸÑÿßŸÇ">
            <i class="fas fa-times"></i>
        </button>
        <div class="form-container" style="max-width: 900px;">
            <div class="form-header">
                <h3><i class="fas fa-book"></i> <span data-i18n="familyBook">ŸÉÿ™ÿßÿ® ÿßŸÑÿπÿßÿ¶ŸÑÿ©</span></h3>
                <button class="close-form" onclick="closeFamilyBook()">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            
            <div class="form-body">
                
                <div class="book-controls" style="margin-bottom: 16px; display:flex; gap:10px; flex-wrap:wrap; align-items:center;">
                    <button class="btn btn-primary" onclick="generateFamilyBook()">
                        <i class="fas fa-sync"></i> <span data-i18n="generateBook">ÿ™ŸàŸÑŸäÿØ ŸÉÿ™ÿßÿ® ÿ¨ÿØŸäÿØ</span>
                    </button>
                    <button class="btn btn-success" onclick="exportFamilyBook()">
                        <i class="fas fa-file-pdf"></i> <span data-i18n="exportPDF">ÿ™ÿµÿØŸäÿ± ŸÉŸÄ PDF</span>
                    </button>
                    <button class="btn btn-info" onclick="printFamilyBook()">
                        <i class="fas fa-print"></i> <span data-i18n="print">ÿ∑ÿ®ÿßÿπÿ©</span>
                    </button>

                    <div class="book-search" style="display:flex; gap:8px; align-items:center; background: rgba(255,255,255,0.15); padding: 8px 12px; border-radius: 999px; border: 1px solid rgba(255,255,255,0.20);">
                        <i class="fas fa-search"></i>
                        <input id="bookSearchInput" class="form-input" style="width: 260px; padding: 8px 10px; border-radius: 999px;" placeholder="ÿ®ÿ≠ÿ´ ÿ≥ÿ±Ÿäÿπ ÿØÿßÿÆŸÑ ŸÉÿ™ÿßÿ® ÿßŸÑÿπÿßÿ¶ŸÑÿ© (ÿßÿ≥ŸÖ/ÿ±ŸÇŸÖ/ŸÖŸÉÿßŸÜ)..." oninput="searchFamilyBook()" />
                        <button class="btn btn-secondary" style="padding: 8px 12px;" onclick="clearBookSearch()" title="ŸÖÿ≥ÿ≠ ÿßŸÑÿ®ÿ≠ÿ´">
                            <i class="fas fa-times"></i>
                        </button>
                    </div>

                    <div id="bookOptions" style="margin-right:auto; display:flex; gap:10px; flex-wrap:wrap; align-items:center;">
                        <div style="display:flex; gap:8px; align-items:center; background: rgba(255,255,255,0.15); padding: 8px 12px; border-radius: 999px; border: 1px solid rgba(255,255,255,0.20);">
                            <i class="fas fa-palette"></i>
                            <input id="familyBrandNameInput" class="form-input" style="width: 220px; padding: 8px 10px; border-radius: 999px;" placeholder="ÿßÿ≥ŸÖ ÿßŸÑÿπÿßÿ¶ŸÑÿ© ŸÑŸÑŸáŸàŸäÿ© (ŸÖÿ´ÿßŸÑ: ÿ¢ŸÑ ŸÖÿ≠ŸÖÿØ ÿπÿ®ÿØÿßŸÑÿ±ÿ≠ŸÖŸÜ)" />
                        </div>
                        <button class="btn btn-warning" onclick="applyBrandingFromInput()" title="ÿ™ÿ∑ÿ®ŸäŸÇ ŸáŸàŸäÿ© ÿ®ÿµÿ±Ÿäÿ©">
                            <i class="fas fa-feather-alt"></i> ÿ™ÿ∑ÿ®ŸäŸÇ ÿßŸÑŸáŸàŸäÿ©
                        </button>
                        <button class="btn btn-info" onclick="toggleBookCompact()" title="ÿπÿ±ÿ∂ ŸÖÿ∂ÿ∫Ÿàÿ∑/ŸÖŸàÿ≥ÿπ">
                            <i class="fas fa-columns"></i> ÿ™ÿÆÿ∑Ÿäÿ∑
                        </button>
                    </div>

                    <button class="btn btn-danger" onclick="closeFamilyBook()" style="margin-right: auto;">
                        <i class="fas fa-times"></i> <span data-i18n="close">ÿ•ÿ∫ŸÑÿßŸÇ</span>
                    </button>
                </div>

                <div class="book-preview" id="bookPreview" style="background: white; padding: 20px; border-radius: 10px; box-shadow: 0 0 10px rgba(0,0,0,0.1);">
                    </div>
            </div>
        </div>
    </div>

    <div class="form-modal" id="familyEventsModal">
        <button class="quick-back-btn" onclick="closeFamilyEvents()" title="ÿ•ÿ∫ŸÑÿßŸÇ">
            <i class="fas fa-times"></i>
        </button>
        <div class="form-container" style="max-width: 1000px;">
            <div class="form-header">
                <h3><i class="fas fa-calendar-alt"></i> <span>ÿßŸÑŸÖŸÜÿßÿ≥ÿ®ÿßÿ™ ŸàÿßŸÑÿ•ÿπŸÑÿßŸÜÿßÿ™ ÿßŸÑÿπÿßÿ¶ŸÑŸäÿ©</span></h3>
                <button class="close-form" onclick="closeFamilyEvents()">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            
            <div class="form-body">
                <!-- ŸÑŸàÿ≠ÿ© ÿßŸÑÿ™ÿ≠ŸÉŸÖ ŸÑŸÑŸÖÿØŸäÿ± -->
                <div class="control-panel" id="eventsControlPanel" style="margin-bottom: 20px; display: none;">
                    <div class="panel-header">
                        <h2><i class="fas fa-plus-circle"></i> <span>ÿ•ÿ∂ÿßŸÅÿ© ÿ•ÿπŸÑÿßŸÜ ÿ¨ÿØŸäÿØ</span></h2>
                    </div>
                    
                    <form id="eventForm" onsubmit="event.preventDefault(); saveEvent();">
                        <input type="hidden" id="eventId" value="">
                        
                        <div class="form-grid">
                            <div class="form-group">
                                <label class="form-label required">ŸÜŸàÿπ ÿßŸÑÿ•ÿπŸÑÿßŸÜ</label>
                                <select class="form-select" id="eventType" required>
                                    <option value="">ÿßÿÆÿ™ÿ± ÿßŸÑŸÜŸàÿπ</option>
                                    <option value="ŸÖŸÜÿßÿ≥ÿ®ÿ©">ŸÖŸÜÿßÿ≥ÿ®ÿ© ÿπÿßÿ¶ŸÑŸäÿ©</option>
                                    <option value="ÿßÿ¨ÿ™ŸÖÿßÿπ">ÿßÿ¨ÿ™ŸÖÿßÿπ ÿπÿßÿ¶ŸÑŸä</option>
                                    <option value="ŸÅÿπÿßŸÑŸäÿ©">ŸÅÿπÿßŸÑŸäÿ©</option>
                                    <option value="ÿ®ÿ±ŸÜÿßŸÖÿ¨">ÿ®ÿ±ŸÜÿßŸÖÿ¨ ÿ£ÿ≥ÿ±Ÿä</option>
                                    <option value="ÿ™ÿ∞ŸÉŸäÿ±">ÿ™ÿ∞ŸÉŸäÿ± ŸÖŸáŸÖ</option>
                                    <option value="ÿ£ÿÆÿ±Ÿâ">ÿ£ÿÆÿ±Ÿâ</option>
                                </select>
                            </div>
                            
                            <div class="form-group">
                                <label class="form-label required">ÿßŸÑÿπŸÜŸàÿßŸÜ</label>
                                <input type="text" class="form-input" id="eventTitle" required placeholder="ÿπŸÜŸàÿßŸÜ ÿßŸÑÿ•ÿπŸÑÿßŸÜ">
                            </div>
                            
                            <div class="form-group">
                                <label class="form-label required">ÿßŸÑÿ™ÿßÿ±ŸäÿÆ</label>
                                <input type="date" class="form-input" id="eventDate" required>
                            </div>
                            
                            <div class="form-group">
                                <label class="form-label">ÿßŸÑŸàŸÇÿ™</label>
                                <input type="time" class="form-input" id="eventTime">
                            </div>
                            
                            <div class="form-group">
                                <label class="form-label">ÿßŸÑŸÖŸÉÿßŸÜ</label>
                                <input type="text" class="form-input" id="eventLocation" placeholder="ŸÖŸÉÿßŸÜ ÿßŸÑÿ≠ÿØÿ´">
                            </div>
                        </div>
                        
                        <div class="form-group">
                            <label class="form-label required">ÿ™ŸÅÿßÿµŸäŸÑ ÿßŸÑÿ•ÿπŸÑÿßŸÜ</label>
                            <textarea class="form-textarea" id="eventDescription" rows="5" required placeholder="ÿ™ŸÅÿßÿµŸäŸÑ ÿßŸÑŸÖŸÜÿßÿ≥ÿ®ÿ© ÿ£Ÿà ÿßŸÑÿ®ÿ±ŸÜÿßŸÖÿ¨..."></textarea>
                        </div>
                        
                        <div class="form-group">
                            <label class="form-label">ÿßŸÑŸÖÿ≥ÿ§ŸàŸÑ ÿπŸÜ ÿßŸÑŸÖŸÜÿßÿ≥ÿ®ÿ©</label>
                            <input type="text" class="form-input" id="eventOrganizer" placeholder="ÿßÿ≥ŸÖ ÿßŸÑŸÖÿ≥ÿ§ŸàŸÑ">
                        </div>
                        
                        <div class="form-group">
                            <label class="form-label">ÿ≠ÿßŸÑÿ© ÿßŸÑÿ•ÿπŸÑÿßŸÜ</label>
                            <select class="form-select" id="eventStatus">
                                <option value="ŸÜÿ¥ÿ∑">ŸÜÿ¥ÿ∑</option>
                                <option value="ŸÖŸÜÿ™ŸáŸä">ŸÖŸÜÿ™ŸáŸä</option>
                                <option value="ŸÖŸÑÿ∫Ÿâ">ŸÖŸÑÿ∫Ÿâ</option>
                                <option value="ŸÖÿ§ÿ¨ŸÑ">ŸÖÿ§ÿ¨ŸÑ</option>
                            </select>
                        </div>
                        
                        <div class="form-actions">
                            <button type="button" class="btn btn-danger" onclick="cancelEventForm()">
                                <i class="fas fa-times"></i> ÿ•ŸÑÿ∫ÿßÿ°
                            </button>
                            <button type="submit" class="btn btn-success">
                                <i class="fas fa-save"></i> ÿ≠ŸÅÿ∏ ÿßŸÑÿ•ÿπŸÑÿßŸÜ
                            </button>
                        </div>
                    </form>
                </div>
                
                <!-- ŸÑŸàÿ≠ÿ© ÿßŸÑÿ•ÿπŸÑÿßŸÜÿßÿ™ ÿßŸÑÿ±ÿ¶Ÿäÿ≥Ÿäÿ© -->
                <div class="panel-header" style="margin-bottom: 20px;">
                    <h2><i class="fas fa-bullhorn"></i> <span>ÿßŸÑÿ•ÿπŸÑÿßŸÜÿßÿ™ ŸàÿßŸÑŸÖŸÜÿßÿ≥ÿ®ÿßÿ™ ÿßŸÑÿ≠ÿßŸÑŸäÿ©</span></h2>
                    <div class="action-buttons">
                        <button class="btn btn-primary" onclick="toggleEventForm()" id="toggleEventFormBtn">
                            <i class="fas fa-plus"></i> ÿ•ÿ∂ÿßŸÅÿ© ÿ•ÿπŸÑÿßŸÜ ÿ¨ÿØŸäÿØ
                        </button>
                        <button class="btn btn-info" onclick="backupEventsToCloud()" title="ŸÜÿ≥ÿÆ ÿßÿ≠ÿ™Ÿäÿßÿ∑Ÿä ŸÑŸÑÿ•ÿπŸÑÿßŸÜÿßÿ™">
                            <i class="fas fa-cloud-upload-alt"></i> ŸÜÿ≥ÿÆ ÿ•ÿπŸÑÿßŸÜÿßÿ™ ÿ≥ÿ≠ÿßÿ®Ÿä
                        </button>
                        <button class="btn btn-info" onclick="forceEventsSync()" title="ŸÖÿ≤ÿßŸÖŸÜÿ© ÿßŸÑÿ•ÿπŸÑÿßŸÜÿßÿ™">
                            <i class="fas fa-sync"></i> ŸÖÿ≤ÿßŸÖŸÜÿ©
                        </button>
                        <button class="btn btn-info" onclick="filterEvents('all')">
                            <i class="fas fa-list"></i> ÿßŸÑŸÉŸÑ
                        </button>
                        <button class="btn btn-success" onclick="filterEvents('ŸÜÿ¥ÿ∑')">
                            <i class="fas fa-eye"></i> ÿßŸÑŸÜÿ¥ÿ∑ÿ©
                        </button>
                        <button class="btn btn-warning" onclick="filterEvents('ŸÇÿßÿØŸÖ')">
                            <i class="fas fa-calendar"></i> ÿßŸÑŸÇÿßÿØŸÖÿ©
                        </button>
                    </div>
                </div>
                
                <!-- ŸÅŸÑÿ™ÿ± ÿßŸÑÿ®ÿ≠ÿ´ -->
                <div class="tree-filter" style="margin: 0 0 20px 0;">
                    <input type="text" id="eventSearch" placeholder="ÿßÿ®ÿ≠ÿ´ ŸÅŸä ÿßŸÑÿ•ÿπŸÑÿßŸÜÿßÿ™..." onkeyup="searchEvents()">
                    <button class="btn btn-primary" onclick="clearEventSearch()">
                        <i class="fas fa-times"></i> ŸÖÿ≥ÿ≠ ÿßŸÑÿ®ÿ≠ÿ´
                    </button>
                    <button class="btn btn-info" onclick="printEvents()">
                        <i class="fas fa-print"></i> ÿ∑ÿ®ÿßÿπÿ©
                    </button>
                </div>
                
                <!-- ÿπÿ±ÿ∂ ÿßŸÑÿ•ÿπŸÑÿßŸÜÿßÿ™ -->
                <div id="eventsList" class="events-grid">
                    <!-- ÿ≥Ÿäÿ™ŸÖ ÿ™ÿπÿ®ÿ¶ÿ© ÿßŸÑÿ•ÿπŸÑÿßŸÜÿßÿ™ ŸáŸÜÿß -->
                </div>
                
                <!-- ÿ±ÿ≥ÿßŸÑÿ© ŸÅÿßÿ±ÿ∫ÿ© -->
                <div id="noEventsMessage" class="empty-message" style="display: none;">
                    <i class="fas fa-calendar-times"></i>
                    <h3>ŸÑÿß ÿ™Ÿàÿ¨ÿØ ÿ•ÿπŸÑÿßŸÜÿßÿ™ ÿ≠ÿßŸÑŸäÿßŸã</h3>
                    <p>ŸäŸÖŸÉŸÜŸÉ ÿ•ÿ∂ÿßŸÅÿ© ÿ•ÿπŸÑÿßŸÜÿßÿ™ ÿ¨ÿØŸäÿØÿ© ÿ®ÿßÿ≥ÿ™ÿÆÿØÿßŸÖ ÿ≤ÿ± "ÿ•ÿ∂ÿßŸÅÿ© ÿ•ÿπŸÑÿßŸÜ ÿ¨ÿØŸäÿØ"</p>
                </div>
            </div>
        </div>
    </div>

    <div class="form-modal" id="permissionsModal">
        <button class="quick-back-btn" onclick="closePermissionsModal()" title="ÿ•ÿ∫ŸÑÿßŸÇ">
            <i class="fas fa-times"></i>
        </button>
        <div class="form-container" style="max-width: 700px;">
            <div class="form-header">
                <h3><i class="fas fa-user-shield"></i> <span data-i18n="permissions">ÿ•ÿØÿßÿ±ÿ© ÿßŸÑÿµŸÑÿßÿ≠Ÿäÿßÿ™</span></h3>
                <button class="close-form" onclick="closePermissionsModal()">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            
            <div class="form-body">
                <div class="alert info">
                    <i class="fas fa-info-circle"></i>
                    <div>
                        <strong data-i18n="permissionsSystem">ŸÜÿ∏ÿßŸÖ ÿßŸÑÿµŸÑÿßÿ≠Ÿäÿßÿ™</strong>
                        <p data-i18n="permissionsInfo">ÿßŸÑŸÖÿØŸäÿ±: ÿ¨ŸÖŸäÿπ ÿßŸÑÿµŸÑÿßÿ≠Ÿäÿßÿ™ | ÿßŸÑŸÖÿ≥ÿ™ÿÆÿØŸÖ: ÿßŸÑÿπÿ±ÿ∂ ŸàÿßŸÑÿ•ÿ∂ÿßŸÅÿ© ŸÅŸÇÿ∑</p>
                    </div>
                </div>
                
                <div class="form-group">
                    <label class="form-label" data-i18n="addNewUser">ÿ•ÿ∂ÿßŸÅÿ© ŸÖÿ≥ÿ™ÿÆÿØŸÖ ÿ¨ÿØŸäÿØ</label>
                    <div class="form-grid">
                        <div class="form-group">
                            <input type="text" class="form-input" id="newUsername" data-i18n-placeholder="usernamePlaceholder" placeholder="ÿßÿ≥ŸÖ ÿßŸÑŸÖÿ≥ÿ™ÿÆÿØŸÖ">
                        </div>
                        <div class="form-group">
                            <input type="password" class="form-input" id="newPassword" data-i18n-placeholder="passwordPlaceholder" placeholder="ŸÉŸÑŸÖÿ© ÿßŸÑŸÖÿ±Ÿàÿ±">
                        </div>
                        <div class="form-group">
                            <select class="form-select" id="newUserRole">
                                <option value="user" data-i18n="user">ŸÖÿ≥ÿ™ÿÆÿØŸÖ</option>
                                <option value="admin" data-i18n="admin">ŸÖÿØŸäÿ±</option>
                            </select>
                        </div>
                    </div>
                    <button class="btn btn-success" onclick="addNewUser()">
                        <i class="fas fa-user-plus"></i> <span data-i18n="addUser">ÿ•ÿ∂ÿßŸÅÿ© ŸÖÿ≥ÿ™ÿÆÿØŸÖ</span>
                    </button>
                </div>
                
                <div class="form-group">
                    <label class="form-label" data-i18n="usersList">ŸÇÿßÿ¶ŸÖÿ© ÿßŸÑŸÖÿ≥ÿ™ÿÆÿØŸÖŸäŸÜ</label>
                    <div class="table-responsive">
                        <table class="data-table">
                            <thead>
                                <tr>
                                    <th data-i18n="username">ÿßÿ≥ŸÖ ÿßŸÑŸÖÿ≥ÿ™ÿÆÿØŸÖ</th>
                                    <th data-i18n="role">ÿßŸÑÿµŸÑÿßÿ≠Ÿäÿ©</th>
                                    <th data-i18n="lastLogin">ÿ¢ÿÆÿ± ÿØÿÆŸàŸÑ</th>
                                    <th data-i18n="actions">ÿßŸÑÿ•ÿ¨ÿ±ÿßÿ°ÿßÿ™</th>
                                </tr>
                            </thead>
                            <tbody id="usersList">
                                </tbody>
                        </table>
                    </div>
                </div>
                
                <div class="form-actions">
                    <button type="button" class="btn btn-danger" onclick="closePermissionsModal()">
                        <i class="fas fa-times"></i> <span data-i18n="close">ÿ•ÿ∫ŸÑÿßŸÇ</span>
                    </button>
                </div>
            </div>
        </div>
    </div>

    <div class="form-modal" id="excelImportModal">
        <button class="quick-back-btn" onclick="closeExcelImport()" title="ÿ•ÿ∫ŸÑÿßŸÇ">
            <i class="fas fa-times"></i>
        </button>
        <div class="form-container" style="max-width: 700px;">
            <div class="form-header">
                <h3><i class="fas fa-file-excel"></i> <span data-i18n="excelImport">ÿßÿ≥ÿ™Ÿäÿ±ÿßÿØ ŸÖŸÜ Excel</span></h3>
                <button class="close-form" onclick="closeExcelImport()">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            
            <div class="form-body">
                <div class="alert warning">
                    <i class="fas fa-exclamation-triangle"></i>
                    <div>
                        <strong data-i18n="importInstructions">ÿ™ÿπŸÑŸäŸÖÿßÿ™ ÿßŸÑÿßÿ≥ÿ™Ÿäÿ±ÿßÿØ</strong>
                        <p data-i18n="importInfo">Ÿäÿ¨ÿ® ÿ£ŸÜ Ÿäÿ≠ÿ™ŸàŸä ŸÖŸÑŸÅ Excel ÿπŸÑŸâ ÿßŸÑÿ£ÿπŸÖÿØÿ© ÿßŸÑÿ™ÿßŸÑŸäÿ©: ÿßŸÑÿ±ŸÇŸÖ, ÿßŸÑÿßÿ≥ŸÖ, ÿßŸÑÿ¨ŸÜÿ≥, ÿßŸÑÿ£ÿ®, ÿßŸÑÿ£ŸÖ, ÿßŸÑÿ≤Ÿàÿ¨/ÿßŸÑÿ≤Ÿàÿ¨ÿ©</p>
                        <p data-i18n="downloadTemplate">ŸäŸÖŸÉŸÜŸÉ ÿ™ÿ≠ŸÖŸäŸÑ <a href="#" onclick="downloadExcelTemplate()" style="color: #1b5e20; text-decoration: underline;">ŸÜŸÖŸàÿ∞ÿ¨ Excel ÿ¨ÿßŸáÿ≤</a></p>
                    </div>
                </div>
                
                <div class="form-group">
                    <label class="form-label" data-i18n="selectExcelFile">ÿßÿÆÿ™ÿ± ŸÖŸÑŸÅ Excel</label>
                    <input type="file" id="excelFile" class="form-input" accept=".xlsx,.xls,.csv" onchange="handleExcelFileSelect(event)">
                </div>
                
                <div class="form-group" id="excelPreview" style="display: none;">
                    <label class="form-label" data-i18n="dataPreview">ŸÖÿπÿßŸäŸÜÿ© ÿßŸÑÿ®ŸäÿßŸÜÿßÿ™</label>
                    
                    <div class="import-preview table-responsive">
                        <table class="data-table">
                            <thead id="excelTableHead"></thead>
                            <tbody id="excelTableBody"></tbody>
                        </table>
                    </div>
                    
                    <div class="import-stats" id="importStats" style="display: none;">
                        <p><i class="fas fa-info-circle"></i> <span id="importStatsText"></span></p>
                    </div>
                    
                    <div class="form-actions" style="margin-top: 20px;">
                        <button class="btn btn-success" onclick="importExcelData()">
                            <i class="fas fa-check"></i> <span data-i18n="confirmImport">ÿ™ÿ£ŸÉŸäÿØ ÿßŸÑÿßÿ≥ÿ™Ÿäÿ±ÿßÿØ</span>
                        </button>
                        <button class="btn btn-danger" onclick="clearExcelPreview()">
                            <i class="fas fa-times"></i> <span data-i18n="cancel">ÿ•ŸÑÿ∫ÿßÿ°</span>
                        </button>
                    </div>
                </div>
                
                <div class="form-actions">
                    <button type="button" class="btn btn-danger" onclick="closeExcelImport()">
                        <i class="fas fa-times"></i> <span data-i18n="close">ÿ•ÿ∫ŸÑÿßŸÇ</span>
                    </button>
                </div>
            </div>
        </div>
    </div>

    <div class="form-modal" id="encryptionModal">
        <button class="quick-back-btn" onclick="closeEncryptionModal()" title="ÿ•ÿ∫ŸÑÿßŸÇ">
            <i class="fas fa-times"></i>
        </button>
        <div class="form-container">
            <div class="form-header">
                <h3><i class="fas fa-lock"></i> <span data-i18n="encryption">ÿ•ÿπÿØÿßÿØÿßÿ™ ÿßŸÑÿ™ÿ¥ŸÅŸäÿ±</span></h3>
                <button class="close-form" onclick="closeEncryptionModal()">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            
            <div class="form-body">
                <div class="form-group">
                    <label class="form-label" data-i18n="encryptionStatus">ÿ≠ÿßŸÑÿ© ÿßŸÑÿ™ÿ¥ŸÅŸäÿ± ÿßŸÑÿ≠ÿßŸÑŸäÿ©</label>
                    <div class="alert info" id="encryptionAlert" style="display: flex;">
                        <i class="fas fa-info-circle"></i>
                        <span id="encryptionMessage" data-i18n="loading">ÿ¨ÿßÿ±Ÿä ÿßŸÑÿ™ÿ≠ŸÖŸäŸÑ...</span>
                    </div>
                </div>
                
                <div class="form-group">
                    <label class="form-label" data-i18n="encryptCurrent">ÿ™ÿ¥ŸÅŸäÿ± ÿßŸÑÿ®ŸäÿßŸÜÿßÿ™ ÿßŸÑÿ≠ÿßŸÑŸäÿ©</label>
                    <div class="form-grid">
                        <div class="form-group">
                            <label class="form-label required" data-i18n="encryptPassword">ŸÉŸÑŸÖÿ© ÿßŸÑŸÖÿ±Ÿàÿ± ŸÑŸÑÿ™ÿ¥ŸÅŸäÿ±</label>
                            <input type="password" class="form-input" id="encryptPassword" data-i18n-placeholder="encryptPasswordPlaceholder" placeholder="ÿ£ÿØÿÆŸÑ ŸÉŸÑŸÖÿ© ŸÖÿ±Ÿàÿ± ŸÇŸàŸäÿ©">
                        </div>
                        <div class="form-group">
                            <label class="form-label required" data-i18n="confirmPassword">ÿ™ÿ£ŸÉŸäÿØ ŸÉŸÑŸÖÿ© ÿßŸÑŸÖÿ±Ÿàÿ±</label>
                            <input type="password" class="form-input" id="encryptConfirmPassword" data-i18n-placeholder="confirmPasswordPlaceholder" placeholder="ÿ£ÿπÿØ ÿ•ÿØÿÆÿßŸÑ ŸÉŸÑŸÖÿ© ÿßŸÑŸÖÿ±Ÿàÿ±">
                        </div>
                    </div>
                    <div class="encryption-actions">
                        <button class="btn btn-success" onclick="encryptCurrentData()">
                            <i class="fas fa-lock"></i> <span data-i18n="encryptData">ÿ™ÿ¥ŸÅŸäÿ± ÿßŸÑÿ®ŸäÿßŸÜÿßÿ™</span>
                        </button>
                        <button class="btn btn-warning" onclick="decryptCurrentData()">
                            <i class="fas fa-unlock"></i> <span data-i18n="decryptData">ŸÅŸÉ ÿ™ÿ¥ŸÅŸäÿ± ÿßŸÑÿ®ŸäÿßŸÜÿßÿ™</span>
                        </button>
                        <button class="btn btn-danger" onclick="removeEncryption()">
                            <i class="fas fa-trash"></i> <span data-i18n="removeEncryption">ÿ•ÿ≤ÿßŸÑÿ© ÿßŸÑÿ™ÿ¥ŸÅŸäÿ±</span>
                        </button>
                    </div>
                </div>
                
                <div class="form-group">
                    <label class="form-label" data-i18n="securityTips">ŸÜÿµÿßÿ¶ÿ≠ ÿßŸÑÿ£ŸÖÿßŸÜ</label>
                    <div class="alert warning">
                        <i class="fas fa-shield-alt"></i>
                        <div>
                            <p><strong data-i18n="importantTips">ŸÜÿµÿßÿ¶ÿ≠ ŸÖŸáŸÖÿ©:</strong></p>
                            <ol style="margin-right: 20px; margin-top: 10px;">
                                <li data-i18n="tip1">ÿßÿ≠ŸÅÿ∏ ŸÉŸÑŸÖÿ© ÿßŸÑŸÖÿ±Ÿàÿ± ŸÅŸä ŸÖŸÉÿßŸÜ ÿ¢ŸÖŸÜ</li>
                                <li data-i18n="tip2">ŸÑÿß ÿ™ÿ≥ÿ™ÿÆÿØŸÖ ŸÉŸÑŸÖÿßÿ™ ŸÖÿ±Ÿàÿ± ÿ®ÿ≥Ÿäÿ∑ÿ© (ÿßÿ≥ÿ™ÿÆÿØŸÖ 6 ÿ£ÿ≠ÿ±ŸÅ ÿπŸÑŸâ ÿßŸÑÿ£ŸÇŸÑ)</li>
                                <li data-i18n="tip3">ŸÇŸÖ ÿ®ÿπŸÖŸÑ ŸÜÿ≥ÿÆÿ© ÿßÿ≠ÿ™Ÿäÿßÿ∑Ÿäÿ© ŸÇÿ®ŸÑ ÿßŸÑÿ™ÿ¥ŸÅŸäÿ±</li>
                                <li data-i18n="tip4">ŸÑÿß ŸäŸÖŸÉŸÜ ÿßÿ≥ÿ™ÿπÿßÿØÿ© ÿßŸÑÿ®ŸäÿßŸÜÿßÿ™ ÿ•ÿ∞ÿß ŸÜÿ≥Ÿäÿ™ ŸÉŸÑŸÖÿ© ÿßŸÑŸÖÿ±Ÿàÿ±</li>
                            </ol>
                        </div>
                    </div>
                </div>
                
                <div class="form-actions">
                    <button type="button" class="btn btn-danger" onclick="closeEncryptionModal()">
                        <i class="fas fa-times"></i> <span data-i18n="close">ÿ•ÿ∫ŸÑÿßŸÇ</span>
                    </button>
                </div>
            </div>
        </div>
    </div>

    <div class="form-modal" id="cloudManagerModal">
        <button class="quick-back-btn" onclick="closeCloudManager()" title="ÿ•ÿ∫ŸÑÿßŸÇ">
            <i class="fas fa-times"></i>
        </button>
        <div class="form-container" style="max-width: 800px;">
            <div class="form-header">
                <h3><i class="fas fa-cloud"></i> <span>ÿ•ÿØÿßÿ±ÿ© ÿ™ÿÆÿ≤ŸäŸÜ ÿßŸÑÿ≥ÿ≠ÿßÿ®ÿ©</span></h3>
                <button class="close-form" onclick="closeCloudManager()">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            
            <div class="form-body">
                <div class="alert info">
                    <i class="fas fa-info-circle"></i>
                    <div>
                        <strong>ŸÜÿ∏ÿßŸÖ ÿßŸÑÿ™ÿÆÿ≤ŸäŸÜ ÿßŸÑÿ≥ÿ≠ÿßÿ®Ÿä</strong>
                        <p>Ÿäÿ™ŸÖ ÿ™ÿÆÿ≤ŸäŸÜ ÿ®ŸäÿßŸÜÿßÿ™ ÿ¥ÿ¨ÿ±ÿ© ÿßŸÑÿπÿßÿ¶ŸÑÿ© ÿπŸÑŸâ ÿÆŸàÿßÿØŸÖ Google Firebase ÿ®ÿ≠Ÿäÿ´ ÿ™ŸÉŸàŸÜ ŸÖÿ™ÿßÿ≠ÿ© ŸÑŸÑÿ¨ŸÖŸäÿπ.</p>
                        <p>ÿßŸÑÿ™ÿ≠ÿØŸäÿ´ÿßÿ™ ÿ™ÿ∏Ÿáÿ± ŸÅŸàÿ±ŸäÿßŸã ŸÑÿ¨ŸÖŸäÿπ ÿßŸÑŸÖÿ≥ÿ™ÿÆÿØŸÖŸäŸÜ ÿßŸÑŸÖÿ™ÿµŸÑŸäŸÜ.</p>
                    </div>
                </div>
                
                <div class="form-grid">
                    <div class="form-group">
                        <label class="form-label">ÿ≠ÿßŸÑÿ© ÿßŸÑÿßÿ™ÿµÿßŸÑ ÿ®ÿßŸÑÿ≥ÿ≠ÿßÿ®ÿ©</label>
                        <div class="status-card">
                            <div class="status-item">
                                <span>ÿ≠ÿßŸÑÿ© ÿßŸÑÿ≥ÿ≠ÿßÿ®ÿ©:</span>
                                <span id="cloudStatus" class="status-badge success">‚úì ŸÜÿ¥ÿ∑ÿ©</span>
                            </div>
                            <div class="status-item">
                                <span>ÿ¢ÿÆÿ± ŸÖÿ≤ÿßŸÖŸÜÿ©:</span>
                                <span id="lastSyncTime">-</span>
                            </div>
                            <div class="status-item">
                                <span>ÿ®ŸäÿßŸÜÿßÿ™ ŸÅŸä ŸÇÿßÿ¶ŸÖÿ© ÿßŸÑÿßŸÜÿ™ÿ∏ÿßÿ±:</span>
                                <span id="pendingSync" class="status-badge">0</span>
                            </div>
                            <div class="status-item">
                                <span>ÿ≠ÿßŸÑÿ© ÿßŸÑÿ•ŸÜÿ™ÿ±ŸÜÿ™:</span>
                                <span id="internetStatus" class="status-badge success">‚úì ŸÖÿ™ÿµŸÑ</span>
                            </div>
                            <div id="eventsStats">
                                <!-- ÿ≥Ÿäÿ™ŸÖ ÿ™ÿπÿ®ÿ¶ÿ© ÿ•ÿ≠ÿµÿßÿ¶Ÿäÿßÿ™ ÿßŸÑÿ•ÿπŸÑÿßŸÜÿßÿ™ ŸáŸÜÿß -->
                            </div>
                        </div>
                    </div>
                    
                    <div class="form-group">
                        <label class="form-label">ÿßŸÑŸÜÿ≥ÿÆ ÿßŸÑÿßÿ≠ÿ™Ÿäÿßÿ∑Ÿäÿ©</label>
                        <div class="backup-list" id="backupList">
                            </div>
                        <button class="btn btn-primary" onclick="loadBackupList()">
                            <i class="fas fa-sync"></i> ÿ™ÿ≠ÿØŸäÿ´ ÿßŸÑŸÇÿßÿ¶ŸÖÿ©
                        </button>
                    </div>
                </div>
                
                <div class="form-actions">
                    <button class="btn btn-success" onclick="forceSync()">
                        <i class="fas fa-sync"></i> ŸÖÿ≤ÿßŸÖŸÜÿ© ŸäÿØŸàŸäÿ©
                    </button>
                    <button class="btn btn-warning" onclick="forceEventsSync()">
                        <i class="fas fa-sync"></i> ŸÖÿ≤ÿßŸÖŸÜÿ© ÿßŸÑÿ•ÿπŸÑÿßŸÜÿßÿ™
                    </button>
                    <button class="btn btn-warning" onclick="clearSyncQueue()">
                        <i class="fas fa-trash"></i> ŸÖÿ≥ÿ≠ ŸÇÿßÿ¶ŸÖÿ© ÿßŸÑÿßŸÜÿ™ÿ∏ÿßÿ±
                    </button>
                    <button class="btn btn-info" onclick="showCloudStatistics()">
                        <i class="fas fa-chart-bar"></i> ÿ•ÿ≠ÿµÿßÿ¶Ÿäÿßÿ™ ÿßŸÑÿ≥ÿ≠ÿßÿ®ÿ©
                    </button>
                    <button class="btn btn-danger" onclick="closeCloudManager()" style="margin-right: auto;">
                        <i class="fas fa-times"></i> ÿ•ÿ∫ŸÑÿßŸÇ
                    </button>
                </div>
            </div>
        </div>
    </div>

    <div class="export-loading" id="exportLoading">
        <i class="fas fa-spinner"></i>
        <div id="exportLoadingText" data-i18n="preparingImage">ÿ¨ÿßÿ±Ÿä ÿ™ÿ≠ÿ∂Ÿäÿ± ÿßŸÑÿµŸàÿ±ÿ©...</div>
        <div style="font-size: 0.9rem; color: #ccc;" data-i18n="exportWait">ŸÇÿØ ÿ™ÿ≥ÿ™ÿ∫ÿ±ŸÇ ÿßŸÑÿπŸÖŸÑŸäÿ© ÿ®ÿ∂ÿπ ÿ´ŸàÿßŸÜŸç</div>
    </div>

    <script>
        // ============================================
        // ÿ™ÿπÿ±ŸäŸÅ ÿßŸÑŸÖÿ™ÿ∫Ÿäÿ±ÿßÿ™ ÿßŸÑÿπÿßŸÖÿ©
        // ============================================
        
        let familyData = [];
        let currentUser = null;
        let nextPersonId = 1;
        let treeZoom = 100;
        let treeCompactMode = false;
        let currentTreeSearch = '';
        let currentSortOrder = 'asc';
        let isDataEncrypted = false;
        let encryptionPassword = '';
        let mobileOptimized = false;
        let searchBarVisible = true;
        let lastScrollTop = 0;
        let currentDetailPersonId = null;
        let excelData = [];
        let currentLanguage = 'ar';
        let searchMatchCount = 0;

        // ŸÖÿ™ÿ∫Ÿäÿ±ÿßÿ™ ÿßŸÑÿ≥ÿ≠ÿßÿ®ÿ©
        let firebaseApp;
        let database;
        let cloudSyncEnabled = false;
        let isOffline = false;
        let lastSyncTime = null;
        let syncQueue = [];

        // ŸÖÿ™ÿ∫Ÿäÿ±ÿßÿ™ ŸÇÿ≥ŸÖ ÿßŸÑŸÖŸÜÿßÿ≥ÿ®ÿßÿ™
        let familyEvents = [];
        let eventsSyncQueue = [];
        let eventsEditing = false;
        let currentEventsFilter = 'all';

        // ÿ™ŸÉŸàŸäŸÜ Firebase
        const firebaseConfig = {
          apiKey: "AIzaSyB5kAQNtC6xP4zaS4Whjoy7ZG7bQTQ68iU",
          authDomain: "familytree-2da8b.firebaseapp.com",
          databaseURL: "https://familytree-2da8b-default-rtdb.firebaseio.com",
          projectId: "familytree-2da8b",
          storageBucket: "familytree-2da8b.firebasestorage.app",
          messagingSenderId: "810651112343",
          appId: "1:810651112343:web:268b54f5505f66885daad2",
          measurementId: "G-0BT7ET24BK"
        };
        
        // ÿ®ŸäÿßŸÜÿßÿ™ ÿßŸÑÿ™ÿ±ÿ¨ŸÖÿ©
        const translations = {
            ar: {
                loginTitle: "ŸÜÿ∏ÿßŸÖ ÿ•ÿØÿßÿ±ÿ© ÿ¥ÿ¨ÿ±ÿ© ÿßŸÑÿπÿßÿ¶ŸÑÿ©",
                loginSubtitle: "ÿßŸÑÿ±ÿ¨ÿßÿ° ÿ™ÿ≥ÿ¨ŸäŸÑ ÿßŸÑÿØÿÆŸàŸÑ ŸÑÿ•ÿØÿßÿ±ÿ© ÿ®ŸäÿßŸÜÿßÿ™ ÿßŸÑÿπÿßÿ¶ŸÑÿ©",
                usernamePlaceholder: "ÿßÿ≥ŸÖ ÿßŸÑŸÖÿ≥ÿ™ÿÆÿØŸÖ",
                passwordPlaceholder: "ŸÉŸÑŸÖÿ© ÿßŸÑŸÖÿ±Ÿàÿ±",
                loginError: "ÿßÿ≥ŸÖ ÿßŸÑŸÖÿ≥ÿ™ÿÆÿØŸÖ ÿ£Ÿà ŸÉŸÑŸÖÿ© ÿßŸÑŸÖÿ±Ÿàÿ± ÿ∫Ÿäÿ± ÿµÿ≠Ÿäÿ≠ÿ©",
                loginButton: "ÿØÿÆŸàŸÑ",
                familyTitle: "ÿ¥ÿ¨ÿ±ÿ© ÿπÿßÿ¶ŸÑÿ© ŸÖÿ≠ŸÖÿØ ÿπÿ®ÿØÿßŸÑÿ±ÿ≠ŸÖŸÜ ( ÿ£ÿ®ÿß )",
                developerInfo: "ÿßÿπÿØÿßÿØ Ÿàÿ™ŸÜŸÅŸäÿ∞: | ŸÖÿ≠ŸÖÿØ ÿπŸÖÿ± ŸÖÿ≠ŸÖÿØ",
                
                appTitle: "ÿ¥ÿ¨ÿ±ÿ© ÿπÿßÿ¶ŸÑÿ© ŸÖÿ≠ŸÖÿØ ÿπÿ®ÿØÿßŸÑÿ±ÿ≠ŸÖŸÜ",
                welcome: "ŸÖÿ±ÿ≠ÿ®ÿßŸãÿå",
                logout: "ÿ™ÿ≥ÿ¨ŸäŸÑ ÿßŸÑÿÆÿ±Ÿàÿ¨",
                dashboard: "ÿßŸÑÿ±ÿ¶Ÿäÿ≥Ÿäÿ©",
                allPersons: "ÿ¨ŸÖŸäÿπ ÿßŸÑÿ£ŸÅÿ±ÿßÿØ",
                addPerson: "ÿ•ÿ∂ÿßŸÅÿ© ŸÅÿ±ÿØ ÿ¨ÿØŸäÿØ",
                searchEdit: "ÿ®ÿ≠ÿ´ Ÿàÿ™ÿπÿØŸäŸÑ",
                statistics: "ÿßŸÑÿ•ÿ≠ÿµÿßÿ¶Ÿäÿßÿ™",
                treeView: "ÿπÿ±ÿ∂ ÿßŸÑÿ¥ÿ¨ÿ±ÿ©",
                backup: "ÿßŸÑŸÜÿ≥ÿÆ ÿßŸÑÿßÿ≠ÿ™Ÿäÿßÿ∑Ÿä",
                familyBook: "ŸÉÿ™ÿßÿ® ÿßŸÑÿπÿßÿ¶ŸÑÿ©",
                excelImport: "ÿßÿ≥ÿ™Ÿäÿ±ÿßÿØ Excel",
                permissions: "ÿ•ÿØÿßÿ±ÿ© ÿßŸÑÿµŸÑÿßÿ≠Ÿäÿßÿ™",
                encryption: "ÿ•ÿπÿØÿßÿØÿßÿ™ ÿßŸÑÿ™ÿ¥ŸÅŸäÿ±",
                familyEvents: "ÿßŸÑŸÖŸÜÿßÿ≥ÿ®ÿßÿ™ ŸàÿßŸÑÿ•ÿπŸÑÿßŸÜÿßÿ™",
                
                totalPersons: "ÿ•ÿ¨ŸÖÿßŸÑŸä ÿßŸÑÿ£ŸÅÿ±ÿßÿØ",
                maleCount: "ÿπÿØÿØ ÿßŸÑÿ∞ŸÉŸàÿ±",
                femaleCount: "ÿπÿØÿØ ÿßŸÑÿ•ŸÜÿßÿ´",
                familiesCount: "ÿπÿØÿØ ÿßŸÑÿπÿßÿ¶ŸÑÿßÿ™",
                
                familyManagement: "ÿ•ÿØÿßÿ±ÿ© ÿ£ŸÅÿ±ÿßÿØ ÿßŸÑÿπÿßÿ¶ŸÑÿ©",
                addNewPerson: "ÿ•ÿ∂ÿßŸÅÿ© ŸÅÿ±ÿØ ÿ¨ÿØŸäÿØ",
                refreshData: "ÿ™ÿ≠ÿØŸäÿ´ ÿßŸÑÿ®ŸäÿßŸÜÿßÿ™",
                exportData: "ÿ™ÿµÿØŸäÿ± ÿßŸÑÿ®ŸäÿßŸÜÿßÿ™",
                exportJson: "JSON",
                exportExcel: "Excel",
                exportCSV: "CSV",
                toggleSort: "ÿ™ÿ±ÿ™Ÿäÿ® ÿ™ÿµÿßÿπÿØŸä / ÿ™ŸÜÿßÿ≤ŸÑŸä",
                importData: "ÿßÿ≥ÿ™Ÿäÿ±ÿßÿØ ÿßŸÑÿ®ŸäÿßŸÜÿßÿ™",
                successMessage: "ÿ™ŸÖÿ™ ÿßŸÑÿπŸÖŸÑŸäÿ© ÿ®ŸÜÿ¨ÿßÿ≠",
                errorMessage: "ÿ≠ÿØÿ´ ÿÆÿ∑ÿ£ ÿ£ÿ´ŸÜÿßÿ° ÿßŸÑÿπŸÖŸÑŸäÿ©",
                
                tableId: "ÿßŸÑÿ±ŸÇŸÖ",
                tableName: "ÿßŸÑÿßÿ≥ŸÖ ÿßŸÑŸÉÿßŸÖŸÑ",
                tableGender: "ÿßŸÑÿ¨ŸÜÿ≥",
                tableBirthPlace: "ŸÖŸÉÿßŸÜ ÿßŸÑŸÖŸäŸÑÿßÿØ",
                tableFather: "ÿßŸÑÿ£ÿ®",
                tableMother: "ÿßŸÑÿ£ŸÖ",
                tableActions: "ÿßŸÑÿ•ÿ¨ÿ±ÿßÿ°ÿßÿ™",
                
                addPersonForm: "ÿ•ÿ∂ÿßŸÅÿ© ŸÅÿ±ÿØ ÿ¨ÿØŸäÿØ",
                editPersonForm: "ÿ™ÿπÿØŸäŸÑ ÿ®ŸäÿßŸÜÿßÿ™ ÿßŸÑŸÅÿ±ÿØ",
                formFullName: "ÿßŸÑÿßÿ≥ŸÖ ÿßŸÑŸÉÿßŸÖŸÑ",
                formGender: "ÿßŸÑÿ¨ŸÜÿ≥",
                formSelectGender: "ÿßÿÆÿ™ÿ± ÿßŸÑÿ¨ŸÜÿ≥",
                male: "ÿ∞ŸÉÿ±",
                female: "ÿ£ŸÜÿ´Ÿâ",
                formBirthPlace: "ŸÖŸÉÿßŸÜ ÿßŸÑŸÖŸäŸÑÿßÿØ",
                formBirthDate: "ÿ™ÿßÿ±ŸäÿÆ ÿßŸÑŸÖŸäŸÑÿßÿØ",
                formDeathDate: "ÿ™ÿßÿ±ŸäÿÆ ÿßŸÑŸàŸÅÿßÿ© (ÿ•ŸÜ Ÿàÿ¨ÿØ)",
                formFatherId: "ÿ±ŸÇŸÖ ÿßŸÑÿ£ÿ®",
                formNoFather: "ŸÑÿß ŸäŸàÿ¨ÿØ (ÿ¨ÿ∞ÿ± ÿßŸÑÿπÿßÿ¶ŸÑÿ©)",
                formMotherId: "ÿ±ŸÇŸÖ ÿßŸÑÿ£ŸÖ",
                formNoMother: "ŸÑÿß ŸäŸàÿ¨ÿØ",
                formSpouseId: "ÿ±ŸÇŸÖ ÿßŸÑÿ≤Ÿàÿ¨/ÿßŸÑÿ≤Ÿàÿ¨ÿ©",
                formNoSpouse: "ŸÑÿß ŸäŸàÿ¨ÿØ",
                formNotes: "ŸÖŸÑÿßÿ≠ÿ∏ÿßÿ™ ÿ•ÿ∂ÿßŸÅŸäÿ©",
                cancel: "ÿ•ŸÑÿ∫ÿßÿ°",
                save: "ÿ≠ŸÅÿ∏ ÿßŸÑÿ®ŸäÿßŸÜÿßÿ™",
                
                fullFamilyTree: "ÿ¥ÿ¨ÿ±ÿ© ÿßŸÑÿπÿßÿ¶ŸÑÿ© ÿßŸÑŸÉÿßŸÖŸÑÿ©",
                toggleView: "ÿ™ÿ®ÿØŸäŸÑ ÿßŸÑÿπÿ±ÿ∂",
                exportImage: "ÿ™ÿµÿØŸäÿ± ÿµŸàÿ±ÿ©",
                exportNormal: "ÿµŸàÿ±ÿ© ÿπÿßÿØŸäÿ©",
                exportHigh: "ÿµŸàÿ±ÿ© ÿπÿßŸÑŸäÿ© ÿßŸÑÿ¨ŸàÿØÿ©",
                exportVisible: "ÿßŸÑÿ¨ÿ≤ÿ° ÿßŸÑŸÖÿ±ÿ¶Ÿä ŸÅŸÇÿ∑",
                exportPDF: "PDF (ÿ™ÿ¨ÿ±Ÿäÿ®Ÿä)",
                mobileMode: "Ÿàÿ∂ÿπ ÿßŸÑŸÖŸàÿ®ÿßŸäŸÑ",
                persons: "ŸÅÿ±ÿØ",
                close: "ÿ•ÿ∫ŸÑÿßŸÇ",
                treeSearchPlaceholder: "ÿßÿ®ÿ≠ÿ´ ÿπŸÜ ŸÅÿ±ÿØ ŸÅŸä ÿßŸÑÿ¥ÿ¨ÿ±ÿ©...",
                clearSearch: "ŸÖÿ≥ÿ≠ ÿßŸÑÿ®ÿ≠ÿ´",
                firstGeneration: "ÿßŸÑÿ¨ŸäŸÑ ÿßŸÑÿ£ŸàŸÑ",
                treeInfo: "ÿßŸÜŸÇÿ± ÿπŸÑŸâ ÿ£Ÿä ŸÅÿ±ÿØ ŸÑÿπÿ±ÿ∂ ŸÖÿπŸÑŸàŸÖÿßÿ™Ÿá",
                
                personInfo: "ŸÖÿπŸÑŸàŸÖÿßÿ™ ÿßŸÑŸÅÿ±ÿØ",
                print: "ÿ∑ÿ®ÿßÿπÿ©",
                edit: "ÿ™ÿπÿØŸäŸÑ",
                
                generateBook: "ÿ™ŸàŸÑŸäÿØ ŸÉÿ™ÿßÿ® ÿ¨ÿØŸäÿØ",
                
                permissionsSystem: "ŸÜÿ∏ÿßŸÖ ÿßŸÑÿµŸÑÿßÿ≠Ÿäÿßÿ™",
                permissionsInfo: "ÿßŸÑŸÖÿØŸäÿ±: ÿ¨ŸÖŸäÿπ ÿßŸÑÿµŸÑÿßÿ≠Ÿäÿßÿ™ | ÿßŸÑŸÖÿ≥ÿ™ÿÆÿØŸÖ: ÿßŸÑÿπÿ±ÿ∂ ŸàÿßŸÑÿ•ÿ∂ÿßŸÅÿ© ŸÅŸÇÿ∑",
                addNewUser: "ÿ•ÿ∂ÿßŸÅÿ© ŸÖÿ≥ÿ™ÿÆÿØŸÖ ÿ¨ÿØŸäÿØ",
                user: "ŸÖÿ≥ÿ™ÿÆÿØŸÖ",
                admin: "ŸÖÿØŸäÿ±",
                addUser: "ÿ•ÿ∂ÿßŸÅÿ© ŸÖÿ≥ÿ™ÿÆÿØŸÖ",
                usersList: "ŸÇÿßÿ¶ŸÖÿ© ÿßŸÑŸÖÿ≥ÿ™ÿÆÿØŸÖŸäŸÜ",
                username: "ÿßÿ≥ŸÖ ÿßŸÑŸÖÿ≥ÿ™ÿÆÿØŸÖ",
                role: "ÿßŸÑÿµŸÑÿßÿ≠Ÿäÿ©",
                lastLogin: "ÿ¢ÿÆÿ± ÿØÿÆŸàŸÑ",
                actions: "ÿßŸÑÿ•ÿ¨ÿ±ÿßÿ°ÿßÿ™",
                
                importInstructions: "ÿ™ÿπŸÑŸäŸÖÿßÿ™ ÿßŸÑÿßÿ≥ÿ™Ÿäÿ±ÿßÿØ",
                importInfo: "Ÿäÿ¨ÿ® ÿ£ŸÜ Ÿäÿ≠ÿ™ŸàŸä ŸÖŸÑŸÅ Excel ÿπŸÑŸâ ÿßŸÑÿ£ÿπŸÖÿØÿ© ÿßŸÑÿ™ÿßŸÑŸäÿ©: ÿßŸÑÿ±ŸÇŸÖ, ÿßŸÑÿßÿ≥ŸÖ, ÿßŸÑÿ¨ŸÜÿ≥, ÿßŸÑÿ£ÿ®, ÿßŸÑÿ£ŸÖ, ÿßŸÑÿ≤Ÿàÿ¨/ÿßŸÑÿ≤Ÿàÿ¨ÿ©",
                downloadTemplate: "ŸäŸÖŸÉŸÜŸÉ ÿ™ÿ≠ŸÖŸäŸÑ ŸÜŸÖŸàÿ∞ÿ¨ Excel ÿ¨ÿßŸáÿ≤",
                selectExcelFile: "ÿßÿÆÿ™ÿ± ŸÖŸÑŸÅ Excel",
                dataPreview: "ŸÖÿπÿßŸäŸÜÿ© ÿßŸÑÿ®ŸäÿßŸÜÿßÿ™",
                confirmImport: "ÿ™ÿ£ŸÉŸäÿØ ÿßŸÑÿßÿ≥ÿ™Ÿäÿ±ÿßÿØ",
                
                encryptionStatus: "ÿ≠ÿßŸÑÿ© ÿßŸÑÿ™ÿ¥ŸÅŸäÿ± ÿßŸÑÿ≠ÿßŸÑŸäÿ©",
                loading: "ÿ¨ÿßÿ±Ÿä ÿßŸÑÿ™ÿ≠ŸÖŸäŸÑ...",
                encryptCurrent: "ÿ™ÿ¥ŸÅŸäÿ± ÿßŸÑÿ®ŸäÿßŸÜÿßÿ™ ÿßŸÑÿ≠ÿßŸÑŸäÿ©",
                encryptPassword: "ŸÉŸÑŸÖÿ© ÿßŸÑŸÖÿ±Ÿàÿ± ŸÑŸÑÿ™ÿ¥ŸÅŸäÿ±",
                encryptPasswordPlaceholder: "ÿ£ÿØÿÆŸÑ ŸÉŸÑŸÖÿ© ŸÖÿ±Ÿàÿ± ŸÇŸàŸäÿ©",
                confirmPassword: "ÿ™ÿ£ŸÉŸäÿØ ŸÉŸÑŸÖÿ© ÿßŸÑŸÖÿ±Ÿàÿ±",
                confirmPasswordPlaceholder: "ÿ£ÿπÿØ ÿ•ÿØÿÆÿßŸÑ ŸÉŸÑŸÖÿ© ÿßŸÑŸÖÿ±Ÿàÿ±",
                encryptData: "ÿ™ÿ¥ŸÅŸäÿ± ÿßŸÑÿ®ŸäÿßŸÜÿßÿ™",
                decryptData: "ŸÅŸÉ ÿ™ÿ¥ŸÅŸäÿ± ÿßŸÑÿ®ŸäÿßŸÜÿßÿ™",
                removeEncryption: "ÿ•ÿ≤ÿßŸÑÿ© ÿßŸÑÿ™ÿ¥ŸÅŸäÿ±",
                securityTips: "ŸÜÿµÿßÿ¶ÿ≠ ÿßŸÑÿ£ŸÖÿßŸÜ",
                importantTips: "ŸÜÿµÿßÿ¶ÿ≠ ŸÖŸáŸÖÿ©:",
                tip1: "ÿßÿ≠ŸÅÿ∏ ŸÉŸÑŸÖÿ© ÿßŸÑŸÖÿ±Ÿàÿ± ŸÅŸä ŸÖŸÉÿßŸÜ ÿ¢ŸÖŸÜ",
                tip2: "ŸÑÿß ÿ™ÿ≥ÿ™ÿÆÿØŸÖ ŸÉŸÑŸÖÿßÿ™ ŸÖÿ±Ÿàÿ± ÿ®ÿ≥Ÿäÿ∑ÿ© (ÿßÿ≥ÿ™ÿÆÿØŸÖ 6 ÿ£ÿ≠ÿ±ŸÅ ÿπŸÑŸâ ÿßŸÑÿ£ŸÇŸÑ)",
                tip3: "ŸÇŸÖ ÿ®ÿπŸÖŸÑ ŸÜÿ≥ÿÆÿ© ÿßÿ≠ÿ™Ÿäÿßÿ∑Ÿäÿ© ŸÇÿ®ŸÑ ÿßŸÑÿ™ÿ¥ŸÅŸäÿ±",
                tip4: "ŸÑÿß ŸäŸÖŸÉŸÜ ÿßÿ≥ÿ™ÿπÿßÿØÿ© ÿßŸÑÿ®ŸäÿßŸÜÿßÿ™ ÿ•ÿ∞ÿß ŸÜÿ≥Ÿäÿ™ ŸÉŸÑŸÖÿ© ÿßŸÑŸÖÿ±Ÿàÿ±",
                
                preparingImage: "ÿ¨ÿßÿ±Ÿä ÿ™ÿ≠ÿ∂Ÿäÿ± ÿßŸÑÿµŸàÿ±ÿ©...",
                exportWait: "ŸÇÿØ ÿ™ÿ≥ÿ™ÿ∫ÿ±ŸÇ ÿßŸÑÿπŸÖŸÑŸäÿ© ÿ®ÿ∂ÿπ ÿ´ŸàÿßŸÜŸç"
            },
            en: {
                loginTitle: "Family Tree Management System",
                loginSubtitle: "Please login to manage family data",
                usernamePlaceholder: "Username",
                passwordPlaceholder: "Password",
                loginError: "Invalid username or password",
                loginButton: "Login",
                familyTitle: "Mohammed Abdulrahman Family Tree (Aba)",
                developerInfo: "Developed by: | Mohammed Omar Mohammed",
                
                appTitle: "Mohammed Abdulrahman Family Tree",
                welcome: "Welcome,",
                logout: "Logout",
                dashboard: "Dashboard",
                allPersons: "All Persons",
                addPerson: "Add New Person",
                searchEdit: "Search & Edit",
                statistics: "Statistics",
                treeView: "Tree View",
                backup: "Backup",
                familyBook: "Family Book",
                excelImport: "Import Excel",
                permissions: "Permissions",
                encryption: "Encryption Settings",
                familyEvents: "Family Events",
                
                totalPersons: "Total Persons",
                maleCount: "Males",
                femaleCount: "Females",
                familiesCount: "Families",
                
                familyManagement: "Family Members Management",
                addNewPerson: "Add New Person",
                refreshData: "Refresh Data",
                exportData: "Export Data",
                exportJson: "JSON",
                exportExcel: "Excel",
                exportCSV: "CSV",
                toggleSort: "Ascending / Descending",
                importData: "Import Data",
                successMessage: "Operation completed successfully",
                errorMessage: "An error occurred",
                
                tableId: "ID",
                tableName: "Full Name",
                tableGender: "Gender",
                tableBirthPlace: "Birth Place",
                tableFather: "Father",
                tableMother: "Mother",
                tableActions: "Actions",
                
                addPersonForm: "Add New Person",
                editPersonForm: "Edit Person",
                formFullName: "Full Name",
                formGender: "Gender",
                formSelectGender: "Select Gender",
                male: "Male",
                female: "Female",
                formBirthPlace: "Birth Place",
                formBirthDate: "Birth Date",
                formDeathDate: "Death Date (if applicable)",
                formFatherId: "Father ID",
                formNoFather: "None (Family Root)",
                formMotherId: "Mother ID",
                formNoMother: "None",
                formSpouseId: "Spouse ID",
                formNoSpouse: "None",
                formNotes: "Additional Notes",
                cancel: "Cancel",
                save: "Save Data",
                
                fullFamilyTree: "Complete Family Tree",
                toggleView: "Toggle View",
                exportImage: "Export Image",
                exportNormal: "Normal Image",
                exportHigh: "High Quality Image",
                exportVisible: "Visible Section Only",
                exportPDF: "PDF (Experimental)",
                mobileMode: "Mobile Mode",
                persons: "Persons",
                close: "Close",
                treeSearchPlaceholder: "Search person in tree...",
                clearSearch: "Clear Search",
                firstGeneration: "First Generation",
                treeInfo: "Click on any person to view details",
                
                personInfo: "Person Information",
                print: "Print",
                edit: "Edit",
                
                generateBook: "Generate New Book",
                
                permissionsSystem: "Permissions System",
                permissionsInfo: "Admin: All permissions | User: View and Add only",
                addNewUser: "Add New User",
                user: "User",
                admin: "Admin",
                addUser: "Add User",
                usersList: "Users List",
                username: "Username",
                role: "Role",
                lastLogin: "Last Login",
                actions: "Actions",
                
                importInstructions: "Import Instructions",
                importInfo: "Excel file must contain the following columns: ID, Name, Gender, Father, Mother, Spouse",
                downloadTemplate: "Download Excel Template",
                selectExcelFile: "Select Excel File",
                dataPreview: "Data Preview",
                confirmImport: "Confirm Import",
                
                encryptionStatus: "Current Encryption Status",
                loading: "Loading...",
                encryptCurrent: "Encrypt Current Data",
                encryptPassword: "Encryption Password",
                encryptPasswordPlaceholder: "Enter strong password",
                confirmPassword: "Confirm Password",
                confirmPasswordPlaceholder: "Re-enter password",
                encryptData: "Encrypt Data",
                decryptData: "Decrypt Data",
                removeEncryption: "Remove Encryption",
                securityTips: "Security Tips",
                importantTips: "Important Tips:",
                tip1: "Save password in a secure place",
                tip2: "Don't use simple passwords (use at least 6 characters)",
                tip3: "Create backup before encryption",
                tip4: "Data cannot be recovered if password is lost",
                
                preparingImage: "Preparing image...",
                exportWait: "Process may take a few seconds"
            }
        };

        // ÿ®ŸäÿßŸÜÿßÿ™ ÿßŸÑŸÖÿ≥ÿ™ÿÆÿØŸÖŸäŸÜ
        const users = {
            'admin': { password: 'mHome155', name: 'ŸÖÿØŸäÿ± ÿßŸÑŸÜÿ∏ÿßŸÖ', role: 'admin' },
            'user': { password: 'a1b2c3', name: 'ŸÖÿ≥ÿ™ÿÆÿØŸÖ', role: 'user' },
            'asma': { password: '112233', name: 'ÿßÿ≥ŸÖÿßÿ°', role: 'asma' },
            'host': { password: '123456', name: 'ŸÖÿ∂ŸäŸÅ', role: 'host' }
        };

        // ÿµŸÑÿßÿ≠Ÿäÿßÿ™ ÿßŸÑŸÖÿ≥ÿ™ÿÆÿØŸÖŸäŸÜ
        const userPermissions = {
            'admin': ['view', 'add', 'edit', 'delete', 'export', 'print', 'import', 'manage_users', 'manage_events'],
            'asma': ['view', 'add', 'edit', 'export', 'print'],
            'user': ['view', 'add', 'export', 'print'],
            'host': ['view', 'print']
        };

        const defaultFamilyData = [
            {
                PersonID: 1,
                FullName: "ŸÖÿ≠ŸÖÿØ ÿπÿ®ÿØÿßŸÑÿ±ÿ≠ŸÖŸÜ ÿßÿØŸÖ",
                Gender: "ÿ∞ŸÉÿ±",
                PlaceOfBirth: "ÿ™ŸÑÿ≥",
                BirthDate: "",
                DeathDate: "",
                FatherID: 0,
                MotherID: 0,
                SpouseID: 0,
                Notes: "ÿßŸÑÿ¨ÿØ"
            },
            {
                PersonID: 2,
                FullName: "ÿπÿßÿ¶ÿ¥ÿ© ÿßÿ®ŸÉÿ± ŸÖÿ≠ŸÖÿØ",
                Gender: "ÿßŸÜÿ´Ÿâ",
                PlaceOfBirth: "ÿ™ŸÑÿ≥",
                BirthDate: "",
                DeathDate: "",
                FatherID: 0,
                MotherID: 0,
                SpouseID: 1,
                Notes: "ÿ≤Ÿàÿ¨ÿ© ÿßŸÑÿ¨ÿØ"
            }
        ];

        const defaultEvents = [
            {
                id: 'EV1',
                type: 'ŸÖŸÜÿßÿ≥ÿ®ÿ©',
                title: 'ÿßÿ¨ÿ™ŸÖÿßÿπ ÿπÿßÿ¶ŸÑŸä ÿ¥Ÿáÿ± ÿ±ŸÖÿ∂ÿßŸÜ',
                date: new Date(new Date().getFullYear(), 3, 15).toISOString().split('T')[0],
                time: '20:00',
                location: 'ŸÖŸÜÿ≤ŸÑ ÿßŸÑÿ¨ÿØ - ŸÜŸäÿßŸÑÿß',
                description: 'ÿßÿ¨ÿ™ŸÖÿßÿπ ÿπÿßÿ¶ŸÑŸä ŸÑÿ™ŸÅŸÇÿØ ÿ£ÿ≠ŸàÿßŸÑ ÿßŸÑÿ£ÿ≥ÿ±ÿ© Ÿàÿ™Ÿàÿ≤Ÿäÿπ ÿßŸÑÿµÿØŸÇÿßÿ™ Ÿàÿ™ŸÜÿ∏ŸäŸÖ ÿ•ŸÅÿ∑ÿßÿ±ÿßÿ™ ÿ±ŸÖÿ∂ÿßŸÜ.',
                organizer: 'ŸÖÿ≠ŸÖÿØ ÿπÿ®ÿØÿßŸÑÿ±ÿ≠ŸÖŸÜ',
                status: 'ŸÜÿ¥ÿ∑',
                createdAt: new Date().toISOString(),
                createdBy: 'admin'
            },
            {
                id: 'EV2',
                type: 'ÿ®ÿ±ŸÜÿßŸÖÿ¨',
                title: 'ÿ®ÿ±ŸÜÿßŸÖÿ¨ ÿ™ÿπŸÑŸäŸÖŸä ŸÑŸÑÿ£ÿ®ŸÜÿßÿ°',
                date: new Date(new Date().getFullYear(), 4, 1).toISOString().split('T')[0],
                time: '17:00',
                location: 'ŸÖŸÉÿ™ÿ®ÿ© ÿßŸÑÿπÿßÿ¶ŸÑÿ©',
                description: 'ÿ®ÿ±ŸÜÿßŸÖÿ¨ ÿ™ÿπŸÑŸäŸÖŸä ŸÖŸÉÿ´ŸÅ ŸÑŸÑÿ£ÿ®ŸÜÿßÿ° Ÿäÿ¥ŸÖŸÑ ÿØÿ±Ÿàÿ≥ ÿ™ŸÇŸàŸäÿ© ŸàÿØŸàÿ±ÿßÿ™ ŸÖŸáÿßÿ±ÿßÿ™ ÿ≠Ÿäÿßÿ™Ÿäÿ©.',
                organizer: 'ŸÑÿ¨ŸÜÿ© ÿßŸÑÿ™ÿπŸÑŸäŸÖ ÿ®ÿßŸÑÿ£ÿ≥ÿ±ÿ©',
                status: 'ŸÜÿ¥ÿ∑',
                createdAt: new Date().toISOString(),
                createdBy: 'admin'
            }
        ];

        // ============================================
        // ÿØŸàÿßŸÑ ÿßŸÑÿ™ÿ±ÿ¨ŸÖÿ©
        // ============================================

        function toggleLanguage() {
            currentLanguage = currentLanguage === 'ar' ? 'en' : 'ar';
            updateLanguage();
        }

        function updateLanguage() {
            const languageText = document.getElementById('languageText');
            const loginLanguageText = document.getElementById('loginLanguageText');
            
            if (languageText) {
                languageText.textContent = currentLanguage === 'ar' ? 'EN' : 'AR';
            }
            
            if (loginLanguageText) {
                loginLanguageText.textContent = currentLanguage === 'ar' ? 'English' : 'ÿßŸÑÿπÿ±ÿ®Ÿäÿ©';
            }
            
            document.documentElement.dir = currentLanguage === 'ar' ? 'rtl' : 'ltr';
            document.documentElement.lang = currentLanguage;
            
            document.querySelectorAll('[data-i18n]').forEach(element => {
                const key = element.getAttribute('data-i18n');
                if (translations[currentLanguage][key]) {
                    element.textContent = translations[currentLanguage][key];
                }
            });
            
            document.querySelectorAll('[data-i18n-placeholder]').forEach(element => {
                const key = element.getAttribute('data-i18n-placeholder');
                if (translations[currentLanguage][key]) {
                    element.placeholder = translations[currentLanguage][key];
                }
            });
            
            if (document.getElementById('formTitle')) {
                const isEdit = document.getElementById('personId').value;
                document.getElementById('formTitle').textContent = translations[currentLanguage][isEdit ? 'editPersonForm' : 'addPersonForm'];
            }
            
            if (document.getElementById('personsTable')) {
                loadPersonsTable();
            }
        }

        // ============================================
        // ÿ™ŸáŸäÿ¶ÿ© Firebase
        // ============================================

        function initializeFirebase() {
            try {
                if (!firebase.apps.length) {
                    firebaseApp = firebase.initializeApp(firebaseConfig);
                } else {
                    firebaseApp = firebase.app();
                }
                
                database = firebase.database();
                enableCloudSync();
                monitorConnection();
                
                console.log('‚úÖ Firebase initialized successfully');
                updateSyncStatus();
                return true;
            } catch (error) {
                console.error('‚ùå Firebase initialization failed:', error);
                showWarning('ÿ™ÿπÿ∞ÿ± ÿßŸÑÿßÿ™ÿµÿßŸÑ ÿ®ÿßŸÑÿ≥ÿ≠ÿßÿ®ÿ©. ÿ≥Ÿäÿ™ŸÖ ÿßÿ≥ÿ™ÿÆÿØÿßŸÖ ÿßŸÑÿ™ÿÆÿ≤ŸäŸÜ ÿßŸÑŸÖÿ≠ŸÑŸä ŸÅŸÇÿ∑.');
                return false;
            }
        }

        // ============================================
        // ÿ™ŸÖŸÉŸäŸÜ ÿßŸÑŸÖÿ≤ÿßŸÖŸÜÿ© ŸÖÿπ ÿßŸÑÿ≥ÿ≠ÿßÿ®ÿ©
        // ============================================

        function enableCloudSync() {
            if (!database) return false;
            
            cloudSyncEnabled = true;
            
            setTimeout(() => {
                loadDataFromCloud();
            }, 1000);
            
            database.ref('familyData').on('value', (snapshot) => {
                if (snapshot.exists()) {
                    const cloudData = snapshot.val();
                    
                    let dataFromCloud;
                    if (Array.isArray(cloudData)) {
                        dataFromCloud = cloudData;
                    } else {
                        dataFromCloud = Object.values(cloudData).filter(item => item && typeof item === 'object');
                        dataFromCloud = dataFromCloud.filter(item => !item._lastUpdated);
                    }
                    
                    const localDataString = localStorage.getItem('familyData');
                    let localData = [];
                    
                    if (localDataString) {
                        try {
                            const parsedData = JSON.parse(localDataString);
                            if (Array.isArray(parsedData)) {
                                localData = parsedData;
                            }
                        } catch (error) {
                            console.error('Error parsing local data:', error);
                        }
                    }
                    
                    const localDataJSON = JSON.stringify(localData.sort((a, b) => a.PersonID - b.PersonID));
                    const cloudDataJSON = JSON.stringify(dataFromCloud.sort((a, b) => a.PersonID - b.PersonID));
                    
                    if (cloudDataJSON !== localDataJSON) {
                        if (confirm('ÿ™ŸÖ ÿ™ÿ≠ÿØŸäÿ´ ÿßŸÑÿ®ŸäÿßŸÜÿßÿ™ ÿπŸÑŸâ ÿßŸÑÿ≥ÿ≠ÿßÿ®ÿ©. ŸáŸÑ ÿ™ÿ±ŸäÿØ ÿ™ÿ≠ŸÖŸäŸÑ ÿßŸÑÿ™ÿ≠ÿØŸäÿ´ÿßÿ™ÿü')) {
                            familyData = dataFromCloud;
                            
                            if (familyData.length > 0) {
                                const maxId = Math.max(...familyData.map(p => p.PersonID));
                                nextPersonId = maxId + 1;
                            } else {
                                nextPersonId = 1;
                            }
                            
                            saveDataLocally();
                            loadDashboard();
                            
                            if (document.getElementById('treeView').classList.contains('active')) {
                                renderTree();
                            }
                            
                            showSuccess('ÿ™ŸÖ ÿ™ÿ≠ÿØŸäÿ´ ÿßŸÑÿ®ŸäÿßŸÜÿßÿ™ ŸÖŸÜ ÿßŸÑÿ≥ÿ≠ÿßÿ®ÿ©');
                        }
                    }
                }
            });
            
            database.ref('familyEvents').on('value', (snapshot) => {
                if (snapshot.exists()) {
                    const cloudEvents = snapshot.val();
                    
                    let eventsFromCloud = [];
                    if (Array.isArray(cloudEvents)) {
                        eventsFromCloud = cloudEvents;
                    } else {
                        eventsFromCloud = Object.values(cloudEvents).filter(item => item && typeof item === 'object');
                    }
                    
                    const localEventsJSON = JSON.stringify(familyEvents.sort((a, b) => new Date(a.date) - new Date(b.date)));
                    const cloudEventsJSON = JSON.stringify(eventsFromCloud.sort((a, b) => new Date(a.date) - new Date(b.date)));
                    
                    if (cloudEventsJSON !== localEventsJSON) {
                        if (confirm('ÿ™ŸÖ ÿ™ÿ≠ÿØŸäÿ´ ÿßŸÑÿ•ÿπŸÑÿßŸÜÿßÿ™ ÿπŸÑŸâ ÿßŸÑÿ≥ÿ≠ÿßÿ®ÿ©. ŸáŸÑ ÿ™ÿ±ŸäÿØ ÿ™ÿ≠ŸÖŸäŸÑ ÿßŸÑÿ™ÿ≠ÿØŸäÿ´ÿßÿ™ÿü')) {
                            familyEvents = eventsFromCloud;
                            saveEventsLocally();
                            
                            if (document.getElementById('familyEventsModal').classList.contains('active')) {
                                loadEvents();
                            }
                            
                            showSuccess('ÿ™ŸÖ ÿ™ÿ≠ÿØŸäÿ´ ÿßŸÑÿ•ÿπŸÑÿßŸÜÿßÿ™ ŸÖŸÜ ÿßŸÑÿ≥ÿ≠ÿßÿ®ÿ©');
                        }
                    }
                }
            });
            
            return true;
        }

        // ============================================
        // ÿ™ÿ≠ŸÖŸäŸÑ ÿßŸÑÿ®ŸäÿßŸÜÿßÿ™ ŸÖŸÜ ÿßŸÑÿ≥ÿ≠ÿßÿ®ÿ©
        // ============================================

        function loadDataFromCloud() {
            if (!database || !cloudSyncEnabled) return;
            
            showExportLoading('ÿ¨ÿßÿ±Ÿä ÿ™ÿ≠ŸÖŸäŸÑ ÿßŸÑÿ®ŸäÿßŸÜÿßÿ™ ŸÖŸÜ ÿßŸÑÿ≥ÿ≠ÿßÿ®ÿ©...');
            
            database.ref('familyData').once('value')
                .then((snapshot) => {
                    if (snapshot.exists()) {
                        const cloudData = snapshot.val();
                        
                        let dataFromCloud;
                        if (Array.isArray(cloudData)) {
                            dataFromCloud = cloudData;
                        } else {
                            dataFromCloud = Object.values(cloudData).filter(item => item && typeof item === 'object');
                            dataFromCloud = dataFromCloud.filter(item => !item._lastUpdated);
                        }
                        
                        const localDataString = localStorage.getItem('familyData');
                        let localData = [];
                        
                        if (localDataString) {
                            try {
                                const parsedData = JSON.parse(localDataString);
                                if (Array.isArray(parsedData)) {
                                    localData = parsedData;
                                }
                            } catch (error) {
                                console.error('Error parsing local data:', error);
                            }
                        }
                        
                        const localDataJSON = JSON.stringify(localData.sort((a, b) => a.PersonID - b.PersonID));
                        const cloudDataJSON = JSON.stringify(dataFromCloud.sort((a, b) => a.PersonID - b.PersonID));
                        
                        if (cloudDataJSON !== localDataJSON) {
                            if (confirm('ÿ™Ÿàÿ¨ÿØ ÿ®ŸäÿßŸÜÿßÿ™ ÿ£ÿ≠ÿØÿ´ ÿπŸÑŸâ ÿßŸÑÿ≥ÿ≠ÿßÿ®ÿ©. ŸáŸÑ ÿ™ÿ±ŸäÿØ ÿ™ÿ≠ŸÖŸäŸÑŸáÿßÿü')) {
                                familyData = dataFromCloud;
                                
                                if (familyData.length > 0) {
                                    const maxId = Math.max(...familyData.map(p => p.PersonID));
                                    nextPersonId = maxId + 1;
                                } else {
                                    nextPersonId = 1;
                                }
                                
                                saveDataLocally();
                                lastSyncTime = new Date();
                                loadDashboard();
                                
                                if (document.getElementById('treeView').classList.contains('active')) {
                                    renderTree();
                                }
                                
                                showSuccess('ÿ™ŸÖ ÿ™ÿ≠ŸÖŸäŸÑ ÿßŸÑÿ®ŸäÿßŸÜÿßÿ™ ŸÖŸÜ ÿßŸÑÿ≥ÿ≠ÿßÿ®ÿ© ÿ®ŸÜÿ¨ÿßÿ≠');
                            }
                        } else {
                            showInfo('ÿßŸÑÿ®ŸäÿßŸÜÿßÿ™ ÿπŸÑŸâ ÿßŸÑÿ≥ÿ≠ÿßÿ®ÿ© ŸÖÿ∑ÿßÿ®ŸÇÿ© ŸÑŸÑÿ®ŸäÿßŸÜÿßÿ™ ÿßŸÑŸÖÿ≠ŸÑŸäÿ©');
                        }
                        
                        updateSyncStatus();
                    } else {
                        showInfo('ŸÑÿß ÿ™Ÿàÿ¨ÿØ ÿ®ŸäÿßŸÜÿßÿ™ ÿπŸÑŸâ ÿßŸÑÿ≥ÿ≠ÿßÿ®ÿ© ÿ®ÿπÿØ');
                    }
                })
                .catch((error) => {
                    console.error('Error loading from cloud:', error);
                    showWarning('ÿ™ÿπÿ∞ÿ± ÿ™ÿ≠ŸÖŸäŸÑ ÿßŸÑÿ®ŸäÿßŸÜÿßÿ™ ŸÖŸÜ ÿßŸÑÿ≥ÿ≠ÿßÿ®ÿ©. ÿ≥Ÿäÿ™ŸÖ ÿßÿ≥ÿ™ÿÆÿØÿßŸÖ ÿßŸÑÿ®ŸäÿßŸÜÿßÿ™ ÿßŸÑŸÖÿ≠ŸÑŸäÿ©.');
                })
                .finally(() => {
                    hideExportLoading();
                });
        }

        // ============================================
        // ÿ™ÿ≠ŸÖŸäŸÑ ÿßŸÑÿ•ÿπŸÑÿßŸÜÿßÿ™ ŸÖŸÜ ÿßŸÑÿ≥ÿ≠ÿßÿ®ÿ©
        // ============================================

        function loadEventsFromCloud() {
            if (!database || !cloudSyncEnabled) return;
            
            database.ref('familyEvents').once('value')
                .then((snapshot) => {
                    if (snapshot.exists()) {
                        const cloudEvents = snapshot.val();
                        
                        let eventsFromCloud = [];
                        if (Array.isArray(cloudEvents)) {
                            eventsFromCloud = cloudEvents;
                        } else {
                            eventsFromCloud = Object.values(cloudEvents).filter(item => item && typeof item === 'object');
                        }
                        
                        const localEventsJSON = JSON.stringify(familyEvents.sort((a, b) => new Date(a.date) - new Date(b.date)));
                        const cloudEventsJSON = JSON.stringify(eventsFromCloud.sort((a, b) => new Date(a.date) - new Date(b.date)));
                        
                        if (cloudEventsJSON !== localEventsJSON) {
                            if (confirm('ÿ™ŸÖ ÿ™ÿ≠ÿØŸäÿ´ ÿßŸÑÿ•ÿπŸÑÿßŸÜÿßÿ™ ÿπŸÑŸâ ÿßŸÑÿ≥ÿ≠ÿßÿ®ÿ©. ŸáŸÑ ÿ™ÿ±ŸäÿØ ÿ™ÿ≠ŸÖŸäŸÑ ÿßŸÑÿ™ÿ≠ÿØŸäÿ´ÿßÿ™ÿü')) {
                                familyEvents = eventsFromCloud;
                                saveEventsLocally();
                                
                                if (document.getElementById('familyEventsModal').classList.contains('active')) {
                                    loadEvents();
                                }
                                
                                showSuccess('ÿ™ŸÖ ÿ™ÿ≠ÿØŸäÿ´ ÿßŸÑÿ•ÿπŸÑÿßŸÜÿßÿ™ ŸÖŸÜ ÿßŸÑÿ≥ÿ≠ÿßÿ®ÿ©');
                            }
                        }
                    }
                })
                .catch((error) => {
                    console.error('Error loading events from cloud:', error);
                });
        }

        // ============================================
        // ÿ±ŸÅÿπ ÿßŸÑÿ®ŸäÿßŸÜÿßÿ™ ÿ•ŸÑŸâ ÿßŸÑÿ≥ÿ≠ÿßÿ®ÿ©
        // ============================================

        function saveDataToCloud() {
            if (!database || !cloudSyncEnabled || isOffline) return Promise.resolve(false);
            
            try {
                const dataToUpload = familyData;
                
                return database.ref('familyData').set(dataToUpload)
                    .then(() => {
                        console.log('‚úÖ Data saved to cloud successfully');
                        lastSyncTime = new Date();
                        
                        database.ref('lastUpdated').set({
                            timestamp: Date.now(),
                            user: currentUser,
                            totalPersons: familyData.length
                        });
                        
                        updateSyncStatus();
                        return true;
                    })
                    .catch((error) => {
                        console.error('‚ùå Error saving to cloud:', error);
                        queueForSync();
                        return false;
                    });
            } catch (error) {
                console.error('‚ùå Exception in saveDataToCloud:', error);
                queueForSync();
                return Promise.resolve(false);
            }
        }

        // ============================================
        // ÿ±ŸÅÿπ ÿßŸÑÿ•ÿπŸÑÿßŸÜÿßÿ™ ÿ•ŸÑŸâ ÿßŸÑÿ≥ÿ≠ÿßÿ®ÿ©
        // ============================================

        function saveEventsToCloud() {
            if (!database || !cloudSyncEnabled || isOffline) return Promise.resolve(false);
            
            try {
                return database.ref('familyEvents').set(familyEvents)
                    .then(() => {
                        console.log('‚úÖ Events saved to cloud successfully');
                        
                        database.ref('eventsLastUpdated').set({
                            timestamp: Date.now(),
                            user: currentUser,
                            totalEvents: familyEvents.length
                        });
                        
                        return true;
                    })
                    .catch((error) => {
                        console.error('‚ùå Error saving events to cloud:', error);
                        queueEventsForSync();
                        return false;
                    });
            } catch (error) {
                console.error('‚ùå Exception in saveEventsToCloud:', error);
                queueEventsForSync();
                return Promise.resolve(false);
            }
        }

        // ============================================
        // ŸÜÿ∏ÿßŸÖ ÿßŸÑŸÖÿ≤ÿßŸÖŸÜÿ© ÿßŸÑÿ∞ŸÉŸäÿ©
        // ============================================

        function saveData() {
            const localSaved = saveDataLocally();
            
            if (cloudSyncEnabled && database && !isOffline) {
                if (localSaved) {
                    saveDataToCloud().then(success => {
                        if (success) {
                            console.log('‚úÖ Data synced with cloud');
                        } else {
                            console.log('‚ö† Data queued for sync');
                        }
                    });
                }
                return localSaved;
            }
            
            return localSaved;
        }

        // ============================================
        // ÿ≠ŸÅÿ∏ ÿßŸÑÿ®ŸäÿßŸÜÿßÿ™ ŸÖÿ≠ŸÑŸäÿßŸã
        // ============================================

        function saveDataLocally() {
            try {
                if (isDataEncrypted && encryptionPassword) {
                    const dataString = JSON.stringify(familyData);
                    const encryptedData = encryptText(dataString, encryptionPassword);
                    localStorage.setItem('familyData', encryptedData);
                    localStorage.setItem('isDataEncrypted', 'true');
                } else {
                    localStorage.setItem('familyData', JSON.stringify(familyData));
                    localStorage.setItem('isDataEncrypted', 'false');
                }
                
                localStorage.setItem('lastSyncTimestamp', Date.now());
                localStorage.setItem('lastUserUpdate', currentUser || 'anonymous');
                
                console.log('‚úÖ Data saved locally');
                return true;
            } catch (error) {
                console.error('‚ùå Error saving locally:', error);
                showError('ŸÅÿ¥ŸÑ ÿ≠ŸÅÿ∏ ÿßŸÑÿ®ŸäÿßŸÜÿßÿ™ ŸÖÿ≠ŸÑŸäÿßŸã: ' + error.message);
                return false;
            }
        }

        // ============================================
        // ÿ≠ŸÅÿ∏ ÿßŸÑÿ•ÿπŸÑÿßŸÜÿßÿ™ ŸÖÿ≠ŸÑŸäÿßŸã
        // ============================================

        function saveEventsLocally() {
            try {
                localStorage.setItem('familyEvents', JSON.stringify(familyEvents));
                console.log('‚úÖ Events saved locally');
                return true;
            } catch (error) {
                console.error('‚ùå Error saving events locally:', error);
                return false;
            }
        }

        // ============================================
        // ŸÇÿßÿ¶ŸÖÿ© ÿßŸÜÿ™ÿ∏ÿßÿ± ÿßŸÑŸÖÿ≤ÿßŸÖŸÜÿ©
        // ============================================

        function queueForSync() {
            const syncItem = {
                data: familyData,
                timestamp: Date.now(),
                user: currentUser,
                type: 'data'
            };
            
            syncQueue.push(syncItem);
            localStorage.setItem('syncQueue', JSON.stringify(syncQueue));
            updateSyncStatus();
            
            if (syncQueue.length > 0) {
                showWarning('ŸäŸàÿ¨ÿØ ÿ®ŸäÿßŸÜÿßÿ™ ÿ∫Ÿäÿ± ŸÖÿ≤ÿßŸÖŸÜÿ©. ÿ≥Ÿäÿ™ŸÖ ŸÖÿ≠ÿßŸàŸÑÿ© ÿßŸÑŸÖÿ≤ÿßŸÖŸÜÿ© ÿπŸÜÿØ ÿßÿ≥ÿ™ÿπÿßÿØÿ© ÿßŸÑÿßÿ™ÿµÿßŸÑ.');
            }
        }

        function queueEventsForSync() {
            const syncItem = {
                events: familyEvents,
                timestamp: Date.now(),
                user: currentUser,
                type: 'events'
            };
            
            eventsSyncQueue.push(syncItem);
            localStorage.setItem('eventsSyncQueue', JSON.stringify(eventsSyncQueue));
            
            if (eventsSyncQueue.length > 0) {
                showWarning('ŸäŸàÿ¨ÿØ ÿ•ÿπŸÑÿßŸÜÿßÿ™ ÿ∫Ÿäÿ± ŸÖÿ≤ÿßŸÖŸÜÿ©. ÿ≥Ÿäÿ™ŸÖ ŸÖÿ≠ÿßŸàŸÑÿ© ÿßŸÑŸÖÿ≤ÿßŸÖŸÜÿ© ÿπŸÜÿØ ÿßÿ≥ÿ™ÿπÿßÿØÿ© ÿßŸÑÿßÿ™ÿµÿßŸÑ.');
            }
        }

        function processSyncQueue() {
            if (syncQueue.length === 0 || !cloudSyncEnabled || isOffline) return;
            
            showExportLoading('ÿ¨ÿßÿ±Ÿä ŸÖÿ≤ÿßŸÖŸÜÿ© ÿßŸÑÿ®ŸäÿßŸÜÿßÿ™ ÿßŸÑŸÖÿπŸÑŸÇÿ©...');
            
            const item = syncQueue.shift();
            
            saveDataToCloud().then(success => {
                if (success) {
                    localStorage.setItem('syncQueue', JSON.stringify(syncQueue));
                    showSuccess('ÿ™ŸÖ ŸÖÿ≤ÿßŸÖŸÜÿ© ÿßŸÑÿ®ŸäÿßŸÜÿßÿ™ ÿßŸÑŸÖÿπŸÑŸÇÿ©');
                } else {
                    syncQueue.unshift(item);
                }
                
                if (syncQueue.length > 0) {
                    setTimeout(processSyncQueue, 2000);
                }
                
                hideExportLoading();
                updateSyncStatus();
            });
        }

        function processEventsSyncQueue() {
            if (eventsSyncQueue.length === 0 || !cloudSyncEnabled || isOffline) return;
            
            showExportLoading('ÿ¨ÿßÿ±Ÿä ŸÖÿ≤ÿßŸÖŸÜÿ© ÿßŸÑÿ•ÿπŸÑÿßŸÜÿßÿ™ ÿßŸÑŸÖÿπŸÑŸÇÿ©...');
            
            const item = eventsSyncQueue.shift();
            
            database.ref('familyEvents').set(item.events)
                .then(() => {
                    localStorage.setItem('eventsSyncQueue', JSON.stringify(eventsSyncQueue));
                    showSuccess('ÿ™ŸÖ ŸÖÿ≤ÿßŸÖŸÜÿ© ÿßŸÑÿ•ÿπŸÑÿßŸÜÿßÿ™ ÿßŸÑŸÖÿπŸÑŸÇÿ©');
                })
                .catch(() => {
                    eventsSyncQueue.unshift(item);
                })
                .finally(() => {
                    hideExportLoading();
                });
        }

        // ============================================
        // ŸÖÿ±ÿßŸÇÿ®ÿ© ÿ≠ÿßŸÑÿ© ÿßŸÑÿßÿ™ÿµÿßŸÑ
        // ============================================

        function monitorConnection() {
            window.addEventListener('online', () => {
                isOffline = false;
                showSuccess('ÿ™ŸÖ ÿßÿ≥ÿ™ÿπÿßÿØÿ© ÿßŸÑÿßÿ™ÿµÿßŸÑ ÿ®ÿßŸÑÿ•ŸÜÿ™ÿ±ŸÜÿ™');
                updateSyncStatus();
                
                if (syncQueue.length > 0) {
                    processSyncQueue();
                }
                
                if (eventsSyncQueue.length > 0) {
                    processEventsSyncQueue();
                }
            });
            
            window.addEventListener('offline', () => {
                isOffline = true;
                showWarning('ŸÅŸÇÿØÿßŸÜ ÿßŸÑÿßÿ™ÿµÿßŸÑ ÿ®ÿßŸÑÿ•ŸÜÿ™ÿ±ŸÜÿ™. ÿ≥Ÿäÿ™ŸÖ ÿßŸÑÿ™ÿÆÿ≤ŸäŸÜ ŸÖÿ≠ŸÑŸäÿßŸã ŸÅŸÇÿ∑.');
                updateSyncStatus();
            });
            
            isOffline = !navigator.onLine;
            updateSyncStatus();
        }

        // ============================================
        // ÿ™ÿ≠ÿØŸäÿ´ ÿ≠ÿßŸÑÿ© ÿßŸÑŸÖÿ≤ÿßŸÖŸÜÿ©
        // ============================================

        function updateSyncStatus() {
            let syncStatusElement = document.getElementById('syncStatus');
            if (!syncStatusElement) {
                syncStatusElement = createSyncStatusElement();
            }
            
            let statusText = '';
            let statusClass = '';
            let icon = '';
            const totalQueue = syncQueue.length + eventsSyncQueue.length;
            
            if (!cloudSyncEnabled) {
                statusText = 'ÿßŸÑŸÖÿ≤ÿßŸÖŸÜÿ© ŸÖÿπ ÿßŸÑÿ≥ÿ≠ÿßÿ®ÿ© ÿ∫Ÿäÿ± ŸÖŸÅÿπŸÑÿ©';
                statusClass = 'warning';
                icon = 'fa-cloud-slash';
            } else if (isOffline) {
                statusText = 'ÿ∫Ÿäÿ± ŸÖÿ™ÿµŸÑ - ÿßŸÑÿ™ÿÆÿ≤ŸäŸÜ ŸÖÿ≠ŸÑŸä ŸÅŸÇÿ∑';
                statusClass = 'error';
                icon = 'fa-wifi-slash';
            } else {
                statusText = `ŸÖÿ≤ÿßŸÖŸÜ ŸÖÿπ ÿßŸÑÿ≥ÿ≠ÿßÿ®ÿ© ${lastSyncTime ? formatTime(lastSyncTime) : ''}`;
                statusClass = 'success';
                icon = 'fa-cloud-check';
                
                if (totalQueue > 0) {
                    statusText += ` (${totalQueue} ŸÅŸä ŸÇÿßÿ¶ŸÖÿ© ÿßŸÑÿßŸÜÿ™ÿ∏ÿßÿ±)`;
                    statusClass = 'warning';
                    icon = 'fa-cloud-upload-alt';
                }
            }
            
            syncStatusElement.innerHTML = `
                <i class="fas ${icon}"></i>
                <span>${statusText}</span>
                ${totalQueue > 0 ? `<span class="sync-badge">${totalQueue}</span>` : ''}
            `;
            syncStatusElement.className = `sync-status ${statusClass}`;
            
            if (document.getElementById('cloudManagerModal').classList.contains('active')) {
                updateCloudManagerStatus();
            }
        }

        function createSyncStatusElement() {
            const element = document.createElement('div');
            element.id = 'syncStatus';
            element.className = 'sync-status';
            
            const syncButton = document.createElement('button');
            syncButton.innerHTML = '<i class="fas fa-sync"></i>';
            syncButton.title = 'ŸÖÿ≤ÿßŸÖŸÜÿ© ŸäÿØŸàŸäÿ©';
            syncButton.onclick = forceSync;
            syncButton.className = 'sync-button';
            
            element.appendChild(syncButton);
            
            const userInfo = document.querySelector('.user-info');
            if (userInfo) {
                userInfo.insertBefore(element, userInfo.firstChild);
            }
            
            return element;
        }

        // ============================================
        // ÿßŸÑŸÖÿ≤ÿßŸÖŸÜÿ© ÿßŸÑŸäÿØŸàŸäÿ©
        // ============================================

        function forceSync() {
            if (!cloudSyncEnabled) {
                showWarning('ÿßŸÑŸÖÿ≤ÿßŸÖŸÜÿ© ŸÖÿπ ÿßŸÑÿ≥ÿ≠ÿßÿ®ÿ© ÿ∫Ÿäÿ± ŸÖŸÅÿπŸÑÿ©');
                return;
            }
            
            if (isOffline) {
                showWarning('ŸÑÿß ŸäŸàÿ¨ÿØ ÿßÿ™ÿµÿßŸÑ ÿ®ÿßŸÑÿ•ŸÜÿ™ÿ±ŸÜÿ™');
                return;
            }
            
            showExportLoading('ÿ¨ÿßÿ±Ÿä ÿßŸÑŸÖÿ≤ÿßŸÖŸÜÿ© ŸÖÿπ ÿßŸÑÿ≥ÿ≠ÿßÿ®ÿ©...');
            
            saveDataToCloud()
                .then((success) => {
                    if (success) {
                        showSuccess('ÿ™ŸÖÿ™ ÿßŸÑŸÖÿ≤ÿßŸÖŸÜÿ© ÿ®ŸÜÿ¨ÿßÿ≠');
                    }
                    updateSyncStatus();
                })
                .catch(error => {
                    showError('ŸÅÿ¥ŸÑÿ™ ÿßŸÑŸÖÿ≤ÿßŸÖŸÜÿ©: ' + error.message);
                })
                .finally(() => {
                    hideExportLoading();
                });
        }

        function forceEventsSync() {
            if (!cloudSyncEnabled) {
                showWarning('ÿßŸÑŸÖÿ≤ÿßŸÖŸÜÿ© ŸÖÿπ ÿßŸÑÿ≥ÿ≠ÿßÿ®ÿ© ÿ∫Ÿäÿ± ŸÖŸÅÿπŸÑÿ©');
                return;
            }
            
            if (isOffline) {
                showWarning('ŸÑÿß ŸäŸàÿ¨ÿØ ÿßÿ™ÿµÿßŸÑ ÿ®ÿßŸÑÿ•ŸÜÿ™ÿ±ŸÜÿ™');
                return;
            }
            
            showExportLoading('ÿ¨ÿßÿ±Ÿä ŸÖÿ≤ÿßŸÖŸÜÿ© ÿßŸÑÿ•ÿπŸÑÿßŸÜÿßÿ™ ŸÖÿπ ÿßŸÑÿ≥ÿ≠ÿßÿ®ÿ©...');
            
            saveEventsToCloud()
                .then((success) => {
                    if (success) {
                        showSuccess('ÿ™ŸÖÿ™ ŸÖÿ≤ÿßŸÖŸÜÿ© ÿßŸÑÿ•ÿπŸÑÿßŸÜÿßÿ™ ÿ®ŸÜÿ¨ÿßÿ≠');
                    }
                })
                .catch(error => {
                    showError('ŸÅÿ¥ŸÑÿ™ ŸÖÿ≤ÿßŸÖŸÜÿ© ÿßŸÑÿ•ÿπŸÑÿßŸÜÿßÿ™: ' + error.message);
                })
                .finally(() => {
                    hideExportLoading();
                });
        }

        // ============================================
        // ÿßŸÑŸÜÿ≥ÿÆ ÿßŸÑÿßÿ≠ÿ™Ÿäÿßÿ∑Ÿä ÿπŸÑŸâ ÿßŸÑÿ≥ÿ≠ÿßÿ®ÿ©
        // ============================================

        function backupToCloud() {
            if (!cloudSyncEnabled || !database) {
                showError('ÿßŸÑŸÖÿ≤ÿßŸÖŸÜÿ© ŸÖÿπ ÿßŸÑÿ≥ÿ≠ÿßÿ®ÿ© ÿ∫Ÿäÿ± ŸÖŸÅÿπŸÑÿ©');
                return;
            }
            
            const confirmMessage = `ÿ≥Ÿäÿ™ŸÖ ÿ•ŸÜÿ¥ÿßÿ° ŸÜÿ≥ÿÆÿ© ÿßÿ≠ÿ™Ÿäÿßÿ∑Ÿäÿ© ÿπŸÑŸâ ÿßŸÑÿ≥ÿ≠ÿßÿ®ÿ©:
            
ÿπÿØÿØ ÿßŸÑÿ£ŸÅÿ±ÿßÿØ: ${familyData.length}
ÿ≠ÿ¨ŸÖ ÿßŸÑÿ®ŸäÿßŸÜÿßÿ™: ${JSON.stringify(familyData).length} ÿ®ÿßŸäÿ™
            
ŸáŸÑ ÿ™ÿ±ŸäÿØ ÿßŸÑŸÖÿ™ÿßÿ®ÿπÿ©ÿü`;
            
            if (confirm(confirmMessage)) {
                showExportLoading('ÿ¨ÿßÿ±Ÿä ÿ•ŸÜÿ¥ÿßÿ° ŸÜÿ≥ÿÆÿ© ÿßÿ≠ÿ™Ÿäÿßÿ∑Ÿäÿ© ÿπŸÑŸâ ÿßŸÑÿ≥ÿ≠ÿßÿ®ÿ©...');
                
                const backupData = {
                    familyData: familyData,
                    backupDate: new Date().toISOString(),
                    backupUser: currentUser,
                    statistics: {
                        total: familyData.length,
                        males: familyData.filter(p => p.Gender === 'ÿ∞ŸÉÿ±').length,
                        females: familyData.filter(p => p.Gender === 'ÿßŸÜÿ´Ÿâ').length,
                        families: familyData.filter(p => (p.FatherID === 0 && p.MotherID === 0 && !isOutsideFamily(p.PersonID))).length
                    }
                };
                
                const backupKey = `backups/${new Date().toISOString().replace(/[:.]/g, '-')}`;
                
                database.ref(backupKey).set(backupData)
                    .then(() => {
                        hideExportLoading();
                        showSuccess('ÿ™ŸÖ ÿ•ŸÜÿ¥ÿßÿ° ÿßŸÑŸÜÿ≥ÿÆÿ© ÿßŸÑÿßÿ≠ÿ™Ÿäÿßÿ∑Ÿäÿ© ÿπŸÑŸâ ÿßŸÑÿ≥ÿ≠ÿßÿ®ÿ© ÿ®ŸÜÿ¨ÿßÿ≠');
                    })
                    .catch(error => {
                        hideExportLoading();
                        showError('ŸÅÿ¥ŸÑ ÿ•ŸÜÿ¥ÿßÿ° ÿßŸÑŸÜÿ≥ÿÆÿ© ÿßŸÑÿßÿ≠ÿ™Ÿäÿßÿ∑Ÿäÿ©: ' + error.message);
                    });
            }
        }

        function backupEventsToCloud() {
            if (!cloudSyncEnabled || !database) {
                showError('ÿßŸÑŸÖÿ≤ÿßŸÖŸÜÿ© ŸÖÿπ ÿßŸÑÿ≥ÿ≠ÿßÿ®ÿ© ÿ∫Ÿäÿ± ŸÖŸÅÿπŸÑÿ©');
                return;
            }
            
            const confirmMessage = `ÿ≥Ÿäÿ™ŸÖ ÿ•ŸÜÿ¥ÿßÿ° ŸÜÿ≥ÿÆÿ© ÿßÿ≠ÿ™Ÿäÿßÿ∑Ÿäÿ© ŸÑŸÑÿ•ÿπŸÑÿßŸÜÿßÿ™ ÿπŸÑŸâ ÿßŸÑÿ≥ÿ≠ÿßÿ®ÿ©:
            
ÿπÿØÿØ ÿßŸÑÿ•ÿπŸÑÿßŸÜÿßÿ™: ${familyEvents.length}
ÿ≠ÿ¨ŸÖ ÿßŸÑÿ®ŸäÿßŸÜÿßÿ™: ${JSON.stringify(familyEvents).length} ÿ®ÿßŸäÿ™

ŸáŸÑ ÿ™ÿ±ŸäÿØ ÿßŸÑŸÖÿ™ÿßÿ®ÿπÿ©ÿü`;
            
            if (confirm(confirmMessage)) {
                showExportLoading('ÿ¨ÿßÿ±Ÿä ÿ•ŸÜÿ¥ÿßÿ° ŸÜÿ≥ÿÆÿ© ÿßÿ≠ÿ™Ÿäÿßÿ∑Ÿäÿ© ŸÑŸÑÿ•ÿπŸÑÿßŸÜÿßÿ™...');
                
                const backupData = {
                    events: familyEvents,
                    backupDate: new Date().toISOString(),
                    backupUser: currentUser,
                    statistics: {
                        total: familyEvents.length,
                        active: familyEvents.filter(e => e.status === 'ŸÜÿ¥ÿ∑').length,
                        upcoming: familyEvents.filter(e => {
                            const eventDate = new Date(e.date);
                            const today = new Date();
                            return eventDate > today && e.status === 'ŸÜÿ¥ÿ∑';
                        }).length
                    }
                };
                
                const backupKey = `eventsBackups/${new Date().toISOString().replace(/[:.]/g, '-')}`;
                
                database.ref(backupKey).set(backupData)
                    .then(() => {
                        hideExportLoading();
                        showSuccess('ÿ™ŸÖ ÿ•ŸÜÿ¥ÿßÿ° ÿßŸÑŸÜÿ≥ÿÆÿ© ÿßŸÑÿßÿ≠ÿ™Ÿäÿßÿ∑Ÿäÿ© ŸÑŸÑÿ•ÿπŸÑÿßŸÜÿßÿ™ ÿπŸÑŸâ ÿßŸÑÿ≥ÿ≠ÿßÿ®ÿ© ÿ®ŸÜÿ¨ÿßÿ≠');
                    })
                    .catch(error => {
                        hideExportLoading();
                        showError('ŸÅÿ¥ŸÑ ÿ•ŸÜÿ¥ÿßÿ° ÿßŸÑŸÜÿ≥ÿÆÿ© ÿßŸÑÿßÿ≠ÿ™Ÿäÿßÿ∑Ÿäÿ©: ' + error.message);
                    });
            }
        }

        // ============================================
        // ŸÜÿßŸÅÿ∞ÿ© ÿ•ÿØÿßÿ±ÿ© ÿßŸÑÿ≥ÿ≠ÿßÿ®ÿ©
        // ============================================

        function showCloudManager() {
            document.getElementById('cloudManagerModal').classList.add('active');
            updateCloudManagerStatus();
            loadBackupList();
        }

        function closeCloudManager() {
            document.getElementById('cloudManagerModal').classList.remove('active');
        }

        function updateCloudManagerStatus() {
            if (document.getElementById('cloudStatus')) {
                document.getElementById('cloudStatus').textContent = cloudSyncEnabled ? '‚úì ŸÜÿ¥ÿ∑ÿ©' : '‚úó ŸÖÿπÿ∑ŸÑÿ©';
                document.getElementById('cloudStatus').className = cloudSyncEnabled ? 'status-badge success' : 'status-badge error';
                
                document.getElementById('lastSyncTime').textContent = lastSyncTime ? lastSyncTime.toLocaleString('ar-EG') : 'ŸÑŸÖ ÿ™ÿ™ŸÖ ÿßŸÑŸÖÿ≤ÿßŸÖŸÜÿ© ÿ®ÿπÿØ';
                
                const totalQueue = syncQueue.length + eventsSyncQueue.length;
                document.getElementById('pendingSync').textContent = totalQueue;
                document.getElementById('pendingSync').className = totalQueue > 0 ? 'status-badge warning' : 'status-badge';
                
                document.getElementById('internetStatus').textContent = isOffline ? '‚úó ÿ∫Ÿäÿ± ŸÖÿ™ÿµŸÑ' : '‚úì ŸÖÿ™ÿµŸÑ';
                document.getElementById('internetStatus').className = isOffline ? 'status-badge error' : 'status-badge success';
                
                if (document.getElementById('eventsStats')) {
                    document.getElementById('eventsStats').innerHTML = `
                        <div class="status-item">
                            <span>ÿπÿØÿØ ÿßŸÑÿ•ÿπŸÑÿßŸÜÿßÿ™:</span>
                            <span>${familyEvents.length}</span>
                        </div>
                        <div class="status-item">
                            <span>ÿ•ÿπŸÑÿßŸÜÿßÿ™ ŸÅŸä ŸÇÿßÿ¶ŸÖÿ© ÿßŸÑÿßŸÜÿ™ÿ∏ÿßÿ±:</span>
                            <span class="${eventsSyncQueue.length > 0 ? 'status-badge warning' : 'status-badge'}">${eventsSyncQueue.length}</span>
                        </div>
                    `;
                }
            }
        }

        function loadBackupList() {
            if (!database) return;
            
            database.ref('backups').once('value')
                .then(snapshot => {
                    const backupList = document.getElementById('backupList');
                    if (!snapshot.exists()) {
                        backupList.innerHTML = '<p style="padding: 20px; text-align: center; color: #7cb342;">ŸÑÿß ÿ™Ÿàÿ¨ÿØ ŸÜÿ≥ÿÆ ÿßÿ≠ÿ™Ÿäÿßÿ∑Ÿäÿ©</p>';
                        return;
                    }
                    
                    const backups = [];
                    snapshot.forEach(child => {
                        backups.push({
                            key: child.key,
                            data: child.val()
                        });
                    });
                    
                    backups.sort((a, b) => new Date(b.data.backupDate) - new Date(a.data.backupDate));
                    
                    let html = '';
                    backups.forEach(backup => {
                        const date = new Date(backup.data.backupDate);
                        const stats = backup.data.statistics;
                        
                        html += `
                            <div class="backup-item">
                                <div class="backup-header">
                                    <h4 style="margin: 0; font-size: 14px;">${date.toLocaleString('ar-EG')}</h4>
                                    <span class="backup-user">ÿ®Ÿàÿßÿ≥ÿ∑ÿ©: ${backup.data.backupUser || 'ŸÖÿ¨ŸáŸàŸÑ'}</span>
                                </div>
                                <div class="backup-stats">
                                    <span><i class="fas fa-users"></i> ${stats.total} ŸÅÿ±ÿØ</span>
                                    <span><i class="fas fa-male"></i> ${stats.males} ÿ∞ŸÉÿ±</span>
                                    <span><i class="fas fa-female"></i> ${stats.females} ÿ£ŸÜÿ´Ÿâ</span>
                                    <span><i class="fas fa-home"></i> ${stats.families} ÿπÿßÿ¶ŸÑÿ©</span>
                                </div>
                                <div class="backup-actions">
                                    <button class="btn btn-sm btn-success" onclick="restoreFromBackup('${backup.key}')">
                                        <i class="fas fa-redo"></i> ÿßÿ≥ÿ™ÿπÿßÿØÿ©
                                    </button>
                                    <button class="btn btn-sm btn-danger" onclick="deleteBackup('${backup.key}')">
                                        <i class="fas fa-trash"></i> ÿ≠ÿ∞ŸÅ
                                    </button>
                                </div>
                            </div>
                        `;
                    });
                    
                    backupList.innerHTML = html;
                })
                .catch(error => {
                    console.error('Error loading backups:', error);
                    showError('ŸÅÿ¥ŸÑ ÿ™ÿ≠ŸÖŸäŸÑ ŸÇÿßÿ¶ŸÖÿ© ÿßŸÑŸÜÿ≥ÿÆ ÿßŸÑÿßÿ≠ÿ™Ÿäÿßÿ∑Ÿäÿ©');
                });
        }

        function restoreFromBackup(backupKey) {
            if (!confirm('ÿ™ÿ≠ÿ∞Ÿäÿ±: ÿ≥Ÿäÿ™ŸÖ ÿßÿ≥ÿ™ÿ®ÿØÿßŸÑ ÿ¨ŸÖŸäÿπ ÿßŸÑÿ®ŸäÿßŸÜÿßÿ™ ÿßŸÑÿ≠ÿßŸÑŸäÿ© ÿ®ÿßŸÑŸÜÿ≥ÿÆÿ© ÿßŸÑÿßÿ≠ÿ™Ÿäÿßÿ∑Ÿäÿ©. ŸáŸÑ ÿ™ÿ±ŸäÿØ ÿßŸÑŸÖÿ™ÿßÿ®ÿπÿ©ÿü')) {
                return;
            }
            
            database.ref(`backups/${backupKey}`).once('value')
                .then(snapshot => {
                    if (snapshot.exists()) {
                        const backupData = snapshot.val();
                        familyData = backupData.familyData;
                        
                        if (saveData()) {
                            showSuccess('ÿ™ŸÖ ÿßÿ≥ÿ™ÿπÿßÿØÿ© ÿßŸÑŸÜÿ≥ÿÆÿ© ÿßŸÑÿßÿ≠ÿ™Ÿäÿßÿ∑Ÿäÿ© ÿ®ŸÜÿ¨ÿßÿ≠');
                            loadDashboard();
                            closeCloudManager();
                        }
                    }
                })
                .catch(error => {
                    showError('ŸÅÿ¥ŸÑ ÿßÿ≥ÿ™ÿπÿßÿØÿ© ÿßŸÑŸÜÿ≥ÿÆÿ© ÿßŸÑÿßÿ≠ÿ™Ÿäÿßÿ∑Ÿäÿ©: ' + error.message);
                });
        }

        function deleteBackup(backupKey) {
            if (!confirm('ŸáŸÑ ÿ™ÿ±ŸäÿØ ÿ≠ÿ∞ŸÅ Ÿáÿ∞Ÿá ÿßŸÑŸÜÿ≥ÿÆÿ© ÿßŸÑÿßÿ≠ÿ™Ÿäÿßÿ∑Ÿäÿ©ÿü')) {
                return;
            }
            
            database.ref(`backups/${backupKey}`).remove()
                .then(() => {
                    showSuccess('ÿ™ŸÖ ÿ≠ÿ∞ŸÅ ÿßŸÑŸÜÿ≥ÿÆÿ© ÿßŸÑÿßÿ≠ÿ™Ÿäÿßÿ∑Ÿäÿ© ÿ®ŸÜÿ¨ÿßÿ≠');
                    loadBackupList();
                })
                .catch(error => {
                    showError('ŸÅÿ¥ŸÑ ÿ≠ÿ∞ŸÅ ÿßŸÑŸÜÿ≥ÿÆÿ© ÿßŸÑÿßÿ≠ÿ™Ÿäÿßÿ∑Ÿäÿ©: ' + error.message);
                });
        }

        function clearSyncQueue() {
            const totalQueue = syncQueue.length + eventsSyncQueue.length;
            if (totalQueue === 0) {
                showInfo('ŸÑÿß ÿ™Ÿàÿ¨ÿØ ÿ®ŸäÿßŸÜÿßÿ™ ŸÅŸä ŸÇÿßÿ¶ŸÖÿ© ÿßŸÑÿßŸÜÿ™ÿ∏ÿßÿ±');
                return;
            }
            
            if (confirm(`ŸáŸÑ ÿ™ÿ±ŸäÿØ ŸÖÿ≥ÿ≠ ${totalQueue} ÿπŸÜÿµÿ± ŸÖŸÜ ŸÇÿßÿ¶ŸÖÿ© ÿßŸÜÿ™ÿ∏ÿßÿ± ÿßŸÑŸÖÿ≤ÿßŸÖŸÜÿ©ÿü`)) {
                syncQueue = [];
                eventsSyncQueue = [];
                localStorage.removeItem('syncQueue');
                localStorage.removeItem('eventsSyncQueue');
                showSuccess('ÿ™ŸÖ ŸÖÿ≥ÿ≠ ŸÇÿßÿ¶ŸÖÿ© ÿßŸÑÿßŸÜÿ™ÿ∏ÿßÿ± ÿ®ŸÜÿ¨ÿßÿ≠');
                updateCloudManagerStatus();
                updateSyncStatus();
            }
        }

        function showCloudStatistics() {
            const stats = {
                totalBackups: 0,
                totalSize: 0,
                lastBackup: null
            };
            
            if (database) {
                database.ref('backups').once('value')
                    .then(snapshot => {
                        if (snapshot.exists()) {
                            stats.totalBackups = snapshot.numChildren();
                            
                            let totalSize = 0;
                            let lastBackup = null;
                            
                            snapshot.forEach(child => {
                                const backup = child.val();
                                totalSize += JSON.stringify(backup).length;
                                const backupDate = new Date(backup.backupDate);
                                if (!lastBackup || backupDate > lastBackup) {
                                    lastBackup = backupDate;
                                }
                            });
                            
                            stats.totalSize = (totalSize / 1024).toFixed(2) + ' KB';
                            stats.lastBackup = lastBackup ? lastBackup.toLocaleString('ar-EG') : 'ŸÑÿß ŸäŸàÿ¨ÿØ';
                            
                            alert(`
                                ÿ•ÿ≠ÿµÿßÿ¶Ÿäÿßÿ™ ÿßŸÑÿ≥ÿ≠ÿßÿ®ÿ©:
                                
                                ÿπÿØÿØ ÿßŸÑŸÜÿ≥ÿÆ ÿßŸÑÿßÿ≠ÿ™Ÿäÿßÿ∑Ÿäÿ©: ${stats.totalBackups}
                                ÿßŸÑÿ≠ÿ¨ŸÖ ÿßŸÑÿ•ÿ¨ŸÖÿßŸÑŸä: ${stats.totalSize}
                                ÿ¢ÿÆÿ± ŸÜÿ≥ÿÆÿ© ÿßÿ≠ÿ™Ÿäÿßÿ∑Ÿäÿ©: ${stats.lastBackup}
                                ÿ®ŸäÿßŸÜÿßÿ™ ŸÅŸä ŸÇÿßÿ¶ŸÖÿ© ÿßŸÑÿßŸÜÿ™ÿ∏ÿßÿ±: ${syncQueue.length}
                                ÿ•ÿπŸÑÿßŸÜÿßÿ™ ŸÅŸä ŸÇÿßÿ¶ŸÖÿ© ÿßŸÑÿßŸÜÿ™ÿ∏ÿßÿ±: ${eventsSyncQueue.length}
                                ÿ≠ÿßŸÑÿ© ÿßŸÑŸÖÿ≤ÿßŸÖŸÜÿ©: ${cloudSyncEnabled ? 'ŸÖŸÅÿπŸÑÿ©' : 'ŸÖÿπÿ∑ŸÑÿ©'}
                                ÿ≠ÿßŸÑÿ© ÿßŸÑÿ•ŸÜÿ™ÿ±ŸÜÿ™: ${isOffline ? 'ÿ∫Ÿäÿ± ŸÖÿ™ÿµŸÑ' : 'ŸÖÿ™ÿµŸÑ'}
                            `);
                        } else {
                            alert('ŸÑÿß ÿ™Ÿàÿ¨ÿØ ŸÜÿ≥ÿÆ ÿßÿ≠ÿ™Ÿäÿßÿ∑Ÿäÿ© ÿπŸÑŸâ ÿßŸÑÿ≥ÿ≠ÿßÿ®ÿ©');
                        }
                    })
                    .catch(error => {
                        showError('ŸÅÿ¥ŸÑ ÿ™ÿ≠ŸÖŸäŸÑ ÿ•ÿ≠ÿµÿßÿ¶Ÿäÿßÿ™ ÿßŸÑÿ≥ÿ≠ÿßÿ®ÿ©: ' + error.message);
                    });
            }
        }

        // ============================================
        // Ÿàÿ∏ÿßÿ¶ŸÅ ŸÖÿ≥ÿßÿπÿØÿ©
        // ============================================

        function formatTime(date) {
            if (!date) return '';
            const now = new Date();
            const diff = now - date;
            
            const minutes = Math.floor(diff / 60000);
            const hours = Math.floor(diff / 3600000);
            const days = Math.floor(diff / 86400000);
            
            if (minutes < 1) return '(ÿßŸÑÿ¢ŸÜ)';
            if (minutes < 60) return `(ŸÇÿ®ŸÑ ${minutes} ÿØŸÇŸäŸÇÿ©)`;
            if (hours < 24) return `(ŸÇÿ®ŸÑ ${hours} ÿ≥ÿßÿπÿ©)`;
            return `(ŸÇÿ®ŸÑ ${days} ŸäŸàŸÖ)`;
        }

        // ============================================
        // ÿØŸàÿßŸÑ ÿßŸÑÿ™ÿ¥ŸÅŸäÿ±
        // ============================================

        function encryptText(text, password) {
            try {
                let combined = password + "::" + text;
                return btoa(unescape(encodeURIComponent(combined)));
            } catch (error) {
                console.error('ÿÆÿ∑ÿ£ ŸÅŸä ÿßŸÑÿ™ÿ¥ŸÅŸäÿ±:', error);
                throw new Error('ŸÅÿ¥ŸÑ ÿ™ÿ¥ŸÅŸäÿ± ÿßŸÑÿ®ŸäÿßŸÜÿßÿ™');
            }
        }

        function decryptText(encryptedText, password) {
            try {
                let decoded = decodeURIComponent(escape(atob(encryptedText)));
                let parts = decoded.split("::");
                if (parts.length !== 2) {
                    throw new Error('ÿ™ŸÜÿ≥ŸäŸÇ ÿßŸÑÿ®ŸäÿßŸÜÿßÿ™ ÿ∫Ÿäÿ± ÿµÿ≠Ÿäÿ≠');
                }
                if (parts[0] !== password) {
                    throw new Error('ŸÉŸÑŸÖÿ© ÿßŸÑŸÖÿ±Ÿàÿ± ÿ∫Ÿäÿ± ÿµÿ≠Ÿäÿ≠ÿ©');
                }
                return parts[1];
            } catch (error) {
                console.error('ÿÆÿ∑ÿ£ ŸÅŸä ŸÅŸÉ ÿßŸÑÿ™ÿ¥ŸÅŸäÿ±:', error);
                throw new Error('ŸÅÿ¥ŸÑ ŸÅŸÉ ÿ™ÿ¥ŸÅŸäÿ± ÿßŸÑÿ®ŸäÿßŸÜÿßÿ™');
            }
        }

        // ============================================
        // ŸÜÿ∏ÿßŸÖ ÿßŸÑŸÖŸÜÿßÿ≥ÿ®ÿßÿ™ ŸàÿßŸÑÿ•ÿπŸÑÿßŸÜÿßÿ™ ÿßŸÑÿπÿßÿ¶ŸÑŸäÿ©
        // ============================================

        function initEventsSystem() {
            const savedEvents = localStorage.getItem('familyEvents');
            if (savedEvents) {
                try {
                    familyEvents = JSON.parse(savedEvents);
                } catch (error) {
                    familyEvents = defaultEvents;
                }
            } else {
                familyEvents = defaultEvents;
                saveEvents();
            }
            
            if (cloudSyncEnabled && database) {
                setTimeout(() => {
                    loadEventsFromCloud();
                }, 1500);
            }
        }

        function saveEvents() {
            try {
                localStorage.setItem('familyEvents', JSON.stringify(familyEvents));
                console.log('‚úÖ Events saved locally');
                
                if (cloudSyncEnabled && database && !isOffline) {
                    saveEventsToCloud();
                } else if (cloudSyncEnabled && isOffline) {
                    queueEventsForSync();
                }
                
                return true;
            } catch (error) {
                console.error('‚ùå Error saving events:', error);
                return false;
            }
        }

        function showFamilyEvents() {
            if (!checkPermission('view')) {
                showError('ŸÑÿß ÿ™ŸÖŸÑŸÉ ÿµŸÑÿßÿ≠Ÿäÿ© ÿßŸÑŸàÿµŸàŸÑ');
                return;
            }
            
            document.querySelectorAll('.menu-item').forEach(item => item.classList.remove('active'));
            document.querySelector('.sidebar-menu li:nth-child(9)').classList.add('active');
            
            document.getElementById('familyEventsModal').classList.add('active');
            
            const isAdmin = currentUser === 'admin';
            document.getElementById('eventsControlPanel').style.display = isAdmin ? 'block' : 'none';
            document.getElementById('toggleEventFormBtn').style.display = isAdmin ? 'inline-flex' : 'none';
            
            loadEvents();
        }

        function closeFamilyEvents() {
            document.getElementById('familyEventsModal').classList.remove('active');
            resetEventForm();
        }

        function toggleEventForm() {
            if (!checkPermission('manage_events')) {
                showError('ŸÑÿß ÿ™ŸÖŸÑŸÉ ÿµŸÑÿßÿ≠Ÿäÿ© ÿ•ÿØÿßÿ±ÿ© ÿßŸÑÿ•ÿπŸÑÿßŸÜÿßÿ™');
                return;
            }
            
            const panel = document.getElementById('eventsControlPanel');
            const isVisible = panel.style.display === 'block';
            panel.style.display = isVisible ? 'none' : 'block';
            
            if (!isVisible) {
                panel.scrollIntoView({ behavior: 'smooth' });
            }
        }

        function resetEventForm() {
            document.getElementById('eventForm').reset();
            document.getElementById('eventId').value = '';
            document.getElementById('eventDate').value = new Date().toISOString().split('T')[0];
            eventsEditing = false;
        }

        function cancelEventForm() {
            resetEventForm();
            document.getElementById('eventsControlPanel').style.display = 'none';
        }

        function saveEvent() {
            if (!checkPermission('manage_events')) {
                showError('ŸÑÿß ÿ™ŸÖŸÑŸÉ ÿµŸÑÿßÿ≠Ÿäÿ© ÿ•ÿØÿßÿ±ÿ© ÿßŸÑÿ•ÿπŸÑÿßŸÜÿßÿ™');
                return;
            }
            
            const eventId = document.getElementById('eventId').value;
            const isEdit = !!eventId;
            
            const eventData = {
                id: isEdit ? eventId : generateEventId(),
                type: document.getElementById('eventType').value,
                title: document.getElementById('eventTitle').value,
                date: document.getElementById('eventDate').value,
                time: document.getElementById('eventTime').value || '',
                location: document.getElementById('eventLocation').value || '',
                description: document.getElementById('eventDescription').value,
                organizer: document.getElementById('eventOrganizer').value || 'ÿ•ÿØÿßÿ±ÿ© ÿßŸÑÿ£ÿ≥ÿ±ÿ©',
                status: document.getElementById('eventStatus').value,
                createdAt: isEdit ? undefined : new Date().toISOString(),
                updatedAt: new Date().toISOString(),
                createdBy: currentUser
            };
            
            if (!eventData.type || !eventData.title || !eventData.date || !eventData.description) {
                showError('ÿßŸÑÿ±ÿ¨ÿßÿ° ŸÖŸÑÿ° ÿ¨ŸÖŸäÿπ ÿßŸÑÿ≠ŸÇŸàŸÑ ÿßŸÑŸÖÿ∑ŸÑŸàÿ®ÿ©');
                return;
            }
            
            if (isEdit) {
                const index = familyEvents.findIndex(e => e.id === eventId);
                if (index !== -1) {
                    familyEvents[index] = {...familyEvents[index], ...eventData};
                }
            } else {
                familyEvents.push(eventData);
            }
            
            saveEvents();
            resetEventForm();
            loadEvents();
            document.getElementById('eventsControlPanel').style.display = 'none';
            
            showSuccess(isEdit ? 'ÿ™ŸÖ ÿ™ÿ≠ÿØŸäÿ´ ÿßŸÑÿ•ÿπŸÑÿßŸÜ ÿ®ŸÜÿ¨ÿßÿ≠' : 'ÿ™ŸÖ ŸÜÿ¥ÿ± ÿßŸÑÿ•ÿπŸÑÿßŸÜ ÿ®ŸÜÿ¨ÿßÿ≠');
        }

        function generateEventId() {
            return 'EV' + Date.now() + Math.floor(Math.random() * 1000);
        }

        function loadEvents() {
            const eventsList = document.getElementById('eventsList');
            const noEventsMessage = document.getElementById('noEventsMessage');
            
            if (familyEvents.length === 0) {
                eventsList.innerHTML = '';
                noEventsMessage.style.display = 'block';
                return;
            }
            
            noEventsMessage.style.display = 'none';
            
            let filteredEvents = [...familyEvents];
            if (currentEventsFilter === 'ŸÜÿ¥ÿ∑') {
                filteredEvents = filteredEvents.filter(e => e.status === 'ŸÜÿ¥ÿ∑');
            } else if (currentEventsFilter === 'ŸÇÿßÿØŸÖ') {
                const today = new Date().toISOString().split('T')[0];
                filteredEvents = filteredEvents.filter(e => e.date >= today && e.status === 'ŸÜÿ¥ÿ∑');
            }
            
            filteredEvents.sort((a, b) => {
                if (a.date === b.date) {
                    return new Date(b.createdAt) - new Date(a.createdAt);
                }
                return new Date(a.date) - new Date(b.date);
            });
            
            let html = '';
            filteredEvents.forEach(event => {
                const eventDate = new Date(event.date);
                const today = new Date();
                const isUpcoming = eventDate > today && event.status === 'ŸÜÿ¥ÿ∑';
                
                html += `
                    <div class="event-card">
                        <div class="event-header event-type-${event.type}">
                            <span class="event-type">${getEventTypeArabic(event.type)}</span>
                            <span class="event-date">${formatEventDate(event.date)}</span>
                        </div>
                        
                        ${isUpcoming ? '<div class="upcoming-badge">ŸÇÿßÿØŸÖ</div>' : ''}
                        <div class="event-status status-${event.status}">${event.status}</div>
                        
                        <div class="event-body">
                            <h3 class="event-title">${event.title}</h3>
                            <div class="event-description">${event.description}</div>
                            
                            <div class="event-details">
                                ${event.time ? `
                                    <div class="event-detail">
                                        <i class="fas fa-clock"></i>
                                        <span>ÿßŸÑŸàŸÇÿ™: ${event.time}</span>
                                    </div>
                                ` : ''}
                                
                                ${event.location ? `
                                    <div class="event-detail">
                                        <i class="fas fa-map-marker-alt"></i>
                                        <span>ÿßŸÑŸÖŸÉÿßŸÜ: ${event.location}</span>
                                    </div>
                                ` : ''}
                            </div>
                        </div>
                        
                        <div class="event-footer">
                            <div class="event-organizer">
                                <i class="fas fa-user"></i> ${event.organizer}
                            </div>
                            
                            ${currentUser === 'admin' ? `
                                <div class="event-actions">
                                    <button class="event-action-btn edit" onclick="editEvent('${event.id}')" title="ÿ™ÿπÿØŸäŸÑ">
                                        <i class="fas fa-edit"></i>
                                    </button>
                                    <button class="event-action-btn delete" onclick="deleteEvent('${event.id}')" title="ÿ≠ÿ∞ŸÅ">
                                        <i class="fas fa-trash"></i>
                                    </button>
                                </div>
                            ` : ''}
                        </div>
                    </div>
                `;
            });
            
            eventsList.innerHTML = html;
        }

        function getEventTypeArabic(type) {
            const types = {
                'ŸÖŸÜÿßÿ≥ÿ®ÿ©': 'ŸÖŸÜÿßÿ≥ÿ®ÿ© ÿπÿßÿ¶ŸÑŸäÿ©',
                'ÿßÿ¨ÿ™ŸÖÿßÿπ': 'ÿßÿ¨ÿ™ŸÖÿßÿπ ÿπÿßÿ¶ŸÑŸä',
                'ŸÅÿπÿßŸÑŸäÿ©': 'ŸÅÿπÿßŸÑŸäÿ©',
                'ÿ®ÿ±ŸÜÿßŸÖÿ¨': 'ÿ®ÿ±ŸÜÿßŸÖÿ¨ ÿ£ÿ≥ÿ±Ÿä',
                'ÿ™ÿ∞ŸÉŸäÿ±': 'ÿ™ÿ∞ŸÉŸäÿ± ŸÖŸáŸÖ',
                'ÿ£ÿÆÿ±Ÿâ': 'ÿ•ÿπŸÑÿßŸÜ'
            };
            return types[type] || type;
        }

        function formatEventDate(dateString) {
            try {
                const date = new Date(dateString);
                return date.toLocaleDateString('ar-EG', {
                    year: 'numeric',
                    month: 'long',
                    day: 'numeric'
                });
            } catch (error) {
                return dateString;
            }
        }

        function editEvent(eventId) {
            if (!checkPermission('manage_events')) {
                showError('ŸÑÿß ÿ™ŸÖŸÑŸÉ ÿµŸÑÿßÿ≠Ÿäÿ© ÿßŸÑÿ™ÿπÿØŸäŸÑ');
                return;
            }
            
            const event = familyEvents.find(e => e.id === eventId);
            if (!event) return;
            
            eventsEditing = true;
            document.getElementById('eventId').value = event.id;
            document.getElementById('eventType').value = event.type;
            document.getElementById('eventTitle').value = event.title;
            document.getElementById('eventDate').value = event.date;
            document.getElementById('eventTime').value = event.time || '';
            document.getElementById('eventLocation').value = event.location || '';
            document.getElementById('eventDescription').value = event.description;
            document.getElementById('eventOrganizer').value = event.organizer || '';
            document.getElementById('eventStatus').value = event.status || 'ŸÜÿ¥ÿ∑';
            
            document.getElementById('eventsControlPanel').style.display = 'block';
            document.getElementById('eventsControlPanel').scrollIntoView({ behavior: 'smooth' });
        }

        function deleteEvent(eventId) {
            if (!checkPermission('manage_events')) {
                showError('ŸÑÿß ÿ™ŸÖŸÑŸÉ ÿµŸÑÿßÿ≠Ÿäÿ© ÿßŸÑÿ≠ÿ∞ŸÅ');
                return;
            }
            
            if (!confirm('ŸáŸÑ ÿ£ŸÜÿ™ ŸÖÿ™ÿ£ŸÉÿØ ŸÖŸÜ ÿ≠ÿ∞ŸÅ Ÿáÿ∞ÿß ÿßŸÑÿ•ÿπŸÑÿßŸÜÿü')) return;
            
            familyEvents = familyEvents.filter(e => e.id !== eventId);
            saveEvents();
            loadEvents();
            showSuccess('ÿ™ŸÖ ÿ≠ÿ∞ŸÅ ÿßŸÑÿ•ÿπŸÑÿßŸÜ ÿ®ŸÜÿ¨ÿßÿ≠');
        }

        function filterEvents(filterType) {
            currentEventsFilter = filterType;
            loadEvents();
            
            const buttons = document.querySelectorAll('.action-buttons button');
            buttons.forEach(btn => btn.classList.remove('active'));
            
            const activeBtn = Array.from(buttons).find(btn => 
                btn.onclick && btn.onclick.toString().includes(`'${filterType}'`)
            );
            if (activeBtn) activeBtn.classList.add('active');
        }

        function searchEvents() {
            const searchTerm = document.getElementById('eventSearch').value.toLowerCase();
            
            const eventCards = document.querySelectorAll('.event-card');
            let foundCount = 0;
            
            eventCards.forEach(card => {
                const title = card.querySelector('.event-title').textContent.toLowerCase();
                const description = card.querySelector('.event-description').textContent.toLowerCase();
                const type = card.querySelector('.event-type').textContent.toLowerCase();
                
                const isMatch = title.includes(searchTerm) || 
                               description.includes(searchTerm) || 
                               type.includes(searchTerm);
                
                card.style.display = isMatch ? 'block' : 'none';
                if (isMatch) foundCount++;
            });
            
            if (searchTerm && foundCount === 0) {
                showError('ŸÑŸÖ Ÿäÿ™ŸÖ ÿßŸÑÿπÿ´Ÿàÿ± ÿπŸÑŸâ ÿ•ÿπŸÑÿßŸÜÿßÿ™ ÿ™ÿ∑ÿßÿ®ŸÇ ÿßŸÑÿ®ÿ≠ÿ´');
            }
        }

        function clearEventSearch() {
            document.getElementById('eventSearch').value = '';
            const eventCards = document.querySelectorAll('.event-card');
            eventCards.forEach(card => {
                card.style.display = 'block';
            });
        }

        function printEvents() {
            const printContent = document.getElementById('eventsList').innerHTML;
            const originalContent = document.body.innerHTML;
            
            document.body.innerHTML = `
                <div dir="rtl" style="padding: 20px; font-family: 'Cairo', sans-serif;">
                    <h1 style="text-align: center; color: #2E7D32; border-bottom: 2px solid #4CAF50; padding-bottom: 10px;">
                        üìÖ ÿ•ÿπŸÑÿßŸÜÿßÿ™ ŸàŸÖŸÜÿßÿ≥ÿ®ÿßÿ™ ÿπÿßÿ¶ŸÑÿ© ŸÖÿ≠ŸÖÿØ ÿπÿ®ÿØÿßŸÑÿ±ÿ≠ŸÖŸÜ
                    </h1>
                    <div style="margin-top: 20px;">
                        ${printContent}
                    </div>
                    <div style="margin-top: 30px; text-align: center; color: #666; font-size: 12px;">
                        <p>ÿ™ÿßÿ±ŸäÿÆ ÿßŸÑÿ∑ÿ®ÿßÿπÿ©: ${new Date().toLocaleDateString('ar-EG')}</p>
                        <p>ÿπÿØÿØ ÿßŸÑÿ•ÿπŸÑÿßŸÜÿßÿ™: ${familyEvents.length}</p>
                    </div>
                </div>
            `;
            
            window.print();
            document.body.innerHTML = originalContent;
            location.reload();
        }

        // ============================================
        // ÿØŸàÿßŸÑ ÿßŸÑŸÜÿ∏ÿßŸÖ ÿßŸÑÿ£ÿ≥ÿßÿ≥Ÿäÿ©
        // ============================================

        function initSystem() {
            console.log('ÿ¨ÿßÿ±Ÿä ÿ™ŸáŸäÿ¶ÿ© ÿßŸÑŸÜÿ∏ÿßŸÖ...');
            
            loadUsers();
            
            const savedQueue = localStorage.getItem('syncQueue');
            if (savedQueue) {
                try {
                    syncQueue = JSON.parse(savedQueue);
                } catch (error) {
                    syncQueue = [];
                }
            }
            
            const savedEventsQueue = localStorage.getItem('eventsSyncQueue');
            if (savedEventsQueue) {
                try {
                    eventsSyncQueue = JSON.parse(savedEventsQueue);
                } catch (error) {
                    eventsSyncQueue = [];
                }
            }
            
            const savedEncryptionFlag = localStorage.getItem('isDataEncrypted');
            const savedData = localStorage.getItem('familyData');
            
            if (savedEncryptionFlag === 'true' && savedData) {
                isDataEncrypted = true;
                familyData = defaultFamilyData;
            } else if (savedData) {
                try {
                    const parsedData = JSON.parse(savedData);
                    if (Array.isArray(parsedData)) {
                        familyData = parsedData;
                    } else {
                        familyData = defaultFamilyData;
                    }
                    isDataEncrypted = false;
                } catch (error) {
                    familyData = defaultFamilyData;
                    isDataEncrypted = false;
                }
            } else {
                familyData = defaultFamilyData;
                isDataEncrypted = false;
            }
            
            initEventsSystem();
            
            if (familyData.length > 0) {
                const maxId = Math.max(...familyData.map(p => p.PersonID));
                nextPersonId = maxId + 1;
            } else {
                nextPersonId = 1;
            }
            
            console.log('ÿπÿØÿØ ÿßŸÑÿ£ŸÅÿ±ÿßÿØ:', familyData.length);
            console.log('ÿπÿØÿØ ÿßŸÑÿ•ÿπŸÑÿßŸÜÿßÿ™:', familyEvents.length);
            console.log('ÿ•ÿπŸÑÿßŸÜÿßÿ™ ŸÅŸä ŸÇÿßÿ¶ŸÖÿ© ÿßŸÑÿßŸÜÿ™ÿ∏ÿßÿ±:', eventsSyncQueue.length);
            
            cloudSyncEnabled = initializeFirebase();
            
            if (cloudSyncEnabled) {
                setTimeout(() => {
                    loadDataFromCloud();
                }, 1000);
            }
            
            updateUIByPermissions();
            updateSidebarPermissions();
            updateSyncStatus();
            
            initMobileMenu();
        }

        function initMobileMenu() {
            const mobileMenuToggle = document.getElementById('mobileMenuToggle');
            const sidebar = document.getElementById('sidebar');
            
            if (mobileMenuToggle && sidebar) {
                mobileMenuToggle.addEventListener('click', function() {
                    sidebar.classList.toggle('active');
                });
                
                document.addEventListener('click', function(event) {
                    if (!sidebar.contains(event.target) && !mobileMenuToggle.contains(event.target) && sidebar.classList.contains('active')) {
                        sidebar.classList.remove('active');
                    }
                });
            }
        }

        function handleLogin() {
            const username = document.getElementById('username').value;
            const password = document.getElementById('password').value;
            const errorDiv = document.getElementById('loginError');
            
            if (users[username] && users[username].password === password) {
                currentUser = username;
                document.getElementById('loggedInUser').textContent = users[username].name;
                document.getElementById('login-screen').style.display = 'none';
                document.getElementById('main-content').style.display = 'block';
                initSystem();
                loadDashboard();
                updateUIByPermissions();
                updateSidebarPermissions();
                showSuccess('ÿ™ŸÖ ÿ™ÿ≥ÿ¨ŸäŸÑ ÿßŸÑÿØÿÆŸàŸÑ ÿ®ŸÜÿ¨ÿßÿ≠');
            } else {
                errorDiv.style.display = 'block';
            }
        }

        function logout() {
            if (confirm('ŸáŸÑ ÿ™ÿ±ŸäÿØ ÿ™ÿ≥ÿ¨ŸäŸÑ ÿßŸÑÿÆÿ±Ÿàÿ¨ÿü')) {
                currentUser = null;
                document.getElementById('main-content').style.display = 'none';
                document.getElementById('login-screen').style.display = 'flex';
                document.getElementById('username').value = '';
                document.getElementById('password').value = '';
                showSuccess('ÿ™ŸÖ ÿ™ÿ≥ÿ¨ŸäŸÑ ÿßŸÑÿÆÿ±Ÿàÿ¨ ÿ®ŸÜÿ¨ÿßÿ≠');
            }
        }

        // ============================================
        // ÿØŸàÿßŸÑ ÿ•ÿØÿßÿ±ÿ© ÿßŸÑÿ£ŸÅÿ±ÿßÿØ
        // ============================================

        function validatePersonData(data) {
            if (!data.FullName || data.FullName.trim() === '') {
                showError('ÿßŸÑÿßÿ≥ŸÖ ÿßŸÑŸÉÿßŸÖŸÑ ŸÖÿ∑ŸÑŸàÿ®');
                return false;
            }
            
            if (!data.Gender) {
                showError('ÿßŸÑÿ¨ŸÜÿ≥ ŸÖÿ∑ŸÑŸàÿ®');
                return false;
            }
            
            return true;
        }

        function savePerson() {
            if (!checkPermission('edit') && !checkPermission('add')) {
                showError('ŸÑÿß ÿ™ŸÖŸÑŸÉ ÿµŸÑÿßÿ≠Ÿäÿ© ÿßŸÑÿ™ÿπÿØŸäŸÑ ÿ£Ÿà ÿßŸÑÿ•ÿ∂ÿßŸÅÿ©');
                return;
            }
            
            const personId = parseInt(document.getElementById('personId').value);
            const isEdit = !!personId;
            
            if (!isEdit) {
                const maxId = familyData.length > 0 ? Math.max(...familyData.map(p => p.PersonID)) : 0;
                nextPersonId = maxId + 1;
            }
            
            const personData = {
                PersonID: isEdit ? personId : nextPersonId,
                FullName: document.getElementById('fullName').value,
                Gender: document.getElementById('gender').value,
                PlaceOfBirth: document.getElementById('placeOfBirth').value,
                BirthDate: document.getElementById('birthDate').value,
                DeathDate: document.getElementById('deathDate').value,
                FatherID: parseInt(document.getElementById('fatherId').value) || 0,
                MotherID: parseInt(document.getElementById('motherId').value) || 0,
                SpouseID: parseInt(document.getElementById('spouseId').value) || 0,
                Notes: document.getElementById('notes').value
            };
            
            if (!validatePersonData(personData)) {
                return;
            }
            
            if (isEdit) {
                const index = familyData.findIndex(p => p.PersonID === personId);
                if (index !== -1) {
                    familyData[index] = personData;
                }
            } else {
                familyData.push(personData);
                nextPersonId++;
            }
            
            if (saveData()) {
                loadDashboard();
                closePersonForm();
                showSuccess(isEdit ? 'ÿ™ŸÖ ÿ™ÿ≠ÿØŸäÿ´ ÿ®ŸäÿßŸÜÿßÿ™ ÿßŸÑŸÅÿ±ÿØ ÿ®ŸÜÿ¨ÿßÿ≠' : 'ÿ™ŸÖ ÿ•ÿ∂ÿßŸÅÿ© ÿßŸÑŸÅÿ±ÿØ ÿßŸÑÿ¨ÿØŸäÿØ ÿ®ŸÜÿ¨ÿßÿ≠');
            }
        }

        function updateDropdowns() {
            const fatherSelect = document.getElementById('fatherId');
            const motherSelect = document.getElementById('motherId');
            const spouseSelect = document.getElementById('spouseId');
            
            fatherSelect.innerHTML = `<option value="0">${translations[currentLanguage].formNoFather}</option>`;
            motherSelect.innerHTML = `<option value="0">${translations[currentLanguage].formNoMother}</option>`;
            spouseSelect.innerHTML = `<option value="0">${translations[currentLanguage].formNoSpouse}</option>`;
            
            familyData.filter(p => p.Gender === 'ÿ∞ŸÉÿ±').forEach(person => {
                fatherSelect.innerHTML += `<option value="${person.PersonID}">${person.FullName} (${person.PersonID})</option>`;
            });
            
            familyData.filter(p => p.Gender === 'ÿßŸÜÿ´Ÿâ').forEach(person => {
                motherSelect.innerHTML += `<option value="${person.PersonID}">${person.FullName} (${person.PersonID})</option>`;
            });
            
            familyData.forEach(person => {
                spouseSelect.innerHTML += `<option value="${person.PersonID}">${person.FullName} (${person.PersonID})</option>`;
            });
        }

        function showAddPersonForm() {
            if (!checkPermission('add')) {
                showError('ŸÑÿß ÿ™ŸÖŸÑŸÉ ÿµŸÑÿßÿ≠Ÿäÿ© ÿßŸÑÿ•ÿ∂ÿßŸÅÿ©');
                return;
            }
            
            document.getElementById('formTitle').textContent = translations[currentLanguage].addPersonForm;
            document.getElementById('personForm').reset();
            document.getElementById('personId').value = '';
            document.getElementById('birthDate').value = '';
            document.getElementById('deathDate').value = '';
            updateDropdowns();
            document.getElementById('personFormModal').classList.add('active');
        }

        function editPerson(personId) {
            if (!checkPermission('edit')) {
                showError('ŸÑÿß ÿ™ŸÖŸÑŸÉ ÿµŸÑÿßÿ≠Ÿäÿ© ÿßŸÑÿ™ÿπÿØŸäŸÑ');
                return;
            }
            
            const person = familyData.find(p => p.PersonID === personId);
            if (!person) return;
            
            document.getElementById('formTitle').textContent = translations[currentLanguage].editPersonForm;
            document.getElementById('personId').value = person.PersonID;
            document.getElementById('fullName').value = person.FullName;
            document.getElementById('gender').value = person.Gender;
            document.getElementById('placeOfBirth').value = person.PlaceOfBirth || '';
            document.getElementById('birthDate').value = person.BirthDate || '';
            document.getElementById('deathDate').value = person.DeathDate || '';
            document.getElementById('fatherId').value = person.FatherID || 0;
            document.getElementById('motherId').value = person.MotherID || 0;
            document.getElementById('spouseId').value = person.SpouseID || 0;
            document.getElementById('notes').value = person.Notes || '';
            
            updateDropdowns();
            document.getElementById('personFormModal').classList.add('active');
        }

        function deletePerson(personId) {
            if (!checkPermission('delete')) {
                showError('ŸÑÿß ÿ™ŸÖŸÑŸÉ ÿµŸÑÿßÿ≠Ÿäÿ© ÿßŸÑÿ≠ÿ∞ŸÅ');
                return;
            }
            
            if (!confirm('ŸáŸÑ ÿ£ŸÜÿ™ ŸÖÿ™ÿ£ŸÉÿØ ŸÖŸÜ ÿ≠ÿ∞ŸÅ Ÿáÿ∞ÿß ÿßŸÑŸÅÿ±ÿØÿü')) return;
            
            const hasChildren = familyData.some(p => p.FatherID === personId || p.MotherID === personId);
            if (hasChildren) {
                if (!confirm('ÿ™ÿ≠ÿ∞Ÿäÿ±: Ÿáÿ∞ÿß ÿßŸÑŸÅÿ±ÿØ ŸÑÿØŸäŸá ÿ£ÿ®ŸÜÿßÿ°. ÿ≠ÿ∞ŸÅŸá ŸÇÿØ Ÿäÿ§ÿ´ÿ± ÿπŸÑŸâ ÿßŸÑÿπŸÑÿßŸÇÿßÿ™ ÿßŸÑÿπÿßÿ¶ŸÑŸäÿ©. ŸáŸÑ ÿ™ÿ±ŸäÿØ ÿßŸÑŸÖÿ™ÿßÿ®ÿπÿ©ÿü')) {
                    return;
                }
            }
            
            familyData = familyData.filter(p => p.PersonID !== personId);
            if (saveData()) {
                loadDashboard();
                showSuccess('ÿ™ŸÖ ÿ≠ÿ∞ŸÅ ÿßŸÑŸÅÿ±ÿØ ÿ®ŸÜÿ¨ÿßÿ≠');
            }
        }

        // ============================================
        // ÿØŸàÿßŸÑ ÿµŸÅÿ≠ÿ© ÿßŸÑŸÅÿ±ÿØ ÿßŸÑÿ™ŸÅÿµŸäŸÑŸäÿ©
        // ============================================

        function showPersonDetail(personId) {
            const person = familyData.find(p => p.PersonID === personId);
            if (!person) return;
            
            currentDetailPersonId = personId;
            document.getElementById('detailTitle').textContent = `${translations[currentLanguage].personInfo}: ${person.FullName}`;
            
            const father = familyData.find(p => p.PersonID === person.FatherID);
            const mother = familyData.find(p => p.PersonID === person.MotherID);
            const spouse = familyData.find(p => p.PersonID === person.SpouseID);
            const children = familyData.filter(p => p.FatherID === personId || p.MotherID === personId);
            const siblings = familyData.filter(p => 
                p.PersonID !== personId && (
                    (person.FatherID && person.FatherID !== 0 && p.FatherID === person.FatherID) ||
                    (person.MotherID && person.MotherID !== 0 && p.MotherID === person.MotherID)
                )
            );
            
            const detailHTML = `
                <div class="person-header">
                    <div class="person-avatar">
                        <i class="fas fa-${person.Gender === 'ÿ∞ŸÉÿ±' ? 'male' : 'female'}"></i>
                    </div>
                    <h2 class="person-name">${person.FullName}</h2>
                    <span class="person-id">ÿ±ŸÇŸÖ: ${person.PersonID}</span>
                </div>
                
                <div class="detail-sections">
                    <div class="detail-section">
                        <h3 class="section-title"><i class="fas fa-info-circle"></i> ÿßŸÑŸÖÿπŸÑŸàŸÖÿßÿ™ ÿßŸÑÿ¥ÿÆÿµŸäÿ©</h3>
                        <div class="detail-item">
                            <span class="detail-label">ÿßŸÑÿ¨ŸÜÿ≥:</span>
                            <span class="detail-value">${person.Gender === 'ÿ∞ŸÉÿ±' ? 'ÿ∞ŸÉÿ±' : 'ÿ£ŸÜÿ´Ÿâ'}</span>
                        </div>
                        <div class="detail-item">
                            <span class="detail-label">ŸÖŸÉÿßŸÜ ÿßŸÑŸÖŸäŸÑÿßÿØ:</span>
                            <span class="detail-value">${person.PlaceOfBirth || 'ÿ∫Ÿäÿ± ŸÖÿ≠ÿØÿØ'}</span>
                        </div>
                        <div class="detail-item">
                            <span class="detail-label">ÿ™ÿßÿ±ŸäÿÆ ÿßŸÑŸÖŸäŸÑÿßÿØ:</span>
                            <span class="detail-value">${formatDate(person.BirthDate) || 'ÿ∫Ÿäÿ± ŸÖÿ≠ÿØÿØ'}</span>
                        </div>
                        <div class="detail-item">
                            <span class="detail-label">ÿ™ÿßÿ±ŸäÿÆ ÿßŸÑŸàŸÅÿßÿ©:</span>
                            <span class="detail-value">${person.DeathDate ? formatDate(person.DeathDate) : 'ŸÑÿß ŸäŸàÿ¨ÿØ'}</span>
                        </div>
                    </div>
                    
                    <div class="detail-section">
                        <h3 class="section-title"><i class="fas fa-family"></i> ÿßŸÑÿπŸÑÿßŸÇÿßÿ™ ÿßŸÑÿπÿßÿ¶ŸÑŸäÿ©</h3>
                        <div class="detail-item">
                            <span class="detail-label">ÿßŸÑÿ£ÿ®:</span>
                            <span class="detail-value">${father ? `${father.FullName} (${father.PersonID})` : 'ÿ∫Ÿäÿ± ŸÖÿ≠ÿØÿØ'}</span>
                        </div>
                        <div class="detail-item">
                            <span class="detail-label">ÿßŸÑÿ£ŸÖ:</span>
                            <span class="detail-value">${mother ? `${mother.FullName} (${mother.PersonID})` : 'ÿ∫Ÿäÿ± ŸÖÿ≠ÿØÿØ'}</span>
                        </div>
                        <div class="detail-item">
                            <span class="detail-label">ÿßŸÑÿ≤Ÿàÿ¨/ÿßŸÑÿ≤Ÿàÿ¨ÿ©:</span>
                            <span class="detail-value">${spouse ? `${spouse.FullName} (${spouse.PersonID})` : 'ŸÑÿß ŸäŸàÿ¨ÿØ'}</span>
                        </div>
                    </div>
                    
                    <div class="detail-section">
                        <h3 class="section-title"><i class="fas fa-users"></i> ÿßŸÑÿ£ÿ®ŸÜÿßÿ° (${children.length})</h3>
                        ${children.length > 0 ? children.map(child => `
                            <div class="detail-item">
                                <span class="detail-label">${child.FullName}:</span>
                                <span class="detail-value">${child.Gender === 'ÿ∞ŸÉÿ±' ? 'ÿ∞ŸÉÿ±' : 'ÿ£ŸÜÿ´Ÿâ'} - ÿ±ŸÇŸÖ ${child.PersonID}</span>
                            </div>
                        `).join('') : `<p>ŸÑÿß ŸäŸàÿ¨ÿØ ÿ£ÿ®ŸÜÿßÿ°</p>`}
                    </div>
                    
                    <div class="detail-section">
                        <h3 class="section-title"><i class="fas fa-user-friends"></i> ÿßŸÑÿ£ÿÆŸàÿ© (${siblings.length})</h3>
                        ${siblings.length > 0 ? siblings.map(sibling => `
                            <div class="detail-item">
                                <span class="detail-label">${sibling.FullName}:</span>
                                <span class="detail-value">${sibling.Gender === 'ÿ∞ŸÉÿ±' ? 'ÿ∞ŸÉÿ±' : 'ÿ£ŸÜÿ´Ÿâ'} - ÿ±ŸÇŸÖ ${sibling.PersonID}</span>
                            </div>
                        `).join('') : `<p>ŸÑÿß ŸäŸàÿ¨ÿØ ÿ£ÿÆŸàÿ©</p>`}
                    </div>
                </div>
                
                ${person.Notes ? `
                <div class="detail-section" style="grid-column: 1 / -1;">
                    <h3 class="section-title"><i class="fas fa-sticky-note"></i> ŸÖŸÑÿßÿ≠ÿ∏ÿßÿ™</h3>
                    <p>${person.Notes}</p>
                </div>
                ` : ''}
            `;
            
            document.getElementById('personDetailContent').innerHTML = detailHTML;
            document.getElementById('personDetailModal').classList.add('active');
        }

        function closePersonDetail() {
            document.getElementById('personDetailModal').classList.remove('active');
        }

        function editCurrentPerson() {
            if (!checkPermission('edit')) {
                showError('ŸÑÿß ÿ™ŸÖŸÑŸÉ ÿµŸÑÿßÿ≠Ÿäÿ© ÿßŸÑÿ™ÿπÿØŸäŸÑ');
                return;
            }
            closePersonDetail();
            editPerson(currentDetailPersonId);
        }

        function printPersonDetail() {
            const printContent = document.getElementById('personDetailContent').innerHTML;
            const originalContent = document.body.innerHTML;
            
            document.body.innerHTML = `
                <div dir="${currentLanguage === 'ar' ? 'rtl' : 'ltr'}" style="padding: 20px; font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;">
                    <h1 style="text-align: center; color: #2E7D32;">ÿ¥ÿ¨ÿ±ÿ© ÿπÿßÿ¶ŸÑÿ© ŸÖÿ≠ŸÖÿØ ÿπÿ®ÿØÿßŸÑÿ±ÿ≠ŸÖŸÜ</h1>
                    ${printContent}
                </div>
            `;
            
            window.print();
            document.body.innerHTML = originalContent;
            location.reload();
        }

        // ============================================
        // ÿØŸàÿßŸÑ ÿßŸÑÿ™ÿ≠ŸÉŸÖ ÿßŸÑÿ±ÿ¶Ÿäÿ≥Ÿäÿ©
        // ============================================

        function loadDashboard() {
            document.querySelectorAll('.menu-item').forEach(item => item.classList.remove('active'));
            document.querySelector('.sidebar-menu li:first-child').classList.add('active');
            
            document.getElementById('totalPersons').textContent = familyData.length;
            document.getElementById('maleCount').textContent = familyData.filter(p => p.Gender === 'ÿ∞ŸÉÿ±').length;
            document.getElementById('femaleCount').textContent = familyData.filter(p => p.Gender === 'ÿßŸÜÿ´Ÿâ').length;
            
            const uniqueFamilies = familyData.filter(p => 
                p.FatherID === 0 && p.MotherID === 0 && !isOutsideFamily(p.PersonID)
            ).length;
            document.getElementById('familiesCount').textContent = uniqueFamilies;
            
            loadPersonsTable();
        }

        function showDashboard() {
            loadDashboard();
        }

        function showAllPersons() {
            document.querySelectorAll('.menu-item').forEach(item => item.classList.remove('active'));
            document.querySelector('.sidebar-menu li:nth-child(2)').classList.add('active');
            loadDashboard();
        }

        function showStatistics() {
            document.querySelectorAll('.menu-item').forEach(item => item.classList.remove('active'));
            document.querySelector('.sidebar-menu li:nth-child(5)').classList.add('active');
            loadDashboard();
        }

        function showSearch() {
            document.querySelectorAll('.menu-item').forEach(item => item.classList.remove('active'));
            document.querySelector('.sidebar-menu li:nth-child(4)').classList.add('active');
            loadDashboard();
        }

        function showBackup() {
            if (confirm('ŸáŸÑ ÿ™ÿ±ŸäÿØ ÿ™ÿµÿØŸäÿ± ŸÜÿ≥ÿÆÿ© ÿßÿ≠ÿ™Ÿäÿßÿ∑Ÿäÿ© ŸÖŸÜ ÿ¨ŸÖŸäÿπ ÿßŸÑÿ®ŸäÿßŸÜÿßÿ™ÿü')) {
                exportData('json');
            }
        }

        function loadPersonsTable() {
            const tableBody = document.getElementById('tableBody');
            if (!tableBody) return;
            
            let sortedData = [...familyData];
            sortedData.sort((a, b) => {
                return currentSortOrder === 'asc' ? a.PersonID - b.PersonID : b.PersonID - a.PersonID;
            });
            
            tableBody.innerHTML = '';
            
            sortedData.forEach(person => {
                const father = familyData.find(p => p.PersonID === person.FatherID);
                const mother = familyData.find(p => p.PersonID === person.MotherID);
                
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td>${person.PersonID}</td>
                    <td>${person.FullName}</td>
                    <td><span class="gender-badge ${person.Gender === 'ÿ∞ŸÉÿ±' ? 'male' : 'female'}">${person.Gender === 'ÿ∞ŸÉÿ±' ? 'ÿ∞ŸÉÿ±' : 'ÿ£ŸÜÿ´Ÿâ'}</span></td>
                    <td>${person.PlaceOfBirth || ''}</td>
                    <td>${father ? `${father.FullName} (${father.PersonID})` : ''}</td>
                    <td>${mother ? `${mother.FullName} (${mother.PersonID})` : ''}</td>
                    <td>
                        <div class="table-actions">
                            <button class="action-btn view" onclick="showPersonDetail(${person.PersonID})" title="ÿπÿ±ÿ∂ ÿßŸÑÿ™ŸÅÿßÿµŸäŸÑ">
                                <i class="fas fa-eye"></i>
                            </button>
                            <button class="action-btn edit" onclick="editPerson(${person.PersonID})" title="ÿ™ÿπÿØŸäŸÑ">
                                <i class="fas fa-edit"></i>
                            </button>
                            <button class="action-btn delete" onclick="deletePerson(${person.PersonID})" title="ÿ≠ÿ∞ŸÅ">
                                <i class="fas fa-trash"></i>
                            </button>
                        </div>
                    </td>
                `;
                tableBody.appendChild(row);
            });
        }

        function refreshData() {
            loadDashboard();
            if (document.getElementById('treeView').classList.contains('active')) {
                renderTree();
            }
            showSuccess('ÿ™ŸÖ ÿ™ÿ≠ÿØŸäÿ´ ÿßŸÑÿ®ŸäÿßŸÜÿßÿ™ ÿ®ŸÜÿ¨ÿßÿ≠');
        }

        function toggleSortOrder() {
            currentSortOrder = currentSortOrder === 'asc' ? 'desc' : 'asc';
            loadPersonsTable();
            showSuccess(`ÿ™ŸÖ ÿ™ÿ∫ŸäŸäÿ± ÿßŸÑÿ™ÿ±ÿ™Ÿäÿ® ÿ•ŸÑŸâ ${currentSortOrder === 'asc' ? 'ÿ™ÿµÿßÿπÿØŸä' : 'ÿ™ŸÜÿßÿ≤ŸÑŸä'}`);
        }

        function closePersonForm() {
            document.getElementById('personFormModal').classList.remove('active');
        }

        // ============================================
        // ÿØŸàÿßŸÑ ŸÉÿ™ÿßÿ® ÿßŸÑÿπÿßÿ¶ŸÑÿ© ÿßŸÑŸÖÿ≠ÿ≥ŸÜÿ©
        // ============================================

        function showFamilyBook() {
            document.getElementById('familyBookModal').classList.add('active');
            generateFamilyBook();
        }

        function closeFamilyBook() {
            document.getElementById('familyBookModal').classList.remove('active');
        }

        function generateFamilyBook() {
            const preview = document.getElementById('bookPreview');
            if (!preview) {
                showError('ŸÑŸÖ Ÿäÿ™ŸÖ ÿßŸÑÿπÿ´Ÿàÿ± ÿπŸÑŸâ ŸÖŸÜÿ∑ŸÇÿ© ÿßŸÑŸÖÿπÿßŸäŸÜÿ©');
                return;
            }

            preview.innerHTML = '';
            const shell = document.createElement('div');
            shell.className = 'book-shell';
            preview.appendChild(shell);

            // ÿßŸÑÿµŸÅÿ≠ÿ© ÿßŸÑÿ£ŸàŸÑŸâ: ÿßŸÑÿ∫ŸÑÿßŸÅ
            const cover = document.createElement('section');
            cover.className = 'book-page book-cover';
            cover.innerHTML = `
                <div class="book-watermark">
                    <i class="fas fa-feather-alt"></i>
                    <span>ÿ¥ÿ¨ÿ±ÿ© ÿπÿßÿ¶ŸÑÿ© ŸÖÿ≠ŸÖÿØ ÿπÿ®ÿØÿßŸÑÿ±ÿ≠ŸÖŸÜ</span>
                </div>
                <div class="book-cover">
                    <h1 class="book-title">üìò ŸÉÿ™ÿßÿ® ÿßŸÑÿπÿßÿ¶ŸÑÿ©</h1>
                    <h2 class="book-subtitle">ÿπÿßÿ¶ŸÑÿ© ŸÖÿ≠ŸÖÿØ ÿπÿ®ÿØÿßŸÑÿ±ÿ≠ŸÖŸÜ (ÿ£ÿ®ÿß)</h2>
                    <div style="margin-top: 100px;">
                        <p>ÿ™ÿßÿ±ŸäÿÆ ÿßŸÑÿ•ÿµÿØÿßÿ±: ${new Date().toLocaleDateString('ar-EG')}</p>
                        <p>ÿπÿØÿØ ÿßŸÑÿ£ŸÅÿ±ÿßÿØ: ${familyData.length}</p>
                        <p>ÿπÿØÿØ ÿßŸÑÿ£ÿ¨ŸäÿßŸÑ: ${new Set(familyData.map(p => calculateGeneration(p.PersonID))).size}</p>
                    </div>
                    <div class="book-badge">
                        <span style="font-size: 20px;">üå≥</span>
                        <span>ŸÜÿ≥ÿÆÿ© ÿ¥ÿßŸÖŸÑÿ© ÿ™ÿ≠ÿØŸäÿ´ ÿ™ŸÑŸÇÿßÿ¶Ÿä</span>
                    </div>
                </div>
            `;
            shell.appendChild(cover);

            // ÿßŸÑÿµŸÅÿ≠ÿ© ÿßŸÑÿ´ÿßŸÜŸäÿ©: ÿßŸÑŸÅŸáÿ±ÿ≥
            const indexPage = document.createElement('section');
            indexPage.className = 'book-page';
            indexPage.innerHTML = `
                <div class="book-watermark">
                    <i class="fas fa-list"></i>
                    <span>ŸÅŸáÿ±ÿ≥ ÿßŸÑŸÖÿ≠ÿ™ŸàŸäÿßÿ™</span>
                </div>
                <h2 style="text-align: center; margin-bottom: 30px;">üìë ŸÅŸáÿ±ÿ≥ ÿßŸÑŸÖÿ≠ÿ™ŸàŸäÿßÿ™</h2>
                <div style="margin-right: 50px;">
                    ${Object.entries(organizeByGeneration()).map(([gen, persons]) => `
                        <div style="margin-bottom: 10px; font-size: 16px;">
                            <a href="#gen-${gen}" style="color: #4CAF50; text-decoration: none;">
                                <i class="fas fa-layer-group"></i> ÿßŸÑÿ¨ŸäŸÑ ${gen} - ${persons.length} ŸÅÿ±ÿØ
                            </a>
                        </div>
                    `).join('')}
                    <div style="margin-top: 20px; padding-top: 20px; border-top: 2px solid #eee;">
                        <h3>ÿ•ÿ≠ÿµÿßÿ¶Ÿäÿßÿ™ ÿßŸÑÿπÿßÿ¶ŸÑÿ©</h3>
                        <p><i class="fas fa-users"></i> ÿ•ÿ¨ŸÖÿßŸÑŸä ÿßŸÑÿ£ŸÅÿ±ÿßÿØ: <b>${familyData.length}</b></p>
                        <p><i class="fas fa-male"></i> ÿπÿØÿØ ÿßŸÑÿ∞ŸÉŸàÿ±: <b>${familyData.filter(p => p.Gender === 'ÿ∞ŸÉÿ±').length}</b></p>
                        <p><i class="fas fa-female"></i> ÿπÿØÿØ ÿßŸÑÿ•ŸÜÿßÿ´: <b>${familyData.filter(p => p.Gender === 'ÿßŸÜÿ´Ÿâ').length}</b></p>
                        <p><i class="fas fa-heart"></i> ÿπÿØÿØ ÿßŸÑŸÖÿ™ÿ≤Ÿàÿ¨ŸäŸÜ: <b>${familyData.filter(p => p.SpouseID !== 0).length}</b></p>
                        <p><i class="fas fa-home"></i> ÿπÿØÿØ ÿßŸÑÿπÿßÿ¶ŸÑÿßÿ™: <b>${familyData.filter(p => p.FatherID === 0 && p.MotherID === 0 && !isOutsideFamily(p.PersonID)).length}</b></p>
                    </div>
                </div>
            `;
            shell.appendChild(indexPage);

            // ÿµŸÅÿ≠ÿßÿ™ ÿßŸÑÿ£ÿ¨ŸäÿßŸÑ
            const generations = organizeByGeneration();
            const ITEMS_PER_PAGE = 12;

            Object.keys(generations).forEach(genKey => {
                const personsInGeneration = generations[genKey];
                const totalPages = Math.ceil(personsInGeneration.length / ITEMS_PER_PAGE);
                
                for (let pageNum = 0; pageNum < totalPages; pageNum++) {
                    const startIdx = pageNum * ITEMS_PER_PAGE;
                    const endIdx = Math.min(startIdx + ITEMS_PER_PAGE, personsInGeneration.length);
                    const pagePersons = personsInGeneration.slice(startIdx, endIdx);
                    
                    const pageSuffix = totalPages > 1 ? ` (ÿµŸÅÿ≠ÿ© ${pageNum + 1} ŸÖŸÜ ${totalPages})` : '';
                    
                    const page = document.createElement('section');
                    page.className = 'book-page';
                    page.id = `gen-${genKey}-page-${pageNum}`;
                    page.innerHTML = `
                        <div class="book-watermark">
                            <i class="fas fa-tree"></i>
                            <span>ÿßŸÑÿ¨ŸäŸÑ ${genKey}</span>
                        </div>
                        <h2 class="book-generation-title">
                            <i class="fas fa-layer-group"></i> 
                            ÿßŸÑÿ¨ŸäŸÑ ${genKey}${pageSuffix}
                            <span style="font-size: 14px; color: #666; margin-right: 10px;">
                                (ÿßŸÑÿ£ŸÅÿ±ÿßÿØ ${startIdx + 1} - ${endIdx} ŸÖŸÜ ${personsInGeneration.length})
                            </span>
                        </h2>
                        <div class="book-grid">
                            ${pagePersons.map(person => renderBookPersonCard(person)).join('')}
                        </div>
                    `;
                    
                    if (pageNum === 0) {
                        page.id = `gen-${genKey}`;
                    }
                    
                    shell.appendChild(page);
                }
            });

            // ÿµŸÅÿ≠ÿ© ŸÅŸáÿ±ÿ≥ ÿ¨ŸÖŸäÿπ ÿßŸÑÿ£ŸÅÿ±ÿßÿØ
            if (familyData.length > 0) {
                const allPersonsPage = document.createElement('section');
                allPersonsPage.className = 'book-page';
                allPersonsPage.id = 'all-persons-index';
                allPersonsPage.innerHTML = `
                    <div class="book-watermark">
                        <i class="fas fa-address-book"></i>
                        <span>ŸÅŸáÿ±ÿ≥ ÿ¨ŸÖŸäÿπ ÿßŸÑÿ£ŸÅÿ±ÿßÿØ</span>
                    </div>
                    <h2 class="book-generation-title" style="color: #2196F3;">
                        <i class="fas fa-address-book"></i>
                        ŸÅŸáÿ±ÿ≥ ÿ¨ŸÖŸäÿπ ÿßŸÑÿ£ŸÅÿ±ÿßÿØ (ŸÖÿ±ÿ™ÿ® ÿ£ÿ®ÿ¨ÿØŸäÿßŸã)
                    </h2>
                    <div style="columns: 2; column-gap: 40px;">
                        ${[...familyData]
                            .sort((a, b) => a.FullName.localeCompare(b.FullName, 'ar'))
                            .map(person => `
                                <div style="margin-bottom: 8px; page-break-inside: avoid;">
                                    <a href="#gen-${calculateGeneration(person.PersonID)}" 
                                       style="color: ${person.Gender === 'ÿ∞ŸÉÿ±' ? '#2196F3' : '#E91E63'}; text-decoration: none;"
                                       onclick="scrollToGenerationInBook(${person.PersonID})">
                                        <i class="fas fa-${person.Gender === 'ÿ∞ŸÉÿ±' ? 'male' : 'female'}"></i>
                                        ${person.FullName} (ÿ±ŸÇŸÖ: ${person.PersonID})
                                    </a>
                                </div>
                            `).join('')}
                    </div>
                `;
                shell.appendChild(allPersonsPage);
            }

            showSuccess(`ÿ™ŸÖ ÿ•ŸÜÿ¥ÿßÿ° ŸÉÿ™ÿßÿ® ÿßŸÑÿπÿßÿ¶ŸÑÿ© ÿ®ŸÜÿ¨ÿßÿ≠ Ÿäÿ≠ÿ™ŸàŸä ÿπŸÑŸâ ${Object.keys(generations).length} ÿ¨ŸäŸÑ${Object.keys(generations).length > 1 ? 'ÿßÿ™' : ''}`);
        }

        function renderBookPersonCard(person) {
            const father = familyData.find(p => p.PersonID === person.FatherID);
            const mother = familyData.find(p => p.PersonID === person.MotherID);
            const spouse = familyData.find(p => p.PersonID === person.SpouseID);
            const children = familyData.filter(p => p.FatherID === person.PersonID || p.MotherID === person.PersonID);
            
            const age = computeAge(person.BirthDate);
            
            return `
                <div class="book-card book-member-card" 
                     onclick="highlightBookLineage(${person.PersonID})" 
                     data-book-person-id="${person.PersonID}"
                     data-book-search="${person.FullName || ''} ${person.PersonID} ${person.PlaceOfBirth || ''} ${person.Notes || ''} ${person.BirthDate || ''} ${person.DeathDate || ''}">
                    
                    <div class="book-card-header">
                        <div class="book-card-id">#${person.PersonID}</div>
                        <div class="book-card-gender ${person.Gender === 'ÿ∞ŸÉÿ±' ? 'male' : 'female'}">
                            ${person.Gender === 'ÿ∞ŸÉÿ±' ? 'ÿ∞ŸÉÿ±' : 'ÿ£ŸÜÿ´Ÿâ'}
                        </div>
                    </div>
                    
                    <h3 class="book-card-name">${person.FullName}</h3>
                    
                    <div class="book-card-details">
                        ${person.BirthDate ? `
                            <div class="book-card-detail">
                                <i class="fas fa-star-and-crescent"></i>
                                <span>ÿßŸÑŸÖŸàŸÑÿØ: ${formatDateDisplay(person.BirthDate)} ${age ? `(${age} ÿ≥ŸÜÿ©)` : ''}</span>
                            </div>
                        ` : ''}
                        
                        ${person.DeathDate ? `
                            <div class="book-card-detail">
                                <i class="fas fa-kaaba"></i>
                                <span>ÿßŸÑŸàŸÅÿßÿ©: ${formatDateDisplay(person.DeathDate)}</span>
                            </div>
                        ` : ''}
                        
                        ${person.PlaceOfBirth ? `
                            <div class="book-card-detail">
                                <i class="fas fa-map-marker-alt"></i>
                                <span>${person.PlaceOfBirth}</span>
                            </div>
                        ` : ''}
                        
                        ${father ? `
                            <div class="book-card-detail">
                                <i class="fas fa-male"></i>
                                <span>ÿßŸÑÿ£ÿ®: ${father.FullName}</span>
                            </div>
                        ` : ''}
                        
                        ${mother ? `
                            <div class="book-card-detail">
                                <i class="fas fa-female"></i>
                                <span>ÿßŸÑÿ£ŸÖ: ${mother.FullName}</span>
                            </div>
                        ` : ''}
                        
                        ${spouse ? `
                            <div class="book-card-detail">
                                <i class="fas fa-heart"></i>
                                <span>ÿßŸÑÿ≤Ÿàÿ¨/ÿßŸÑÿ≤Ÿàÿ¨ÿ©: ${spouse.FullName}</span>
                            </div>
                        ` : ''}
                        
                        ${children.length > 0 ? `
                            <div class="book-card-detail">
                                <i class="fas fa-child"></i>
                                <span>ÿßŸÑÿ£ÿ®ŸÜÿßÿ°: ${children.length} ŸÅÿ±ÿØ</span>
                            </div>
                        ` : ''}
                        
                        ${person.Notes ? `
                            <div class="book-card-detail">
                                <i class="fas fa-sticky-note"></i>
                                <span>${person.Notes}</span>
                            </div>
                        ` : ''}
                    </div>
                </div>
            `;
        }

        function scrollToGenerationInBook(personId) {
            const generation = calculateGeneration(personId);
            const genElement = document.getElementById(`gen-${generation}`);
            if (genElement) {
                genElement.scrollIntoView({ behavior: 'smooth' });
                highlightBookLineage(personId);
            }
        }

        // ============================================
        // ÿ®ÿ≠ÿ´ ÿ≥ÿ±Ÿäÿπ ÿØÿßÿÆŸÑ ŸÉÿ™ÿßÿ® ÿßŸÑÿπÿßÿ¶ŸÑÿ©
        // ============================================

        function normalizeArabic(str) {
            if (!str) return '';
            return String(str)
                .toLowerCase()
                .replace(/[ÿ•ÿ£ÿ¢ÿß]/g, 'ÿß')
                .replace(/[Ÿâ]/g, 'Ÿä')
                .replace(/[ÿ§]/g, 'Ÿà')
                .replace(/[ÿ¶]/g, 'Ÿä')
                .replace(/[ÿ©]/g, 'Ÿá')
                .replace(/[Ÿã-ŸüŸ∞]/g, '')
                .replace(/\s+/g, ' ')
                .trim();
        }

        function clearBookSearch() {
            const input = document.getElementById('bookSearchInput');
            if (input) input.value = '';
            document.querySelectorAll('.book-member-card').forEach(card => {
                card.classList.remove('book-hidden', 'book-match');
                unmarkElement(card);
            });
        }

        function unmarkElement(root) {
            if (!root) return;
            const marks = root.querySelectorAll('mark.book-mark');
            marks.forEach(m => {
                const text = document.createTextNode(m.textContent);
                m.parentNode.replaceChild(text, m);
                m.parentNode.normalize();
            });
        }

        function markMatchesInElement(root, query) {
            const nameEl = root.querySelector('h4');
            if (!nameEl) return;
            unmarkElement(nameEl);

            const text = nameEl.textContent;
            const normText = normalizeArabic(text);
            const normQ = normalizeArabic(query);
            if (!normQ) return;

            const idx = normText.indexOf(normQ);
            if (idx === -1) return;

            const safeQ = query.replace(/[.*+?^${}()|[\]\\]/g, '\\$&');
            const rx = new RegExp(safeQ, 'gi');
            nameEl.innerHTML = nameEl.innerHTML.replace(rx, (m) => `<mark class="book-mark">${m}</mark>`);
        }

        function searchFamilyBook() {
            const input = document.getElementById('bookSearchInput');
            const q = input ? input.value : '';
            const nq = normalizeArabic(q);

            const cards = document.querySelectorAll('.book-member-card');
            if (!nq) {
                cards.forEach(card => {
                    card.classList.remove('book-hidden', 'book-match');
                    unmarkElement(card);
                });
                return;
            }

            let firstMatch = null;
            cards.forEach(card => {
                const hay = normalizeArabic(card.getAttribute('data-book-search') || '');
                const isMatch = hay.includes(nq);
                card.classList.toggle('book-hidden', !isMatch);
                card.classList.toggle('book-match', isMatch);

                if (isMatch && !firstMatch) firstMatch = card;
                if (isMatch) markMatchesInElement(card, q);
                else unmarkElement(card);
            });

            if (firstMatch) {
                firstMatch.scrollIntoView({ behavior: 'smooth', block: 'center' });
            }
        }

        // ============================================
        // ÿßŸÑÿ™ŸÅÿßÿπŸÑ ÿØÿßÿÆŸÑ ŸÉÿ™ÿßÿ® ÿßŸÑÿπÿßÿ¶ŸÑÿ©
        // ============================================

        function onBookPersonClick(evt, personId) {
            if (evt) evt.stopPropagation();
            highlightBookLineage(personId);
            highlightLineage(personId);
            const node = document.querySelector(`.tree-node[data-person-id="${personId}"]`);
            if (node) node.scrollIntoView({ behavior: 'smooth', block: 'center', inline: 'center' });
        }

        function clearBookLineage() {
            document.querySelectorAll('.book-member-card').forEach(card => {
                card.classList.remove('book-card-dimmed','book-card-selected','book-card-ancestor','book-card-descendant');
            });
        }

        function highlightBookLineage(personId) {
            clearBookLineage();
            const cards = Array.from(document.querySelectorAll('.book-member-card'));
            if (!cards.length) return;

            const ancestors = getAncestors(personId);
            const descendants = getDescendants(personId);

            cards.forEach(c => c.classList.add('book-card-dimmed'));

            const sel = document.querySelector(`.book-member-card[data-book-person-id="${personId}"]`);
            if (sel) {
                sel.classList.remove('book-card-dimmed');
                sel.classList.add('book-card-selected');
                sel.scrollIntoView({ behavior: 'smooth', block: 'center' });
            }

            ancestors.forEach(id => {
                const el = document.querySelector(`.book-member-card[data-book-person-id="${id}"]`);
                if (el) {
                    el.classList.remove('book-card-dimmed');
                    el.classList.add('book-card-ancestor');
                }
            });

            descendants.forEach(id => {
                const el = document.querySelector(`.book-member-card[data-book-person-id="${id}"]`);
                if (el) {
                    el.classList.remove('book-card-dimmed');
                    el.classList.add('book-card-descendant');
                }
            });
        }

        function exportFamilyBook() {
            const element = document.getElementById('bookPreview');
            const opt = {
                margin: [10, 10, 10, 10],
                filename: `ŸÉÿ™ÿßÿ®-ÿßŸÑÿπÿßÿ¶ŸÑÿ©-${new Date().toISOString().split('T')[0]}.pdf`,
                image: { type: 'jpeg', quality: 0.98 },
                html2canvas: { scale: 2, useCORS: true },
                jsPDF: { unit: 'mm', format: 'a4', orientation: 'portrait' }
            };
            
            html2pdf().set(opt).from(element).save();
            showSuccess('ÿ™ŸÖ ÿ™ÿµÿØŸäÿ± ŸÉÿ™ÿßÿ® ÿßŸÑÿπÿßÿ¶ŸÑÿ© ÿ®ŸÜÿ¨ÿßÿ≠');
        }

        function printFamilyBook() {
            window.print();
        }

        function toggleBookCompact() {
            const bookGrid = document.querySelector('.book-grid');
            if (bookGrid) {
                bookGrid.classList.toggle('compact');
            }
        }

        function applyBrandingFromInput() {
            const input = document.getElementById('familyBrandNameInput');
            const brandName = input.value.trim();
            if (brandName) {
                document.querySelectorAll('.book-title, .book-subtitle').forEach(el => {
                    if (el.classList.contains('book-title')) {
                        el.textContent = `ŸÉÿ™ÿßÿ® ÿπÿßÿ¶ŸÑÿ© ${brandName}`;
                    } else if (el.classList.contains('book-subtitle')) {
                        el.textContent = `ÿπÿßÿ¶ŸÑÿ© ${brandName}`;
                    }
                });
                showSuccess(`ÿ™ŸÖ ÿ™ÿ∑ÿ®ŸäŸÇ ŸáŸàŸäÿ© ÿπÿßÿ¶ŸÑÿ© ${brandName}`);
            }
        }

        // ============================================
        // ÿØŸàÿßŸÑ ÿ•ÿØÿßÿ±ÿ© ÿßŸÑÿµŸÑÿßÿ≠Ÿäÿßÿ™
        // ============================================

        function showPermissions() {
            if (!checkPermission('manage_users')) {
                showError('ŸÑÿß ÿ™ŸÖŸÑŸÉ ÿµŸÑÿßÿ≠Ÿäÿ© ÿßŸÑŸàÿµŸàŸÑ ÿ•ŸÑŸâ ÿ•ÿØÿßÿ±ÿ© ÿßŸÑÿµŸÑÿßÿ≠Ÿäÿßÿ™');
                return;
            }
            
            document.getElementById('permissionsModal').classList.add('active');
            loadUsersList();
        }

        function closePermissionsModal() {
            document.getElementById('permissionsModal').classList.remove('active');
        }

        function loadUsersList() {
            const usersList = document.getElementById('usersList');
            usersList.innerHTML = '';
            
            Object.keys(users).forEach(username => {
                const user = users[username];
                const tr = document.createElement('tr');
                tr.innerHTML = `
                    <td>${user.name} (${username})</td>
                    <td>${user.role === 'admin' ? 'ŸÖÿØŸäÿ±' : user.role === 'host' ? 'ŸÖÿ∂ŸäŸÅ' : 'ŸÖÿ≥ÿ™ÿÆÿØŸÖ'}</td>
                    <td>${new Date().toLocaleDateString('ar-EG')}</td>
                    <td>
                        ${username !== 'admin' ? `
                        <button class="action-btn delete" onclick="deleteUser('${username}')" title="ÿ≠ÿ∞ŸÅ">
                            <i class="fas fa-trash"></i>
                        </button>
                        ` : 'ŸÑÿß ŸäŸÖŸÉŸÜ ÿ≠ÿ∞ŸÅ ÿßŸÑŸÖÿØŸäÿ± ÿßŸÑÿ±ÿ¶Ÿäÿ≥Ÿä'}
                    </td>
                `;
                usersList.appendChild(tr);
            });
        }

        function addNewUser() {
            const username = document.getElementById('newUsername').value;
            const password = document.getElementById('newPassword').value;
            const role = document.getElementById('newUserRole').value;
            
            if (!username || !password) {
                showError('Ÿäÿ¨ÿ® ÿ•ÿØÿÆÿßŸÑ ÿßÿ≥ŸÖ ÿßŸÑŸÖÿ≥ÿ™ÿÆÿØŸÖ ŸàŸÉŸÑŸÖÿ© ÿßŸÑŸÖÿ±Ÿàÿ±');
                return;
            }
            
            if (users[username]) {
                showError('ÿßÿ≥ŸÖ ÿßŸÑŸÖÿ≥ÿ™ÿÆÿØŸÖ ŸÖŸàÿ¨ŸàÿØ ÿ®ÿßŸÑŸÅÿπŸÑ');
                return;
            }
            
            users[username] = {
                password: password,
                name: username,
                role: role
            };
            
            localStorage.setItem('familyTreeUsers', JSON.stringify(users));
            
            document.getElementById('newUsername').value = '';
            document.getElementById('newPassword').value = '';
            
            loadUsersList();
            showSuccess('ÿ™ŸÖ ÿ•ÿ∂ÿßŸÅÿ© ÿßŸÑŸÖÿ≥ÿ™ÿÆÿØŸÖ ÿ®ŸÜÿ¨ÿßÿ≠');
        }

        function deleteUser(username) {
            if (username === 'admin') {
                showError('ŸÑÿß ŸäŸÖŸÉŸÜ ÿ≠ÿ∞ŸÅ ÿßŸÑŸÖÿØŸäÿ± ÿßŸÑÿ±ÿ¶Ÿäÿ≥Ÿä');
                return;
            }
            
            if (confirm(`ŸáŸÑ ÿ™ÿ±ŸäÿØ ÿ≠ÿ∞ŸÅ ÿßŸÑŸÖÿ≥ÿ™ÿÆÿØŸÖ ${username}ÿü`)) {
                delete users[username];
                localStorage.setItem('familyTreeUsers', JSON.stringify(users));
                loadUsersList();
                showSuccess('ÿ™ŸÖ ÿ≠ÿ∞ŸÅ ÿßŸÑŸÖÿ≥ÿ™ÿÆÿØŸÖ ÿ®ŸÜÿ¨ÿßÿ≠');
            }
        }

        // ============================================
        // ÿØŸàÿßŸÑ ÿßŸÑÿ™ÿ¥ŸÅŸäÿ±
        // ============================================

        function encryptCurrentData() {
            const password = document.getElementById('encryptPassword').value;
            const confirmPassword = document.getElementById('encryptConfirmPassword').value;
            
            if (!password || password.length < 4) {
                showError('ŸÉŸÑŸÖÿ© ÿßŸÑŸÖÿ±Ÿàÿ± Ÿäÿ¨ÿ® ÿ£ŸÜ ÿ™ŸÉŸàŸÜ 4 ÿ£ÿ≠ÿ±ŸÅ ÿπŸÑŸâ ÿßŸÑÿ£ŸÇŸÑ');
                return;
            }
            
            if (password !== confirmPassword) {
                showError('ŸÉŸÑŸÖÿßÿ™ ÿßŸÑŸÖÿ±Ÿàÿ± ÿ∫Ÿäÿ± ŸÖÿ™ÿ∑ÿßÿ®ŸÇÿ©');
                return;
            }
            
            if (confirm('ÿ™ÿ≠ÿ∞Ÿäÿ±: ÿ≥Ÿäÿ™ŸÖ ÿ™ÿ¥ŸÅŸäÿ± ÿ¨ŸÖŸäÿπ ÿßŸÑÿ®ŸäÿßŸÜÿßÿ™. ŸÑÿß ŸäŸÖŸÉŸÜ ÿßÿ≥ÿ™ÿπÿßÿØÿ™Ÿáÿß ÿ®ÿØŸàŸÜ ŸÉŸÑŸÖÿ© ÿßŸÑŸÖÿ±Ÿàÿ±. ŸáŸÑ ÿ™ÿ±ŸäÿØ ÿßŸÑŸÖÿ™ÿßÿ®ÿπÿ©ÿü')) {
                try {
                    const dataString = JSON.stringify(familyData);
                    const encryptedData = encryptText(dataString, password);
                    
                    localStorage.setItem('familyData', encryptedData);
                    localStorage.setItem('isDataEncrypted', 'true');
                    
                    isDataEncrypted = true;
                    encryptionPassword = password;
                    
                    document.getElementById('encryptPassword').value = '';
                    document.getElementById('encryptConfirmPassword').value = '';
                    
                    showSuccess('ÿ™ŸÖ ÿ™ÿ¥ŸÅŸäÿ± ÿßŸÑÿ®ŸäÿßŸÜÿßÿ™ ÿ®ŸÜÿ¨ÿßÿ≠');
                    updateEncryptionStatus();
                } catch (error) {
                    showError('ŸÅÿ¥ŸÑ ÿ™ÿ¥ŸÅŸäÿ± ÿßŸÑÿ®ŸäÿßŸÜÿßÿ™: ' + error.message);
                }
            }
        }

        function decryptCurrentData() {
            const password = prompt('ÿ£ÿØÿÆŸÑ ŸÉŸÑŸÖÿ© ÿßŸÑŸÖÿ±Ÿàÿ± ŸÑŸÅŸÉ ÿ™ÿ¥ŸÅŸäÿ± ÿßŸÑÿ®ŸäÿßŸÜÿßÿ™:');
            if (!password) return;
            
            try {
                const encryptedData = localStorage.getItem('familyData');
                if (!encryptedData) {
                    showError('ŸÑÿß ÿ™Ÿàÿ¨ÿØ ÿ®ŸäÿßŸÜÿßÿ™ ŸÖÿ¥ŸÅÿ±ÿ©');
                    return;
                }
                
                const decryptedText = decryptText(encryptedData, password);
                const decryptedData = JSON.parse(decryptedText);
                
                familyData = decryptedData;
                isDataEncrypted = false;
                encryptionPassword = '';
                
                localStorage.setItem('familyData', JSON.stringify(decryptedData));
                localStorage.setItem('isDataEncrypted', 'false');
                
                showSuccess('ÿ™ŸÖ ŸÅŸÉ ÿ™ÿ¥ŸÅŸäÿ± ÿßŸÑÿ®ŸäÿßŸÜÿßÿ™ ÿ®ŸÜÿ¨ÿßÿ≠');
                updateEncryptionStatus();
                loadDashboard();
            } catch (error) {
                showError('ŸÅÿ¥ŸÑ ŸÅŸÉ ÿ™ÿ¥ŸÅŸäÿ± ÿßŸÑÿ®ŸäÿßŸÜÿßÿ™: ' + error.message);
            }
        }

        function removeEncryption() {
            if (!isDataEncrypted) {
                showError('ÿßŸÑÿ®ŸäÿßŸÜÿßÿ™ ÿ∫Ÿäÿ± ŸÖÿ¥ŸÅÿ±ÿ© ÿ≠ÿßŸÑŸäÿßŸã');
                return;
            }
            
            if (confirm('ÿ™ÿ≠ÿ∞Ÿäÿ±: ÿ•ÿ≤ÿßŸÑÿ© ÿßŸÑÿ™ÿ¥ŸÅŸäÿ± ÿ≥ÿ™ÿπÿ±ÿ∂ ÿßŸÑÿ®ŸäÿßŸÜÿßÿ™ ŸÑŸÑŸÇÿ±ÿßÿ°ÿ© ÿ®ÿØŸàŸÜ ÿ≠ŸÖÿßŸäÿ©. ŸáŸÑ ÿ™ÿ±ŸäÿØ ÿßŸÑŸÖÿ™ÿßÿ®ÿπÿ©ÿü')) {
                try {
                    localStorage.setItem('familyData', JSON.stringify(familyData));
                    localStorage.setItem('isDataEncrypted', 'false');
                    
                    isDataEncrypted = false;
                    encryptionPassword = '';
                    
                    showSuccess('ÿ™ŸÖ ÿ•ÿ≤ÿßŸÑÿ© ÿßŸÑÿ™ÿ¥ŸÅŸäÿ± ÿ®ŸÜÿ¨ÿßÿ≠');
                    updateEncryptionStatus();
                } catch (error) {
                    showError('ŸÅÿ¥ŸÑ ÿ•ÿ≤ÿßŸÑÿ© ÿßŸÑÿ™ÿ¥ŸÅŸäÿ±: ' + error.message);
                }
            }
        }

        function updateEncryptionStatus() {
            const statusElement = document.getElementById('encryptionAlert');
            const messageElement = document.getElementById('encryptionMessage');
            
            if (isDataEncrypted) {
                statusElement.className = 'alert success';
                messageElement.innerHTML = `
                    <strong>‚úì ÿßŸÑÿ®ŸäÿßŸÜÿßÿ™ ŸÖÿ¥ŸÅÿ±ÿ©</strong><br>
                    <small>ÿ¨ŸÖŸäÿπ ÿßŸÑÿ®ŸäÿßŸÜÿßÿ™ ŸÖÿ≠ŸÖŸäÿ© ÿ®ÿ™ÿ¥ŸÅŸäÿ± ÿ¢ŸÖŸÜ</small>
                `;
            } else {
                statusElement.className = 'alert warning';
                messageElement.innerHTML = `
                    <strong>‚ö† ÿßŸÑÿ®ŸäÿßŸÜÿßÿ™ ÿ∫Ÿäÿ± ŸÖÿ¥ŸÅÿ±ÿ©</strong><br>
                    <small>ŸäŸàÿµŸâ ÿ®ÿ™ÿ¥ŸÅŸäÿ± ÿßŸÑÿ®ŸäÿßŸÜÿßÿ™ ŸÑÿ≠ŸÖÿßŸäÿ™Ÿáÿß</small>
                `;
            }
            statusElement.style.display = 'flex';
        }

        function showEncryptionSettings() {
            document.querySelectorAll('.menu-item').forEach(item => item.classList.remove('active'));
            document.querySelector('.sidebar-menu li:nth-child(12)').classList.add('active');
            document.getElementById('encryptionModal').classList.add('active');
            updateEncryptionStatus();
        }

        function closeEncryptionModal() {
            document.getElementById('encryptionModal').classList.remove('active');
        }

        // ============================================
        // ÿØŸàÿßŸÑ ÿßŸÑÿ¥ÿ¨ÿ±ÿ©
        // ============================================

        function showTreeView() {
            document.getElementById('treeView').classList.add('active');
            treeZoom = 100;
            treeCompactMode = false;
            renderTree();
            setupTreeScrollListener();
            setupMobileSearch();
        }

        function closeTreeView() {
            document.getElementById('treeView').classList.remove('active');
        }

        function renderTree() {
            const container = document.getElementById('treeContainer');
            if (familyData.length === 0) {
                container.innerHTML = `
                    <div class="empty-message">
                        <i class="fas fa-tree"></i>
                        <h3>ŸÑÿß ÿ™Ÿàÿ¨ÿØ ÿ®ŸäÿßŸÜÿßÿ™ ŸÑŸÑÿπÿ±ÿ∂</h3>
                        <p>ÿ£ÿ∂ŸÅ ÿ£ŸÅÿ±ÿßÿØÿßŸã ÿ•ŸÑŸâ ÿßŸÑÿπÿßÿ¶ŸÑÿ© ŸÑÿπÿ±ÿ∂ ÿßŸÑÿ¥ÿ¨ÿ±ÿ©</p>
                    </div>
                `;
                return;
            }
            
            container.innerHTML = '<div class="tree-wrapper" id="treeWrapper"></div>';
            const treeWrapper = document.getElementById('treeWrapper');
            const generations = organizeByGeneration();
            
            Object.keys(generations).forEach(genKey => {
                const genNumber = parseInt(genKey);
                const generationDiv = document.createElement('div');
                generationDiv.className = `tree-generation generation-${Math.min(genNumber, 5)}`;
                
                let genLabel = '';
                switch(genNumber) {
                    case 1: genLabel = 'ÿßŸÑÿ¨ŸäŸÑ ÿßŸÑÿ£ŸàŸÑ: ÿßŸÑÿ£ÿ¨ÿØÿßÿØ'; break;
                    case 2: genLabel = 'ÿßŸÑÿ¨ŸäŸÑ ÿßŸÑÿ´ÿßŸÜŸä: ÿßŸÑÿ¢ÿ®ÿßÿ°'; break;
                    case 3: genLabel = 'ÿßŸÑÿ¨ŸäŸÑ ÿßŸÑÿ´ÿßŸÑÿ´: ÿßŸÑÿ£ÿ®ŸÜÿßÿ°'; break;
                    case 4: genLabel = 'ÿßŸÑÿ¨ŸäŸÑ ÿßŸÑÿ±ÿßÿ®ÿπ: ÿßŸÑÿ£ÿ≠ŸÅÿßÿØ'; break;
                    default: genLabel = `ÿßŸÑÿ¨ŸäŸÑ ${genNumber}`;
                }
                
                generationDiv.innerHTML = `
                    <div class="generation-label">${genLabel} (${generations[genKey].length} ŸÅÿ±ÿØ)</div>
                    <div class="tree-level" id="generation-${genNumber}"></div>
                `;
                
                treeWrapper.appendChild(generationDiv);
                const genContainer = document.getElementById(`generation-${genNumber}`);
                
                const personsInGeneration = generations[genKey];
                const displayedPersons = new Set();
                
                personsInGeneration.forEach(person => {
                    if (displayedPersons.has(person.PersonID)) return;
                    
                    const spouse = findSpouse(person.PersonID);
                    const children = findChildren(person.PersonID);
                    
                    const personDiv = document.createElement('div');
                    personDiv.className = 'tree-node-container';
                    
                    let personHTML = '';
                    
                    if (spouse && !displayedPersons.has(spouse.PersonID)) {
                        personHTML += `
                            <div class="spouse-container">
                                <div class="married-couple">
                                    ${renderPersonCard(person)}
                                    ${renderPersonCard(spouse)}
                                </div>
                                ${renderChildren(children, genNumber + 1)}
                            </div>
                        `;
                        displayedPersons.add(person.PersonID);
                        displayedPersons.add(spouse.PersonID);
                    } else if (!spouse || displayedPersons.has(spouse.PersonID)) {
                        personHTML += `
                            ${renderPersonCard(person)}
                            ${renderChildren(children, genNumber + 1)}
                        `;
                        displayedPersons.add(person.PersonID);
                    }
                    
                    personDiv.innerHTML = personHTML;
                    genContainer.appendChild(personDiv);
                });
            });
            
            updateTreeZoom();
            updateTreePersonCount();
            setTimeout(addTreeConnectors, 100);
            if (currentTreeSearch) searchInTree();
        }

        // ============================================
        // ŸÖŸÜÿ∑ŸÇ ŸÖÿ≠ÿ≥ŸÜ ŸÑÿ≠ÿ≥ÿßÿ® ÿßŸÑÿ£ÿ¨ŸäÿßŸÑ
        // ============================================

        function getSpouseById(personId) {
            const person = familyData.find(p => p.PersonID === personId);
            if (!person) return null;

            let spouse = null;
            if (person.SpouseID && person.SpouseID !== 0) {
                spouse = familyData.find(p => p.PersonID === person.SpouseID) || null;
            }
            if (!spouse) {
                spouse = familyData.find(p => p.SpouseID === personId) || null;
            }
            return spouse;
        }

        function isOutsideFamily(personId, visited = new Set()) {
            if (visited.has(personId)) return false;
            visited.add(personId);

            const person = familyData.find(p => p.PersonID === personId);
            if (!person) return false;

            const noParents = (person.FatherID === 0 && person.MotherID === 0);
            if (!noParents) return false;

            const spouse = getSpouseById(personId);
            if (!spouse) return false;

            const spouseHasParents = (spouse.FatherID !== 0 || spouse.MotherID !== 0);
            if (spouseHasParents) return true;

            const spouseGen = calculateGeneration(spouse.PersonID, new Set(visited));
            return spouseGen > 1;
        }

        function calculateGeneration(personId, visited = new Set()) {
            if (visited.has(personId)) return 0;
            visited.add(personId);

            const person = familyData.find(p => p.PersonID === personId);
            if (!person) return 0;

            const noParents = (person.FatherID === 0 && person.MotherID === 0);

            if (noParents) {
                const spouse = getSpouseById(personId);
                if (spouse) {
                    const spouseHasParents = (spouse.FatherID !== 0 || spouse.MotherID !== 0);
                    if (spouseHasParents) {
                        return calculateGeneration(spouse.PersonID, visited);
                    }
                }
                return 1;
            }

            const fatherGen = person.FatherID ? calculateGeneration(person.FatherID, visited) : 0;
            const motherGen = person.MotherID ? calculateGeneration(person.MotherID, visited) : 0;

            return Math.max(fatherGen, motherGen) + 1;
        }

        function organizeByGeneration() {
            const generations = {};
            const sortedData = [...familyData].sort((a, b) => {
                return currentSortOrder === 'asc' ? a.PersonID - b.PersonID : b.PersonID - a.PersonID;
            });

            sortedData.forEach(person => {
                const gen = calculateGeneration(person.PersonID);
                if (!generations[gen]) generations[gen] = [];
                generations[gen].push(person);
            });

            const sortedGenerations = {};
            Object.keys(generations).sort((a, b) => a - b).forEach(key => {
                sortedGenerations[key] = generations[key];
            });

            return sortedGenerations;
        }

        function findChildren(personId) {
            return familyData.filter(p => p.FatherID === personId || p.MotherID === personId);
        }

        function findSpouse(personId) {
            return getSpouseById(personId);
        }

        function renderPersonCard(person) {
            const spouse = findSpouse(person.PersonID);
            const isMarried = spouse ? 'married' : '';
            const genClass = `gen-${Math.min(calculateGeneration(person.PersonID), 5)}`;
            const generation = calculateGeneration(person.PersonID);
            const outsider = isOutsideFamily(person.PersonID);
            const outsiderClass = outsider ? 'outsider' : '';
            const outsiderBadge = outsider ? `<div class="outsider-badge" title="ŸÖŸÜ ÿÆÿßÿ±ÿ¨ ÿßŸÑÿπÿßÿ¶ŸÑÿ© (ŸÜÿ≥ÿ®)"><i class="fas fa-link"></i> ŸÜÿ≥ÿ®</div>` : '';
            
            const nodeId = `tree-node-${person.PersonID}`;
            
            return `
                <div class="tree-node ${person.Gender === 'ÿ∞ŸÉÿ±' ? 'male' : 'female'} ${isMarried} ${genClass} ${outsiderClass}" 
                     id="${nodeId}" onclick="onTreeNodeClick(event, ${person.PersonID})" data-person-id="${person.PersonID}">
                    ${outsiderBadge}
                    <div class="generation-badge">ÿßŸÑÿ¨ŸäŸÑ ${generation}</div>
                    <div class="node-header">
                        <div class="node-id">${person.PersonID}</div>
                        <div style="font-size: 11px; color: ${person.Gender === 'ÿ∞ŸÉÿ±' ? 'var(--male-color)' : 'var(--female-color)'}">
                            ${person.Gender === 'ÿ∞ŸÉÿ±' ? 'ÿ∞ŸÉÿ±' : 'ÿ£ŸÜÿ´Ÿâ'}
                        </div>
                    </div>
                    <div class="node-name" id="node-name-${person.PersonID}">${person.FullName}</div>
                    <div class="node-details">
                        ${person.BirthDate ? `<div>üë∂ ŸÖŸàŸÑÿØ: ${formatDate(person.BirthDate)}</div>` : ''}
                        ${person.DeathDate ? `<div>‚ò™Ô∏è ŸàŸÅÿßÿ©: ${formatDate(person.DeathDate)}</div>` : ''}
                    </div>
                    ${person.PlaceOfBirth ? `<div class="node-place"><i class="fas fa-map-marker-alt"></i> ${person.PlaceOfBirth}</div>` : ''}
                    ${spouse ? `<div style="margin-top: 5px; font-size: 10px; color: #E91E63;"><i class="fas fa-heart"></i> ŸÖÿ™ÿ≤Ÿàÿ¨</div>` : ''}
                </div>
            `;
        }

        // ============================================
        // ÿ™ŸÖŸäŸäÿ≤ ÿßŸÑÿ≥ŸÑÿßŸÑÿ© (ÿßŸÑÿ£ÿ≥ŸÑÿßŸÅ/ÿßŸÑÿ£ÿ≠ŸÅÿßÿØ)
        // ============================================

        function getAncestors(personId, ancestors = new Set()) {
            const person = familyData.find(p => p.PersonID === personId);
            if (!person) return Array.from(ancestors);
            
            if (person.FatherID !== 0 && person.FatherID) {
                ancestors.add(person.FatherID);
                getAncestors(person.FatherID, ancestors);
            }
            
            if (person.MotherID !== 0 && person.MotherID) {
                ancestors.add(person.MotherID);
                getAncestors(person.MotherID, ancestors);
            }
            
            return Array.from(ancestors);
        }

        function getDescendants(personId, descendants = new Set()) {
            const children = findChildren(personId);
            
            children.forEach(child => {
                descendants.add(child.PersonID);
                getDescendants(child.PersonID, descendants);
            });
            
            return Array.from(descendants);
        }

        function highlightLineage(personId) {
            document.querySelectorAll('.tree-node').forEach(node => {
                node.classList.remove('lineage-dimmed', 'lineage-selected', 'lineage-ancestor', 'lineage-descendant');
            });
            
            const ancestors = getAncestors(personId);
            const descendants = getDescendants(personId);
            
            const selectedNode = document.querySelector(`.tree-node[data-person-id="${personId}"]`);
            if (selectedNode) {
                selectedNode.classList.add('lineage-selected');
            }
            
            ancestors.forEach(ancestorId => {
                const ancestorNode = document.querySelector(`.tree-node[data-person-id="${ancestorId}"]`);
                if (ancestorNode) {
                    ancestorNode.classList.add('lineage-ancestor');
                }
            });
            
            descendants.forEach(descendantId => {
                const descendantNode = document.querySelector(`.tree-node[data-person-id="${descendantId}"]`);
                if (descendantNode) {
                    descendantNode.classList.add('lineage-descendant');
                }
            });
            
            document.querySelectorAll('.tree-node').forEach(node => {
                const nodeId = parseInt(node.getAttribute('data-person-id'));
                if (nodeId !== personId && 
                    !ancestors.includes(nodeId) && 
                    !descendants.includes(nodeId)) {
                    node.classList.add('lineage-dimmed');
                }
            });
        }

        function clearLineageHighlight() {
            document.querySelectorAll('.tree-node').forEach(node => {
                node.classList.remove('lineage-dimmed', 'lineage-selected', 'lineage-ancestor', 'lineage-descendant');
            });
        }

        function onTreeNodeClick(event, personId) {
            event.stopPropagation();
            highlightLineage(personId);
            
            if (!currentTreeSearch) {
                showPersonDetail(personId);
            }
        }

        function renderChildren(children, generation) {
            if (children.length === 0) return '';
            
            return `
                <div class="node-children" style="min-height: 50px;">
                    ${children.map(child => renderPersonCard(child)).join('')}
                </div>
            `;
        }

        function addTreeConnectors() {
            document.querySelectorAll('.tree-node-container').forEach(container => {
                const parentNode = container.querySelector('.tree-node');
                const childrenContainer = container.querySelector('.node-children');
                
                if (parentNode && childrenContainer && childrenContainer.children.length > 0) {
                    const connector = document.createElement('div');
                    connector.className = 'tree-connector vertical-connector';
                    container.insertBefore(connector, parentNode.nextSibling);
                    
                    if (childrenContainer.children.length > 1) {
                        const horizontalConnector = document.createElement('div');
                        horizontalConnector.className = 'tree-connector horizontal-connector';
                        childrenContainer.insertBefore(horizontalConnector, childrenContainer.firstChild);
                    }
                }
            });
        }

        function updateTreeZoom() {
            const wrapper = document.getElementById('treeWrapper');
            if (wrapper) {
                wrapper.style.transform = `scale(${treeZoom / 100})`;
                wrapper.style.transformOrigin = 'top right';
                document.getElementById('zoomLevel').textContent = `${treeZoom}%`;
            }
        }

        function zoomInTree() {
            if (treeZoom < 200) {
                treeZoom += 10;
                updateTreeZoom();
            }
        }

        function zoomOutTree() {
            if (treeZoom > 30) {
                treeZoom -= 10;
                updateTreeZoom();
            }
        }

        function toggleCompactMode() {
            treeCompactMode = !treeCompactMode;
            const wrapper = document.getElementById('treeWrapper');
            
            if (treeCompactMode) {
                wrapper.classList.add('compact-mode');
                showSuccess('ÿ™ŸÖ ÿ™ŸÅÿπŸäŸÑ ÿßŸÑÿπÿ±ÿ∂ ÿßŸÑŸÖÿ∂ÿ∫Ÿàÿ∑');
            } else {
                wrapper.classList.remove('compact-mode');
                showSuccess('ÿ™ŸÖ ÿ™ŸÅÿπŸäŸÑ ÿßŸÑÿπÿ±ÿ∂ ÿßŸÑÿπÿßÿØŸä');
            }
        }

        function toggleMobileOptimization() {
            mobileOptimized = !mobileOptimized;
            const treeContainer = document.getElementById('treeContainer');
            
            if (mobileOptimized) {
                treeContainer.classList.add('mobile-optimized');
                showSuccess('ÿ™ŸÖ ÿ™ŸÅÿπŸäŸÑ Ÿàÿ∂ÿπ ÿßŸÑŸÖŸàÿ®ÿßŸäŸÑ');
            } else {
                treeContainer.classList.remove('mobile-optimized');
                showSuccess('ÿ™ŸÖ ÿ™ÿπÿ∑ŸäŸÑ Ÿàÿ∂ÿπ ÿßŸÑŸÖŸàÿ®ÿßŸäŸÑ');
            }
        }

        function searchInTree() {
            const searchTerm = document.getElementById('treeSearch').value.toLowerCase();
            currentTreeSearch = searchTerm;
            searchMatchCount = 0;
            
            document.querySelectorAll('.tree-node').forEach(node => {
                const name = node.querySelector('.node-name').textContent.toLowerCase();
                const id = node.getAttribute('data-person-id');
                const person = familyData.find(p => p.PersonID === parseInt(id));
                
                let match = false;
                if (searchTerm) {
                    match = name.includes(searchTerm) || 
                           id.includes(searchTerm) ||
                           (person && person.PlaceOfBirth && person.PlaceOfBirth.toLowerCase().includes(searchTerm)) ||
                           (person && person.Notes && person.Notes.toLowerCase().includes(searchTerm));
                }
                
                node.classList.remove('search-match', 'search-no-match');
                
                if (searchTerm) {
                    if (match) {
                        node.classList.add('search-match');
                        searchMatchCount++;
                    } else {
                        node.classList.add('search-no-match');
                    }
                }
            });
            
            const searchMatchElement = document.getElementById('searchMatchCount');
            if (searchTerm && searchMatchCount > 0) {
                searchMatchElement.textContent = ` (${searchMatchCount} ŸÖÿ∑ÿßÿ®ŸÇ)`;
                searchMatchElement.style.display = 'inline';
                showSuccess(`ÿ™ŸÖ ÿßŸÑÿπÿ´Ÿàÿ± ÿπŸÑŸâ ${searchMatchCount} ŸÅÿ±ÿØ`);
                
                const firstMatch = document.querySelector('.tree-node.search-match');
                if (firstMatch) {
                    firstMatch.scrollIntoView({ behavior: 'smooth', block: 'center' });
                    highlightLineage(parseInt(firstMatch.getAttribute('data-person-id')));
                }
            } else if (searchTerm) {
                searchMatchElement.style.display = 'none';
                showError('ŸÑŸÖ Ÿäÿ™ŸÖ ÿßŸÑÿπÿ´Ÿàÿ± ÿπŸÑŸâ ÿ£ŸÅÿ±ÿßÿØ Ÿäÿ∑ÿßÿ®ŸÇŸàŸÜ ÿßŸÑÿ®ÿ≠ÿ´');
            } else {
                searchMatchElement.style.display = 'none';
                clearLineageHighlight();
            }
        }

        function clearTreeSearch() {
            document.getElementById('treeSearch').value = '';
            currentTreeSearch = '';
            searchMatchCount = 0;
            document.getElementById('searchMatchCount').style.display = 'none';
            searchInTree();
            clearLineageHighlight();
        }

        function scrollToGeneration(genNumber) {
            const genElement = document.getElementById(`generation-${genNumber}`);
            if (genElement) {
                genElement.scrollIntoView({ behavior: 'smooth' });
            }
        }

        function setupTreeScrollListener() {
            const treeContent = document.getElementById('treeContainer');
            if (!treeContent) return;
            
            treeContent.addEventListener('scroll', function() {
                const currentScrollTop = treeContent.scrollTop;
                
                if (Math.abs(currentScrollTop - lastScrollTop) > 50) {
                    const treeFilter = document.getElementById('treeFilter');
                    if (currentScrollTop > lastScrollTop) {
                        treeFilter.style.transform = 'translateY(-100%)';
                    } else {
                        treeFilter.style.transform = 'translateY(0)';
                    }
                    lastScrollTop = currentScrollTop;
                }
            });
        }

        function setupMobileSearch() {
            const mobileSearchToggle = document.getElementById('mobileSearchToggle');
            const treeFilter = document.getElementById('treeFilter');
            
            if (mobileSearchToggle && treeFilter) {
                mobileSearchToggle.addEventListener('click', function() {
                    treeFilter.classList.toggle('active');
                });
                
                document.addEventListener('click', function(event) {
                    if (!treeFilter.contains(event.target) && 
                        !mobileSearchToggle.contains(event.target) && 
                        treeFilter.classList.contains('active')) {
                        treeFilter.classList.remove('active');
                    }
                });
            }
        }

        function updateTreePersonCount() {
            document.getElementById('treePersonCount').textContent = familyData.length;
        }

        // ============================================
        // ÿØŸàÿßŸÑ ÿßŸÑÿ™ÿµÿØŸäÿ± ŸàÿßŸÑÿßÿ≥ÿ™Ÿäÿ±ÿßÿØ
        // ============================================

        function toggleExportMenu() {
            const menu = document.getElementById('exportMenu');
            menu.classList.toggle('show');
            
            setTimeout(() => {
                document.addEventListener('click', function closeMenu(event) {
                    if (!menu.contains(event.target) && !event.target.closest('.export-options')) {
                        menu.classList.remove('show');
                        document.removeEventListener('click', closeMenu);
                    }
                });
            }, 10);
        }

        function toggleTreeExportMenu() {
            const menu = document.getElementById('treeExportMenu');
            menu.classList.toggle('show');
            
            setTimeout(() => {
                document.addEventListener('click', function closeMenu(event) {
                    if (!menu.contains(event.target) && !event.target.closest('.export-options')) {
                        menu.classList.remove('show');
                        document.removeEventListener('click', closeMenu);
                    }
                });
            }, 10);
        }

        function exportData(format) {
            let dataStr, fileName, mimeType;
            
            switch(format) {
                case 'json':
                    dataStr = JSON.stringify(familyData, null, 2);
                    fileName = `family-tree-${new Date().toISOString().split('T')[0]}.json`;
                    mimeType = 'application/json';
                    break;
                    
                case 'excel':
                    const ws = XLSX.utils.json_to_sheet(familyData);
                    const wb = XLSX.utils.book_new();
                    XLSX.utils.book_append_sheet(wb, ws, "Family Members");
                    XLSX.writeFile(wb, `family-tree-${new Date().toISOString().split('T')[0]}.xlsx`);
                    showSuccess('ÿ™ŸÖ ÿ™ÿµÿØŸäÿ± ÿßŸÑÿ®ŸäÿßŸÜÿßÿ™ ŸÉŸÖŸÑŸÅ Excel ÿ®ŸÜÿ¨ÿßÿ≠');
                    return;
                    
                case 'csv':
                    const csv = XLSX.utils.sheet_to_csv(XLSX.utils.json_to_sheet(familyData));
                    dataStr = csv;
                    fileName = `family-tree-${new Date().toISOString().split('T')[0]}.csv`;
                    mimeType = 'text/csv';
                    break;
                    
                default:
                    return;
            }
            
            const blob = new Blob([dataStr], { type: mimeType });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = fileName;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
            
            showSuccess(`ÿ™ŸÖ ÿ™ÿµÿØŸäÿ± ÿßŸÑÿ®ŸäÿßŸÜÿßÿ™ ŸÉŸÖŸÑŸÅ ${format.toUpperCase()} ÿ®ŸÜÿ¨ÿßÿ≠`);
        }

        function exportFullExcel() {
            const enrichedData = familyData.map(person => {
                const father = familyData.find(p => p.PersonID === person.FatherID);
                const mother = familyData.find(p => p.PersonID === person.MotherID);
                const spouse = familyData.find(p => p.PersonID === person.SpouseID);
                const childrenCount = findChildren(person.PersonID).length;
                const generation = calculateGeneration(person.PersonID);
                
                return {
                    ...person,
                    FatherName: father ? father.FullName : '',
                    MotherName: mother ? mother.FullName : '',
                    SpouseName: spouse ? spouse.FullName : '',
                    ChildrenCount: childrenCount,
                    Generation: generation
                };
            });
            
            const ws = XLSX.utils.json_to_sheet(enrichedData);
            const wb = XLSX.utils.book_new();
            XLSX.utils.book_append_sheet(wb, ws, "Family Members");
            
            const relationships = [];
            familyData.forEach(person => {
                if (person.FatherID !== 0) {
                    relationships.push({
                        Person: person.FullName,
                        Relation: 'Father',
                        RelatedTo: familyData.find(p => p.PersonID === person.FatherID)?.FullName || '',
                        PersonID: person.PersonID,
                        RelatedID: person.FatherID
                    });
                }
                if (person.MotherID !== 0) {
                    relationships.push({
                        Person: person.FullName,
                        Relation: 'Mother',
                        RelatedTo: familyData.find(p => p.PersonID === person.MotherID)?.FullName || '',
                        PersonID: person.PersonID,
                        RelatedID: person.MotherID
                    });
                }
                if (person.SpouseID !== 0) {
                    relationships.push({
                        Person: person.FullName,
                        Relation: 'Spouse',
                        RelatedTo: familyData.find(p => p.PersonID === person.SpouseID)?.FullName || '',
                        PersonID: person.PersonID,
                        RelatedID: person.SpouseID
                    });
                }
            });
            
            const ws2 = XLSX.utils.json_to_sheet(relationships);
            XLSX.utils.book_append_sheet(wb, ws2, "Relationships");
            
            XLSX.writeFile(wb, `family-tree-complete-${new Date().toISOString().split('T')[0]}.xlsx`);
            showSuccess('ÿ™ŸÖ ÿ™ÿµÿØŸäÿ± ÿßŸÑÿ®ŸäÿßŸÜÿßÿ™ ÿßŸÑŸÖÿ™ŸÇÿØŸÖÿ© ÿ®ŸÜÿ¨ÿßÿ≠');
        }

        function exportTreeImage(quality) {
            showExportLoading('ÿ¨ÿßÿ±Ÿä ÿ™ÿ≠ÿ∂Ÿäÿ± ÿµŸàÿ±ÿ© ÿßŸÑÿ¥ÿ¨ÿ±ÿ©...');
            
            setTimeout(() => {
                const treeContent = document.getElementById('treeContainer');
                const scale = quality === 'high' ? 2 : 1;
                
                html2canvas(treeContent, {
                    scale: scale,
                    useCORS: true,
                    backgroundColor: '#f8faf8',
                    logging: false,
                    allowTaint: true,
                    foreignObjectRendering: false,
                    width: treeContent.scrollWidth,
                    height: treeContent.scrollHeight
                }).then(canvas => {
                    const link = document.createElement('a');
                    link.download = `family-tree-${new Date().toISOString().split('T')[0]}.png`;
                    link.href = canvas.toDataURL('image/png');
                    link.click();
                    hideExportLoading();
                    showSuccess('ÿ™ŸÖ ÿ™ÿµÿØŸäÿ± ÿµŸàÿ±ÿ© ÿßŸÑÿ¥ÿ¨ÿ±ÿ© ÿ®ŸÜÿ¨ÿßÿ≠');
                }).catch(error => {
                    hideExportLoading();
                    showError('ŸÅÿ¥ŸÑ ÿ™ÿµÿØŸäÿ± ÿßŸÑÿµŸàÿ±ÿ©: ' + error.message);
                });
            }, 100);
        }

        function exportCurrentSection() {
            showExportLoading('ÿ¨ÿßÿ±Ÿä ÿ™ÿ≠ÿ∂Ÿäÿ± ÿµŸàÿ±ÿ© ÿßŸÑÿ¨ÿ≤ÿ° ÿßŸÑŸÖÿ±ÿ¶Ÿä...');
            
            setTimeout(() => {
                const treeContent = document.getElementById('treeContainer');
                
                html2canvas(treeContent, {
                    scale: 2,
                    useCORS: true,
                    backgroundColor: '#f8faf8',
                    logging: false
                }).then(canvas => {
                    const link = document.createElement('a');
                    link.download = `family-tree-section-${new Date().toISOString().split('T')[0]}.png`;
                    link.href = canvas.toDataURL('image/png');
                    link.click();
                    hideExportLoading();
                    showSuccess('ÿ™ŸÖ ÿ™ÿµÿØŸäÿ± ÿµŸàÿ±ÿ© ÿßŸÑÿ¨ÿ≤ÿ° ÿßŸÑŸÖÿ±ÿ¶Ÿä ÿ®ŸÜÿ¨ÿßÿ≠');
                }).catch(error => {
                    hideExportLoading();
                    showError('ŸÅÿ¥ŸÑ ÿ™ÿµÿØŸäÿ± ÿßŸÑÿµŸàÿ±ÿ©: ' + error.message);
                });
            }, 100);
        }

        function showExportLoading(message) {
            const loading = document.getElementById('exportLoading');
            const text = document.getElementById('exportLoadingText');
            if (loading && text) {
                text.textContent = message;
                loading.classList.add('active');
            }
        }

        function hideExportLoading() {
            const loading = document.getElementById('exportLoading');
            if (loading) {
                loading.classList.remove('active');
            }
        }

        function handleFileImport(event) {
            const file = event.target.files[0];
            if (!file) return;
            
            const reader = new FileReader();
            reader.onload = function(e) {
                try {
                    const importedData = JSON.parse(e.target.result);
                    
                    if (Array.isArray(importedData)) {
                        if (confirm(`ÿ≥Ÿäÿ™ŸÖ ÿßÿ≥ÿ™Ÿäÿ±ÿßÿØ ${importedData.length} ŸÅÿ±ÿØ. ŸáŸÑ ÿ™ÿ±ŸäÿØ ÿßŸÑŸÖÿ™ÿßÿ®ÿπÿ©ÿü`)) {
                            familyData = importedData;
                            if (saveData()) {
                                nextPersonId = familyData.length > 0 ? Math.max(...familyData.map(p => p.PersonID)) + 1 : 1;
                                loadDashboard();
                                showSuccess(`ÿ™ŸÖ ÿßÿ≥ÿ™Ÿäÿ±ÿßÿØ ${importedData.length} ŸÅÿ±ÿØ ÿ®ŸÜÿ¨ÿßÿ≠`);
                            }
                        }
                    } else {
                        showError('ŸÖŸÑŸÅ ÿ∫Ÿäÿ± ÿµÿßŸÑÿ≠. Ÿäÿ¨ÿ® ÿ£ŸÜ Ÿäÿ≠ÿ™ŸàŸä ÿπŸÑŸâ ŸÖÿµŸÅŸàŸÅÿ© ŸÖŸÜ ÿßŸÑÿ£ŸÅÿ±ÿßÿØ.');
                    }
                } catch (error) {
                    showError('ŸÅÿ¥ŸÑ ŸÇÿ±ÿßÿ°ÿ© ÿßŸÑŸÖŸÑŸÅ: ' + error.message);
                }
                
                event.target.value = '';
            };
            
            reader.readAsText(file);
        }

        // ============================================
        // ÿØŸàÿßŸÑ ÿßÿ≥ÿ™Ÿäÿ±ÿßÿØ Excel
        // ============================================

        function showExcelImport() {
            document.getElementById('excelImportModal').classList.add('active');
        }

        function closeExcelImport() {
            document.getElementById('excelImportModal').classList.remove('active');
            clearExcelPreview();
        }

        function handleExcelFileSelect(event) {
            const file = event.target.files[0];
            if (!file) return;
            
            const reader = new FileReader();
            reader.onload = function(e) {
                try {
                    const data = new Uint8Array(e.target.result);
                    const workbook = XLSX.read(data, { type: 'array' });
                    const firstSheet = workbook.Sheets[workbook.SheetNames[0]];
                    excelData = XLSX.utils.sheet_to_json(firstSheet);
                    
                    if (excelData.length > 0) {
                        displayExcelPreview();
                    }
                } catch (error) {
                    showError('ŸÅÿ¥ŸÑ ŸÇÿ±ÿßÿ°ÿ© ŸÖŸÑŸÅ Excel: ' + error.message);
                }
            };
            
            reader.readAsArrayBuffer(file);
        }

        function displayExcelPreview() {
            const previewDiv = document.getElementById('excelPreview');
            const tableHead = document.getElementById('excelTableHead');
            const tableBody = document.getElementById('excelTableBody');
            const statsDiv = document.getElementById('importStats');
            
            if (excelData.length === 0) {
                previewDiv.style.display = 'none';
                return;
            }
            
            const headers = Object.keys(excelData[0]);
            tableHead.innerHTML = `<tr>${headers.map(h => `<th>${h}</th>`).join('')}</tr>`;
            
            tableBody.innerHTML = '';
            excelData.slice(0, 10).forEach(row => {
                const tr = document.createElement('tr');
                headers.forEach(header => {
                    const td = document.createElement('td');
                    td.textContent = row[header] || '';
                    tr.appendChild(td);
                });
                tableBody.appendChild(tr);
            });
            
            statsDiv.style.display = 'block';
            document.getElementById('importStatsText').textContent = 
                `ÿ™ŸÖ ÿ™ÿ≠ŸÖŸäŸÑ ${excelData.length} ÿµŸÅ. ${excelData.length > 10 ? 'Ÿäÿ™ŸÖ ÿπÿ±ÿ∂ ÿ£ŸàŸÑ 10 ÿµŸÅŸàŸÅ ŸÅŸÇÿ∑.' : ''}`;
            
            previewDiv.style.display = 'block';
        }

        function clearExcelPreview() {
            excelData = [];
            document.getElementById('excelPreview').style.display = 'none';
            document.getElementById('excelFile').value = '';
        }

        function importExcelData() {
            if (excelData.length === 0) {
                showError('ŸÑÿß ÿ™Ÿàÿ¨ÿØ ÿ®ŸäÿßŸÜÿßÿ™ ŸÑŸÑÿßÿ≥ÿ™Ÿäÿ±ÿßÿØ');
                return;
            }
            
            if (!confirm(`ÿ≥Ÿäÿ™ŸÖ ÿßÿ≥ÿ™Ÿäÿ±ÿßÿØ ${excelData.length} ŸÅÿ±ÿØ. ŸáŸÑ ÿ™ÿ±ŸäÿØ ÿßŸÑŸÖÿ™ÿßÿ®ÿπÿ©ÿü')) {
                return;
            }
            
            try {
                const importedPersons = [];
                
                excelData.forEach((row, index) => {
                    const person = {
                        PersonID: row['PersonID'] || row['ÿ±ŸÇŸÖ'] || nextPersonId + index,
                        FullName: row['FullName'] || row['ÿßŸÑÿßÿ≥ŸÖ'] || row['Name'] || '',
                        Gender: (row['Gender'] || row['ÿßŸÑÿ¨ŸÜÿ≥'] || 'ÿ∞ŸÉÿ±') === 'ÿ∞ŸÉÿ±' ? 'ÿ∞ŸÉÿ±' : 'ÿßŸÜÿ´Ÿâ',
                        PlaceOfBirth: row['PlaceOfBirth'] || row['ŸÖŸÉÿßŸÜ ÿßŸÑŸÖŸäŸÑÿßÿØ'] || '',
                        BirthDate: row['BirthDate'] || row['ÿ™ÿßÿ±ŸäÿÆ ÿßŸÑŸÖŸäŸÑÿßÿØ'] || '',
                        DeathDate: row['DeathDate'] || row['ÿ™ÿßÿ±ŸäÿÆ ÿßŸÑŸàŸÅÿßÿ©'] || '',
                        FatherID: parseInt(row['FatherID'] || row['ÿßŸÑÿ£ÿ®'] || 0),
                        MotherID: parseInt(row['MotherID'] || row['ÿßŸÑÿ£ŸÖ'] || 0),
                        SpouseID: parseInt(row['SpouseID'] || row['ÿßŸÑÿ≤Ÿàÿ¨'] || row['ÿßŸÑÿ≤Ÿàÿ¨ÿ©'] || 0),
                        Notes: row['Notes'] || row['ŸÖŸÑÿßÿ≠ÿ∏ÿßÿ™'] || ''
                    };
                    
                    importedPersons.push(person);
                });
                
                familyData = [...familyData, ...importedPersons];
                
                if (familyData.length > 0) {
                    nextPersonId = Math.max(...familyData.map(p => p.PersonID)) + 1;
                }
                
                if (saveData()) {
                    closeExcelImport();
                    loadDashboard();
                    showSuccess(`ÿ™ŸÖ ÿßÿ≥ÿ™Ÿäÿ±ÿßÿØ ${importedPersons.length} ŸÅÿ±ÿØ ÿ®ŸÜÿ¨ÿßÿ≠`);
                }
            } catch (error) {
                showError('ŸÅÿ¥ŸÑ ÿßÿ≥ÿ™Ÿäÿ±ÿßÿØ ÿßŸÑÿ®ŸäÿßŸÜÿßÿ™: ' + error.message);
            }
        }

        function downloadExcelTemplate() {
            const templateData = [
                {
                    PersonID: 1,
                    FullName: "ŸÖÿ≠ŸÖÿØ ÿπÿ®ÿØÿßŸÑÿ±ÿ≠ŸÖŸÜ ÿßÿØŸÖ",
                    Gender: "ÿ∞ŸÉÿ±",
                    PlaceOfBirth: "ÿßŸÑÿ±Ÿäÿßÿ∂",
                    BirthDate: "1950-01-01",
                    DeathDate: "",
                    FatherID: 0,
                    MotherID: 0,
                    SpouseID: 2,
                    Notes: "ÿßŸÑÿ¨ÿØ"
                },
                {
                    PersonID: 2,
                    FullName: "ÿπÿßÿ¶ÿ¥ÿ© ÿßÿ®ŸÉÿ± ŸÖÿ≠ŸÖÿØ",
                    Gender: "ÿßŸÜÿ´Ÿâ",
                    PlaceOfBirth: "ÿßŸÑÿ±Ÿäÿßÿ∂",
                    BirthDate: "1955-01-01",
                    DeathDate: "",
                    FatherID: 0,
                    MotherID: 0,
                    SpouseID: 1,
                    Notes: "ÿßŸÑÿ¨ÿØÿ©"
                }
            ];
            
            const ws = XLSX.utils.json_to_sheet(templateData);
            const wb = XLSX.utils.book_new();
            XLSX.utils.book_append_sheet(wb, ws, "Family Template");
            XLSX.writeFile(wb, "family-tree-template.xlsx");
            showSuccess('ÿ™ŸÖ ÿ™ÿ≠ŸÖŸäŸÑ ÿßŸÑŸÜŸÖŸàÿ∞ÿ¨ ÿ®ŸÜÿ¨ÿßÿ≠');
        }

        // ============================================
        // ÿØŸàÿßŸÑ ŸÖÿ≥ÿßÿπÿØÿ© ÿ•ÿ∂ÿßŸÅŸäÿ©
        // ============================================

        function formatDate(dateString) {
            if (!dateString) return '';
            try {
                const date = new Date(dateString);
                return date.toLocaleDateString('ar-EG');
            } catch (error) {
                return dateString;
            }
        }

        function formatDateDisplay(dateString) {
            if (!dateString) return '';
            try {
                const date = new Date(dateString);
                return date.toLocaleDateString('ar-EG', {
                    year: 'numeric',
                    month: 'long',
                    day: 'numeric'
                });
            } catch (error) {
                return dateString;
            }
        }

        function computeAge(birthDate) {
            if (!birthDate) return null;
            try {
                const birth = new Date(birthDate);
                const today = new Date();
                let age = today.getFullYear() - birth.getFullYear();
                const monthDiff = today.getMonth() - birth.getMonth();
                if (monthDiff < 0 || (monthDiff === 0 && today.getDate() < birth.getDate())) {
                    age--;
                }
                return age;
            } catch (error) {
                return null;
            }
        }

        function loadUsers() {
            const savedUsers = localStorage.getItem('familyTreeUsers');
            if (savedUsers) {
                try {
                    const parsedUsers = JSON.parse(savedUsers);
                    Object.assign(users, parsedUsers);
                } catch (error) {
                    console.error('Error loading users:', error);
                }
            }
        }

        function updateUIByPermissions() {
            if (!currentUser) return;
            
            const permissions = userPermissions[currentUser] || userPermissions['user'];
            const isAdmin = currentUser === 'admin';
            
            // ÿ•ÿÆŸÅÿßÿ°/ÿ•ÿ∏Ÿáÿßÿ± ÿßŸÑÿ£ÿ≤ÿ±ÿßÿ± ÿ≠ÿ≥ÿ® ÿßŸÑÿµŸÑÿßÿ≠Ÿäÿßÿ™
            const addBtn = document.querySelector('.btn-primary[onclick="showAddPersonForm()"]');
            if (addBtn) {
                addBtn.style.display = permissions.includes('add') ? 'inline-flex' : 'none';
            }
            
            const exportBtn = document.querySelector('.export-options');
            if (exportBtn) {
                exportBtn.style.display = permissions.includes('export') ? 'inline-block' : 'none';
            }
            
            const importBtn = document.querySelector('.import-btn');
            if (importBtn) {
                importBtn.style.display = permissions.includes('import') ? 'inline-flex' : 'none';
            }
            
            const cloudBtns = document.querySelectorAll('.btn-info[onclick*="cloud"]');
            cloudBtns.forEach(btn => {
                btn.style.display = isAdmin ? 'inline-flex' : 'none';
            });
        }

        function updateSidebarPermissions() {
            if (!currentUser) return;
            
            const isAdmin = currentUser === 'admin';
            const permissions = userPermissions[currentUser] || userPermissions['user'];
            
            // ÿ•ÿÆŸÅÿßÿ° ÿπŸÜÿßÿµÿ± ÿßŸÑŸÇÿßÿ¶ŸÖÿ© ÿßŸÑÿ¨ÿßŸÜÿ®Ÿäÿ© ÿ≠ÿ≥ÿ® ÿßŸÑÿµŸÑÿßÿ≠Ÿäÿßÿ™
            const permissionItems = document.querySelectorAll('.menu-item[onclick*="Permissions"], .menu-item[onclick*="Encryption"], .menu-item[onclick*="Cloud"]');
            permissionItems.forEach(item => {
                if (item.textContent.includes('ÿ•ÿØÿßÿ±ÿ© ÿßŸÑÿµŸÑÿßÿ≠Ÿäÿßÿ™') || item.textContent.includes('Permissions')) {
                    item.style.display = permissions.includes('manage_users') ? 'block' : 'none';
                } else if (item.textContent.includes('ÿ•ÿπÿØÿßÿØÿßÿ™ ÿßŸÑÿ™ÿ¥ŸÅŸäÿ±') || item.textContent.includes('Encryption')) {
                    item.style.display = isAdmin ? 'block' : 'none';
                } else if (item.textContent.includes('ÿ•ÿØÿßÿ±ÿ© ÿßŸÑÿ≥ÿ≠ÿßÿ®ÿ©') || item.textContent.includes('Cloud')) {
                    item.style.display = isAdmin ? 'block' : 'none';
                }
            });
        }

        function checkPermission(permission) {
            if (!currentUser) return false;
            const permissions = userPermissions[currentUser] || userPermissions['user'];
            return permissions.includes(permission);
        }

        function showSuccess(message) {
            const alert = document.getElementById('successAlert');
            const messageEl = document.getElementById('successMessage');
            if (alert && messageEl) {
                messageEl.textContent = message;
                alert.style.display = 'flex';
                setTimeout(() => {
                    alert.style.display = 'none';
                }, 3000);
            }
        }

        function showError(message) {
            const alert = document.getElementById('errorAlert');
            const messageEl = document.getElementById('errorMessage');
            if (alert && messageEl) {
                messageEl.textContent = message;
                alert.style.display = 'flex';
                setTimeout(() => {
                    alert.style.display = 'none';
                }, 3000);
            }
        }

        function showWarning(message) {
            const alert = document.createElement('div');
            alert.className = 'alert warning';
            alert.innerHTML = `<i class="fas fa-exclamation-triangle"></i><span>${message}</span>`;
            document.querySelector('.main-content-area').insertBefore(alert, document.querySelector('.control-panel'));
            setTimeout(() => {
                alert.remove();
            }, 3000);
        }

        function showInfo(message) {
            const alert = document.createElement('div');
            alert.className = 'alert info';
            alert.innerHTML = `<i class="fas fa-info-circle"></i><span>${message}</span>`;
            document.querySelector('.main-content-area').insertBefore(alert, document.querySelector('.control-panel'));
            setTimeout(() => {
                alert.remove();
            }, 3000);
        }

        // Ÿàÿ∏ÿßÿ¶ŸÅ ÿßŸÇÿ™ÿ±ÿßÿ≠ÿßÿ™ ÿ∞ŸÉŸäÿ© (ŸàŸáŸÖŸäÿ© ÿ≠ÿßŸÑŸäÿßŸã)
        function applySmartSuggestions() {
            showInfo('ÿÆÿßÿµŸäÿ© ÿßŸÑÿßŸÇÿ™ÿ±ÿßÿ≠ÿßÿ™ ÿßŸÑÿ∞ŸÉŸäÿ© ŸÇŸäÿØ ÿßŸÑÿ™ÿ∑ŸàŸäÿ±');
        }

        function showWhySuggestion() {
            showInfo('ÿ¥ÿ±ÿ≠ ÿßŸÑÿßŸÇÿ™ÿ±ÿßÿ≠ÿßÿ™ ŸÇŸäÿØ ÿßŸÑÿ™ÿ∑ŸàŸäÿ±');
        }

        function clearSmartSuggestions() {
            document.getElementById('relationSuggestBox').style.display = 'none';
        }

        // ============================================
        // ÿ™ŸáŸäÿ¶ÿ© ÿßŸÑŸÜÿ∏ÿßŸÖ ÿπŸÜÿØ ÿ™ÿ≠ŸÖŸäŸÑ ÿßŸÑÿµŸÅÿ≠ÿ©
        // ============================================
        
        document.addEventListener('DOMContentLoaded', function() {
            updateLanguage();
        });
    </script>
</body>
</html>
