<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Ø´Ø¬Ø±Ø© Ø¹Ø§Ø¦Ù„Ø© Ù…Ø­Ù…Ø¯ Ø¹Ø¨Ø¯Ø§Ù„Ø±Ø­Ù…Ù† ( Ø£Ø¨Ø§ ) - ÙˆØ§Ù„Ù…Ù†ØªØ¯Ù‰</title>
    
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@400;600;700&family=Amiri:wght@700&display=swap" rel="stylesheet">
    
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-database-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-auth-compat.js"></script>
    
    <script src="https://html2canvas.hertzen.com/dist/html2canvas.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>

    <style>
        /* =========================
           Ø£Ù†Ù…Ø§Ø· Ø§Ù„Ù†Ø¸Ø§Ù… Ø§Ù„Ø£Ø³Ø§Ø³ÙŠØ© ÙˆØ§Ù„Ø´Ø¬Ø±Ø©
           ========================= */
        :root { 
            --male-color: #2196F3; 
            --female-color: #E91E63; 
            --highlight: #FFC107; 
            --header-bg: #2E7D32;
            --login-bg: #1B5E20;
            --panel-bg: #ffffff;
            --button-primary: #4CAF50;
            --button-success: #388E3C;
            --button-danger: #F44336;
            --button-warning: #FF9800;
            --button-info: #0097A7;
            --sidebar-bg: #388E3C;
            --generation-1: #1B5E20;
            --generation-2: #2E7D32;
            --generation-3: #43A047;
            --generation-4: #66BB6A;
            --generation-5: #81C784;
            --generation-1-bg: #E8F5E9;
            --generation-2-bg: #E3F2FD;
            --generation-3-bg: #FFF8E1;
            --generation-4-bg: #F3E5F5;
            --generation-5-bg: #E0F7FA;
            --accent-green: #4CAF50;
            
            /* Ù…ØªØºÙŠØ±Ø§Øª Ø§Ù„Ù‡ÙˆÙŠØ© */
            --brand-family-name: "Ù…Ø­Ù…Ø¯ Ø¹Ø¨Ø¯Ø§Ù„Ø±Ø­Ù…Ù†";
            --brand-mark: "ğŸŒ³";
            --paper-bg: rgba(255,255,255,0.92);
            --paper-border: rgba(27,94,32,0.12);
            --shadow-soft: 0 10px 30px rgba(0,0,0,0.10);
        }
        
        * { 
            margin: 0; 
            padding: 0; 
            box-sizing: border-box; 
            font-family: "Cairo", 'Segoe UI', Tahoma, sans-serif; 
        }
        
        body { 
            background-color: #f8faf8; 
            direction: rtl; 
            min-height: 100vh;
            overflow-x: hidden;
        }

        /* Ø§Ù„Ø®Ø·ÙˆØ· Ø§Ù„Ø¹Ø±Ø¨ÙŠØ© Ø§Ù„ÙƒÙ„Ø§Ø³ÙŠÙƒÙŠØ© Ù„Ù„Ø¹Ù†Ø§ÙˆÙŠÙ† */
        .book-title, .book-generation-title, .person-name, .logo h1, .panel-header h2, .tree-header h2 {
            font-family: "Amiri", "Cairo", serif;
        }

        /* Ø®Ù„ÙÙŠØ© Ù…Ø§Ø¦ÙŠØ© Ø®ÙÙŠÙØ© */
        body::before {
            content:"";
            position:fixed;
            inset:0;
            background: linear-gradient(rgba(248,250,248,0.80), rgba(248,250,248,0.80));
            z-index:-1;
            pointer-events:none;
        }

        /* --- Ø´Ø§Ø´Ø© Ø§Ù„Ø¯Ø®ÙˆÙ„ --- */
        #login-screen {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: linear-gradient(135deg, var(--login-bg) 0%, var(--header-bg) 100%);
            display: flex; justify-content: center; align-items: center; z-index: 10000;
        }
        .login-container {
            background: rgba(255, 255, 255, 0.95); padding: 30px 20px; border-radius: 20px;
            box-shadow: 0 15px 35px rgba(0, 0, 0, 0.3); width: 90%; max-width: 400px; text-align: center;
        }
        .login-input {
            width: 100%; padding: 15px; border: 2px solid #c8e6c9; border-radius: 10px; margin-bottom: 10px;
        }
        .login-btn {
            background: var(--button-primary); color: white; border: none; padding: 15px;
            border-radius: 10px; width: 100%; cursor: pointer; font-weight: bold;
        }
        .login-language-toggle {
            position: absolute; top: 20px; left: 20px; background: rgba(255,255,255,0.2);
            border: 1px solid white; color: white; padding: 5px 10px; border-radius: 15px; cursor: pointer;
        }

        /* --- Ø§Ù„ØªØ®Ø·ÙŠØ· Ø§Ù„Ø¹Ø§Ù… --- */
        .top-bar {
            background: linear-gradient(135deg, var(--header-bg) 0%, #1B5E20 100%);
            color: white; padding: 15px 20px; display: flex; justify-content: space-between;
            align-items: center; position: sticky; top: 0; z-index: 1000;
        }
        .logo { display: flex; align-items: center; gap: 10px; }
        .user-info { display: flex; align-items: center; gap: 10px; }

        .sidebar {
            width: 250px; background: linear-gradient(135deg, var(--sidebar-bg) 0%, var(--header-bg) 100%);
            color: white; height: calc(100vh - 70px); position: fixed; top: 70px; right: 0;
            transition: right 0.3s; overflow-y: auto; z-index: 999;
        }
        .sidebar.active { right: 0; }
        .sidebar-menu { list-style: none; padding: 20px 0; }
        .menu-item {
            padding: 12px 20px; cursor: pointer; display: flex; align-items: center; gap: 12px;
            border-bottom: 1px solid rgba(255,255,255,0.1); transition: 0.3s;
        }
        .menu-item:hover, .menu-item.active { background: rgba(255,255,255,0.2); }

        .main-content-area {
            margin-right: 250px; padding: 20px; transition: margin-right 0.3s;
            min-height: calc(100vh - 70px);
        }

        @media (max-width: 992px) {
            .sidebar { right: -250px; }
            .main-content-area { margin-right: 0; }
        }

        /* --- Ø§Ù„Ù…ÙƒÙˆÙ†Ø§Øª Ø§Ù„Ù…Ø´ØªØ±ÙƒØ© (Ø£Ø²Ø±Ø§Ø±ØŒ Ù†Ù…Ø§Ø°Ø¬ØŒ Ø¬Ø¯Ø§ÙˆÙ„) --- */
        .btn { padding: 8px 15px; border: none; border-radius: 8px; cursor: pointer; color: white; display: inline-flex; align-items: center; gap: 5px; }
        .btn-primary { background: var(--button-primary); }
        .btn-success { background: var(--button-success); }
        .btn-danger { background: var(--button-danger); }
        .btn-warning { background: var(--button-warning); }
        .btn-info { background: var(--button-info); }
        
        .form-modal {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5);
            display: none; justify-content: center; align-items: center; z-index: 2000;
        }
        .form-modal.active { display: flex; }
        .form-container {
            background: white; width: 100%; max-width: 700px; border-radius: 15px; overflow: hidden;
            max-height: 90vh; display: flex; flex-direction: column;
        }
        .form-header {
            background: var(--header-bg); color: white; padding: 15px; display: flex; justify-content: space-between;
        }
        .form-body { padding: 20px; overflow-y: auto; }
        .form-group { margin-bottom: 15px; }
        .form-input, .form-select, .form-textarea {
            width: 100%; padding: 10px; border: 2px solid #ddd; border-radius: 8px;
        }

        /* --- Ø£Ù†Ù…Ø§Ø· Ø§Ù„Ø´Ø¬Ø±Ø© --- */
        .tree-view {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: #f8faf8;
            z-index: 2000; display: none; flex-direction: column;
        }
        .tree-view.active { display: flex; }
        .tree-content { flex: 1; padding: 20px; overflow: auto; display: flex; justify-content: center; }
        .tree-wrapper { display: flex; flex-direction: column; align-items: center; }
        .tree-level { display: flex; justify-content: center; gap: 20px; margin-bottom: 40px; flex-wrap: wrap; }
        .tree-node {
            background: white; border: 2px solid #e8f5e9; border-radius: 10px; padding: 10px;
            width: 150px; text-align: center; cursor: pointer; position: relative;
            box-shadow: 0 3px 10px rgba(0,0,0,0.1); margin: 10px;
        }
        .tree-node.male { border-top: 4px solid var(--male-color); }
        .tree-node.female { border-top: 4px solid var(--female-color); }
        
        .tree-view-btn {
            position: fixed; bottom: 20px; left: 20px; background: var(--button-success);
            color: white; width: 60px; height: 60px; border-radius: 50%; border: none;
            font-size: 24px; cursor: pointer; box-shadow: 0 4px 15px rgba(0,0,0,0.3); z-index: 100;
        }
        .mobile-menu-toggle {
            position: fixed; top: 15px; right: 15px; z-index: 1002; background: none; border: none; color: white; font-size: 24px; display: none;
        }
        @media (max-width: 992px) { .mobile-menu-toggle { display: block; } }

        /* =========================
           Ø£Ù†Ù…Ø§Ø· Ø§Ù„Ù…Ù†ØªØ¯Ù‰ Ø§Ù„Ø¬Ø¯ÙŠØ¯Ø©
           ========================= */
        .forum-container { display: flex; flex-direction: column; height: 100%; }
        .forum-controls {
            background: linear-gradient(135deg, #2E7D32 0%, #1B5E20 100%);
            color: white; padding: 15px; border-radius: 10px; margin-bottom: 15px;
            display: flex; justify-content: space-between; align-items: center; flex-wrap: wrap; gap: 15px;
        }
        .forum-user-info { display: flex; align-items: center; gap: 12px; }
        .user-avatar {
            width: 50px; height: 50px; border-radius: 50%; background: #4CAF50;
            display: flex; align-items: center; justify-content: center; font-size: 20px; color: white; border: 3px solid white;
        }
        .forum-search input { padding: 8px; border-radius: 20px; border: none; }
        .forum-stats { display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 15px; margin-bottom: 20px; }
        .stat-item { background: white; padding: 15px; border-radius: 10px; display: flex; align-items: center; gap: 15px; box-shadow: 0 3px 5px rgba(0,0,0,0.1); }
        .stat-item i { font-size: 30px; color: #4CAF50; }
        
        .category-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(200px, 1fr)); gap: 15px; margin-top: 15px; }
        .category-card {
            background: #f8faf8; border: 2px solid #e8f5e9; border-radius: 10px; padding: 15px; cursor: pointer; transition: 0.3s;
        }
        .category-card:hover { transform: translateY(-3px); border-color: #4CAF50; }
        .category-icon {
            width: 40px; height: 40px; border-radius: 50%; display: flex; align-items: center; justify-content: center; color: white; margin-bottom: 10px;
        }

        .posts-list { display: flex; flex-direction: column; gap: 10px; }
        .post-item {
            background: #f8faf8; padding: 12px; border-radius: 8px; border-right: 3px solid #4CAF50; cursor: pointer; transition: 0.3s;
        }
        .post-item:hover { background: #e8f5e9; transform: translateX(5px); }
        .post-header { display: flex; justify-content: space-between; margin-bottom: 8px; }
        .post-title { font-weight: bold; color: #2E7D32; }
        .post-tags { display: flex; gap: 5px; margin-top: 5px; }
        .post-tag { background: #e0f2f1; color: #00695c; padding: 2px 8px; border-radius: 10px; font-size: 10px; }

        /* Ù…Ø­Ø±Ø± Ø§Ù„Ù†ØµÙˆØµ */
        .editor-toolbar { display: flex; gap: 5px; margin-bottom: 10px; background: #f8faf8; padding: 8px; border-radius: 8px; }
        .editor-toolbar button { width: 35px; height: 35px; border: 1px solid #ddd; background: white; cursor: pointer; border-radius: 5px; }
        
        /* Ø¹Ø±Ø¶ Ø§Ù„Ù…Ù†Ø´ÙˆØ± */
        .post-view { padding: 15px; }
        .post-view-title { color: #2E7D32; font-size: 24px; margin-bottom: 10px; border-bottom: 2px solid #e8f5e9; padding-bottom: 10px; }
        .post-comments { margin-top: 30px; }
        .comment-item { background: #f8faf8; padding: 12px; border-radius: 8px; margin-bottom: 10px; border-left: 3px solid #4CAF50; }
        
        /* ØªØ­Ø³ÙŠÙ†Ø§Øª Ø§Ù„Ø¬ÙˆØ§Ù„ Ù„Ù„Ù…Ù†ØªØ¯Ù‰ */
        @media (max-width: 768px) {
            .forum-controls { flex-direction: column; align-items: stretch; }
            .category-grid, .forum-stats { grid-template-columns: 1fr; }
        }
    </style>
</head>
<body>

    <button class="mobile-menu-toggle" id="mobileMenuToggle">
        <i class="fas fa-bars"></i>
    </button>

    <div id="login-screen">
        <button class="login-language-toggle" onclick="toggleLanguage()">
            <i class="fas fa-globe"></i>
            <span id="loginLanguageText">English</span>
        </button>
        
        <div class="login-container">
            <div style="font-size: 3rem; color: #2E7D32; margin-bottom: 15px;"><i class="fas fa-tree"></i></div>
            <h2 class="login-title" data-i18n="loginTitle">Ù†Ø¸Ø§Ù… Ø¥Ø¯Ø§Ø±Ø© Ø´Ø¬Ø±Ø© Ø§Ù„Ø¹Ø§Ø¦Ù„Ø©</h2>
            <p data-i18n="loginSubtitle" style="color: #2E7D32; margin-bottom: 20px;">Ø§Ù„Ø±Ø¬Ø§Ø¡ ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„</p>
            
            <form class="login-form" onsubmit="event.preventDefault(); handleLogin();">
                <input type="text" id="username" class="login-input" placeholder="Ø§Ø³Ù… Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…" required>
                <input type="password" id="password" class="login-input" placeholder="ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ±" required>
                <div class="login-error" id="loginError" style="color: red; display: none; margin-bottom: 10px;">Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø¯Ø®ÙˆÙ„ ØºÙŠØ± ØµØ­ÙŠØ­Ø©</div>
                <button type="submit" class="login-btn">Ø¯Ø®ÙˆÙ„</button>
            </form>
            <div style="margin-top: 20px; font-size: 12px; color: #555;">
                Ø§Ø¹Ø¯Ø§Ø¯ ÙˆØªÙ†ÙÙŠØ°: Ù…Ø­Ù…Ø¯ Ø¹Ù…Ø± Ù…Ø­Ù…Ø¯
            </div>
        </div>
    </div>

    <div id="main-content" style="display: none;">
        <div class="top-bar">
            <div class="logo">
                <i class="fas fa-tree"></i>
                <h1 data-i18n="appTitle">Ø´Ø¬Ø±Ø© Ø¹Ø§Ø¦Ù„Ø© Ù…Ø­Ù…Ø¯ Ø¹Ø¨Ø¯Ø§Ù„Ø±Ø­Ù…Ù†</h1>
            </div>
            <div class="user-info">
                <span id="loggedInUser">Ù…Ø³ØªØ®Ø¯Ù…</span>
                <button class="btn-danger btn" style="padding: 5px 10px; font-size: 12px;" onclick="logout()">Ø®Ø±ÙˆØ¬</button>
            </div>
        </div>

        <div class="sidebar" id="sidebar">
            <ul class="sidebar-menu">
                <li class="menu-item active" onclick="showDashboard()">
                    <i class="fas fa-home"></i> <span data-i18n="dashboard">Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ©</span>
                </li>
                <li class="menu-item" onclick="showAllPersons()">
                    <i class="fas fa-users"></i> <span data-i18n="allPersons">Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø£ÙØ±Ø§Ø¯</span>
                </li>
                <li class="menu-item" onclick="showAddPersonForm()">
                    <i class="fas fa-user-plus"></i> <span data-i18n="addPerson">Ø¥Ø¶Ø§ÙØ© ÙØ±Ø¯</span>
                </li>
                <li class="menu-item" onclick="showTreeView()">
                    <i class="fas fa-project-diagram"></i> <span data-i18n="treeView">Ø¹Ø±Ø¶ Ø§Ù„Ø´Ø¬Ø±Ø©</span>
                </li>
                <li class="menu-item" onclick="showFamilyBook()">
                    <i class="fas fa-book"></i> <span data-i18n="familyBook">ÙƒØªØ§Ø¨ Ø§Ù„Ø¹Ø§Ø¦Ù„Ø©</span>
                </li>
                <li class="menu-item" onclick="showFamilyForum()">
                    <i class="fas fa-comments"></i> <span data-i18n="familyForum">Ù…Ù†ØªØ¯Ù‰ Ø§Ù„Ø¹Ø§Ø¦Ù„Ø©</span>
                </li>
                <li class="menu-item" onclick="showBackup()">
                    <i class="fas fa-database"></i> <span>Ø§Ù„Ù†Ø³Ø® Ø§Ù„Ø§Ø­ØªÙŠØ§Ø·ÙŠ</span>
                </li>
            </ul>
        </div>

        <div class="main-content-area" id="contentArea">
            <div class="stats-cards" style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 20px; margin-bottom: 20px;">
                <div class="stat-item" style="background: white; padding: 20px; border-radius: 10px; border-right: 4px solid #4CAF50;">
                    <i class="fas fa-users"></i>
                    <div>
                        <h3 id="totalPersons">0</h3>
                        <p>Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ø£ÙØ±Ø§Ø¯</p>
                    </div>
                </div>
                <div class="stat-item" style="background: white; padding: 20px; border-radius: 10px; border-right: 4px solid #2196F3;">
                    <i class="fas fa-male"></i>
                    <div>
                        <h3 id="maleCount">0</h3>
                        <p>Ø§Ù„Ø°ÙƒÙˆØ±</p>
                    </div>
                </div>
                <div class="stat-item" style="background: white; padding: 20px; border-radius: 10px; border-right: 4px solid #E91E63;">
                    <i class="fas fa-female"></i>
                    <div>
                        <h3 id="femaleCount">0</h3>
                        <p>Ø§Ù„Ø¥Ù†Ø§Ø«</p>
                    </div>
                </div>
            </div>

            <div style="background: white; padding: 20px; border-radius: 10px;">
                <h3>Ø£Ø­Ø¯Ø« Ø§Ù„Ø¥Ø¶Ø§ÙØ§Øª</h3>
                <div style="overflow-x: auto;">
                    <table style="width: 100%; border-collapse: collapse; margin-top: 15px;">
                        <thead>
                            <tr style="background: #f1f8e9; text-align: right;">
                                <th style="padding: 10px;">Ø§Ù„Ø±Ù‚Ù…</th>
                                <th style="padding: 10px;">Ø§Ù„Ø§Ø³Ù…</th>
                                <th style="padding: 10px;">Ø§Ù„Ø¬Ù†Ø³</th>
                                <th style="padding: 10px;">Ø§Ù„Ø¥Ø¬Ø±Ø§Ø¡Ø§Øª</th>
                            </tr>
                        </thead>
                        <tbody id="dashboardTableBody">
                            </tbody>
                    </table>
                </div>
            </div>
        </div>

        <button class="tree-view-btn" onclick="showTreeView()">
            <i class="fas fa-tree"></i>
        </button>
    </div>

    <div class="form-modal" id="familyForumModal">
        <div class="form-container" style="max-width: 1000px; height: 90vh;">
            <div class="form-header">
                <h3><i class="fas fa-comments"></i> <span>Ù…Ù†ØªØ¯Ù‰ Ø§Ù„Ø¹Ø§Ø¦Ù„Ø©</span></h3>
                <button class="btn" style="background:none;" onclick="closeFamilyForum()"><i class="fas fa-times"></i></button>
            </div>
            <div class="form-body" style="padding: 0;">
                <div class="forum-container">
                    <div class="forum-controls">
                        <div class="forum-user-info">
                            <div class="user-avatar" id="forumUserAvatar">U</div>
                            <div>
                                <h4 id="forumUserName">Ù…Ø±Ø­Ø¨Ø§Ù‹ØŒ <span id="currentForumUser"></span></h4>
                                <div style="font-size: 12px; opacity: 0.8;">
                                    <span><i class="fas fa-pen"></i> <span id="userPostCount">0</span> Ù…Ù†Ø´ÙˆØ±</span>
                                </div>
                            </div>
                        </div>
                        <div style="display: flex; gap: 10px;">
                            <button class="btn btn-primary" onclick="showNewPostForm()"><i class="fas fa-plus"></i> Ù…Ù†Ø´ÙˆØ± Ø¬Ø¯ÙŠØ¯</button>
                            <button class="btn btn-success" onclick="refreshForum()"><i class="fas fa-sync"></i> ØªØ­Ø¯ÙŠØ«</button>
                            <div class="forum-search">
                                <input type="text" id="forumSearch" placeholder="Ø¨Ø­Ø«..." onkeyup="searchForum()">
                            </div>
                        </div>
                    </div>

                    <div class="forum-content" id="forumContent" style="padding: 20px; overflow-y: auto;">
                        <div id="forumHomeView">
                            <div class="forum-stats">
                                <div class="stat-item">
                                    <i class="fas fa-file-alt"></i>
                                    <div><h3 id="totalPosts">0</h3><p>Ù…Ù†Ø´ÙˆØ±</p></div>
                                </div>
                                <div class="stat-item">
                                    <i class="fas fa-comments"></i>
                                    <div><h3 id="totalComments">0</h3><p>Ø±Ø¯</p></div>
                                </div>
                            </div>
                            
                            <div id="forumCategories"></div>
                            
                            <div style="margin-top: 20px;">
                                <h3 style="color: #2E7D32; border-bottom: 2px solid #e8f5e9; padding-bottom: 10px;">Ø£Ø­Ø¯Ø« Ø§Ù„Ù…Ù†Ø´ÙˆØ±Ø§Øª</h3>
                                <div class="posts-list" id="recentPostsList"></div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div class="form-modal" id="newPostModal">
        <div class="form-container" style="max-width: 700px;">
            <div class="form-header">
                <h3><i class="fas fa-edit"></i> Ù…Ù†Ø´ÙˆØ± Ø¬Ø¯ÙŠØ¯</h3>
                <button class="btn" style="background:none;" onclick="closeNewPost()"><i class="fas fa-times"></i></button>
            </div>
            <div class="form-body">
                <form id="newPostForm" onsubmit="event.preventDefault(); saveNewPost();">
                    <div class="form-group">
                        <label>Ø¹Ù†ÙˆØ§Ù† Ø§Ù„Ù…Ù†Ø´ÙˆØ±</label>
                        <input type="text" class="form-input" id="postTitle" required>
                    </div>
                    <div class="form-group">
                        <label>Ø§Ù„Ù‚Ø³Ù…</label>
                        <select class="form-select" id="postCategory" required>
                            <option value="">Ø§Ø®ØªØ± Ø§Ù„Ù‚Ø³Ù…</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label>Ø§Ù„Ù…Ø­ØªÙˆÙ‰</label>
                        <div class="editor-toolbar">
                            <button type="button" onclick="insertFormat('**')"><i class="fas fa-bold"></i></button>
                            <button type="button" onclick="insertFormat('*')"><i class="fas fa-italic"></i></button>
                        </div>
                        <textarea class="form-textarea" id="postContent" rows="8" required></textarea>
                    </div>
                    <div class="form-group">
                        <label>Ø§Ù„ÙˆØ³ÙˆÙ… (Ø§Ø®ØªÙŠØ§Ø±ÙŠ)</label>
                        <input type="text" class="form-input" id="postTags" placeholder="Ø§ÙØµÙ„ Ø¨ÙŠÙ†Ù‡Ø§ Ø¨ÙØ§ØµÙ„Ø©">
                    </div>
                    <button type="submit" class="btn btn-success">Ù†Ø´Ø±</button>
                </form>
            </div>
        </div>
    </div>

    <div class="form-modal" id="viewPostModal">
        <div class="form-container" style="max-width: 800px; height: 90vh;">
            <div class="form-header">
                <h3 id="viewPostTitleHeader">Ø¹Ù†ÙˆØ§Ù† Ø§Ù„Ù…Ù†Ø´ÙˆØ±</h3>
                <button class="btn" style="background:none;" onclick="closeViewPost()"><i class="fas fa-times"></i></button>
            </div>
            <div class="form-body" id="postViewContainer">
                </div>
        </div>
    </div>

    <div class="tree-view" id="treeView">
        <div class="top-bar">
            <h2>Ø´Ø¬Ø±Ø© Ø§Ù„Ø¹Ø§Ø¦Ù„Ø©</h2>
            <div>
                <button class="btn btn-info" onclick="exportTreeImage()">ØµÙˆØ±Ø©</button>
                <button class="btn btn-danger" onclick="closeTreeView()">Ø¥ØºÙ„Ø§Ù‚</button>
            </div>
        </div>
        <div class="tree-content" id="treeContainer">
            </div>
    </div>

    <div class="form-modal" id="personFormModal">
        <div class="form-container">
            <div class="form-header">
                <h3>Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„ÙØ±Ø¯</h3>
                <button class="btn" style="background:none;" onclick="closePersonForm()"><i class="fas fa-times"></i></button>
            </div>
            <div class="form-body">
                <form id="personForm">
                    <input type="hidden" id="personId">
                    <div class="form-group">
                        <label>Ø§Ù„Ø§Ø³Ù… Ø§Ù„ÙƒØ§Ù…Ù„</label>
                        <input type="text" class="form-input" id="fullName" required>
                    </div>
                    <div class="form-group">
                        <label>Ø§Ù„Ø¬Ù†Ø³</label>
                        <select class="form-select" id="gender" required>
                            <option value="Ø°ÙƒØ±">Ø°ÙƒØ±</option>
                            <option value="Ø§Ù†Ø«Ù‰">Ø£Ù†Ø«Ù‰</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label>Ø§Ù„Ø£Ø¨</label>
                        <select class="form-select" id="fatherId">
                            <option value="0">Ù„Ø§ ÙŠÙˆØ¬Ø¯ / Ø¬Ø°Ø±</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label>Ø§Ù„Ø£Ù…</label>
                        <select class="form-select" id="motherId">
                            <option value="0">Ù„Ø§ ÙŠÙˆØ¬Ø¯</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label>Ø§Ù„Ø²ÙˆØ¬/Ø©</label>
                        <select class="form-select" id="spouseId">
                            <option value="0">Ù„Ø§ ÙŠÙˆØ¬Ø¯</option>
                        </select>
                    </div>
                    <button type="button" class="btn btn-success" onclick="savePerson()">Ø­ÙØ¸</button>
                </form>
            </div>
        </div>
    </div>

    <div class="form-modal" id="familyBookModal">
        <div class="form-container" style="max-width: 900px; height: 90vh;">
            <div class="form-header">
                <h3>ÙƒØªØ§Ø¨ Ø§Ù„Ø¹Ø§Ø¦Ù„Ø©</h3>
                <button class="btn btn-danger" onclick="closeFamilyBook()"><i class="fas fa-times"></i></button>
            </div>
            <div class="form-body">
                <div style="margin-bottom: 10px;">
                    <button class="btn btn-primary" onclick="generateFamilyBook()">ØªÙˆÙ„ÙŠØ¯ Ø¬Ø¯ÙŠØ¯</button>
                    <button class="btn btn-info" onclick="printFamilyBook()">Ø·Ø¨Ø§Ø¹Ø©</button>
                </div>
                <div id="bookPreview" style="border: 1px solid #ddd; padding: 20px; min-height: 400px;"></div>
            </div>
        </div>
    </div>

    <script>
        // =========================
        // ØªÙ‡ÙŠØ¦Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª ÙˆØ§Ù„Ù…ØªØºÙŠØ±Ø§Øª
        // =========================
        let familyData = [
            { PersonID: 1, FullName: "Ù…Ø­Ù…Ø¯ Ø¹Ø¨Ø¯Ø§Ù„Ø±Ø­Ù…Ù† (Ø§Ù„Ø¬Ø¯)", Gender: "Ø°ÙƒØ±", FatherID: 0, MotherID: 0, SpouseID: 2 },
            { PersonID: 2, FullName: "Ø§Ù„Ø²ÙˆØ¬Ø© Ø§Ù„Ø£ÙˆÙ„Ù‰", Gender: "Ø§Ù†Ø«Ù‰", FatherID: 0, MotherID: 0, SpouseID: 1 }
        ];
        
        let forumData = {
            posts: [],
            comments: [],
            categories: [
                { id: 1, name: 'Ø§Ù„Ù…Ù‡Ø§Ø±Ø§Øª Ø§Ù„ÙƒØªØ§Ø¨ÙŠØ©', icon: 'fa-pen', color: '#4CAF50' },
                { id: 2, name: 'Ø§Ù„Ù‚ØµØµ Ø§Ù„Ø¹Ø§Ø¦Ù„ÙŠØ©', icon: 'fa-book', color: '#2196F3' },
                { id: 3, name: 'Ø§Ù„Ù…Ù†Ø§Ø³Ø¨Ø§Øª ÙˆØ§Ù„ÙØ¹Ø§Ù„ÙŠØ§Øª', icon: 'fa-calendar', color: '#FF9800' },
                { id: 4, name: 'Ø§Ù„Ù†Ù‚Ø§Ø´ Ø§Ù„Ø¹Ø§Ù…', icon: 'fa-comments', color: '#795548' }
            ],
            userStats: {}
        };

        let currentUser = null;
        let users = {
            'admin': { password: '123', name: 'Ù…Ø¯ÙŠØ± Ø§Ù„Ù†Ø¸Ø§Ù…', role: 'admin' },
            'user': { password: '123', name: 'Ø¹Ø¶Ùˆ Ø§Ù„Ø¹Ø§Ø¦Ù„Ø©', role: 'user' }
        };

        const translations = {
            ar: { dashboard: "Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ©", addPerson: "Ø¥Ø¶Ø§ÙØ© ÙØ±Ø¯", treeView: "Ø§Ù„Ø´Ø¬Ø±Ø©", familyBook: "Ø§Ù„ÙƒØªØ§Ø¨", familyForum: "Ø§Ù„Ù…Ù†ØªØ¯Ù‰" },
            en: { dashboard: "Dashboard", addPerson: "Add Person", treeView: "Tree", familyBook: "Book", familyForum: "Forum" }
        };
        let currentLanguage = 'ar';

        // =========================
        // Ø¯ÙˆØ§Ù„ Ø§Ù„Ù†Ø¸Ø§Ù… Ø§Ù„Ø£Ø³Ø§Ø³ÙŠØ©
        // =========================
        function initSystem() {
            loadDataFromLocal();
            loadForumData(); // ØªØ­Ù…ÙŠÙ„ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ù†ØªØ¯Ù‰
            if(currentUser) {
                document.getElementById('login-screen').style.display = 'none';
                document.getElementById('main-content').style.display = 'block';
                document.getElementById('loggedInUser').textContent = users[currentUser].name;
                loadDashboard();
            }
            // Ø¥Ø¹Ø¯Ø§Ø¯ Ø§Ù„Ù‚Ø§Ø¦Ù…Ø© Ù„Ù„Ø¬ÙˆØ§Ù„
            document.getElementById('mobileMenuToggle').onclick = function() {
                document.getElementById('sidebar').classList.toggle('active');
            };
        }

        function loadDataFromLocal() {
            const storedFamily = localStorage.getItem('familyData');
            if(storedFamily) familyData = JSON.parse(storedFamily);
            
            const storedForum = localStorage.getItem('familyForumData');
            if(storedForum) forumData = JSON.parse(storedForum);
        }

        function saveDataLocal() {
            localStorage.setItem('familyData', JSON.stringify(familyData));
        }

        function saveForumData() {
            localStorage.setItem('familyForumData', JSON.stringify(forumData));
        }

        function handleLogin() {
            const u = document.getElementById('username').value;
            const p = document.getElementById('password').value;
            if(users[u] && users[u].password === p) {
                currentUser = u;
                initSystem();
            } else {
                document.getElementById('loginError').style.display = 'block';
            }
        }

        function logout() {
            currentUser = null;
            location.reload();
        }

        function toggleLanguage() {
            currentLanguage = currentLanguage === 'ar' ? 'en' : 'ar';
            document.documentElement.dir = currentLanguage === 'ar' ? 'rtl' : 'ltr';
            document.getElementById('loginLanguageText').textContent = currentLanguage === 'ar' ? 'English' : 'Ø§Ù„Ø¹Ø±Ø¨ÙŠØ©';
            // ØªØ­Ø¯ÙŠØ« Ø§Ù„Ù†ØµÙˆØµ Ø§Ù„Ø¨Ø³ÙŠØ·Ø©
            document.querySelectorAll('[data-i18n]').forEach(el => {
                const key = el.getAttribute('data-i18n');
                if(translations[currentLanguage][key]) el.textContent = translations[currentLanguage][key];
            });
        }

        // =========================
        // Ø¯ÙˆØ§Ù„ Ù„ÙˆØ­Ø© Ø§Ù„ØªØ­ÙƒÙ… ÙˆØ§Ù„Ø£ÙØ±Ø§Ø¯
        // =========================
        function showDashboard() {
            document.getElementById('contentArea').style.display = 'block';
            closeTreeView(); closeFamilyForum();
            updateStats();
            renderDashboardTable();
        }

        function updateStats() {
            document.getElementById('totalPersons').textContent = familyData.length;
            document.getElementById('maleCount').textContent = familyData.filter(p=>p.Gender==='Ø°ÙƒØ±').length;
            document.getElementById('femaleCount').textContent = familyData.filter(p=>p.Gender==='Ø§Ù†Ø«Ù‰').length;
        }

        function renderDashboardTable() {
            const tbody = document.getElementById('dashboardTableBody');
            tbody.innerHTML = '';
            familyData.slice(-5).reverse().forEach(p => {
                tbody.innerHTML += `
                    <tr>
                        <td style="padding:10px;">${p.PersonID}</td>
                        <td style="padding:10px;">${p.FullName}</td>
                        <td style="padding:10px;">${p.Gender}</td>
                        <td style="padding:10px;">
                            <button class="btn-info btn" onclick="editPerson(${p.PersonID})"><i class="fas fa-edit"></i></button>
                        </td>
                    </tr>
                `;
            });
        }

        function showAddPersonForm() {
            document.getElementById('personForm').reset();
            document.getElementById('personId').value = '';
            populateParentsDropdown();
            document.getElementById('personFormModal').classList.add('active');
        }

        function closePersonForm() {
            document.getElementById('personFormModal').classList.remove('active');
        }

        function populateParentsDropdown() {
            const f = document.getElementById('fatherId');
            const m = document.getElementById('motherId');
            const s = document.getElementById('spouseId');
            f.innerHTML = '<option value="0">Ù„Ø§ ÙŠÙˆØ¬Ø¯</option>';
            m.innerHTML = '<option value="0">Ù„Ø§ ÙŠÙˆØ¬Ø¯</option>';
            s.innerHTML = '<option value="0">Ù„Ø§ ÙŠÙˆØ¬Ø¯</option>';
            
            familyData.forEach(p => {
                const opt = `<option value="${p.PersonID}">${p.FullName}</option>`;
                if(p.Gender === 'Ø°ÙƒØ±') f.innerHTML += opt;
                if(p.Gender === 'Ø§Ù†Ø«Ù‰') m.innerHTML += opt;
                s.innerHTML += opt;
            });
        }

        function savePerson() {
            const id = document.getElementById('personId').value;
            const person = {
                PersonID: id ? parseInt(id) : (familyData.length > 0 ? Math.max(...familyData.map(p=>p.PersonID)) + 1 : 1),
                FullName: document.getElementById('fullName').value,
                Gender: document.getElementById('gender').value,
                FatherID: parseInt(document.getElementById('fatherId').value),
                MotherID: parseInt(document.getElementById('motherId').value),
                SpouseID: parseInt(document.getElementById('spouseId').value)
            };

            if(id) {
                const idx = familyData.findIndex(p => p.PersonID == id);
                familyData[idx] = person;
            } else {
                familyData.push(person);
            }
            saveDataLocal();
            closePersonForm();
            loadDashboard();
        }

        function editPerson(id) {
            const p = familyData.find(x => x.PersonID == id);
            if(!p) return;
            populateParentsDropdown();
            document.getElementById('personId').value = p.PersonID;
            document.getElementById('fullName').value = p.FullName;
            document.getElementById('gender').value = p.Gender;
            document.getElementById('fatherId').value = p.FatherID;
            document.getElementById('motherId').value = p.MotherID;
            document.getElementById('spouseId').value = p.SpouseID;
            document.getElementById('personFormModal').classList.add('active');
        }

        function showAllPersons() {
            showDashboard(); // Ù„Ù„ØªØ¨Ø³ÙŠØ·ØŒ Ù†Ø³ØªØ®Ø¯Ù… Ø§Ù„Ø¬Ø¯ÙˆÙ„ Ø§Ù„Ù…ÙˆØ¬ÙˆØ¯
        }

        // =========================
        // Ø¯ÙˆØ§Ù„ Ø§Ù„Ø´Ø¬Ø±Ø© (Tree)
        // =========================
        function showTreeView() {
            document.getElementById('treeView').classList.add('active');
            renderTree();
        }

        function closeTreeView() {
            document.getElementById('treeView').classList.remove('active');
        }

        function renderTree() {
            const container = document.getElementById('treeContainer');
            container.innerHTML = '';
            
            // Ø®ÙˆØ§Ø±Ø²Ù…ÙŠØ© Ø±Ø³Ù… Ø¨Ø³ÙŠØ·Ø©: Ø±Ø³Ù… Ø§Ù„Ø¬Ø°ÙˆØ± (Ø§Ù„Ø°ÙŠÙ† Ù„ÙŠØ³ Ù„Ø¯ÙŠÙ‡Ù… Ø¢Ø¨Ø§Ø¡ ÙÙŠ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª)
            const roots = familyData.filter(p => p.FatherID === 0);
            
            const wrapper = document.createElement('div');
            wrapper.className = 'tree-wrapper';
            
            roots.forEach(root => {
                wrapper.appendChild(createTreeNode(root));
            });
            
            container.appendChild(wrapper);
        }

        function createTreeNode(person) {
            const nodeDiv = document.createElement('div');
            nodeDiv.style.display = 'flex';
            nodeDiv.style.flexDirection = 'column';
            nodeDiv.style.alignItems = 'center';
            nodeDiv.style.margin = '10px';

            const card = document.createElement('div');
            card.className = `tree-node ${person.Gender === 'Ø°ÙƒØ±' ? 'male' : 'female'}`;
            card.innerHTML = `<strong>${person.FullName}</strong><br><small>#${person.PersonID}</small>`;
            card.onclick = () => editPerson(person.PersonID);
            
            nodeDiv.appendChild(card);

            const children = familyData.filter(p => p.FatherID === person.PersonID || p.MotherID === person.PersonID);
            if(children.length > 0) {
                const childrenContainer = document.createElement('div');
                childrenContainer.style.display = 'flex';
                childrenContainer.style.marginTop = '20px';
                childrenContainer.style.borderTop = '2px solid #ccc';
                
                children.forEach(child => {
                    childrenContainer.appendChild(createTreeNode(child));
                });
                nodeDiv.appendChild(childrenContainer);
            }
            
            return nodeDiv;
        }

        function exportTreeImage() {
            const element = document.getElementById('treeContainer');
            html2canvas(element).then(canvas => {
                const link = document.createElement('a');
                link.download = 'family_tree.png';
                link.href = canvas.toDataURL();
                link.click();
            });
        }

        // =========================
        // Ø¯ÙˆØ§Ù„ ÙƒØªØ§Ø¨ Ø§Ù„Ø¹Ø§Ø¦Ù„Ø©
        // =========================
        function showFamilyBook() {
            document.getElementById('familyBookModal').classList.add('active');
            generateFamilyBook();
        }
        
        function closeFamilyBook() {
            document.getElementById('familyBookModal').classList.remove('active');
        }

        function generateFamilyBook() {
            const container = document.getElementById('bookPreview');
            let html = `<div style="text-align:center;"><h1>ÙƒØªØ§Ø¨ Ø¹Ø§Ø¦Ù„Ø© Ù…Ø­Ù…Ø¯ Ø¹Ø¨Ø¯Ø§Ù„Ø±Ø­Ù…Ù†</h1><p>ØªØ§Ø±ÙŠØ® Ø§Ù„Ø¥ØµØ¯Ø§Ø±: ${new Date().toLocaleDateString()}</p><hr></div>`;
            
            familyData.forEach(p => {
                const father = familyData.find(x => x.PersonID === p.FatherID);
                const mother = familyData.find(x => x.PersonID === p.MotherID);
                const spouse = familyData.find(x => x.PersonID === p.SpouseID);
                
                html += `
                    <div style="margin-bottom: 20px; padding: 10px; border-bottom: 1px solid #eee;">
                        <h3>${p.FullName} (#${p.PersonID})</h3>
                        <p>Ø§Ù„Ø¬Ù†Ø³: ${p.Gender}</p>
                        <p>Ø§Ù„Ø£Ø¨: ${father ? father.FullName : 'ØºÙŠØ± Ù…Ø³Ø¬Ù„'}</p>
                        <p>Ø§Ù„Ø£Ù…: ${mother ? mother.FullName : 'ØºÙŠØ± Ù…Ø³Ø¬Ù„'}</p>
                        <p>Ø§Ù„Ø²ÙˆØ¬/Ø©: ${spouse ? spouse.FullName : 'ØºÙŠØ± Ù…Ø³Ø¬Ù„'}</p>
                    </div>
                `;
            });
            container.innerHTML = html;
        }

        function printFamilyBook() {
            const content = document.getElementById('bookPreview').innerHTML;
            const w = window.open();
            w.document.write(`<html dir="rtl"><body>${content}</body></html>`);
            w.print();
            w.close();
        }

        function showBackup() {
            const dataStr = JSON.stringify(familyData);
            const blob = new Blob([dataStr], {type: "application/json"});
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = "backup_family.json";
            a.click();
        }

        // =========================
        // Ø¯ÙˆØ§Ù„ Ø§Ù„Ù…Ù†ØªØ¯Ù‰ (Forum Logic)
        // =========================
        function loadForumData() {
            // ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ù…Ø­Ù„ÙŠØ§Ù‹ (Ø£Ùˆ Ù…Ù† Firebase ÙÙŠ Ø­Ø§Ù„Ø© Ø§Ù„ØªØ·ÙˆÙŠØ± Ø§Ù„ÙƒØ§Ù…Ù„)
            if(!forumData.categories) {
                // Ø¥Ø¹Ø§Ø¯Ø© ØªØ¹ÙŠÙŠÙ† Ø¥Ø°Ø§ ÙƒØ§Ù†Øª ÙØ§Ø±ØºØ©
                forumData = {
                    posts: [], comments: [], categories: [
                        { id: 1, name: 'Ø§Ù„Ù…Ù‡Ø§Ø±Ø§Øª Ø§Ù„ÙƒØªØ§Ø¨ÙŠØ©', icon: 'fa-pen', color: '#4CAF50' },
                        { id: 2, name: 'Ø§Ù„Ù‚ØµØµ Ø§Ù„Ø¹Ø§Ø¦Ù„ÙŠØ©', icon: 'fa-book', color: '#2196F3' },
                        { id: 3, name: 'Ø§Ù„Ù…Ù†Ø§Ø³Ø¨Ø§Øª ÙˆØ§Ù„ÙØ¹Ø§Ù„ÙŠØ§Øª', icon: 'fa-calendar', color: '#FF9800' },
                        { id: 4, name: 'Ø§Ù„Ù†Ù‚Ø§Ø´ Ø§Ù„Ø¹Ø§Ù…', icon: 'fa-comments', color: '#795548' }
                    ], userStats: {}
                };
            }
        }

        function showFamilyForum() {
            if(!currentUser) { alert('ÙŠØ¬Ø¨ ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„ Ø£ÙˆÙ„Ø§Ù‹'); return; }
            document.getElementById('familyForumModal').classList.add('active');
            updateForumUserInfo();
            showForumHome();
        }

        function closeFamilyForum() {
            document.getElementById('familyForumModal').classList.remove('active');
        }

        function updateForumUserInfo() {
            const uName = users[currentUser].name;
            document.getElementById('forumUserName').innerHTML = `Ù…Ø±Ø­Ø¨Ø§Ù‹ØŒ <span>${uName}</span>`;
            document.getElementById('forumUserAvatar').textContent = uName.charAt(0);
            
            // Ø­Ø³Ø§Ø¨ Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…
            const myPosts = forumData.posts.filter(p => p.authorId === currentUser).length;
            document.getElementById('userPostCount').textContent = myPosts;
        }

        function showForumHome() {
            // ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª Ø§Ù„Ø¹Ø§Ù…Ø©
            document.getElementById('totalPosts').textContent = forumData.posts.length;
            document.getElementById('totalComments').textContent = forumData.comments.length;

            // Ø±Ø³Ù… Ø§Ù„Ø£Ù‚Ø³Ø§Ù…
            const catContainer = document.getElementById('forumCategories');
            catContainer.innerHTML = '';
            let catHTML = '<div class="category-grid">';
            forumData.categories.forEach(c => {
                const count = forumData.posts.filter(p => p.categoryId == c.id).length;
                catHTML += `
                    <div class="category-card" onclick="filterForumByCategory(${c.id})">
                        <div class="category-icon" style="background: ${c.color}"><i class="fas ${c.icon}"></i></div>
                        <h4>${c.name}</h4>
                        <p>${count} Ù…Ù†Ø´ÙˆØ±</p>
                    </div>
                `;
            });
            catHTML += '</div>';
            catContainer.innerHTML = catHTML;

            // Ø±Ø³Ù… Ø£Ø­Ø¯Ø« Ø§Ù„Ù…Ù†Ø´ÙˆØ±Ø§Øª
            renderPostsList(forumData.posts);
        }

        function renderPostsList(posts) {
            const container = document.getElementById('recentPostsList');
            container.innerHTML = '';
            const sorted = [...posts].sort((a,b) => new Date(b.date) - new Date(a.date));
            
            if(sorted.length === 0) {
                container.innerHTML = '<p style="text-align:center; color:#777;">Ù„Ø§ ØªÙˆØ¬Ø¯ Ù…Ù†Ø´ÙˆØ±Ø§Øª Ø¨Ø¹Ø¯</p>';
                return;
            }

            sorted.forEach(p => {
                container.innerHTML += `
                    <div class="post-item" onclick="viewPost(${p.id})">
                        <div class="post-header">
                            <span class="post-title">${p.title}</span>
                            <span style="font-size:12px; color:#777;">${new Date(p.date).toLocaleDateString()}</span>
                        </div>
                        <div style="font-size:13px; color:#555;">${p.content.substring(0, 100)}...</div>
                        <div class="post-tags">
                            <span class="post-tag"><i class="fas fa-user"></i> ${p.authorName}</span>
                            <span class="post-tag"><i class="fas fa-comment"></i> ${forumData.comments.filter(c=>c.postId==p.id).length}</span>
                        </div>
                    </div>
                `;
            });
        }

        function showNewPostForm() {
            // ØªØ¹Ø¨Ø¦Ø© Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ø£Ù‚Ø³Ø§Ù…
            const sel = document.getElementById('postCategory');
            sel.innerHTML = '<option value="">Ø§Ø®ØªØ± Ø§Ù„Ù‚Ø³Ù…</option>';
            forumData.categories.forEach(c => {
                sel.innerHTML += `<option value="${c.id}">${c.name}</option>`;
            });
            document.getElementById('postTitle').value = '';
            document.getElementById('postContent').value = '';
            document.getElementById('newPostModal').classList.add('active');
        }

        function closeNewPost() {
            document.getElementById('newPostModal').classList.remove('active');
        }

        function saveNewPost() {
            const title = document.getElementById('postTitle').value;
            const catId = document.getElementById('postCategory').value;
            const content = document.getElementById('postContent').value;
            
            if(!title || !catId || !content) return;

            const newPost = {
                id: Date.now(),
                title: title,
                categoryId: catId,
                content: content,
                authorId: currentUser,
                authorName: users[currentUser].name,
                date: new Date().toISOString()
            };

            forumData.posts.push(newPost);
            saveForumData();
            closeNewPost();
            refreshForum();
        }

        function viewPost(postId) {
            const post = forumData.posts.find(p => p.id == postId);
            if(!post) return;

            document.getElementById('viewPostTitleHeader').textContent = post.title;
            
            // ØªØ¬Ù…ÙŠØ¹ Ø§Ù„ØªØ¹Ù„ÙŠÙ‚Ø§Øª
            const comments = forumData.comments.filter(c => c.postId == postId);
            let commentsHTML = '';
            comments.forEach(c => {
                commentsHTML += `
                    <div class="comment-item">
                        <div style="display:flex; justify-content:space-between; font-size:12px; color:#2E7D32; margin-bottom:5px;">
                            <strong>${c.authorName}</strong>
                            <span>${new Date(c.date).toLocaleDateString()}</span>
                        </div>
                        <div>${c.content}</div>
                    </div>
                `;
            });

            const html = `
                <div class="post-view">
                    <div class="post-view-title">${post.title}</div>
                    <div style="margin-bottom: 20px; color:#555; line-height:1.6;">${post.content}</div>
                    <div style="font-size:12px; color:#777; margin-bottom: 20px;">
                        ÙƒØªØ¨Ù‡: ${post.authorName} | Ø¨ØªØ§Ø±ÙŠØ®: ${new Date(post.date).toLocaleDateString()}
                    </div>
                    
                    <div class="post-comments">
                        <h4>Ø§Ù„ØªØ¹Ù„ÙŠÙ‚Ø§Øª (${comments.length})</h4>
                        <div id="commentsList">${commentsHTML}</div>
                        <div style="margin-top: 15px;">
                            <textarea id="newCommentContent" class="form-textarea" rows="3" placeholder="Ø£Ø¶Ù ØªØ¹Ù„ÙŠÙ‚Ùƒ..."></textarea>
                            <button class="btn btn-primary" onclick="addComment(${post.id})" style="margin-top:5px;">Ø¥Ø±Ø³Ø§Ù„</button>
                        </div>
                    </div>
                </div>
            `;
            
            document.getElementById('postViewContainer').innerHTML = html;
            document.getElementById('viewPostModal').classList.add('active');
        }

        function closeViewPost() {
            document.getElementById('viewPostModal').classList.remove('active');
        }

        function addComment(postId) {
            const content = document.getElementById('newCommentContent').value;
            if(!content) return;

            const newComment = {
                id: Date.now(),
                postId: postId,
                content: content,
                authorId: currentUser,
                authorName: users[currentUser].name,
                date: new Date().toISOString()
            };

            forumData.comments.push(newComment);
            saveForumData();
            viewPost(postId); // Ø¥Ø¹Ø§Ø¯Ø© ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø¹Ø±Ø¶
        }

        function refreshForum() {
            showForumHome();
        }

        function searchForum() {
            const txt = document.getElementById('forumSearch').value.toLowerCase();
            const filtered = forumData.posts.filter(p => p.title.toLowerCase().includes(txt) || p.content.toLowerCase().includes(txt));
            renderPostsList(filtered);
        }

        function insertFormat(char) {
            const area = document.getElementById('postContent');
            area.value += char;
        }

        // =========================
        // Ø¨Ø¯Ø¡ Ø§Ù„ØªØ´ØºÙŠÙ„
        // =========================
        window.onload = function() {
            // Ù…Ø­Ø§ÙˆÙ„Ø© ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø¹Ù†Ø¯ Ø¨Ø¯Ø¡ Ø§Ù„ØªØ´ØºÙŠÙ„
            initSystem();
        };

    </script>
</body>
</html>
